<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–¢–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –º–µ–∂–¥—É —Å—Ü–µ–Ω–∞–º–∏</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        color: #ffffff;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
      }

      h1 {
        text-align: center;
        margin-bottom: 30px;
        font-size: 2rem;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }

      .test-section {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 25px;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .test-title {
        font-size: 1.3rem;
        font-weight: bold;
        margin-bottom: 15px;
        color: #4caf50;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
      }

      .test-step {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        padding: 15px;
        margin: 10px 0;
        border-left: 4px solid #2196f3;
      }

      .test-result {
        background: rgba(0, 0, 0, 0.3);
        border-radius: 8px;
        padding: 15px;
        margin: 15px 0;
        font-family: "Courier New", monospace;
        font-size: 0.9rem;
        white-space: pre-wrap;
        overflow-x: auto;
        border-left: 4px solid #ffc107;
      }

      .success {
        border-left-color: #4caf50;
        background: rgba(76, 175, 80, 0.1);
      }

      .error {
        border-left-color: #f44336;
        background: rgba(244, 67, 54, 0.1);
      }

      .button {
        background: linear-gradient(145deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        margin: 8px 8px 8px 0;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      }

      .button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      }

      .button:active {
        transform: translateY(0);
      }

      .status {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.9rem;
        font-weight: bold;
      }

      .status.pending {
        background: #ffc107;
        color: #000;
      }

      .status.success {
        background: #4caf50;
        color: #fff;
      }

      .status.error {
        background: #f44336;
        color: #fff;
      }

      .iframe-container {
        width: 100%;
        height: 500px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 12px;
        overflow: hidden;
        margin: 20px 0;
        background: #000;
      }

      iframe {
        width: 100%;
        height: 100%;
        border: none;
      }

      .console-log {
        background: #1a1a1a;
        color: #00ff00;
        font-family: "Courier New", monospace;
        padding: 15px;
        border-radius: 8px;
        margin: 10px 0;
        max-height: 200px;
        overflow-y: auto;
        font-size: 0.8rem;
      }

      .test-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin: 20px 0;
      }

      .color-box {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 1px solid #ccc;
        border-radius: 4px;
        margin-right: 10px;
        vertical-align: middle;
      }

      @media (max-width: 768px) {
        .test-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üß™ –¢–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –º–µ–∂–¥—É —Å—Ü–µ–Ω–∞–º–∏</h1>
      <p style="text-align: center; opacity: 0.9; margin-bottom: 30px">
        –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ü–≤–µ—Ç–æ–≤ —Ö–æ—Ç—Å–ø–æ—Ç–æ–≤ –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–µ—Ä–µ—Ö–æ–¥–æ–≤
      </p>

      <div class="iframe-container">
        <iframe src="index.html" id="testFrame"></iframe>
      </div>

      <!-- –¢–µ—Å—Ç 1: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ü–≤–µ—Ç–æ–≤ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–∞—Ö -->
      <div class="test-section">
        <div class="test-title">
          üé® –¢–µ—Å—Ç 1: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ü–≤–µ—Ç–æ–≤ —Ö–æ—Ç—Å–ø–æ—Ç–æ–≤ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–∞—Ö
          <span id="colorTest-status" class="status pending">–û–∂–∏–¥–∞–Ω–∏–µ</span>
        </div>

        <div class="test-step">
          <strong>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:</strong><br />
          1. –°–æ–∑–¥–∞–π—Ç–µ 2 —Å—Ü–µ–Ω—ã —Å —Ä–∞–∑–Ω—ã–º–∏ –ø–∞–Ω–æ—Ä–∞–º–∞–º–∏<br />
          2. –ù–∞ –ø–µ—Ä–≤–æ–π —Å—Ü–µ–Ω–µ —Å–æ–∑–¥–∞–π—Ç–µ —Ö–æ—Ç—Å–ø–æ—Ç (–∫—Ä–∞—Å–Ω—ã–π) –∏ –∏–Ω—Ñ–æ—Ç–æ—á–∫—É (—Å–∏–Ω—é—é) —Å
          –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º–∏ —Ü–≤–µ—Ç–∞–º–∏<br />
          3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ö–æ—Ç—Å–ø–æ—Ç –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ –≤—Ç–æ—Ä—É—é —Å—Ü–µ–Ω—É<br />
          4. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –≤—Ç–æ—Ä—É—é —Å—Ü–µ–Ω—É —á–µ—Ä–µ–∑ —Ö–æ—Ç—Å–ø–æ—Ç<br />
          5. –í–µ—Ä–Ω–∏—Ç–µ—Å—å –Ω–∞ –ø–µ—Ä–≤—É—é —Å—Ü–µ–Ω—É<br />
          6. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ü–≤–µ—Ç–∞ –º–∞—Ä–∫–µ—Ä–æ–≤ –æ—Å—Ç–∞–ª–∏—Å—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏
        </div>

        <button class="button" onclick="startColorTest()">
          –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Ü–≤–µ—Ç–æ–≤
        </button>
        <button class="button" onclick="checkColorValues()">
          –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ü–≤–µ—Ç–∞ –≤ –∫–æ–Ω—Å–æ–ª–∏
        </button>

        <div
          id="colorTest-result"
          class="test-result"
          style="display: none"
        ></div>
      </div>

      <!-- –¢–µ—Å—Ç 2: –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã -->
      <div class="test-section">
        <div class="test-title">
          üîÑ –¢–µ—Å—Ç 2: –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –º–µ–∂–¥—É —Å—Ü–µ–Ω–∞–º–∏
          <span id="transitionTest-status" class="status pending"
            >–û–∂–∏–¥–∞–Ω–∏–µ</span
          >
        </div>

        <div class="test-step">
          <strong>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:</strong><br />
          1. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –º–µ–∂–¥—É —Å—Ü–µ–Ω–∞–º–∏ —á–µ—Ä–µ–∑ —Ö–æ—Ç—Å–ø–æ—Ç—ã<br />
          2. –í—ã–ø–æ–ª–Ω–∏—Ç–µ –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –≤—Ç–æ—Ä—É—é —Å—Ü–µ–Ω—É<br />
          3. –ü–æ–¥–æ–∂–¥–∏—Ç–µ 2 —Å–µ–∫—É–Ω–¥—ã<br />
          4. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –æ–±—Ä–∞—Ç–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥<br />
          5. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑<br />
          6. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ –ø–µ—Ä–µ—Ö–æ–¥—ã —Ä–∞–±–æ—Ç–∞—é—Ç –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫
        </div>

        <button class="button" onclick="startTransitionTest()">
          –¢–µ—Å—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–µ—Ä–µ—Ö–æ–¥–æ–≤
        </button>
        <button class="button" onclick="checkTransitionLogs()">
          –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤
        </button>

        <div
          id="transitionTest-result"
          class="test-result"
          style="display: none"
        ></div>
      </div>

      <!-- –¢–µ—Å—Ç 3: –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –∫–Ω–æ–ø–∫–∏ –∫–∞–º–µ—Ä—ã -->
      <div class="test-section">
        <div class="test-title">
          üìπ –¢–µ—Å—Ç 3: –ö–Ω–æ–ø–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤–∏–¥–∞ –∫–∞–º–µ—Ä—ã
          <span id="cameraTest-status" class="status pending">–û–∂–∏–¥–∞–Ω–∏–µ</span>
        </div>

        <div class="test-step">
          <strong>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:</strong><br />
          1. –ü–æ–≤–µ—Ä–Ω–∏—Ç–µ –∫–∞–º–µ—Ä—É –≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—É—é –ø–æ–∑–∏—Ü–∏—é –Ω–∞ –ø–µ—Ä–≤–æ–π —Å—Ü–µ–Ω–µ<br />
          2. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "üìπ" –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤–∏–¥–∞ –∫–∞–º–µ—Ä—ã<br />
          3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –¥—Ä—É–≥—É—é —Å—Ü–µ–Ω—É<br />
          4. –í–µ—Ä–Ω–∏—Ç–µ—Å—å –Ω–∞ –ø–µ—Ä–≤—É—é —Å—Ü–µ–Ω—É<br />
          5. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫–∞–º–µ—Ä–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–∏–ª–∞—Å—å –≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é
          –ø–æ–∑–∏—Ü–∏—é
        </div>

        <button class="button" onclick="startCameraTest()">
          –¢–µ—Å—Ç –∫–Ω–æ–ø–∫–∏ –∫–∞–º–µ—Ä—ã
        </button>
        <button class="button" onclick="checkCameraPosition()">
          –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é –∫–∞–º–µ—Ä—ã
        </button>

        <div
          id="cameraTest-result"
          class="test-result"
          style="display: none"
        ></div>
      </div>

      <!-- –ö–æ–Ω—Å–æ–ª—å –ª–æ–≥–æ–≤ -->
      <div class="test-section">
        <div class="test-title">üìã –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∏—Å—Ç–µ–º—ã</div>
        <button class="button" onclick="startMonitoring()">
          –ù–∞—á–∞—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
        </button>
        <button class="button" onclick="stopMonitoring()">
          –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
        </button>
        <button class="button" onclick="clearLogs()">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏</button>

        <div id="monitoring-logs" class="console-log">
          –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –ù–∞–∂–º–∏—Ç–µ "–ù–∞—á–∞—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥" –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
          –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.
        </div>
      </div>

      <!-- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–µ—Å—Ç -->
      <div class="test-section">
        <div class="test-title">üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</div>
        <button class="button" onclick="runFullDiagnostic()">
          –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–ª–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É
        </button>

        <div
          id="diagnostic-result"
          class="test-result"
          style="display: none"
        ></div>
      </div>
    </div>

    <script>
      let monitoringActive = false;
      let monitoringInterval = null;
      let testFrame = null;

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
      document.addEventListener("DOMContentLoaded", () => {
        testFrame = document.getElementById("testFrame");
        updateStatus("–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é");
      });

      // –§—É–Ω–∫—Ü–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
      function updateStatus(message, type = "info") {
        const timestamp = new Date().toLocaleTimeString();
        const logDiv = document.getElementById("monitoring-logs");
        logDiv.innerHTML += `[${timestamp}] ${message}\n`;
        logDiv.scrollTop = logDiv.scrollHeight;
      }

      function setTestStatus(testId, status) {
        const statusEl = document.getElementById(testId + "-status");
        statusEl.className = `status ${status}`;
        statusEl.textContent =
          status === "success"
            ? "–ü—Ä–æ–π–¥–µ–Ω"
            : status === "error"
              ? "–û—à–∏–±–∫–∞"
              : "–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è";
      }

      function showTestResult(testId, content, success = true) {
        const resultEl = document.getElementById(testId + "-result");
        resultEl.style.display = "block";
        resultEl.className = `test-result ${success ? "success" : "error"}`;
        resultEl.textContent = content;
      }

      // –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ü–≤–µ—Ç–æ–≤
      function startColorTest() {
        setTestStatus("colorTest", "running");
        updateStatus("üé® –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ü–≤–µ—Ç–æ–≤ —Ö–æ—Ç—Å–ø–æ—Ç–æ–≤...");

        try {
          const testWindow = testFrame.contentWindow;
          if (!testWindow) {
            throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ —Ç–µ—Å—Ç–æ–≤–æ–º—É –æ–∫–Ω—É");
          }

          // –ü–æ–ª—É—á–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º
          const hotspotManager = testWindow.hotspotManager;
          const sceneManager = testWindow.sceneManager;

          if (!hotspotManager || !sceneManager) {
            throw new Error("–ú–µ–Ω–µ–¥–∂–µ—Ä—ã –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã");
          }

          updateStatus("‚úì –î–æ—Å—Ç—É–ø –∫ –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º –ø–æ–ª—É—á–µ–Ω");

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å—Ü–µ–Ω –∏ —Ö–æ—Ç—Å–ø–æ—Ç–æ–≤
          const scenes = sceneManager.getAllScenes();
          const hotspots = hotspotManager.getAllHotspots();

          updateStatus(
            `–ù–∞–π–¥–µ–Ω–æ —Å—Ü–µ–Ω: ${scenes.length}, —Ö–æ—Ç—Å–ø–æ—Ç–æ–≤: ${hotspots.length}`
          );

          if (hotspots.length === 0) {
            showTestResult(
              "colorTest",
              "–î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–∑–¥–∞—Ç—å —Ö–æ—Ç—Å–ø–æ—Ç—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º–∏ —Ü–≤–µ—Ç–∞–º–∏",
              false
            );
            setTestStatus("colorTest", "error");
            return;
          }

          // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ü–≤–µ—Ç–∞ —Ö–æ—Ç—Å–ø–æ—Ç–æ–≤
          let colorReport = "–ê–Ω–∞–ª–∏–∑ —Ü–≤–µ—Ç–æ–≤ —Ö–æ—Ç—Å–ø–æ—Ç–æ–≤:\n";
          hotspots.forEach((hotspot) => {
            colorReport += `- ${hotspot.title || hotspot.id}: ${hotspot.type} (—Ü–≤–µ—Ç: ${hotspot.color})\n`;
          });

          showTestResult("colorTest", colorReport, true);
          setTestStatus("colorTest", "success");
          updateStatus("‚úì –¢–µ—Å—Ç —Ü–≤–µ—Ç–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ");
        } catch (error) {
          updateStatus(`‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∞ —Ü–≤–µ—Ç–æ–≤: ${error.message}`);
          showTestResult("colorTest", `–û—à–∏–±–∫–∞: ${error.message}`, false);
          setTestStatus("colorTest", "error");
        }
      }

      function checkColorValues() {
        try {
          const testWindow = testFrame.contentWindow;
          testWindow.console.log("=== –ü–†–û–í–ï–†–ö–ê –¶–í–ï–¢–û–í –•–û–¢–°–ü–û–¢–û–í ===");

          const hotspots = testWindow.hotspotManager?.getAllHotspots() || [];
          hotspots.forEach((hotspot) => {
            testWindow.console.log(`üéØ –•–æ—Ç—Å–ø–æ—Ç ${hotspot.id}:`, {
              title: hotspot.title,
              type: hotspot.type,
              color: hotspot.color,
              sceneId: hotspot.sceneId,
            });
          });

          updateStatus("üìä –î–∞–Ω–Ω—ã–µ –æ —Ü–≤–µ—Ç–∞—Ö –≤—ã–≤–µ–¥–µ–Ω—ã –≤ –∫–æ–Ω—Å–æ–ª—å –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –æ–∫–Ω–∞");
        } catch (error) {
          updateStatus(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ü–≤–µ—Ç–æ–≤: ${error.message}`);
        }
      }

      // –¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤
      function startTransitionTest() {
        setTestStatus("transitionTest", "running");
        updateStatus("üîÑ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–µ—Ä–µ—Ö–æ–¥–æ–≤...");

        try {
          const testWindow = testFrame.contentWindow;
          const sceneManager = testWindow.sceneManager;

          if (!sceneManager) {
            throw new Error("SceneManager –Ω–µ –Ω–∞–π–¥–µ–Ω");
          }

          const scenes = sceneManager.getAllScenes();
          if (scenes.length < 2) {
            throw new Error("–î–ª—è —Ç–µ—Å—Ç–∞ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –Ω—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 2 —Å—Ü–µ–Ω—ã");
          }

          updateStatus(`‚úì –ù–∞–π–¥–µ–Ω–æ ${scenes.length} —Å—Ü–µ–Ω –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è`);

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞—â–∏—Ç—ã –æ—Ç –ø–µ—Ä–µ—Ö–æ–¥–æ–≤
          const lastSwitchTime = sceneManager._lastSwitchTime;
          const lastSwitchTarget = sceneManager._lastSwitchTarget;

          let statusReport = `–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –ø–µ—Ä–µ—Ö–æ–¥–æ–≤:\n`;
          statusReport += `- –ü–æ—Å–ª–µ–¥–Ω–∏–π –ø–µ—Ä–µ—Ö–æ–¥: ${lastSwitchTime ? new Date(lastSwitchTime).toLocaleTimeString() : "–Ω–µ –≤—ã–ø–æ–ª–Ω—è–ª—Å—è"}\n`;
          statusReport += `- –¶–µ–ª–µ–≤–∞—è —Å—Ü–µ–Ω–∞: ${lastSwitchTarget || "–Ω–µ –∑–∞–¥–∞–Ω–∞"}\n`;
          statusReport += `- –¢–µ–∫—É—â–∞—è —Å—Ü–µ–Ω–∞: ${sceneManager.getCurrentScene()?.name || "–Ω–µ –≤—ã–±—Ä–∞–Ω–∞"}\n`;

          showTestResult("transitionTest", statusReport, true);
          setTestStatus("transitionTest", "success");
          updateStatus("‚úì –¢–µ—Å—Ç –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω");
        } catch (error) {
          updateStatus(`‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∞ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤: ${error.message}`);
          showTestResult("transitionTest", `–û—à–∏–±–∫–∞: ${error.message}`, false);
          setTestStatus("transitionTest", "error");
        }
      }

      function checkTransitionLogs() {
        try {
          const testWindow = testFrame.contentWindow;
          testWindow.console.log("=== –ü–†–û–í–ï–†–ö–ê –õ–û–ì–û–í –ü–ï–†–ï–•–û–î–û–í ===");

          const sceneManager = testWindow.sceneManager;
          testWindow.console.log("–°–æ—Å—Ç–æ—è–Ω–∏–µ SceneManager:", {
            lastSwitchTime: sceneManager?._lastSwitchTime,
            lastSwitchTarget: sceneManager?._lastSwitchTarget,
            currentScene: sceneManager?.getCurrentScene(),
          });

          updateStatus("üìã –õ–æ–≥–∏ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –≤—ã–≤–µ–¥–µ–Ω—ã –≤ –∫–æ–Ω—Å–æ–ª—å –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –æ–∫–Ω–∞");
        } catch (error) {
          updateStatus(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–æ–≥–æ–≤: ${error.message}`);
        }
      }

      // –¢–µ—Å—Ç 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–Ω–æ–ø–∫–∏ –∫–∞–º–µ—Ä—ã
      function startCameraTest() {
        setTestStatus("cameraTest", "running");
        updateStatus("üìπ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞ –∫–Ω–æ–ø–∫–∏ –∫–∞–º–µ—Ä—ã...");

        try {
          const testWindow = testFrame.contentWindow;
          const viewerManager = testWindow.viewerManager;
          const sceneManager = testWindow.sceneManager;

          if (!viewerManager || !sceneManager) {
            throw new Error("–ú–µ–Ω–µ–¥–∂–µ—Ä—ã –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã");
          }

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–Ω–æ–ø–∫–∏ –∫–∞–º–µ—Ä—ã
          const cameraBtn = testWindow.document.getElementById(
            "set-camera-view-btn"
          );
          if (!cameraBtn) {
            throw new Error("–ö–Ω–æ–ø–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤–∏–¥–∞ –∫–∞–º–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
          }

          updateStatus("‚úì –ö–Ω–æ–ø–∫–∞ –∫–∞–º–µ—Ä—ã –Ω–∞–π–¥–µ–Ω–∞");

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–µ—Ç–æ–¥—ã —Ä–∞–±–æ—Ç—ã —Å –∫–∞–º–µ—Ä–æ–π
          const hasGetCameraPosition =
            typeof viewerManager.getCameraPosition === "function";
          const hasSetCameraPosition =
            typeof viewerManager.setCameraPosition === "function";
          const hasSaveCameraPosition =
            typeof viewerManager.saveCameraPositionForScene === "function";

          let methodsReport = `–ú–µ—Ç–æ–¥—ã —Ä–∞–±–æ—Ç—ã —Å –∫–∞–º–µ—Ä–æ–π:\n`;
          methodsReport += `- getCameraPosition: ${hasGetCameraPosition ? "‚úì" : "‚úó"}\n`;
          methodsReport += `- setCameraPosition: ${hasSetCameraPosition ? "‚úì" : "‚úó"}\n`;
          methodsReport += `- saveCameraPositionForScene: ${hasSaveCameraPosition ? "‚úì" : "‚úó"}\n`;

          const allMethodsExist =
            hasGetCameraPosition &&
            hasSetCameraPosition &&
            hasSaveCameraPosition;

          showTestResult("cameraTest", methodsReport, allMethodsExist);
          setTestStatus("cameraTest", allMethodsExist ? "success" : "error");
          updateStatus(
            allMethodsExist
              ? "‚úì –í—Å–µ –º–µ—Ç–æ–¥—ã –∫–∞–º–µ—Ä—ã –¥–æ—Å—Ç—É–ø–Ω—ã"
              : "‚ùå –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –º–µ—Ç–æ–¥—ã –∫–∞–º–µ—Ä—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç"
          );
        } catch (error) {
          updateStatus(`‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∞ –∫–∞–º–µ—Ä—ã: ${error.message}`);
          showTestResult("cameraTest", `–û—à–∏–±–∫–∞: ${error.message}`, false);
          setTestStatus("cameraTest", "error");
        }
      }

      function checkCameraPosition() {
        try {
          const testWindow = testFrame.contentWindow;
          const viewerManager = testWindow.viewerManager;

          if (
            viewerManager &&
            typeof viewerManager.getCameraPosition === "function"
          ) {
            const cameraPosition = viewerManager.getCameraPosition();
            testWindow.console.log(
              "üìπ –¢–µ–∫—É—â–∞—è –ø–æ–∑–∏—Ü–∏—è –∫–∞–º–µ—Ä—ã:",
              cameraPosition
            );
            updateStatus("üìπ –ü–æ–∑–∏—Ü–∏—è –∫–∞–º–µ—Ä—ã –≤—ã–≤–µ–¥–µ–Ω–∞ –≤ –∫–æ–Ω—Å–æ–ª—å –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –æ–∫–Ω–∞");
          } else {
            updateStatus("‚ùå –ú–µ—Ç–æ–¥ getCameraPosition –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω");
          }
        } catch (error) {
          updateStatus(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏ –∫–∞–º–µ—Ä—ã: ${error.message}`);
        }
      }

      // –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
      function startMonitoring() {
        if (monitoringActive) return;

        monitoringActive = true;
        updateStatus("üü¢ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω");

        monitoringInterval = setInterval(() => {
          try {
            const testWindow = testFrame.contentWindow;
            if (!testWindow) return;

            // –ë–∞–∑–æ–≤–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
            const sceneManager = testWindow.sceneManager;
            const hotspotManager = testWindow.hotspotManager;
            const viewerManager = testWindow.viewerManager;

            if (Date.now() % 5000 < 1000) {
              // –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
              const status = {
                scenes: sceneManager?.getAllScenes().length || 0,
                hotspots: hotspotManager?.getAllHotspots().length || 0,
                currentScene:
                  sceneManager?.getCurrentScene()?.name || "–Ω–µ –≤—ã–±—Ä–∞–Ω–∞",
              };
              updateStatus(
                `üìä –°—Ç–∞—Ç—É—Å: ${status.scenes} —Å—Ü–µ–Ω, ${status.hotspots} —Ö–æ—Ç—Å–ø–æ—Ç–æ–≤, —Ç–µ–∫—É—â–∞—è: ${status.currentScene}`
              );
            }
          } catch (error) {
            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
          }
        }, 1000);
      }

      function stopMonitoring() {
        if (!monitoringActive) return;

        monitoringActive = false;
        if (monitoringInterval) {
          clearInterval(monitoringInterval);
          monitoringInterval = null;
        }
        updateStatus("üî¥ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω");
      }

      function clearLogs() {
        document.getElementById("monitoring-logs").innerHTML = "";
        updateStatus("üìã –õ–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã");
      }

      // –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
      function runFullDiagnostic() {
        updateStatus("üöÄ –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏...");

        try {
          const testWindow = testFrame.contentWindow;
          if (!testWindow) {
            throw new Error("–¢–µ—Å—Ç–æ–≤–æ–µ –æ–∫–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ");
          }

          let diagnosticReport = "–ü–û–õ–ù–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –°–ò–°–¢–ï–ú–´\n\n";

          // –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
          const managers = [
            "sceneManager",
            "hotspotManager",
            "viewerManager",
            "coordinateManager",
          ];
          diagnosticReport += "–ú–µ–Ω–µ–¥–∂–µ—Ä—ã:\n";
          managers.forEach((manager) => {
            const exists = !!testWindow[manager];
            diagnosticReport += `- ${manager}: ${exists ? "‚úì –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω" : "‚úó –ù–µ –Ω–∞–π–¥–µ–Ω"}\n`;
          });

          // –ü—Ä–æ–≤–µ—Ä–∫–∞ A-Frame
          const aframeExists = !!testWindow.AFRAME;
          const sceneElement = testWindow.document.querySelector("a-scene");
          diagnosticReport += `\nA-Frame:\n`;
          diagnosticReport += `- AFRAME –æ–±—ä–µ–∫—Ç: ${aframeExists ? "‚úì" : "‚úó"}\n`;
          diagnosticReport += `- a-scene —ç–ª–µ–º–µ–Ω—Ç: ${sceneElement ? "‚úì" : "‚úó"}\n`;

          // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö
          if (testWindow.sceneManager) {
            const scenes = testWindow.sceneManager.getAllScenes();
            diagnosticReport += `\n–î–∞–Ω–Ω—ã–µ:\n`;
            diagnosticReport += `- –°—Ü–µ–Ω—ã: ${scenes.length}\n`;
            scenes.forEach((scene, index) => {
              diagnosticReport += `  ${index + 1}. ${scene.name} (ID: ${scene.id})\n`;
            });
          }

          if (testWindow.hotspotManager) {
            const hotspots = testWindow.hotspotManager.getAllHotspots();
            diagnosticReport += `- –•–æ—Ç—Å–ø–æ—Ç—ã: ${hotspots.length}\n`;

            const colorIssues = hotspots.filter(
              (h) => !h.color || h.color === "undefined"
            );
            if (colorIssues.length > 0) {
              diagnosticReport += `‚ö†Ô∏è –•–æ—Ç—Å–ø–æ—Ç—ã –±–µ–∑ —Ü–≤–µ—Ç–∞: ${colorIssues.length}\n`;
            }
          }

          // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–Ω–æ–ø–æ–∫ UI
          const uiButtons = [
            "set-camera-view-btn",
            "save-project",
            "export-btn",
          ];
          diagnosticReport += `\nUI —ç–ª–µ–º–µ–Ω—Ç—ã:\n`;
          uiButtons.forEach((btnId) => {
            const exists = !!testWindow.document.getElementById(btnId);
            diagnosticReport += `- ${btnId}: ${exists ? "‚úì" : "‚úó"}\n`;
          });

          showTestResult("diagnostic", diagnosticReport, true);
          updateStatus("‚úÖ –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞");
        } catch (error) {
          const errorReport = `–û—à–∏–±–∫–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏: ${error.message}`;
          showTestResult("diagnostic", errorReport, false);
          updateStatus(`‚ùå ${errorReport}`);
        }
      }

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ iframe
      document.getElementById("testFrame").onload = function () {
        updateStatus("üîÑ –¢–µ—Å—Ç–æ–≤–æ–µ –æ–∫–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...");

        setTimeout(() => {
          try {
            const testWindow = this.contentWindow;
            if (testWindow && testWindow.viewerManager) {
              updateStatus("‚úÖ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é");
            } else {
              updateStatus("‚ö†Ô∏è –ú–µ–Ω–µ–¥–∂–µ—Ä—ã –µ—â–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è, –ø–æ–¥–æ–∂–¥–∏—Ç–µ...");
            }
          } catch (e) {
            updateStatus("‚ö†Ô∏è –î–æ—Å—Ç—É–ø –∫ —Ç–µ—Å—Ç–æ–≤–æ–º—É –æ–∫–Ω—É –æ–≥—Ä–∞–Ω–∏—á–µ–Ω");
          }
        }, 2000);
      };
    </script>
  </body>
</html>
