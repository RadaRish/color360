<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–¢–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π —ç–∫—Å–ø–æ—Ä—Ç–∞ –∏ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://unpkg.com/@aframe/environment-component@1.3.0/dist/aframe-environment-component.min.js"></script>
    <link rel="stylesheet" href="styles/photo-sphere-viewer.css" />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div id="container">
      <a-scene id="aframe-scene" embedded style="height: 100vh">
        <a-assets>
          <img id="panorama" src="panoramas/demo.svg" crossorigin="anonymous" />
        </a-assets>

        <a-sky src="#panorama" rotation="0 0 0"></a-sky>
      </a-scene>

      <!-- UI —ç–ª–µ–º–µ–Ω—Ç—ã -->
      <div id="controls">
        <h3>–¢–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π</h3>
        <button id="create-hotspot" style="background: #ff0000">
          –°–æ–∑–¥–∞—Ç—å –∫—Ä–∞—Å–Ω—ã–π —Ö–æ—Ç—Å–ø–æ—Ç (–ø–µ—Ä–µ—Ö–æ–¥)
        </button>
        <button id="create-infopoint" style="background: #0099ff">
          –°–æ–∑–¥–∞—Ç—å —Å–∏–Ω—é—é –∏–Ω—Ñ–æ—Ç–æ—á–∫—É
        </button>
        <button id="create-video" style="background: #666666">
          –°–æ–∑–¥–∞—Ç—å –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç—å
        </button>
        <button id="add-scene">–î–æ–±–∞–≤–∏—Ç—å –≤—Ç–æ—Ä—É—é —Å—Ü–µ–Ω—É</button>
        <button id="export-test">–¢–µ—Å—Ç–æ–≤—ã–π —ç–∫—Å–ø–æ—Ä—Ç</button>
        <div id="status"></div>
      </div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –º–æ–¥—É–ª–µ–π -->
    <script type="module" src="core/coordinate_manager.js"></script>
    <script type="module" src="core/hotspot_manager.js"></script>
    <script type="module" src="core/scene_manager.js"></script>
    <script type="module" src="core/project_manager.js"></script>
    <script type="module" src="core/export_manager.js"></script>
    <script type="module" src="core/viewer_manager.js"></script>
    <script type="module" src="ui/scene_list.js"></script>
    <script type="module" src="ui/hotspot-editor.js"></script>

    <script type="module">
      import ViewerManager from "./core/viewer_manager.js";
      import HotspotManager from "./core/hotspot_manager.js";
      import SceneManager from "./core/scene_manager.js";
      import ProjectManager from "./core/project_manager.js";
      import ExportManager from "./core/export_manager.js";

      let viewerManager;
      let hotspotManager;
      let sceneManager;
      let projectManager;
      let exportManager;
      let testSceneId;

      function updateStatus(message) {
        document.getElementById("status").innerHTML =
          "<p>" + new Date().toLocaleTimeString() + ": " + message + "</p>";
        console.log("üìù –°—Ç–∞—Ç—É—Å:", message);
      }

      // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ A-Frame
      document.querySelector("a-scene").addEventListener("loaded", () => {
        console.log("üé¨ A-Frame —Å—Ü–µ–Ω–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞");

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä—ã
        const scene = document.querySelector("a-scene");

        sceneManager = new SceneManager();
        hotspotManager = new HotspotManager();
        projectManager = new ProjectManager();
        viewerManager = new ViewerManager(scene, hotspotManager, sceneManager);
        exportManager = new ExportManager(
          sceneManager,
          hotspotManager,
          projectManager
        );

        // –°–≤—è–∑—ã–≤–∞–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä—ã
        sceneManager.setManagers(viewerManager, hotspotManager);
        hotspotManager.setViewerManager(viewerManager);

        // –î–µ–ª–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        window.viewerManager = viewerManager;
        window.hotspotManager = hotspotManager;
        window.sceneManager = sceneManager;
        window.projectManager = projectManager;
        window.exportManager = exportManager;

        updateStatus("–í—Å–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã");

        // –°–æ–∑–¥–∞–Ω–∏–µ –∫—Ä–∞—Å–Ω–æ–≥–æ —Ö–æ—Ç—Å–ø–æ—Ç–∞ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞
        document
          .getElementById("create-hotspot")
          .addEventListener("click", () => {
            const hotspot = {
              id: "hotspot-" + Date.now(),
              type: "hotspot",
              title: "–ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å—Ü–µ–Ω–µ 2",
              description: "–¢–µ—Å—Ç–æ–≤—ã–π —Ö–æ—Ç—Å–ø–æ—Ç –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞",
              position: { x: -3, y: 0, z: -5 },
              color: "#ff0000",
              size: 0.4,
              icon: "arrow",
              targetSceneId: testSceneId,
              sceneId: sceneManager.currentScene?.id || "scene-1",
            };

            try {
              hotspotManager.addHotspot(hotspot);
              updateStatus("–ö—Ä–∞—Å–Ω—ã–π —Ö–æ—Ç—Å–ø–æ—Ç —Å–æ–∑–¥–∞–Ω —Å —Ü–≤–µ—Ç–æ–º: " + hotspot.color);
            } catch (error) {
              updateStatus("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ö–æ—Ç—Å–ø–æ—Ç–∞: " + error.message);
            }
          });

        // –°–æ–∑–¥–∞–Ω–∏–µ —Å–∏–Ω–µ–π –∏–Ω—Ñ–æ—Ç–æ—á–∫–∏
        document
          .getElementById("create-infopoint")
          .addEventListener("click", () => {
            const hotspot = {
              id: "infopoint-" + Date.now(),
              type: "infopoint",
              title: "–°–∏–Ω—è—è –∏–Ω—Ñ–æ—Ç–æ—á–∫–∞",
              description: "–¢–µ—Å—Ç–æ–≤–∞—è –∏–Ω—Ñ–æ—Ç–æ—á–∫–∞",
              position: { x: 0, y: 0, z: -5 },
              color: "#0099ff",
              size: 0.3,
              icon: "sphere",
              sceneId: sceneManager.currentScene?.id || "scene-1",
            };

            try {
              hotspotManager.addHotspot(hotspot);
              updateStatus(
                "–°–∏–Ω—è—è –∏–Ω—Ñ–æ—Ç–æ—á–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ —Å —Ü–≤–µ—Ç–æ–º: " + hotspot.color
              );
            } catch (error) {
              updateStatus("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω—Ñ–æ—Ç–æ—á–∫–∏: " + error.message);
            }
          });

        // –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏
        document
          .getElementById("create-video")
          .addEventListener("click", () => {
            const hotspot = {
              id: "video-" + Date.now(),
              type: "video-area",
              title: "–í–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç—å",
              position: { x: 3, y: 0, z: -5 },
              videoWidth: 4,
              videoHeight: 3,
              color: "#666666",
              sceneId: sceneManager.currentScene?.id || "scene-1",
            };

            try {
              viewerManager.createVideoArea(hotspot);
              updateStatus("–í–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç—å —Å–æ–∑–¥–∞–Ω–∞");
            } catch (error) {
              updateStatus("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏: " + error.message);
            }
          });

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤—Ç–æ—Ä–æ–π —Å—Ü–µ–Ω—ã
        document.getElementById("add-scene").addEventListener("click", () => {
          testSceneId = "scene-" + Date.now();
          const scene2 = {
            id: testSceneId,
            name: "–¢–µ—Å—Ç–æ–≤–∞—è —Å—Ü–µ–Ω–∞ 2",
            src: "panoramas/demo.svg", // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç—É –∂–µ –ø–∞–Ω–æ—Ä–∞–º—É –¥–ª—è —Ç–µ—Å—Ç–∞
          };

          try {
            sceneManager.addScene(scene2);
            updateStatus("–í—Ç–æ—Ä–∞—è —Å—Ü–µ–Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞: " + scene2.name);

            // –û–±–Ω–æ–≤–ª—è–µ–º targetSceneId —É —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ö–æ—Ç—Å–ø–æ—Ç–æ–≤
            const hotspots = hotspotManager.getHotspotsForScene(
              sceneManager.currentScene?.id
            );
            hotspots.forEach((h) => {
              if (h.type === "hotspot" && !h.targetSceneId) {
                h.targetSceneId = testSceneId;
                hotspotManager.updateHotspot(h.id, {
                  targetSceneId: testSceneId,
                });
              }
            });
          } catch (error) {
            updateStatus("–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å—Ü–µ–Ω—ã: " + error.message);
          }
        });

        // –¢–µ—Å—Ç–æ–≤—ã–π —ç–∫—Å–ø–æ—Ä—Ç
        document
          .getElementById("export-test")
          .addEventListener("click", async () => {
            try {
              updateStatus("–ù–∞—á–∏–Ω–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π —ç–∫—Å–ø–æ—Ä—Ç...");
              const result = await exportManager.exportProject();
              if (result && result.files) {
                updateStatus(
                  "–≠–∫—Å–ø–æ—Ä—Ç —É—Å–ø–µ—à–µ–Ω! –§–∞–π–ª–æ–≤: " + Object.keys(result.files).length
                );

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç–∫—Å–ø–æ—Ä—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                if (result.files["index.html"]) {
                  const html = result.files["index.html"];
                  const hasNoCursor = html.indexOf("<a-cursor") === -1;
                  const hasHotspots = html.indexOf("hotspot-handler") !== -1;

                  updateStatus(
                    `–≠–∫—Å–ø–æ—Ä—Ç –ø—Ä–æ–≤–µ—Ä–µ–Ω: –±–µ–ª—ã–π –∫—É—Ä—Å–æ—Ä —É–¥–∞–ª–µ–Ω: ${hasNoCursor}, —Ö–æ—Ç—Å–ø–æ—Ç—ã –µ—Å—Ç—å: ${hasHotspots}`
                  );
                }
              } else {
                updateStatus("–≠–∫—Å–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω, –Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–µ –ø–æ–ª—É—á–µ–Ω");
              }
            } catch (error) {
              updateStatus("–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: " + error.message);
            }
          });
      });

      // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –ø–µ—Ä–µ—Ö–æ–¥—ã –º–µ–∂–¥—É —Å—Ü–µ–Ω–∞–º–∏
      window.addEventListener("sceneChanged", (e) => {
        updateStatus(
          "–ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å—Ü–µ–Ω–µ: " +
            e.detail.sceneName +
            " (ID: " +
            e.detail.sceneId +
            ")"
        );

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ü–≤–µ—Ç–∞ –º–∞—Ä–∫–µ—Ä–æ–≤ —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏—Å—å
        setTimeout(() => {
          const markers = document.querySelectorAll('[id^="marker-"]');
          markers.forEach((marker) => {
            const shape = marker.querySelector(
              "a-sphere, a-box, a-cylinder, a-octahedron, a-plane, a-cone, a-circle"
            );
            if (shape) {
              const color = shape.getAttribute("color");
              console.log("üé® –¶–≤–µ—Ç –º–∞—Ä–∫–µ—Ä–∞", marker.id, ":", color);
            }
          });
        }, 1000);
      });

      // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –æ—à–∏–±–∫–∏ JavaScript
      window.addEventListener("error", (e) => {
        console.error("‚ùå JavaScript –æ—à–∏–±–∫–∞:", e.error);
        updateStatus("JavaScript –æ—à–∏–±–∫–∞: " + e.message);
      });
    </script>

    <style>
      #controls {
        position: fixed;
        top: 10px;
        right: 10px;
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 20px;
        border-radius: 8px;
        z-index: 1000;
        max-width: 350px;
      }

      #controls button {
        display: block;
        width: 100%;
        margin: 8px 0;
        padding: 12px;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
      }

      #controls button:hover {
        opacity: 0.8;
      }

      #add-scene {
        background: #28a745;
      }

      #export-test {
        background: #ffc107;
        color: black;
      }

      #status {
        margin-top: 15px;
        font-size: 12px;
        max-height: 300px;
        overflow-y: auto;
        background: rgba(255, 255, 255, 0.1);
        padding: 10px;
        border-radius: 4px;
      }

      #status p {
        margin: 3px 0;
        padding: 2px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }
    </style>
  </body>
</html>
