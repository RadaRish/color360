<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–µ–π - ColoR</title>
    <link rel="stylesheet" href="styles/photo-sphere-viewer.css">
    <link rel="stylesheet" href="style.css">
    <style>
        .test-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 8px;
            min-width: 300px;
            z-index: 1000;
            font-family: 'Segoe UI', sans-serif;
            font-size: 12px;
        }
        
        .test-panel h3 {
            margin: 0 0 10px 0;
            color: #4CAF50;
        }
        
        .test-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .test-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }
        
        .test-btn:hover {
            background: #1976D2;
        }
        
        .test-btn.danger {
            background: #f44336;
        }
        
        .test-btn.danger:hover {
            background: #d32f2f;
        }
        
        .test-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px;
            border-radius: 4px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            font-size: 10px;
        }
        
        .video-url-input {
            width: 100%;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
            margin-bottom: 8px;
        }
        
        .dragging-info {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid #ffc107;
            padding: 8px;
            border-radius: 4px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div id="viewer-container"></div>
    
    <!-- –¢–µ—Å—Ç–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
    <div class="test-panel">
        <h3>üé¨ –¢–µ—Å—Ç –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–µ–π</h3>
        
        <div class="test-buttons">
            <button class="test-btn" onclick="createTestVideoArea()">
                üìπ –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç—å
            </button>
            <button class="test-btn" onclick="testVideoPlayback()">
                ‚ñ∂Ô∏è –¢–µ—Å—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –≤–∏–¥–µ–æ
            </button>
            <button class="test-btn" onclick="testDraggingPrecision()">
                üéØ –¢–µ—Å—Ç —Ç–æ—á–Ω–æ—Å—Ç–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
            </button>
            <button class="test-btn" onclick="listAllVideoElements()">
                üìã –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            </button>
            <button class="test-btn danger" onclick="clearAllVideoAreas()">
                üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏
            </button>
        </div>
        
        <div>
            <label>–¢–µ—Å—Ç–æ–≤—ã–π URL –≤–∏–¥–µ–æ:</label>
            <input type="text" class="video-url-input" id="testVideoUrl" 
                   value="https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4" 
                   placeholder="–í–≤–µ–¥–∏—Ç–µ URL –≤–∏–¥–µ–æ">
        </div>
        
        <div class="dragging-info">
            <strong>üéØ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é:</strong><br>
            1. –°–æ–∑–¥–∞–π—Ç–µ –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç—å –∫–Ω–æ–ø–∫–æ–π –≤—ã—à–µ<br>
            2. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç—å –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç—å –∑–∞ –ø—Ä–µ–¥–µ–ª—ã –µ—ë –≥—Ä–∞–Ω–∏—Ü<br>
            3. –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –ø—É—Å—Ç–æ–µ –º–µ—Å—Ç–æ —Ä—è–¥–æ–º —Å –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç—å—é<br>
            4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –≤–∏–¥–µ–æ –∫–ª–∏–∫–æ–º –ø–æ –æ–±–ª–∞—Å—Ç–∏<br>
            5. –°–ª–µ–¥–∏—Ç–µ –∑–∞ –∫–æ–Ω—Å–æ–ª—å–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
        </div>
        
        <div class="test-info" id="test-info">
            –ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é...
        </div>
    </div>

    <!-- –ó–∞–≥—Ä—É–∂–∞–µ–º A-Frame -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    
    <!-- –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—à–∏ –º–æ–¥—É–ª–∏ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ -->
    <script src="core/hotspot_manager.js"></script>
    <script src="core/coordinate_manager.js"></script>
    <script src="core/viewer_manager.js"></script>
    <script src="core/project_manager.js"></script>
    <script src="core/scene_manager.js"></script>
    <script src="ui/hotspot-editor.js"></script>
    <script src="ui/scene_list.js"></script>
    <!-- modal.js –ø—Ä–æ–ø—É—Å–∫–∞–µ–º, —Ç–∞–∫ –∫–∞–∫ –µ–≥–æ –Ω–µ—Ç -->

    <script>
        let viewerManager, hotspotManager, coordinateManager;
        let testVideoAreaId = 1;
        
        function updateTestInfo(message) {
            const infoDiv = document.getElementById('test-info');
            const timestamp = new Date().toLocaleTimeString();
            infoDiv.innerHTML = `[${timestamp}] ${message}`;
            console.log(`üß™ TEST: ${message}`);
        }

        function createTestVideoArea() {
            if (!hotspotManager) {
                updateTestInfo('‚ùå HotspotManager –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                return;
            }

            const videoUrl = document.getElementById('testVideoUrl').value.trim();
            if (!videoUrl) {
                updateTestInfo('‚ùå –í–≤–µ–¥–∏—Ç–µ URL –≤–∏–¥–µ–æ');
                return;
            }

            const testHotspot = {
                id: `test-video-${testVideoAreaId++}`,
                title: `–¢–µ—Å—Ç–æ–≤–∞—è –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç—å ${testVideoAreaId - 1}`,
                type: 'video-area',
                position: { x: Math.random() * 4 - 2, y: Math.random() * 2 - 1, z: -5 },
                videoUrl: videoUrl,
                videoWidth: 4,
                videoHeight: 3
            };

            console.log('üß™ –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—É—é –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç—å:', testHotspot);
            hotspotManager.addHotspot(testHotspot);
            updateTestInfo(`‚úÖ –°–æ–∑–¥–∞–Ω–∞ –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç—å: ${testHotspot.title}`);
        }

        function testVideoPlayback() {
            const videoAreas = document.querySelectorAll('[data-video-plane]');
            if (videoAreas.length === 0) {
                updateTestInfo('‚ùå –ù–µ—Ç –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–µ–π –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
                return;
            }

            updateTestInfo(`üé¨ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ${videoAreas.length} –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–µ–π...`);
            
            videoAreas.forEach((plane, index) => {
                const marker = plane.closest('[data-hotspot-id]');
                const hotspotId = marker ? marker.getAttribute('data-hotspot-id') : null;
                
                if (hotspotId) {
                    const hotspot = hotspotManager.findHotspotById(hotspotId);
                    const videoEl = document.getElementById(`video-${hotspotId}`);
                    
                    console.log(`üß™ –¢–µ—Å—Ç –≤–∏–¥–µ–æ ${index + 1}:`, {
                        hotspotId,
                        hotspotTitle: hotspot?.title,
                        videoUrl: hotspot?.videoUrl,
                        videoElementExists: !!videoEl,
                        videoSrc: videoEl?.src,
                        videoReadyState: videoEl?.readyState
                    });
                }
            });
        }

        function testDraggingPrecision() {
            updateTestInfo('üéØ –¢–µ—Å—Ç –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è: –∫–ª–∏–∫–Ω–∏—Ç–µ –∏ —Ç–∞—â–∏—Ç–µ —Ä—è–¥–æ–º —Å –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç—å—é');
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            const testHandler = (event) => {
                const rect = viewerManager.container.getBoundingClientRect();
                const x = event.clientX - rect.left;
                const y = event.clientY - rect.top;
                
                console.log('üß™ DRAGGING TEST - –∫–ª–∏–∫ –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º:', { x, y });
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏
                const videoAreas = document.querySelectorAll('[data-hotspot-id]');
                videoAreas.forEach(marker => {
                    const hotspotId = marker.getAttribute('data-hotspot-id');
                    const hotspot = hotspotManager.findHotspotById(hotspotId);
                    
                    if (hotspot && hotspot.type === 'video-area') {
                        const isWithin = viewerManager.isMouseOverVideoArea(event, marker, 
                            hotspot.videoWidth || 4, hotspot.videoHeight || 3);
                        
                        console.log(`üß™ –í–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç—å ${hotspotId}: –∫—É—Ä—Å–æ—Ä ${isWithin ? '–í–ù–£–¢–†–ò' : '–°–ù–ê–†–£–ñ–ò'} –≥—Ä–∞–Ω–∏—Ü`);
                    }
                });
            };

            viewerManager.container.addEventListener('mousedown', testHandler);
            
            setTimeout(() => {
                viewerManager.container.removeEventListener('mousedown', testHandler);
                updateTestInfo('‚úÖ –¢–µ—Å—Ç –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω');
            }, 10000);
        }

        function listAllVideoElements() {
            const allVideos = document.querySelectorAll('video');
            const videoInfo = Array.from(allVideos).map(video => ({
                id: video.id,
                src: video.src,
                readyState: video.readyState,
                paused: video.paused,
                duration: video.duration
            }));
            
            console.log('üß™ –í—Å–µ –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç—ã:', videoInfo);
            updateTestInfo(`üìã –ù–∞–π–¥–µ–Ω–æ ${allVideos.length} –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ (—Å–º. –∫–æ–Ω—Å–æ–ª—å)`);
        }

        function clearAllVideoAreas() {
            const videoAreas = document.querySelectorAll('[data-video-plane]');
            videoAreas.forEach(plane => {
                const marker = plane.closest('[data-hotspot-id]');
                if (marker) {
                    const hotspotId = marker.getAttribute('data-hotspot-id');
                    hotspotManager.removeHotspot(hotspotId);
                }
            });
            
            updateTestInfo(`üóëÔ∏è –£–¥–∞–ª–µ–Ω–æ ${videoAreas.length} –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–µ–π`);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üß™ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–µ–π');
            
            // –°–æ–∑–¥–∞–µ–º –≤—Å–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã
            hotspotManager = new HotspotManager();
            coordinateManager = new CoordinateManager();
            viewerManager = new ViewerManager(document.getElementById('viewer-container'));
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–≤—è–∑–∏ –º–µ–∂–¥—É –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º–∏
            viewerManager.setHotspotManager(hotspotManager);
            viewerManager.setCoordinateManager(coordinateManager);
            coordinateManager.setViewerManager(viewerManager);
            
            hotspotManager.onHotspotAdded = (hotspot) => {
                console.log('üß™ Hotspot –¥–æ–±–∞–≤–ª–µ–Ω:', hotspot);
                viewerManager.createMarker(hotspot);
            };
            
            hotspotManager.onHotspotRemoved = (hotspotId) => {
                console.log('üß™ Hotspot —É–¥–∞–ª–µ–Ω:', hotspotId);
                viewerManager.removeMarker(hotspotId);
            };

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º viewer —Å —Ç–µ—Å—Ç–æ–≤–æ–π –ø–∞–Ω–æ—Ä–∞–º–æ–π
            viewerManager.initializeViewer().then(() => {
                console.log('‚úÖ ViewerManager –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ—Å—Ç–æ–≤—É—é –ø–∞–Ω–æ—Ä–∞–º—É
                viewerManager.setPanorama('panoramas/test_panorama.jpg').then(() => {
                    updateTestInfo('‚úÖ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é');
                }).catch(() => {
                    // –ï—Å–ª–∏ —Ç–µ—Å—Ç–æ–≤–∞—è –ø–∞–Ω–æ—Ä–∞–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ü–≤–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                    viewerManager.aframeSky.setAttribute('color', '#87CEEB');
                    updateTestInfo('‚úÖ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ (—Ç–µ—Å—Ç–æ–≤–∞—è –ø–∞–Ω–æ—Ä–∞–º–∞)');
                });
            }).catch(error => {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
                updateTestInfo('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + error.message);
            });
        });
    </script>
</body>
</html>
