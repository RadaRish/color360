<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–¢–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –º–∞—Ä–∫–µ—Ä–æ–≤</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://unpkg.com/@aframe/environment-component@1.3.0/dist/aframe-environment-component.min.js"></script>
    <link rel="stylesheet" href="styles/photo-sphere-viewer.css" />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div id="container">
      <a-scene id="aframe-scene" embedded style="height: 100vh">
        <a-assets>
          <img id="panorama" src="panoramas/demo.svg" crossorigin="anonymous" />
        </a-assets>

        <a-sky src="#panorama" rotation="0 0 0"></a-sky>
      </a-scene>

      <!-- UI —ç–ª–µ–º–µ–Ω—Ç—ã -->
      <div id="controls">
        <h3>–¢–µ—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –º–∞—Ä–∫–µ—Ä–æ–≤</h3>
        <button id="test-create-marker">–°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –º–∞—Ä–∫–µ—Ä</button>
        <button id="test-create-video">–°–æ–∑–¥–∞—Ç—å –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç—å</button>
        <div id="debug-info"></div>
      </div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –º–æ–¥—É–ª–µ–π -->
    <script type="module" src="core/coordinate_manager.js"></script>
    <script type="module" src="core/hotspot_manager.js"></script>
    <script type="module" src="core/scene_manager.js"></script>
    <script type="module" src="core/viewer_manager.js"></script>
    <script type="module" src="ui/scene_list.js"></script>
    <script type="module" src="ui/hotspot-editor.js"></script>

    <script type="module">
      import ViewerManager from "./core/viewer_manager.js";
      import HotspotManager from "./core/hotspot_manager.js";
      import SceneManager from "./core/scene_manager.js";

      let viewerManager;
      let hotspotManager;
      let sceneManager;

      // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ A-Frame
      document.querySelector("a-scene").addEventListener("loaded", () => {
        console.log("üé¨ A-Frame —Å—Ü–µ–Ω–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞");

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä—ã
        const scene = document.querySelector("a-scene");

        sceneManager = new SceneManager();
        hotspotManager = new HotspotManager();
        viewerManager = new ViewerManager(scene, hotspotManager, sceneManager);

        // –î–µ–ª–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        window.viewerManager = viewerManager;
        window.hotspotManager = hotspotManager;
        window.sceneManager = sceneManager;

        console.log("‚úÖ –í—Å–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã");

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –º–∞—Ä–∫–µ—Ä–∞
        document
          .getElementById("test-create-marker")
          .addEventListener("click", () => {
            console.log("üéØ –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –º–∞—Ä–∫–µ—Ä");

            const testHotspot = {
              id: "test-marker-" + Date.now(),
              type: "info",
              title: "–¢–µ—Å—Ç–æ–≤—ã–π –º–∞—Ä–∫–µ—Ä",
              description: "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π",
              position: { x: 0, y: 0, z: -5 },
            };

            try {
              viewerManager.addHotspot(testHotspot);
              console.log("‚úÖ –¢–µ—Å—Ç–æ–≤—ã–π –º–∞—Ä–∫–µ—Ä —Å–æ–∑–¥–∞–Ω –±–µ–∑ –æ—à–∏–±–æ–∫");
              updateDebugInfo("–¢–µ—Å—Ç–æ–≤—ã–π –º–∞—Ä–∫–µ—Ä —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ");
            } catch (error) {
              console.error("‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞:", error);
              updateDebugInfo("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞: " + error.message);
            }
          });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–∑–¥–∞–Ω–∏—è –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏
        document
          .getElementById("test-create-video")
          .addEventListener("click", () => {
            console.log("üé¨ –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—É—é –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç—å");

            const testVideo = {
              id: "test-video-" + Date.now(),
              type: "video-area",
              title: "–¢–µ—Å—Ç–æ–≤–∞—è –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç—å",
              position: { x: 2, y: 0, z: -5 },
              videoWidth: 4,
              videoHeight: 3,
            };

            try {
              viewerManager.createVideoArea(testVideo);
              console.log("‚úÖ –¢–µ—Å—Ç–æ–≤–∞—è –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç—å —Å–æ–∑–¥–∞–Ω–∞ –±–µ–∑ –æ—à–∏–±–æ–∫");
              updateDebugInfo("–¢–µ—Å—Ç–æ–≤–∞—è –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç—å —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ");
            } catch (error) {
              console.error("‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏:", error);
              updateDebugInfo(
                "–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏: " + error.message
              );
            }
          });
      });

      function updateDebugInfo(message) {
        const debugDiv = document.getElementById("debug-info");
        debugDiv.innerHTML +=
          "<p>" + new Date().toLocaleTimeString() + ": " + message + "</p>";
      }

      // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –æ—à–∏–±–∫–∏ JavaScript
      window.addEventListener("error", (e) => {
        console.error("‚ùå JavaScript –æ—à–∏–±–∫–∞:", e.error);
        updateDebugInfo("JavaScript –æ—à–∏–±–∫–∞: " + e.message);
      });
    </script>

    <style>
      #controls {
        position: fixed;
        top: 10px;
        right: 10px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 15px;
        border-radius: 8px;
        z-index: 1000;
        max-width: 300px;
      }

      #controls button {
        display: block;
        width: 100%;
        margin: 5px 0;
        padding: 8px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      #controls button:hover {
        background: #0056b3;
      }

      #debug-info {
        margin-top: 10px;
        font-size: 12px;
        max-height: 200px;
        overflow-y: auto;
        background: rgba(255, 255, 255, 0.1);
        padding: 8px;
        border-radius: 4px;
      }

      #debug-info p {
        margin: 2px 0;
      }
    </style>
  </body>
</html>
