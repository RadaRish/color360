/**
 * –ú–µ–Ω–µ–¥–∂–µ—Ä —ç–∫—Å–ø–æ—Ä—Ç–∞ –ø–∞–Ω–æ—Ä–∞–º–Ω—ã—Ö —Ç—É—Ä–æ–≤
 * –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –≥–æ—Ç–æ–≤–æ–µ A-Frame –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–∞—à—É —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–Ω—É—é —Å–∏—Å—Ç–µ–º—É —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∫–∏—Ä–∏–ª–ª–∏—Ü—ã –∏ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –∏–∫–æ–Ω–æ–∫
 */
class ExportManager {
    constructor(sceneManager, hotspotManager, projectManager) {
        this.exportData = null;
        this.sceneManager = sceneManager;
        this.hotspotManager = hotspotManager;
        this.projectManager = projectManager;
    }

    /**
     * –£–±–∏—Ä–∞–µ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è
     */
    removeFileExtension(filename) {
        if (!filename || typeof filename !== 'string') {
            return filename;
        }

        // –°–ø–∏—Å–æ–∫ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π –≤–∏–¥–µ–æ –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        const videoExtensions = ['.mp4', '.avi', '.mov', '.webm', '.mkv', '.flv', '.wmv', '.m4v', '.3gp', '.ogv'];
        const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.svg', '.webp', '.tiff', '.ico'];
        const allExtensions = [...videoExtensions, ...imageExtensions];

        const lowerFilename = filename.toLowerCase();

        for (const ext of allExtensions) {
            if (lowerFilename.endsWith(ext)) {
                return filename.slice(0, -ext.length);
            }
        }

        return filename;
    }

    /**
     * –≠–∫—Å–ø–æ—Ä—Ç –ø—Ä–æ–µ–∫—Ç–∞ –≤ –≥–æ—Ç–æ–≤–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
     */
    async exportProject() {
    // start export

        try {
            // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç–∞
            const projectData = this.collectProjectData();

            // –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ñ–∞–π–ª–æ–≤ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞
            const exportPackage = await this.createExportPackage(projectData);

            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏ —Å–∫–∞—á–∏–≤–∞–µ–º ZIP –∞—Ä—Ö–∏–≤
            await this.downloadExportPackage(exportPackage);

            // export done

        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –ø—Ä–æ–µ–∫—Ç–∞: ' + error.message);
        }
    }

    /**
     * –°–æ–±–∏—Ä–∞–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç–∞
     */
    collectProjectData() {
    // collecting project data

        const scenes = this.sceneManager.getAllScenes();
        const projectInfo = this.projectManager.getProjectInfo();

    // scenes count: %d
    // eslint-disable-next-line no-unused-expressions
    scenes.length;
        scenes.forEach((scene, i) => {
            // scene info
        });

        // –û—á–∏—â–∞–µ–º —Ö–æ—Ç—Å–ø–æ—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—Ç –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º —Å—Ü–µ–Ω–∞–º
        const validSceneIds = scenes.map(scene => scene.id);
        const orphanedCount = this.hotspotManager.cleanupOrphanedHotspots(validSceneIds);
        if (orphanedCount > 0) {
            // cleaned orphaned hotspots
        }

        // –ü–æ–ª—É—á–∞–µ–º –í–°–ï —Ö–æ—Ç—Å–ø–æ—Ç—ã –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
        const allHotspots = this.hotspotManager.getHotspots();
    // hotspots count after cleanup
        allHotspots.forEach((hotspot, i) => {
            // hotspot summary
        });

        // –ü–æ–¥–≥–æ—Ç–æ–≤–∏–º –∫–∞—Ä—Ç—É —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è editorId -> exportId (–ø–µ—Ä–≤—ã–π –ø—Ä–æ—Ö–æ–¥)
        const idMap = {};
        scenes.forEach((scene, index) => {
            const exportId = this.generateSceneId(scene.name, index);
            idMap[scene.id] = exportId;
        });

        // –°–æ–±–∏—Ä–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞–∂–¥–æ–π —Å—Ü–µ–Ω–µ (–≤—Ç–æ—Ä–æ–π –ø—Ä–æ—Ö–æ–¥)
        const exportScenes = scenes.map((scene, index) => {
            // process scene
            const hotspots = this.hotspotManager.getHotspotsForScene(scene.id);
            // scene hotspots count

            hotspots.forEach((hotspot, i) => {
                // hotspot processed
            });

            return {
                id: idMap[scene.id],
                name: scene.name,
                panoramaFile: scene.name || `scene_${index}.jpg`,
                panoramaData: scene.src, // URL –∏–ª–∏ Data URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                hotspots: hotspots.map(hotspot => this.convertHotspot(hotspot, idMap)),
                initialView: {
                    yaw: 0,
                    pitch: 0,
                    fov: Math.PI / 3
                }
            };
        });

        return {
            projectTitle: projectInfo.title || '–ü–∞–Ω–æ—Ä–∞–º–Ω—ã–π —Ç—É—Ä',
            scenes: exportScenes,
            settings: {
                autorotate: projectInfo.autorotate || false,
                showSceneList: projectInfo.showSceneList !== false,
                fullscreenButton: projectInfo.fullscreenButton !== false
            }
        };
    }

    /**
     * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω—ã–π ID –¥–ª—è —Å—Ü–µ–Ω—ã
     */
    generateSceneId(sceneName, index) {
        // –£–±–∏—Ä–∞–µ–º –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –∏ —Å–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID
        const cleanName = sceneName
            .replace(/[^a-zA-Z–∞-—è–ê-–Ø0-9]/g, '-')
            .replace(/-+/g, '-')
            .replace(/^-|-$/g, '');

        return `scene-${index}-${cleanName}`;
    }

    /**
     * –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç —Ö–æ—Ç—Å–ø–æ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞
     */
    convertHotspot(hotspot, idMap) {
    // convert hotspot

        const converted = {
            id: hotspot.id,
            position: {
                x: hotspot.position?.x || 0,
                y: hotspot.position?.y || 0,
                z: hotspot.position?.z || 0
            },
            title: hotspot.title ? this.removeFileExtension(hotspot.title) : '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è',
            description: hotspot.description || '',
            type: hotspot.type || 'hotspot',
            targetSceneId: hotspot.targetSceneId || null, // –≤—Ä–µ–º–µ–Ω–Ω–æ, –ø–µ—Ä–µ–ø–∏—à–µ–º –Ω–∏–∂–µ —á–µ—Ä–µ–∑ idMap
            icon: hotspot.icon || (hotspot.type === 'hotspot' ? 'arrow' :
                hotspot.type === 'info-point' ? 'sphere' :
                    hotspot.type === 'video-area' ? 'cube' :
                        hotspot.type === 'animated-object' ? 'cube' : 'sphere'),
            size: hotspot.size || 0.3,
            color: hotspot.color || (hotspot.type === 'info-point' ? '#ffcc00' :
                hotspot.type === 'video-area' ? '#ff6600' :
                    hotspot.type === 'animated-object' ? '#ffffff' : '#00ff00'),
            textColor: hotspot.textColor || '#ffffff',
            textSize: hotspot.textSize || 1.0,
            videoUrl: hotspot.videoUrl || hotspot._originalData?.videoUrl || null,
            videoWidth: hotspot.videoWidth || hotspot._originalData?.videoWidth || null,
            videoHeight: hotspot.videoHeight || hotspot._originalData?.videoHeight || null,
            chromaEnabled: !!hotspot.chromaEnabled,
            chromaColor: hotspot.chromaColor || '#00ff00',
            chromaSimilarity: hotspot.chromaSimilarity ?? 0.4,
            chromaSmoothness: hotspot.chromaSmoothness ?? 0.1,
            chromaThreshold: hotspot.chromaThreshold ?? 0.0,
            customIconData: hotspot.customIconData || null // –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –∏–∫–æ–Ω–æ–∫
        };

        // –ü–µ—Ä–µ–ø–∏—Å—ã–≤–∞–µ–º targetSceneId (editor id -> export id), —á—Ç–æ–±—ã –ø–µ—Ä–µ—Ö–æ–¥—ã —Ä–∞–±–æ—Ç–∞–ª–∏ –≤ —Å–±–æ—Ä–∫–µ
        if (converted.targetSceneId && idMap && idMap[converted.targetSceneId]) {
            converted.targetSceneId = idMap[converted.targetSceneId];
        }

    // converted hotspot position

        return converted;
    }

    /**
     * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç HTML —Ñ–∞–π–ª –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ç—É—Ä–∞
     */
    generateViewerHTML(projectData) {
    // generate viewer html

        return `<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${projectData.projectTitle}</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&subset=cyrillic&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="tour-container">
        <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å–æ —Å—Ü–µ–Ω–∞–º–∏ -->
        <div id="scene-panel" class="open">
            <div class="scene-panel-header">
                <span class="title">${projectData.projectTitle}</span>
                <button id="scene-panel-toggle" title="–°–∫—Ä—ã—Ç—å/–ø–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ —Å—Ü–µ–Ω">‚ü®</button>
            </div>
            <div id="scene-list"></div>
        </div>

        <!-- A-Frame —Å—Ü–µ–Ω–∞ -->
        <a-scene 
            id="tour-scene"
            embedded
            style="height: 100vh; width: 100%;"
            background="color: #000000"
            vr-mode-ui="enabled: false"
            cursor="rayOrigin: mouse">
            
            <!-- –ê–∫—Ç–∏–≤—ã -->
            <a-assets>
                ${projectData.scenes.map(scene =>
            `<img id="${scene.id}-panorama" src="panoramas/${scene.id}.jpg">`
        ).join('\n                ')}
            </a-assets>

            <!-- –ù–µ–±–µ—Å–Ω–∞—è —Å—Ñ–µ—Ä–∞ –¥–ª—è –ø–∞–Ω–æ—Ä–∞–º—ã -->
            <a-sky id="panorama-sky" src="#${projectData.scenes[0]?.id || 'scene-0'}-panorama" rotation="0 0 0"></a-sky>

            <!-- –ö–∞–º–µ—Ä–∞ —Å –æ—Ä–±–∏—Ç–∞–ª—å–Ω—ã–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º -->
            <a-camera 
                id="tour-camera"
                look-controls="pointerLockEnabled: false"
                wasd-controls="enabled: false"
                position="0 1.6 0"
                fov="75"
                raycaster="objects: [data-raycastable]; far: 100; interval: 100">
            </a-camera>

            <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ö–æ—Ç—Å–ø–æ—Ç–æ–≤ -->
            <a-entity id="hotspots-container"></a-entity>
        </a-scene>

        <!-- –≠–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
    <div id="tour-controls">
            <button id="fullscreen-btn">‚õ∂</button>
            <button id="zoom-in-btn">+</button>
            <button id="zoom-out-btn">‚àí</button>
            <button id="reset-view-btn">‚åÇ</button>
            <button id="gyro-btn" title="–ì–∏—Ä–æ—Å–∫–æ–ø">üì±</button>
        </div>
        <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
        <div id="tour-loading" style="display: none">
            <div class="bar"><div class="glow"></div></div>
            <span class="label">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
        </div>
    </div>

    <!-- –î–∞–Ω–Ω—ã–µ —Ç—É—Ä–∞ -->
    <script src="tour-data.js"></script>
    
    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ -->
    <script>
        // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã A-Frame
        ${this.generateAFrameComponents()}

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç—É—Ä–∞
        window.addEventListener('DOMContentLoaded', () => {
            new TourViewer(TOUR_DATA);
        });
    </script>
</body>
</html>`;
    }

    /**
     * –°–æ–∑–¥–∞–µ—Ç –ø–∞–∫–µ—Ç —Ñ–∞–π–ª–æ–≤ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞
     */
    async createExportPackage(projectData) {
    // create export package

        const packageFiles = {};

        // 1. –°–æ–∑–¥–∞–µ–º –±–∞–∑–æ–≤–æ–µ A-Frame –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
        packageFiles['index.html'] = this.generateViewerHTML(projectData);

        // 2. –°–æ–∑–¥–∞–µ–º JavaScript —Ñ–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏ –∏ –ª–æ–≥–∏–∫–æ–π
        packageFiles['tour-data.js'] = this.generateTourDataJS(projectData);

        // 3. –°–æ–∑–¥–∞–µ–º CSS —Å—Ç–∏–ª–∏ 
        packageFiles['style.css'] = this.generateViewerCSS();

        // 4. –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–∞–Ω–æ—Ä–∞–º
        await this.processPanoramaImages(projectData, packageFiles);

        // 5. –î–æ–±–∞–≤–ª—è–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–µ –∏–∫–æ–Ω–∫–∏ —Ö–æ—Ç—Å–ø–æ—Ç–æ–≤
        await this.processCustomIcons(projectData, packageFiles);

        // 6. –°–æ–∑–¥–∞–µ–º README —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏
        packageFiles['README.md'] = this.generateReadme(projectData);

        return packageFiles;
    }

    /**
     * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç A-Frame –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
     */
    generateAFrameComponents() {
        return `
        // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç billboard –¥–ª—è –ø–æ–≤–æ—Ä–æ—Ç–∞ –∫ –∫–∞–º–µ—Ä–µ
        AFRAME.registerComponent('billboard', {
            tick: function () {
                const camera = document.querySelector('[camera]');
                if (camera) {
                    this.el.object3D.lookAt(camera.object3D.position);
                }
            }
        });

        // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç face-camera –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–µ–π
        AFRAME.registerComponent('face-camera', {
            init: function () {
                this.cameraEl = null;
                this.tick = this.tick.bind(this);
                this.findCamera();
            },

            findCamera: function () {
                this.cameraEl = document.querySelector('[camera]') ||
                              document.querySelector('a-camera') ||
                              document.querySelector('#defaultCamera');

                if (!this.cameraEl) {
                    const scene = document.querySelector('a-scene');
                    if (scene && scene.camera && scene.camera.el) {
                        this.cameraEl = scene.camera.el;
                    }
                }
            },

            tick: function () {
                if (!this.cameraEl) {
                    this.findCamera();
                    return;
                }

                const cameraWorldPosition = new THREE.Vector3();
                const elementWorldPosition = new THREE.Vector3();

                this.cameraEl.object3D.getWorldPosition(cameraWorldPosition);
                this.el.object3D.getWorldPosition(elementWorldPosition);

                const direction = new THREE.Vector3();
                direction.subVectors(cameraWorldPosition, elementWorldPosition);
                direction.y = 0;
                direction.normalize();

                if (direction.length() > 0) {
                    const angle = Math.atan2(direction.x, direction.z) + Math.PI;
                    this.el.object3D.rotation.set(0, angle, 0);
                }
            }
        });

        // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –∫–∏—Ä–∏–ª–ª–∏—á–µ—Å–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ (—Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π family/bold/underline)
        AFRAME.registerComponent('cyrillic-text', {
            schema: {
                value: { type: 'string', default: '' },
                color: { type: 'color', default: '#ffffff' },
                align: { type: 'string', default: 'center' },
                family: { type: 'string', default: 'Arial, sans-serif' },
                bold: { type: 'boolean', default: false },
                underline: { type: 'boolean', default: false }
            },
            init: function () { this.createTextTexture(); },
            update: function () { this.createTextTexture(); },
            createTextTexture: function () {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const data = this.data;
                const value = data.value;
                const color = data.color;
                const align = data.align;
                const family = data.family;
                const bold = data.bold;
                const underline = data.underline;
                canvas.width = 1024; canvas.height = 256;
                ctx.clearRect(0,0,canvas.width,canvas.height);
                const fontSize = 48; // –±–∞–∑–æ–≤—ã–π, –º–∞—Å—à—Ç–∞–± –∑–∞–¥–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ entity.setAttribute('scale')
                ctx.font = (bold ? 'bold ' : '') + fontSize + 'px ' + family;
                ctx.fillStyle = color;
                ctx.textAlign = align;
                ctx.textBaseline = 'middle';
                const x = align === 'center' ? canvas.width/2 : (align === 'right' ? canvas.width-20 : 20);
                ctx.fillText(value || '', x, canvas.height/2);
                if (underline) {
                    const metrics = ctx.measureText(value || '');
                    const textWidth = metrics.width;
                    const startX = x - (align === 'center' ? textWidth/2 : (align === 'right' ? textWidth : 0));
                    ctx.fillRect(startX, canvas.height/2 + fontSize*0.45, textWidth, 4);
                }
                const texture = new THREE.CanvasTexture(canvas); texture.needsUpdate = true;
                const material = new THREE.MeshBasicMaterial({ map: texture, transparent: true, alphaTest: 0.1 });
                const geometry = new THREE.PlaneGeometry(2, 0.5);
                const mesh = new THREE.Mesh(geometry, material);
                this.el.setObject3D('mesh', mesh);
            }
        });

        // –®–µ–π–¥–µ—Ä chroma-key –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Ñ–æ–Ω–∞ –ø–æ –∫–ª—é—á–µ–≤–æ–º—É —Ü–≤–µ—Ç—É
        if (!AFRAME.shaders || !AFRAME.shaders['chroma-key']) {
            AFRAME.registerShader('chroma-key', {
                schema: {
                    src: { type: 'map' },
                    color: { type: 'color', default: '#00ff00' },
                    similarity: { type: 'number', default: 0.4 },
                    smoothness: { type: 'number', default: 0.1 },
                    threshold: { type: 'number', default: 0.0 }
                },
                init: function (data) {
                    this.material = new THREE.ShaderMaterial({
                        uniforms: {
                            map: { value: null },
                            keyColor: { value: new THREE.Color(data.color) },
                            similarity: { value: data.similarity },
                            smoothness: { value: data.smoothness },
                            threshold: { value: data.threshold }
                        },
                        transparent: true,
                        depthWrite: false,
                        side: THREE.DoubleSide,
                        vertexShader: 'varying vec2 vUV; void main(){ vUV = uv; gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0); }',
                        fragmentShader: 'uniform sampler2D map; uniform vec3 keyColor; uniform float similarity; uniform float smoothness; uniform float threshold; varying vec2 vUV;\n'
                            + 'void main(){ vec4 color = texture2D(map, vUV);\n'
                            + '  float kr = 0.299, kg = 0.587, kb = 0.114; float r = color.r, g = color.g, b = color.b;\n'
                            + '  float y = kr * r + kg * g + kb * b; float cr = (r - y) * 0.713 + 0.5; float cb = (b - y) * 0.564 + 0.5;\n'
                            + '  float rK = keyColor.r, gK = keyColor.g, bK = keyColor.b; float yK = kr * rK + kg * gK + kb * bK; float crK = (rK - yK) * 0.713 + 0.5; float cbK = (bK - yK) * 0.564 + 0.5;\n'
                            + '  float d = distance(vec2(cb, cr), vec2(cbK, crK)); float a = smoothstep(similarity, similarity + smoothness, d);\n'
                            + '  a = clamp((a - threshold) / (1.0 - threshold + 1e-6), 0.0, 1.0);\n'
                            + '  gl_FragColor = vec4(color.rgb, a * color.a);\n'
                            + '}'
                    });
                },
                update: function (data) {
                    if (data.src && data.src.image) { this.material.uniforms.map.value = data.src.image; this.material.needsUpdate = true; }
                    if (data.color) this.material.uniforms.keyColor.value.set(data.color);
                    if (typeof data.similarity === 'number') this.material.uniforms.similarity.value = data.similarity;
                    if (typeof data.smoothness === 'number') this.material.uniforms.smoothness.value = data.smoothness;
                    if (typeof data.threshold === 'number') this.material.uniforms.threshold.value = data.threshold;
                }
            });
        }

        // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ö–æ—Ç—Å–ø–æ—Ç–æ–≤
        AFRAME.registerComponent('hotspot-handler', {
            schema: {
                hotspotId: { type: 'string' },
                type: { type: 'string', default: 'info' },
                linkTo: { type: 'string' },
                title: { type: 'string' },
                description: { type: 'string' },
                videoUrl: { type: 'string' }
            },
            init: function() {
                this.el.addEventListener('click', this.onClick.bind(this));
                this.el.addEventListener('mouseenter', this.onMouseEnter.bind(this));
                this.el.addEventListener('mouseleave', this.onMouseLeave.bind(this));
                
                // –î–æ–±–∞–≤–ª—è–µ–º data-raycastable –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã raycaster
                this.el.setAttribute('data-raycastable', '');
            },
            onClick: function() {
                // hotspot click
                // Info-point: –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç, –ù–ï –Ω–∞–≤–∏–≥–∏—Ä—É–µ–º
                if (this.data.type === 'info-point' || this.data.type === 'infopoint') {
                    this.showInfoModal();
                    return;
                }
                // –í–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç—å: –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –í–ù–£–¢–†–ò –ø–ª–æ—Å–∫–æ—Å—Ç–∏
                if (this.data.type === 'video-area') {
                    const markerEl = this.el.parentElement;
                    if (!markerEl) return;
                    let videoEl = document.getElementById('video-' + this.data.hotspotId);
                    const plane = markerEl.querySelector('a-plane');
                    if (!videoEl) {
                        videoEl = document.createElement('video');
                        videoEl.id = 'video-' + this.data.hotspotId;
                        videoEl.crossOrigin = 'anonymous';
                        videoEl.loop = true;
                        videoEl.playsInline = true;
                        videoEl.muted = true; // –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ –±–µ–∑ –∑–≤—É–∫–∞
                        videoEl.style.display = 'none';
                        const assets = document.querySelector('a-assets') || (()=>{ const a=document.createElement('a-assets'); document.querySelector('a-scene').appendChild(a); return a; })();
                        assets.appendChild(videoEl);
                        if (this.data.videoUrl) {
                            videoEl.src = this.data.videoUrl;
                        }
                    }
                    if (plane) {
                        plane.setAttribute('material', { src: '#' + videoEl.id, transparent: false, side: 'double' });
                    }
                    // toggle
                    if (videoEl.paused) {
                        videoEl.play().catch(()=>{});
                    } else {
                        videoEl.pause();
                    }
                    return;
                }
                // –ü–µ—Ä–µ—Ö–æ–¥ –∫ –¥—Ä—É–≥–æ–π —Å—Ü–µ–Ω–µ —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ö–æ—Ç—Å–ø–æ—Ç–æ–≤
                if (this.data.linkTo && this.data.linkTo !== '' && this.data.linkTo !== 'undefined' && this.data.linkTo !== 'null') {
                    // go to scene
                    window.tourViewer.switchToScene(this.data.linkTo);
                    return;
                }
                // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî –∏–Ω—Ñ–æ
                this.showInfoModal();
            },
            showInfoModal: function() {
                // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π —Ñ–∞–π–ª–æ–≤
                const removeFileExtension = (filename) => {
                    if (!filename || typeof filename !== 'string') {
                        return filename;
                    }
                    const videoExtensions = ['.mp4', '.avi', '.mov', '.webm', '.mkv', '.flv', '.wmv', '.m4v', '.3gp', '.ogv'];
                    const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.svg', '.webp', '.tiff', '.ico'];
                    const allExtensions = [...videoExtensions, ...imageExtensions];
                    const lowerFilename = filename.toLowerCase();
                    for (const ext of allExtensions) {
                        if (lowerFilename.endsWith(ext)) {
                            return filename.slice(0, -ext.length);
                        }
                    }
                    return filename;
                };

                // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
                const modal = document.createElement('div');
                modal.style.cssText = 
                    'position: fixed;' +
                    'top: 0;' +
                    'left: 0;' +
                    'width: 100%;' +
                    'height: 100%;' +
                    'background: rgba(0, 0, 0, 0.8);' +
                    'z-index: 10000;' +
                    'display: flex;' +
                    'align-items: center;' +
                    'justify-content: center;';
                
                const content = document.createElement('div');
                content.style.cssText = 
                    'background: #2a2a2a;' +
                    'padding: 30px;' +
                    'border-radius: 10px;' +
                    'max-width: 500px;' +
                    'color: white;' +
                    'font-family: Roboto, Arial, sans-serif;';
                
                content.innerHTML = 
                    '<h3 style="margin: 0 0 15px 0; color: #ffcc00;">' + (this.data.title ? removeFileExtension(this.data.title) : '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è') + '</h3>' +
                    '<p style="margin: 0 0 20px 0; line-height: 1.5;">' + (this.data.description || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç') + '</p>' +
                    '<button style="background: #ffcc00; color: black; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">–ó–∞–∫—Ä—ã—Ç—å</button>';
                
                modal.appendChild(content);
                document.body.appendChild(modal);
                
                // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
                const closeBtn = content.querySelector('button');
                const closeModal = () => {
                    document.body.removeChild(modal);
                };
                
                closeBtn.addEventListener('click', closeModal);
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) closeModal();
                });
            },
            // –£–¥–∞–ª–µ–Ω showVideoModal: –≤–∏–¥–µ–æ —Ç–µ–ø–µ—Ä—å –∏–≥—Ä–∞–µ—Ç –≤ –ø–ª–æ—Å–∫–æ—Å—Ç–∏
            onMouseEnter: function(evt) {
                const textEl = this.el.querySelector('[cyrillic-text]');
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º 3D-–ª–µ–π–±–ª –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ (info-point, hotspot, video-area)
                if (textEl) {
                    textEl.setAttribute('visible', true);
                }
                this.el.setAttribute('scale', '1.2 1.2 1.2');
                // 2D –ø–æ–¥—Å–∫–∞–∑–∫–∞ –¢–û–õ–¨–ö–û –¥–ª—è –∏–Ω—Ñ–æ—Ç–æ—á–µ–∫: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ù–∞–∑–≤–∞–Ω–∏–µ + –û–ø–∏—Å–∞–Ω–∏–µ
                if ((this.data.type === 'info-point' || this.data.type === 'infopoint') && (this.data.title || this.data.description)) {
                    const tip = document.createElement('div');
                    tip.className = 'tour-tooltip';
                    const title = removeFileExtension(this.data.title || '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è');
                    const desc = this.data.description ? '<div class="desc">' + this.data.description + '</div>' : '';
                    tip.innerHTML = '<div class="title">' + title + '</div>' + desc;
                    document.body.appendChild(tip);
                    const move = (e) => { tip.style.left = (e.clientX + 12) + 'px'; tip.style.top = (e.clientY + 12) + 'px'; };
                    window.addEventListener('mousemove', move);
                    this._tooltipEl = tip; this._tooltipMove = move;
                }
            },
            onMouseLeave: function() {
                const textEl = this.el.querySelector('[cyrillic-text]');
                if (textEl) textEl.setAttribute('visible', false);
                this.el.setAttribute('scale', '1 1 1');
                if (this._tooltipEl) {
                    window.removeEventListener('mousemove', this._tooltipMove);
                    document.body.removeChild(this._tooltipEl);
                    this._tooltipEl = null; this._tooltipMove = null;
                }
            }
        });
        `;
    }

    /**
     * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ñ–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏ —Ç—É—Ä–∞ –∏ –ª–æ–≥–∏–∫–æ–π –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
     */
    generateTourDataJS(projectData) {
    // generate tour-data.js

        return `// –î–∞–Ω–Ω—ã–µ –ø–∞–Ω–æ—Ä–∞–º–Ω–æ–≥–æ —Ç—É—Ä–∞
const TOUR_DATA = ${JSON.stringify(projectData, null, 2)};

// –•–µ–ª–ø–µ—Ä: —É–¥–∞–ª—è–µ—Ç –∏–∑–≤–µ—Å—Ç–Ω—ã–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ –∏–∑ —Å—Ç—Ä–æ–∫–∏
function removeFileExtension(filename) {
    if (!filename || typeof filename !== 'string') return filename;
    const videoExtensions = ['.mp4', '.avi', '.mov', '.webm', '.mkv', '.flv', '.wmv', '.m4v', '.3gp', '.ogv'];
    const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.svg', '.webp', '.tiff', '.ico'];
    const allExtensions = [...videoExtensions, ...imageExtensions];
    const lower = filename.toLowerCase();
    for (const ext of allExtensions) {
        if (lower.endsWith(ext)) return filename.slice(0, -ext.length);
    }
    return filename;
}

// –û—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å –ø—Ä–æ—Å–º–æ—Ç—Ä—â–∏–∫–∞ —Ç—É—Ä–∞
class TourViewer {
    constructor(tourData) {
        this.tourData = tourData;
        this.currentSceneId = tourData.scenes[0]?.id || null;
        this.scene = document.querySelector('#tour-scene');
        this.panoramaSky = document.querySelector('#panorama-sky');
        this.hotspotsContainer = document.querySelector('#hotspots-container');
    this.sceneList = document.querySelector('#scene-list');
    this.scenePanel = document.querySelector('#scene-panel');
    this.loadingBox = document.querySelector('#tour-loading');

    // –ê–≤—Ç–æ—Ä–æ—Ç–∞—Ü–∏—è
    this.autorotateEnabled = !!(tourData.settings && tourData.settings.autorotate);
    this.autorotateSpeed = 0.02; // —Ä–∞–¥/—Å–µ–∫
    this.autorotateIdleDelay = 3000; // –º—Å
    this._autorotatePaused = false;
    this._autorotateLastTs = 0;
    this._lastUserInteraction = Date.now();
    this._autorotateRaf = null;
    // –ì–∏—Ä–æ—Å–∫–æ–ø –∏ pinch
    this.gyroEnabled = false;
    this._pinch = { active: false, startDist: 0, startFov: 75 };
        
        this.init();
        window.tourViewer = this; // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –¥–æ—Å—Ç—É–ø
    }

    init() {
        this.setupEventListeners();
        this.loadScene(this.currentSceneId);
    }

    setupEventListeners() {
        // –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Å—Ü–µ–Ω –∏ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –ø–∞–Ω–µ–ª–∏
        this.renderSceneList();
        const toggleBtn = document.getElementById('scene-panel-toggle');
        if (toggleBtn) {
            toggleBtn.addEventListener('click', () => {
                this.scenePanel.classList.toggle('open');
                toggleBtn.textContent = this.scenePanel.classList.contains('open') ? '‚ü®' : '‚ü©';
            });
        }

        // –≠–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        document.getElementById('fullscreen-btn').addEventListener('click', () => {
            this.toggleFullscreen();
        });

        document.getElementById('zoom-in-btn').addEventListener('click', () => {
            this.zoomIn();
        });

        document.getElementById('zoom-out-btn').addEventListener('click', () => {
            this.zoomOut();
        });

        document.getElementById('reset-view-btn').addEventListener('click', () => {
            this.resetView();
        });

        const gyroBtn = document.getElementById('gyro-btn');
        if (gyroBtn) {
            gyroBtn.addEventListener('click', async () => {
                this.enableGyro(!this.gyroEnabled);
                gyroBtn.classList.toggle('active', this.gyroEnabled);
            });
        }

        // –ì–æ—Ä—è—á–∞—è –∫–ª–∞–≤–∏—à–∞: R ‚Äî –≤–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ—Ä–æ—Ç–∞—Ü–∏—é
        window.addEventListener('keydown', (e) => {
            if ((e.key || '').toLowerCase() === 'r') {
                this.enableAutorotate(!this.autorotateEnabled);
            }
        });

        this._setupAutorotateUserInteractivity();

        // Pinch-to-zoom
        const sceneEl = this.scene;
        if (sceneEl) {
            sceneEl.addEventListener('touchstart', (e) => {
                if (e.touches && e.touches.length === 2) {
                    this._pinch.active = true;
                    const dx = e.touches[0].clientX - e.touches[1].clientX;
                    const dy = e.touches[0].clientY - e.touches[1].clientY;
                    this._pinch.startDist = Math.hypot(dx, dy);
                    const cam = document.querySelector('#tour-camera');
                    this._pinch.startFov = parseFloat(cam?.getAttribute('fov')) || 75;
                }
            }, { passive: false });
            sceneEl.addEventListener('touchmove', (e) => {
                if (this._pinch.active && e.touches && e.touches.length === 2) {
                    e.preventDefault();
                    const dx = e.touches[0].clientX - e.touches[1].clientX;
                    const dy = e.touches[0].clientY - e.touches[1].clientY;
                    const dist = Math.hypot(dx, dy);
                    if (this._pinch.startDist > 0) {
                        const scale = this._pinch.startDist / dist;
                        let newFov = this._pinch.startFov * scale;
                        newFov = Math.max(30, Math.min(120, newFov));
                        const cam = document.querySelector('#tour-camera');
                        cam.setAttribute('fov', newFov);
                    }
                }
            }, { passive: false });
            const endPinch = () => { this._pinch.active = false; };
            sceneEl.addEventListener('touchend', endPinch, { passive: true });
            sceneEl.addEventListener('touchcancel', endPinch, { passive: true });
        }
    }

    switchToScene(sceneId) {
    // switch to scene
        this.currentSceneId = sceneId;
        this.loadScene(sceneId);
    this.markActiveScene(sceneId);
    }

    loadScene(sceneId) {
    // load scene
        const scene = this.tourData.scenes.find(s => s.id === sceneId);
        if (!scene) {
            console.error('‚ùå –°—Ü–µ–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞:', sceneId);
            return;
        }

    // scene data
        scene.hotspots.forEach(function(hotspot, i){
            console.log('  üéØ –•–æ—Ç—Å–ø–æ—Ç ' + (i+1) + ': "' + hotspot.title + '" —Ç–∏–ø: ' + hotspot.type + ' –ø–µ—Ä–µ—Ö–æ–¥: ' + hotspot.targetSceneId);
        });

        // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –ø–∞–Ω–æ—Ä–∞–º—ã
        this.showLoading('–ó–∞–≥—Ä—É–∑–∫–∞ –ø–∞–Ω–æ—Ä–∞–º—ã...');
        var self = this;
        var hideTimeout = setTimeout(function(){ self.hideLoading(); }, 10000);
        var onLoaded = function() {
            clearTimeout(hideTimeout);
            self.hideLoading();
            if (self.panoramaSky) {
                self.panoramaSky.removeEventListener('materialtextureloaded', onLoaded);
            }
        };
        if (this.panoramaSky) {
            this.panoramaSky.addEventListener('materialtextureloaded', onLoaded);
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞–Ω–æ—Ä–∞–º—É
        const panoramaElement = document.querySelector('#' + sceneId + '-panorama');
        if (panoramaElement) {
            this.panoramaSky.setAttribute('src', '#' + sceneId + '-panorama');
            console.log('‚úÖ –ü–∞–Ω–æ—Ä–∞–º–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞:', sceneId);
        } else {
            console.error('‚ùå –≠–ª–µ–º–µ–Ω—Ç –ø–∞–Ω–æ—Ä–∞–º—ã –Ω–µ –Ω–∞–π–¥–µ–Ω:', sceneId + '-panorama');
        }

        // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Ö–æ—Ç—Å–ø–æ—Ç—ã
        while (this.hotspotsContainer.firstChild) {
            this.hotspotsContainer.removeChild(this.hotspotsContainer.firstChild);
        }
        console.log('üßπ –°—Ç–∞—Ä—ã–µ —Ö–æ—Ç—Å–ø–æ—Ç—ã –æ—á–∏—â–µ–Ω—ã');

        // –î–æ–±–∞–≤–ª—è–µ–º —Ö–æ—Ç—Å–ø–æ—Ç—ã
        console.log('üéØ –°–æ–∑–¥–∞–µ–º', scene.hotspots.length, '—Ö–æ—Ç—Å–ø–æ—Ç–æ–≤...');
        scene.hotspots.forEach((hotspot, i) => {
            console.log('üîß –°–æ–∑–¥–∞–µ–º —Ö–æ—Ç—Å–ø–æ—Ç ' + (i + 1) + '/' + scene.hotspots.length + ':', hotspot.title);
            this.createHotspot(hotspot);
        });
        
        console.log('‚úÖ –°—Ü–µ–Ω–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞:', scene.name);
        this.hideLoading();
}

    renderSceneList() {
        if (!this.sceneList) return;
        this.sceneList.innerHTML = '';
        this.tourData.scenes.forEach(scene => {
            const item = document.createElement('div');
            item.className = 'scene-item';
            item.dataset.sceneId = scene.id;
            item.textContent = removeFileExtension(scene.name);
            item.addEventListener('click', () => this.switchToScene(scene.id));
            this.sceneList.appendChild(item);
        });
        this.markActiveScene(this.currentSceneId);
    }

    markActiveScene(sceneId) {
        if (!this.sceneList) return;
        Array.from(this.sceneList.children).forEach(el => {
            el.classList.toggle('active', el.dataset.sceneId === sceneId);
        });
    }

    createHotspot(hotspot) {
        console.log('üéØ –°–æ–∑–¥–∞–µ–º —Ö–æ—Ç—Å–ø–æ—Ç:', hotspot.title, '–ø–æ–∑–∏—Ü–∏—è:', hotspot.position);

        // –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ö–æ—Ç—Å–ø–æ—Ç–∞
        const hotspotEl = document.createElement('a-entity');
        hotspotEl.setAttribute('id', 'hotspot-' + hotspot.id);
        hotspotEl.setAttribute('position',
            hotspot.position.x + ' ' + hotspot.position.y + ' ' + hotspot.position.z);
        hotspotEl.setAttribute('hotspot-handler', {
            hotspotId: hotspot.id,
            type: hotspot.type,
            linkTo: hotspot.targetSceneId,
            title: hotspot.title,
            description: hotspot.description,
            videoUrl: hotspot.videoUrl || ''
        });

        // –í–∏–∑—É–∞–ª—å–Ω–∞—è —Ñ–æ—Ä–º–∞ —Ö–æ—Ç—Å–ø–æ—Ç–∞
    let shape;
    const size = parseFloat(hotspot.size) || 0.3; // –í —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ —Ä–∞–¥–∏—É—Å = size
        
        if (hotspot.type === 'video-area') {
            // –í–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç—å - –ø–ª–æ—Å–∫–æ—Å—Ç—å —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ —Ä–∞–∑–º–µ—Ä–∞–º–∏
            shape = document.createElement('a-plane');
            const width = parseFloat(hotspot.videoWidth) || 4;
            const height = parseFloat(hotspot.videoHeight) || 3;
            shape.setAttribute('width', width);
            shape.setAttribute('height', height);
            shape.setAttribute('color', hotspot.color || '#666666');
            shape.setAttribute('material', 'transparent: false; side: double');
            
            // –î–æ–±–∞–≤–ª—è–µ–º face-camera –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏
            hotspotEl.setAttribute('face-camera', '');
        } else if (hotspot.type === 'animated-object') {
            // –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç ‚Äî –≤–∏–¥–µ–æ-–ø–ª–æ—Å–∫–æ—Å—Ç—å —Å –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º —Ö—Ä–æ–º–∞–∫–µ–µ–º
            shape = document.createElement('a-plane');
            const width = parseFloat(hotspot.videoWidth) || 2;
            const height = parseFloat(hotspot.videoHeight) || (2 * 9/16);
            shape.setAttribute('width', width);
            shape.setAttribute('height', height);
            hotspotEl.setAttribute('face-camera', '');

            // –ü–æ–¥–≥–æ—Ç–æ–≤–∏–º video element
            let videoEl = document.getElementById('video-' + hotspot.id);
            if (!videoEl) {
                videoEl = document.createElement('video');
                videoEl.id = 'video-' + hotspot.id;
                videoEl.crossOrigin = 'anonymous';
                videoEl.loop = true;
                videoEl.playsInline = true;
                videoEl.muted = true;
                videoEl.style.display = 'none';
                const assets = document.querySelector('a-assets') || (()=>{ const a=document.createElement('a-assets'); document.querySelector('a-scene').appendChild(a); return a; })();
                assets.appendChild(videoEl);
                if (hotspot.videoUrl) videoEl.src = hotspot.videoUrl;
            }

            // –ú–∞—Ç–µ—Ä–∏–∞–ª: chroma-key –∏–ª–∏ flat
            if (hotspot.chromaEnabled) {
                shape.setAttribute('material', {
                    shader: 'chroma-key',
                    src: '#video-' + hotspot.id,
                    color: hotspot.chromaColor || '#00ff00',
                    similarity: hotspot.chromaSimilarity ?? 0.4,
                    smoothness: hotspot.chromaSmoothness ?? 0.1,
                    threshold: hotspot.chromaThreshold ?? 0.0,
                    side: 'double'
                });
            } else {
                shape.setAttribute('material', { shader: 'flat', src: '#video-' + hotspot.id, side: 'double' });
            }

            // Toggle –ø–æ –∫–ª–∏–∫—É
            shape.addEventListener('click', () => {
                if (videoEl.paused) videoEl.play().catch(()=>{}); else videoEl.pause();
            });
        } else if (hotspot.icon === 'arrow') {
            // –°—Ç—Ä–µ–ª–∫–∞ –∏–∑ —Å–ø–ª—é—Å–Ω—É—Ç–æ–≥–æ –∫–æ–Ω—É—Å–∞
            shape = document.createElement('a-cone');
            shape.setAttribute('height', size * 1.5);
            shape.setAttribute('radius-bottom', size * 0.8);
            shape.setAttribute('radius-top', 0);
            shape.setAttribute('rotation', '0 0 0');
            shape.setAttribute('color', hotspot.color || '#ff0000');
        } else if (hotspot.icon === 'sphere' || hotspot.type === 'info-point' || hotspot.type === 'infopoint') {
            // –°—Ñ–µ—Ä–∏—á–µ—Å–∫–∏–π –º–∞—Ä–∫–µ—Ä
            shape = document.createElement('a-sphere');
            shape.setAttribute('radius', size);
            shape.setAttribute('color', hotspot.color || '#0099ff');
        } else {
            // –ü–ª–æ—Å–∫–∏–π –∫—Ä—É–≥–ª—ã–π –º–∞—Ä–∫–µ—Ä –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            shape = document.createElement('a-circle');
            shape.setAttribute('radius', size);
            shape.setAttribute('color', hotspot.color || '#ff0000');
        }

        shape.setAttribute('opacity', '0.8');
        shape.setAttribute('data-raycastable', '');
        hotspotEl.appendChild(shape);

        // –ö–∞—Å—Ç–æ–º–Ω–∞—è –∏–∫–æ–Ω–∫–∞ –µ—Å–ª–∏ –µ—Å—Ç—å
        if (hotspot.customIconData) {
            const icon = document.createElement('a-image');
            icon.setAttribute('src', 'icons/' + hotspot.id + '-icon.png');
            icon.setAttribute('width', size * 2);
            icon.setAttribute('height', size * 2);
            icon.setAttribute('position', '0 0 0.01');
            icon.setAttribute('data-raycastable', '');
            hotspotEl.appendChild(icon);
        }

        // –¢–µ–∫—Å—Ç (–Ω–∞–∑–≤–∞–Ω–∏–µ)
        if (hotspot.title) {
            const textContainer = document.createElement('a-entity');
            textContainer.setAttribute('position', '0 ' + (size + 0.1) + ' 0');
            textContainer.setAttribute('billboard', '');

            const text = document.createElement('a-entity');
            const textSize = parseFloat(hotspot.textSize) || 1.0;
            text.setAttribute('cyrillic-text', {
                value: removeFileExtension(hotspot.title),
                color: hotspot.textColor || '#ffffff',
                align: 'center',
                family: hotspot.textFamily || 'Arial, sans-serif',
                bold: !!hotspot.textBold,
                underline: !!hotspot.textUnderline
            });
            if (textSize && textSize !== 1) {
                text.setAttribute('scale', textSize + ' ' + textSize + ' ' + textSize);
            }
            text.setAttribute('visible', false);
            text.setAttribute('position', '0 0 0.02');

            textContainer.appendChild(text);
            hotspotEl.appendChild(textContainer);
        }

        console.log('‚úÖ –•–æ—Ç—Å–ø–æ—Ç —Å–æ–∑–¥–∞–Ω:', hotspot.title);
    this.hotspotsContainer.appendChild(hotspotEl);
    }

toggleFullscreen() {
    if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
    } else {
        document.exitFullscreen();
    }
}

zoomIn() {
    const camera = document.querySelector('#tour-camera');
    const currentFov = camera.getAttribute('fov');
    const newFov = Math.max(30, currentFov - 10);
    camera.setAttribute('fov', newFov);
}

zoomOut() {
    const camera = document.querySelector('#tour-camera');
    const currentFov = camera.getAttribute('fov');
    const newFov = Math.min(120, currentFov + 10);
    camera.setAttribute('fov', newFov);
}

resetView() {
    const camera = document.querySelector('#tour-camera');
    camera.setAttribute('fov', 75);
    camera.setAttribute('rotation', '0 0 0');
}
// === –ì–∏—Ä–æ—Å–∫–æ–ø ===
async enableGyro(enabled) {
    this.gyroEnabled = !!enabled;
    const cam = document.querySelector('#tour-camera');
    if (!cam) return;
    const current = cam.getAttribute('look-controls') || {};
    if (this.gyroEnabled) {
        try { await this.requestGyroPermission(); } catch {}
        cam.setAttribute('look-controls', { ...current, magicWindowTrackingEnabled: true, pointerLockEnabled: false });
    } else {
        cam.setAttribute('look-controls', { ...current, magicWindowTrackingEnabled: false });
    }
}

async requestGyroPermission() {
    const w = window;
    if (typeof w.DeviceOrientationEvent !== 'undefined' && typeof w.DeviceOrientationEvent.requestPermission === 'function') {
        try { const res = await w.DeviceOrientationEvent.requestPermission(); return res === 'granted'; } catch { return false; }
    }
    return true;
}
// ===== –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä =====
showLoading(label) {
    if (!this.loadingBox) return;
    var labelEl = this.loadingBox.querySelector('.label');
    if (labelEl) labelEl.textContent = label || '–ó–∞–≥—Ä—É–∑–∫–∞...';
    var glow = this.loadingBox.querySelector('.glow');
    if (glow) { glow.style.width = '5%'; setTimeout(function(){ glow.style.width = '80%'; }, 50); }
    this.loadingBox.style.display = 'flex';
}

hideLoading() {
    if (!this.loadingBox) return;
    this.loadingBox.style.display = 'none';
}

// ===== –ê–≤—Ç–æ—Ä–æ—Ç–∞—Ü–∏—è =====
enableAutorotate(enabled, speed, idleDelay) {
    this.autorotateEnabled = !!enabled;
    if (typeof speed === 'number') this.autorotateSpeed = speed;
    if (typeof idleDelay === 'number') this.autorotateIdleDelay = idleDelay;
    if (this.autorotateEnabled) this._startAutorotateLoop(); else this._stopAutorotateLoop();
}

_setupAutorotateUserInteractivity() {
    var self = this;
    var onInteract = function(){ self._lastUserInteraction = Date.now(); self._autorotatePaused = true; };
    var sceneEl = document.querySelector('a-scene');
    var canvas = sceneEl ? sceneEl.querySelector('canvas') : null;
    var target = canvas || window;
    ['mousedown','wheel','touchstart','keydown'].forEach(function(evt){ target.addEventListener(evt, onInteract, { passive: true }); });
}

_startAutorotateLoop() {
    if (this._autorotateRaf) return;
    this._autorotatePaused = false;
    this._autorotateLastTs = performance.now();
    var self = this;
    var loop = function(ts){
        if (!self.autorotateEnabled) { self._autorotateRaf = null; return; }
        var dt = Math.max(0, (ts - self._autorotateLastTs) / 1000);
        self._autorotateLastTs = ts;
        if (self._autorotatePaused) {
            if (Date.now() - self._lastUserInteraction >= self.autorotateIdleDelay) self._autorotatePaused = false;
        }
        var camera = document.querySelector('#tour-camera');
        if (!self._autorotatePaused && camera) {
            var rot = camera.getAttribute('rotation') || { x: 0, y: 0, z: 0 };
            var newY = rot.y + (self.autorotateSpeed * (180 / Math.PI)) * dt;
            camera.setAttribute('rotation', rot.x + ' ' + newY + ' ' + rot.z);
        }
        self._autorotateRaf = requestAnimationFrame(loop);
    };
    this._autorotateRaf = requestAnimationFrame(loop);
}

_stopAutorotateLoop() {
    if (this._autorotateRaf) {
        cancelAnimationFrame(this._autorotateRaf);
        this._autorotateRaf = null;
    }
}
}`;
    }

    /**
     * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç CSS —Å—Ç–∏–ª–∏ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä—â–∏–∫–∞
     */
    generateViewerCSS() {
        return `/* –°—Ç–∏–ª–∏ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä—â–∏–∫–∞ –ø–∞–Ω–æ—Ä–∞–º–Ω–æ–≥–æ —Ç—É—Ä–∞ */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Roboto', Arial, sans-serif;
    background: #000;
    color: #fff;
    overflow: hidden;
}

#tour-container {
    width: 100vw;
    height: 100vh;
    display: block;
}

/* –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å–æ —Å—Ü–µ–Ω–∞–º–∏ */
#scene-panel {
    position: fixed;
    top: 0;
    left: 0;
    width: 280px;
    height: 100vh;
    background: rgba(26, 26, 26, 0.85);
    border-right: 1px solid #333;
    backdrop-filter: blur(4px);
    color: #fff;
    transform: translateX(0);
    transition: transform 0.2s ease-in-out;
    z-index: 1001;
}

#scene-panel:not(.open) {
    transform: translateX(-250px);
}

.scene-panel-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 10px 8px 14px;
    border-bottom: 1px solid #333;
}

.scene-panel-header .title {
    font-size: 16px;
    font-weight: 400;
}

#scene-panel-toggle {
    background: transparent;
    border: 1px solid #555;
    color: #fff;
    width: 28px;
    height: 28px;
    border-radius: 6px;
    cursor: pointer;
}

#scene-list {
    padding: 10px;
    overflow-y: auto;
    height: calc(100vh - 50px);
}

#scene-list .scene-item {
    padding: 8px 10px;
    border-radius: 6px;
    border: 1px solid transparent;
    cursor: pointer;
    margin-bottom: 6px;
}

#scene-list .scene-item.active, #scene-list .scene-item:hover {
    border-color: #646cff;
    background: rgba(100, 108, 255, 0.15);
}

#tour-controls {
    position: fixed;
    bottom: 20px;
    right: 20px;
    display: flex;
    gap: 10px;
    z-index: 1000;
}

#tour-controls button {
    width: 50px;
    height: 50px;
    background: rgba(26, 26, 26, 0.9);
    border: 1px solid #555;
    border-radius: 8px;
    color: #fff;
    font-size: 18px;
    cursor: pointer;
    transition: all 0.2s ease;
}

#tour-controls button:hover {
    background: rgba(100, 108, 255, 0.8);
    border-color: #646cff;
}

#tour-controls button:active {
    transform: scale(0.95);
}

#tour-controls #gyro-btn.active {
    background: rgba(100, 200, 120, 0.9);
    border-color: #36c26a;
}

/* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ */
#tour-loading {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(26, 26, 26, 0.95);
    border: 1px solid #646cff;
    border-radius: 12px;
    padding: 20px 30px;
    z-index: 2000;
    display: none;
    flex-direction: column;
    gap: 12px;
    min-width: 280px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
}

#tour-loading .bar { height: 6px; background: #333; border-radius: 3px; overflow: hidden; position: relative; }
#tour-loading .glow { position: absolute; top: 0; left: 0; height: 100%; width: 0%; background: linear-gradient(90deg, #646cff, #535bf2); box-shadow: 0 0 10px #646cff; transition: width 0.3s ease; }
#tour-loading .label { color: rgba(255,255,255,0.9); font-size: 14px; text-align: center; }

/* –ü–æ–¥—Å–∫–∞–∑–∫–∞ (2D) */
.tour-tooltip {
    position: fixed;
    padding: 6px 10px;
    background: rgba(26, 26, 26, 0.95);
    border: 1px solid #333;
    color: #fff;
    border-radius: 6px;
    font-size: 12px;
    pointer-events: none;
    z-index: 1002;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è A-Frame —Å—Ü–µ–Ω—ã */
a-scene {
    border: none !important;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 768px) {
    #scene-panel {
        width: 75vw;
    }
    #tour-controls {
        bottom: 10px;
        right: 10px;
        gap: 5px;
    }
    
    #tour-controls button {
        width: 40px;
        height: 40px;
        font-size: 16px;
    }
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ */
#tour-container:-webkit-full-screen {
    width: 100vw;
    height: 100vh;
}

#tour-container:-moz-full-screen {
    width: 100vw;
    height: 100vh;
}

#tour-container:fullscreen {
    width: 100vw;
    height: 100vh;
}`;
    }

    /**
     * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–∞–Ω–æ—Ä–∞–º –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞
     */
    async processPanoramaImages(projectData, packageFiles) {
        console.log('üñºÔ∏è –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–∞–Ω–æ—Ä–∞–º...');

        for (const scene of projectData.scenes) {
            if (scene.panoramaData) {
                try {
                    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º Data URL –≤ Blob
                    const response = await fetch(scene.panoramaData);
                    const blob = await response.blob();

                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å –∏–º–µ–Ω–µ–º —Å—Ü–µ–Ω—ã
                    const imagePath = `panoramas/${scene.id}.jpg`;
                    packageFiles[imagePath] = blob;

                    console.log(`‚úÖ –ü–∞–Ω–æ—Ä–∞–º–∞ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞: ${scene.name}`);
                } catch (error) {
                    console.warn(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–∞–Ω–æ—Ä–∞–º—ã ${scene.name}:`, error);
                }
            }
        }
    }

    /**
     * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–∞—Å—Ç–æ–º–Ω—ã–µ –∏–∫–æ–Ω–∫–∏ —Ö–æ—Ç—Å–ø–æ—Ç–æ–≤
     */
    async processCustomIcons(projectData, packageFiles) {
        console.log('üé® –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–µ –∏–∫–æ–Ω–∫–∏...');

        const processedIcons = new Set();

        for (const scene of projectData.scenes) {
            for (const hotspot of scene.hotspots) {
                if (hotspot.customIcon && !processedIcons.has(hotspot.customIcon)) {
                    try {
                        // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º Data URL –≤ Blob
                        const response = await fetch(hotspot.customIcon);
                        const blob = await response.blob();

                        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ ID —Ö–æ—Ç—Å–ø–æ—Ç–∞
                        const iconFileName = `icons/${hotspot.id}-icon.png`;
                        packageFiles[iconFileName] = blob;

                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É –≤ –¥–∞–Ω–Ω—ã—Ö —Ö–æ—Ç—Å–ø–æ—Ç–∞
                        hotspot.customIcon = iconFileName;

                        processedIcons.add(hotspot.customIcon);
                        console.log(`‚úÖ –ò–∫–æ–Ω–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ –¥–ª—è —Ö–æ—Ç—Å–ø–æ—Ç–∞: ${hotspot.title}`);
                    } catch (error) {
                        console.warn(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∫–æ–Ω–∫–∏ –¥–ª—è ${hotspot.title}:`, error);
                        // –£–¥–∞–ª—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –∏–∫–æ–Ω–∫—É
                        hotspot.customIcon = null;
                    }
                }
            }
        }
    }

    /**
     * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç README —Ñ–∞–π–ª —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏
     */
    generateReadme(projectData) {
        return `# ${projectData.projectTitle}

–ü–∞–Ω–æ—Ä–∞–º–Ω—ã–π —Ç—É—Ä, —Å–æ–∑–¥–∞–Ω–Ω—ã–π –≤ ColoR Tour Editor.

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞

1. –†–∞–∑–∞—Ä—Ö–∏–≤–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª—ã –Ω–∞ –≤–∞—à –≤–µ–±-—Å–µ—Ä–≤–µ—Ä
2. –û—Ç–∫—Ä–æ–π—Ç–µ index.html –≤ –±—Ä–∞—É–∑–µ—Ä–µ

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

- \`index.html\` - –≥–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Ç—É—Ä–∞
- \`tour-data.js\` - –¥–∞–Ω–Ω—ã–µ —Ç—É—Ä–∞ –∏ –ª–æ–≥–∏–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞  
- \`style.css\` - —Å—Ç–∏–ª–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
- \`panoramas/\` - –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–∞–Ω–æ—Ä–∞–º
- \`icons/\` - –∫–∞—Å—Ç–æ–º–Ω—ã–µ –∏–∫–æ–Ω–∫–∏ —Ö–æ—Ç—Å–ø–æ—Ç–æ–≤

## –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- üñ±Ô∏è –ù–∞–≤–∏–≥–∞—Ü–∏—è –º—ã—à—å—é –ø–æ –ø–∞–Ω–æ—Ä–∞–º–µ
- üì± –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- üéØ –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ —Ö–æ—Ç—Å–ø–æ—Ç—ã —Å –∫–∏—Ä–∏–ª–ª–∏—á–µ—Å–∫–∏–º–∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏
- üîó –ü–µ—Ä–µ—Ö–æ–¥—ã –º–µ–∂–¥—É —Å—Ü–µ–Ω–∞–º–∏
- üñºÔ∏è –ö–∞—Å—Ç–æ–º–Ω—ã–µ –∏–∫–æ–Ω–∫–∏ –º–∞—Ä–∫–µ—Ä–æ–≤
- ‚õ∂ –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º
- üîç –ó—É–º–∏—Ä–æ–≤–∞–Ω–∏–µ

## –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

- **–ú—ã—à—å**: –ø–æ–≤–æ—Ä–æ—Ç –∫–∞–º–µ—Ä—ã
- **–ö–ª–∏–∫ –ø–æ —Ö–æ—Ç—Å–ø–æ—Ç—É**: –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ
- **–ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è**: –∑—É–º, —Å–±—Ä–æ—Å –≤–∏–¥–∞, –ø–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω
- **–°–µ–ª–µ–∫—Ç–æ—Ä —Å—Ü–µ–Ω**: –±—ã—Å—Ç—Ä—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –º–µ–∂–¥—É –ª–æ–∫–∞—Ü–∏—è–º–∏

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

- –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –±—Ä–∞—É–∑–µ—Ä —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π WebGL
- –í–µ–±-—Å–µ—Ä–≤–µ—Ä (–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ file://)

---

–°–æ–∑–¥–∞–Ω–æ –≤ ColoR Tour Editor v1.0
–î–∞—Ç–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ${new Date().toLocaleDateString('ru-RU')}
–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ü–µ–Ω: ${projectData.scenes.length}
`;
    }

    /**
     * –°–æ–∑–¥–∞–µ—Ç –∏ —Å–∫–∞—á–∏–≤–∞–µ—Ç ZIP –∞—Ä—Ö–∏–≤
     */
    async downloadExportPackage(packageFiles) {
        console.log('‚¨áÔ∏è –°–æ–∑–¥–∞–µ–º ZIP –∞—Ä—Ö–∏–≤...');

        if (typeof JSZip === 'undefined') {
            throw new Error('JSZip –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞.');
        }

        const zip = new JSZip();

        // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ —Ñ–∞–π–ª—ã –≤ –∞—Ä—Ö–∏–≤
        for (const [filePath, content] of Object.entries(packageFiles)) {
            if (content instanceof Blob) {
                // –î–ª—è –±–∏–Ω–∞—Ä–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ (–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è)
                zip.file(filePath, content);
            } else {
                // –î–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤
                zip.file(filePath, content);
            }
        }

        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∞—Ä—Ö–∏–≤
        const zipBlob = await zip.generateAsync({
            type: 'blob',
            compression: 'DEFLATE',
            compressionOptions: { level: 6 }
        });

        // –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
        const url = URL.createObjectURL(zipBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'panorama-tour.zip';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);

        console.log('üì• ZIP –∞—Ä—Ö–∏–≤ —Å–∫–∞—á–∞–Ω!');
    }
}

export default ExportManager;
