import CoordinateManager from './coordinate_manager.js';

export default class ViewerManager {
  constructor(containerId, hotspotManager) {
    this.container = document.getElementById(containerId);
    this.aframeScene = null;
    this.aframeCamera = null;
    this.aframeSky = null;
    this.currentPanorama = null;
    this.zoomSpeed = 1.0; // –°–∫–æ—Ä–æ—Å—Ç—å –∑—É–º–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    this.hotspotManager = hotspotManager; // –°—Å—ã–ª–∫–∞ –Ω–∞ –º–µ–Ω–µ–¥–∂–µ—Ä —Ö–æ—Ç—Å–ø–æ—Ç–æ–≤
    this.coordinateManager = new CoordinateManager(this); // –ü–µ—Ä–µ–¥–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ ViewerManager

    // –§–ª–∞–≥–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    this._isResizing = false;
    this._resizeSaveTimeout = null;
    this._currentResizeHandle = null; // –•—Ä–∞–Ω–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º —É–≥–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞

    // –ê–≤—Ç–æ—Ä–æ—Ç–∞—Ü–∏—è (–∞–≤—Ç–æ–ø–æ–≤–æ—Ä–æ—Ç) –ø–∞–Ω–æ—Ä–∞–º—ã
    this.autorotateEnabled = false;
    this.autorotateSpeed = 0.02; // —Ä–∞–¥–∏–∞–Ω/—Å–µ–∫
    this.autorotateIdleDelay = 3000; // –º—Å –¥–æ –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
    this._autorotatePaused = false;
    this._autorotateLastTs = 0;
    this._lastUserInteraction = Date.now();
    this._autorotateRaf = null;

    // –ì–∏—Ä–æ—Å–∫–æ–ø –∏ –∂–µ—Å—Ç—ã
    this.gyroEnabled = false;
    this._pinch = { active: false, startDist: 0, startFov: 80 };

    this.initializeViewer();
  }

  initializeViewer() {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º A-Frame —Å—Ü–µ–Ω—É
    this.initializeAFrame();

    // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç billboard –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞
    if (!AFRAME.components['billboard']) {
      AFRAME.registerComponent('billboard', {
        tick: function () {
          const camera = this.el.sceneEl.camera;
          if (camera) {
            this.el.object3D.lookAt(camera.getWorldPosition(new THREE.Vector3()));
          }
        }
      });
    }

    // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∏—Ä–∏–ª–ª–∏—Ü—ã
    if (!AFRAME.components['cyrillic-text']) {
      AFRAME.registerComponent('cyrillic-text', {
        schema: {
          value: { type: 'string' },
          color: { type: 'color', default: '#ffffff' },
          align: { type: 'string', default: 'center' },
          family: { type: 'string', default: 'Arial, sans-serif' },
          bold: { type: 'boolean', default: false },
          underline: { type: 'boolean', default: false }
        },
        init: function () {
          this.updateText();
        },
        update: function () {
          this.updateText();
        },
        updateText: function () {
          // –°–æ–∑–¥–∞–µ–º canvas –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –∫–∏—Ä–∏–ª–ª–∏—Ü—ã
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          canvas.width = 512;
          canvas.height = 128;

          // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —à—Ä–∏—Ñ—Ç–∞
          const fontPx = 48;
          const weight = this.data.bold ? 'bold ' : '';
          const family = this.data.family || 'Arial, sans-serif';
          const text = this.data.value || '';

          ctx.font = `${weight}${fontPx}px ${family}`;
          ctx.fillStyle = this.data.color;
          ctx.textAlign = this.data.align;
          ctx.textBaseline = 'middle';

          // –§–æ–Ω –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
          // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.fillText(text, canvas.width / 2, canvas.height / 2);

          // –ü–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏–µ
          if (this.data.underline && text) {
            const metrics = ctx.measureText(text);
            const underlineY = canvas.height / 2 + fontPx * 0.45;
            const underlineWidth = metrics.width;
            const startX = canvas.width / 2 - underlineWidth / 2;
            const endX = canvas.width / 2 + underlineWidth / 2;
            ctx.strokeStyle = this.data.color;
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(startX, underlineY);
            ctx.lineTo(endX, underlineY);
            ctx.stroke();
          }

          // –°–æ–∑–¥–∞–µ–º —Ç–µ–∫—Å—Ç—É—Ä—É –∏ –º–∞—Ç–µ—Ä–∏–∞–ª
          const texture = new THREE.CanvasTexture(canvas);
          const material = new THREE.MeshBasicMaterial({
            map: texture,
            transparent: true,
            alphaTest: 0.5
          });

          // –°–æ–∑–¥–∞–µ–º plane –≥–µ–æ–º–µ—Ç—Ä–∏—é
          const geometry = new THREE.PlaneGeometry(2, 0.5);
          const mesh = new THREE.Mesh(geometry, material);

          // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π mesh
          while (this.el.object3D.children.length > 0) {
            this.el.object3D.remove(this.el.object3D.children[0]);
          }

          this.el.object3D.add(mesh);
        }
      });
    }

    // –®–µ–π–¥–µ—Ä –¥–ª—è —Ö—Ä–æ–º–∞–∫–µ—è (—É–¥–∞–ª–µ–Ω–∏–µ —Ñ–æ–Ω–∞ –ø–æ —Ü–≤–µ—Ç—É)
    if (!AFRAME.shaders || !AFRAME.shaders['chroma-key']) {
      AFRAME.registerShader('chroma-key', {
        schema: {
          src: { type: 'map' },
          color: { type: 'color', default: '#00ff00' },
          similarity: { type: 'number', default: 0.4 },
          smoothness: { type: 'number', default: 0.1 },
          threshold: { type: 'number', default: 0.0 }
        },
        init: function (data) {
          const uniforms = {
            map: { value: null },
            keyColor: { value: new THREE.Color(data.color) },
            similarity: { value: data.similarity },
            smoothness: { value: data.smoothness },
            threshold: { value: data.threshold }
          };
          this.material = new THREE.ShaderMaterial({
            uniforms,
            transparent: true,
            depthWrite: false,
            side: THREE.DoubleSide,
            vertexShader: `
              varying vec2 vUV;
              void main(){
                vUV = uv;
                gl_Position = projectionMatrix * modelViewMatrix * vec4(position,1.0);
              }
            `,
            fragmentShader: `
              uniform sampler2D map;
              uniform vec3 keyColor;
              uniform float similarity;
              uniform float smoothness;
              uniform float threshold;
              varying vec2 vUV;
              void main(){
                vec4 color = texture2D(map, vUV);
                // RGB -> YCbCr –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ
                float r = color.r; float g = color.g; float b = color.b;
                float kr = 0.299; float kg = 0.587; float kb = 0.114;
                float y = kr*r + kg*g + kb*b;
                float cr = (r - y) * 0.713 + 0.5;
                float cb = (b - y) * 0.564 + 0.5;
                float rK = keyColor.r; float gK = keyColor.g; float bK = keyColor.b;
                float yK = kr*rK + kg*gK + kb*bK;
                float crK = (rK - yK) * 0.713 + 0.5;
                float cbK = (bK - yK) * 0.564 + 0.5;
                float blend = distance(vec2(cb,cr), vec2(cbK,crK));
                float alpha = smoothstep(similarity, similarity + smoothness, blend);
                alpha = clamp((alpha - threshold)/(1.0-threshold+1e-6), 0.0, 1.0);
                gl_FragColor = vec4(color.rgb, alpha * color.a);
              }
            `
          });
        },
        update: function (data) {
          if (data.src && data.src.image) {
            this.material.uniforms.map.value = data.src.image;
            this.material.needsUpdate = true;
          }
          if (data.color) this.material.uniforms.keyColor.value.set(data.color);
          if (typeof data.similarity === 'number') this.material.uniforms.similarity.value = data.similarity;
          if (typeof data.smoothness === 'number') this.material.uniforms.smoothness.value = data.smoothness;
          if (typeof data.threshold === 'number') this.material.uniforms.threshold.value = data.threshold;
        }
      });
    }

    // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç hotspot-handler –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π
    if (typeof AFRAME !== 'undefined') {
      AFRAME.registerComponent('hotspot-handler', {
        schema: {
          hotspotId: { type: 'string' },
          hotspotTitle: { type: 'string' },
          hotspotType: { type: 'string' }
        },
        init: function () {
          const el = this.el;
          const data = this.data;
          // init hotspot-handler

          // –î–æ–±–∞–≤–ª—è–µ–º CSS pointer-events –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏–π –º—ã—à–∏
          el.setAttribute('style', 'pointer-events: auto;');

          // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∫–ª–∏–∫–æ–≤
          let clickCount = 0;
          let clickTimer = null;
          let lastClickTime = 0;
          let rightClickHandled = false;
          let doubleClickHandled = false;

          // –û–¢–õ–ê–î–ö–ê: –¥–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Å–æ–±—ã—Ç–∏–π –º—ã—à–∏ —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
          const mousedownHandler = () => {};
          const mouseupHandler = () => {};
          const clickHandler = () => {};

          // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
          if (!el._debugHandlersAdded) {
            el.addEventListener('mousedown', mousedownHandler, true);
            el.addEventListener('mouseup', mouseupHandler, true);
            el.addEventListener('click', clickHandler, true);
            el._debugHandlersAdded = true;
          }

          // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –æ—Ç raycaster —Å –¥–µ–±–∞—É–Ω—Å–∏–Ω–≥–æ–º
          let intersectedTimeout = null;
          let clearedTimeout = null;

          el.addEventListener('raycaster-intersected', (e) => {
            if (intersectedTimeout) clearTimeout(intersectedTimeout);
            intersectedTimeout = setTimeout(() => {
              el.emit('mouseenter');
            }, 50); // –î–µ–±–∞—É–Ω—Å–∏–Ω–≥ 50ms
          });

          el.addEventListener('raycaster-intersected-cleared', (e) => {
            if (clearedTimeout) clearTimeout(clearedTimeout);
            clearedTimeout = setTimeout(() => {
              el.emit('mouseleave');
            }, 50); // –î–µ–±–∞—É–Ω—Å–∏–Ω–≥ 50ms
          });

          // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
          el.addEventListener('mouseenter', (e) => {
            // –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ–º tooltip –¥–ª—è –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–µ–π - –Ω–∞–∑–≤–∞–Ω–∏–µ —É–∂–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –Ω–∞–¥ –≤–∏–¥–µ–æ
            if (data.hotspotType === 'video-area') return;
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–º–µ–Ω–Ω–æ —ç–ª–µ–º–µ–Ω—Ç —Å –Ω–∞—à–∏–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–º cyrillic-text
            const markerEl = el.parentElement;
            const textEl = markerEl && markerEl.querySelector('[cyrillic-text]');
            if (textEl) {
              textEl.setAttribute('visible', 'true');
            }
          });

          el.addEventListener('mouseleave', (e) => {
            // –ù–ï —Å–∫—Ä—ã–≤–∞–µ–º tooltip –¥–ª—è –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–µ–π
            if (data.hotspotType === 'video-area') return;
            // –°–∫—Ä—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —Å –Ω–∞—à–∏–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–º
            const markerEl = el.parentElement;
            const textEl = markerEl && markerEl.querySelector('[cyrillic-text]');
            if (textEl) {
              textEl.setAttribute('visible', 'false');
            }
          });

          // –ö–ê–°–¢–û–ú–ù–ê–Ø —Å–∏—Å—Ç–µ–º–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏–π –º—ã—à–∏ —Å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è
          let mouseDownTime = 0;
          let isRightMouseDown = false;
          let clickStartTime = 0;

          el.addEventListener('mousedown', (e) => {
            const currentTime = Date.now();
            mouseDownTime = currentTime;

            // –ù–ï –ü–´–¢–ê–ï–ú–°–Ø –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—Ä–∞–≤—É—é –∫–Ω–æ–ø–∫—É —á–µ—Ä–µ–∑ A-Frame
            // –ü–æ–ª–∞–≥–∞–µ–º—Å—è –Ω–∞ canvas –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø—Ä–∞–≤–æ–≥–æ –∫–ª–∏–∫–∞
            // rely on canvas handlers for right click

            // –õ–µ–≤–∞—è –∫–Ω–æ–ø–∫–∞ –º—ã—à–∏ - –Ω–∞—á–∏–Ω–∞–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –¥–ª—è –¥–≤–æ–π–Ω–æ–≥–æ –∫–ª–∏–∫–∞
            if (e.which === 1 || e.button === 0) {
              clickStartTime = currentTime;
            }
          });

          el.addEventListener('mouseup', (e) => {
            // –ü—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º
            // no special handling on mouseup
          });

          // –î–í–û–ô–ù–û–ô –ö–õ–ò–ö –û–¢–ö–õ–Æ–ß–ï–ù –ü–û –ü–†–û–°–¨–ë–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
          // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –±—ã—Å—Ç—Ä—ã—Ö –¥–≤–æ–π–Ω—ã—Ö –∫–ª–∏–∫–æ–≤ —á–µ—Ä–µ–∑ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—É—é –ª–æ–≥–∏–∫—É
          /*
          el.addEventListener('click', (e) => {
            const currentTime = Date.now();
            const timeSinceMouseDown = currentTime - clickStartTime;
    
            // –ï—Å–ª–∏ –∫–ª–∏–∫ –ø—Ä–æ–∏–∑–æ—à–µ–ª –æ—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ –ø–æ—Å–ª–µ –¥—Ä—É–≥–æ–≥–æ –∫–ª–∏–∫–∞ - —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫
            if (timeSinceMouseDown < 50 && (currentTime - lastClickTime) < 300) {
              console.log('üéØ A-Frame –ë–´–°–¢–†–´–ô –î–í–û–ô–ù–û–ô –ö–õ–ò–ö –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:', data.hotspotTitle);
    
              doubleClickHandled = true;
              el.parentElement._doubleClickHandled = true;
    
              e.preventDefault();
              e.stopPropagation();
    
              const hotspotId = data.hotspotId;
              if (window.hotspotManager) {
                console.log('‚úÖ –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä –º–∞—Ä–∫–µ—Ä–∞:', data.hotspotTitle);
                window.hotspotManager.editHotspot(hotspotId);
              }
    
              setTimeout(() => {
                doubleClickHandled = false;
                delete el.parentElement._doubleClickHandled;
              }, 300);
    
              return false;
            }
    
            lastClickTime = currentTime;
          });
          */

          // –ù–ï –¥–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ contextmenu –∏ dblclick
          // –ü–æ–ª–∞–≥–∞–µ–º—Å—è –Ω–∞ canvas –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —ç—Ç–∏—Ö —Å–æ–±—ã—Ç–∏–π
          // rely on canvas handlers for contextmenu and dblclick

          el.addEventListener('click', (e) => {
            // a-frame click

            // üî• –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–í–ï–†–ö–ê: –±–ª–æ–∫–∏—Ä—É–µ–º –∫–ª–∏–∫ –ø–æ—Å–ª–µ –ø—Ä–∞–≤–æ–≥–æ –∫–ª–∏–∫–∞
            const currentTime = Date.now();
            const lastRightClickTime = window.viewerManager ? window.viewerManager._lastRightClickTime : 0;
            const timeSinceRightClick = currentTime - (lastRightClickTime || 0);

            if (timeSinceRightClick < 300) {
              return;
            }

            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
            // –ò–°–ö–õ–Æ–ß–ï–ù–ò–ï: –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏ –ù–ï –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è –≥–ª–æ–±–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π –¥–ª—è –õ–ö–ú –∫–ª–∏–∫–æ–≤
            if (window._dragSystemBlocked && data.hotspotType !== 'video-area') {
              return;
            }

            // –°–ü–ï–¶–ò–ê–õ–¨–ù–ê–Ø –û–ë–†–ê–ë–û–¢–ö–ê –¥–ª—è –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–µ–π: –∏—Å–ø–æ–ª—å–∑—É–µ–º —É–ø—Ä–æ—â–µ–Ω–Ω—É—é –ª–æ–≥–∏–∫—É
            if (data.hotspotType === 'video-area') {
              // video-area simplified click handler

              // –ü–æ–ª—É—á–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ video —ç–ª–µ–º–µ–Ω—Ç
              const markerEl = el.parentElement;
              const videoEl = markerEl.querySelector('video');

              if (videoEl) {
                // –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ toggle –¥–ª—è –≤–∏–¥–µ–æ
                if (videoEl.paused) {
                  videoEl.play().catch(error => {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –≤–∏–¥–µ–æ:', error);
                  });
                } else {
                  videoEl.pause();
                }

                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ —Å–∞–º –≤–∏–¥–µ–æ-—ç–ª–µ–º–µ–Ω—Ç (–¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ–≥–æ toggle)
                if (!videoEl._clickHandlerAdded) {
                  videoEl.addEventListener('click', (ev) => {
                    ev.stopPropagation(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ —Å–æ–±—ã—Ç–∏—è
                    if (videoEl.paused) {
                      videoEl.play().catch(error => {
                        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –≤–∏–¥–µ–æ:', error);
                      });
                    } else {
                      videoEl.pause();
                    }
                  });
                  videoEl._clickHandlerAdded = true;
                }

                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–∞–¥ –≤–∏–¥–µ–æ –° —Ç–µ–º–Ω–æ–π –ø–æ–¥–ª–æ–∂–∫–æ–π
                const hotspot = window.hotspotManager.findHotspotById(data.hotspotId);
                if (hotspot && markerEl) {
                  let titlePlane = markerEl.querySelector('.video-title-plane');
                  if (!titlePlane) {
                    // –°–æ–∑–¥–∞–µ–º —Ç–µ–º–Ω—É—é –ø–æ–¥–ª–æ–∂–∫—É –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞
                    titlePlane = document.createElement('a-entity');
                    titlePlane.setAttribute('geometry', 'primitive: plane; width: 2.5; height: 0.5');
                    titlePlane.setAttribute('material', 'color: #222; opacity: 0.8; transparent: true');
                    titlePlane.setAttribute('position', `0 ${(hotspot.videoHeight || 3) / 2 + 0.35} 0.01`); // –Ω–∞–¥ –≤–∏–¥–µ–æ
                    titlePlane.setAttribute('billboard', '');
                    titlePlane.classList.add('video-title-plane');

                    // –¢–µ–∫—Å—Ç –Ω–∞ –ø–æ–¥–ª–æ–∂–∫–µ
                    let titleText = document.createElement('a-text');
                    titleText.setAttribute('value', hotspot.title || '–í–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç—å');
                    titleText.setAttribute('align', 'center');
                    titleText.setAttribute('color', '#ffffff');
                    titleText.setAttribute('width', '2.3');
                    titleText.setAttribute('position', '0 0 0.01');
                    titleText.setAttribute('font', 'roboto');
                    titleText.setAttribute('shader', 'msdf');
                    titlePlane.appendChild(titleText);
                    markerEl.appendChild(titlePlane);
                  }
                }
              }
              return; // –ó–∞–≤–µ—Ä—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–ª—è –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–µ–π
            }

            // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞: Ctrl+Click –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            if (e.ctrlKey) {
              // ctrl+click edit

              doubleClickHandled = true;
              el.parentElement._doubleClickHandled = true;

              e.preventDefault();
              e.stopPropagation();

              const hotspotId = data.hotspotId;
              if (window.hotspotManager) {
                window.hotspotManager.editHotspot(hotspotId);
              }

              setTimeout(() => {
                doubleClickHandled = false;
                delete el.parentElement._doubleClickHandled;
              }, 300);

              return false;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–ª–∞–≥–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
            if (rightClickHandled || doubleClickHandled) {
              return;
            }

            // –ò—â–µ–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π —ç–ª–µ–º–µ–Ω—Ç –º–∞—Ä–∫–µ—Ä–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–ª–∞–≥–æ–≤ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
            const markerParent = el.parentElement;

            if (markerParent) {
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–ª–∞–≥–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –æ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
              if (markerParent._rightClickHandled) {
                return;
              }

              if (markerParent._doubleClickHandled) {
                return;
              }

              if (markerParent._wasDragged) {
                return;
              }
            }

            // –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–∞–º —ç–ª–µ–º–µ–Ω—Ç
            if (el._wasDragged) {
              return;
            }

            // proceed primary action

            // –ù–∞—Ö–æ–¥–∏–º –¥–∞–Ω–Ω—ã–µ —Ö–æ—Ç—Å–ø–æ—Ç–∞ –∏ –≤—ã–∑—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é
            const hotspotId = data.hotspotId;
            const hotspot = window.hotspotManager ? window.hotspotManager.getHotspotWithFullData(hotspotId) : null;

            if (hotspot) {
              if (hotspot.type === 'hotspot' && hotspot.targetSceneId) {
                console.log('üéØ A-Frame –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–±–Ω–∞—Ä—É–∂–∏–ª —Ö–æ—Ç—Å–ø–æ—Ç - –ø–µ—Ä–µ–¥–∞–µ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ DOM –æ–±—Ä–∞–±–æ—Ç—á–∏–∫—É');
                // –ù–ï –í–´–ó–´–í–ê–ï–ú switchToScene –∑–¥–µ—Å—å - —ç—Ç–æ –¥–µ–ª–∞–µ—Ç DOM –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å –∑–∞—â–∏—Ç–æ–π!
                // window.sceneManager.switchToScene(hotspot.targetSceneId);
              } else if (hotspot.type === 'info-point') {
                console.log('–ü–æ–∫–∞–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –∏–Ω—Ñ–æ—Ç–æ—á–∫–∏');
                window.viewerManager.showInfoPointModal(hotspot);
              } else if (hotspot.type === 'video-area') {
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –≤ –±–ª–æ–∫–µ –≤—ã—à–µ –¥–ª—è data.hotspotType === 'video-area'
                console.log('üé¨ –í–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç—å —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞');
              }
            }
          });
        }
      });
    }
  }

  /**
   * –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –≤–∏–¥–µ–æ —Å –Ω–∞–¥–µ–∂–Ω–æ–π –ª–æ–≥–∏–∫–æ–π toggle
   */
  playVideoElement(videoEl, hotspot) {
    try {
      console.log('üé¨ –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –¥–ª—è:', hotspot.title);
      console.log('üîç –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:', {
        paused: videoEl.paused,
        readyState: videoEl.readyState
      });

      // –ü—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞ toggle
      if (videoEl.paused) {
        console.log('‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫ –≤–∏–¥–µ–æ...');
        videoEl.play().catch(err => {
          console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞:', err);
          if (err.name === 'NotAllowedError') {
            videoEl.muted = true;
            videoEl.play().catch(e => console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –±–µ–∑ –∑–≤—É–∫–∞:', e));
          }
        });
      } else {
        console.log('‚è∏Ô∏è –ü–∞—É–∑–∞ –≤–∏–¥–µ–æ...');
        videoEl.pause();
      }
    } catch (err) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –≤ playVideoElement:', err);
    }
  }

  /**
   * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ö–æ—Ç—Å–ø–æ—Ç–æ–≤ –≤ —Å—Ü–µ–Ω–µ
   */
  hasActiveHotspots() {
    return this.hotspots && this.hotspots.length > 0;
  }

  /**
   * –°–æ–∑–¥–∞–µ—Ç –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–π –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è —Ö–æ—Ç—Å–ø–æ—Ç–∞
   */
  createMissingVideoElement(hotspot) {
    console.log('üîß –°–æ–∑–¥–∞–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–π –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è:', hotspot.id);
    console.log('üîç –ü–∞—Ä–∞–º–µ—Ç—Ä—ã hotspot:', {
      id: hotspot.id,
      title: hotspot.title,
      videoUrl: hotspot.videoUrl,
      hasVideoUrl: !!hotspot.videoUrl
    });

    const videoId = `video-${hotspot.id}`;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç–ª–µ–º–µ–Ω—Ç –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if (document.getElementById(videoId)) {
      console.log('‚úÖ –í–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:', videoId);
      const existingVideo = document.getElementById(videoId);

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –æ–±–Ω–æ–≤–ª—è–µ–º src –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
      if (hotspot.videoUrl && hotspot.videoUrl !== existingVideo.src) {
        console.log('üîÑ –û–±–Ω–æ–≤–ª—è–µ–º src —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –≤–∏–¥–µ–æ:', hotspot.videoUrl);

        // –£–ª—É—á—à–µ–Ω–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ src
        if (existingVideo.readyState !== undefined) {
          existingVideo.src = hotspot.videoUrl;
          existingVideo.load();
          console.log('‚úÖ Src –æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –≤–∏–¥–µ–æ');
        } else {
          setTimeout(() => {
            existingVideo.src = hotspot.videoUrl;
            existingVideo.load();
            console.log('‚úÖ –û—Ç–ª–æ–∂–µ–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ src');
          }, 100);
        }
      }
      return;
    }

    // –°–æ–∑–¥–∞–µ–º –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç
    const videoEl = document.createElement('video');
    videoEl.id = videoId;
    videoEl.crossOrigin = 'anonymous';
    videoEl.loop = true;
    videoEl.muted = true;
    videoEl.autoplay = false; // –û–¢–ö–õ–Æ–ß–ê–ï–ú autoplay - –≤–∏–¥–µ–æ –¥–æ–ª–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –ø–æ –∫–ª–∏–∫—É
    videoEl.controls = false;
    videoEl.style.display = 'none';
    videoEl.preload = 'metadata';

    // –ù–ï —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º poster - –æ–Ω –º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    // videoEl.poster = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';

    console.log('üé¨ –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç:', videoId);

    // –î–æ–±–∞–≤–ª—è–µ–º –≤ assets
    let assets = this.aframeScene.querySelector('a-assets');
    if (!assets) {
      console.log('üèóÔ∏è –°–æ–∑–¥–∞–µ–º a-assets –¥–ª—è –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤');
      assets = document.createElement('a-assets');
      this.aframeScene.appendChild(assets);
    }
    assets.appendChild(videoEl);

    // –ù–∞—Ö–æ–¥–∏–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –≤–∏–¥–µ–æ-–ø–ª–æ—Å–∫–æ—Å—Ç—å
    const marker = document.getElementById(`marker-${hotspot.id}`);
    const videoPlane = marker ? marker.querySelector('a-plane') : null;

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏
    videoEl.addEventListener('loadeddata', () => {
      console.log('‚úÖ –ù–µ–¥–æ—Å—Ç–∞—é—â–µ–µ –≤–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ:', hotspot.title);

      // –ò–°–ü–†–ê–í–õ–Ø–ï–ú: –∂–¥–µ–º –ø–æ–ª–Ω–æ–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –≤–∏–¥–µ–æ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º —Ç–µ–∫—Å—Ç—É—Ä—ã
      if (videoEl.readyState >= 2 && videoEl.videoWidth > 0 && videoEl.videoHeight > 0) {
        if (videoPlane) {
          // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª —Å –≤–∏–¥–µ–æ —Ç–µ–∫—Å—Ç—É—Ä–æ–π
          videoPlane.setAttribute('material', {
            src: `#${videoId}`,
            transparent: false,
            side: 'double'
          });

          // –£–±–∏—Ä–∞–µ–º —Ç–µ–∫—Å—Ç-–∑–∞–≥–ª—É—à–∫—É
          videoPlane.removeAttribute('text');
        }
      } else {
        // –ï—Å–ª–∏ –≤–∏–¥–µ–æ –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤–æ, –∂–¥–µ–º —Å–æ–±—ã—Ç–∏—è canplay
        console.warn('‚ö†Ô∏è –í–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ, –Ω–æ –Ω–µ –≥–æ—Ç–æ–≤–æ –¥–ª—è —Ç–µ–∫—Å—Ç—É—Ä—ã, –∂–¥–µ–º canplay');
      }
    });

    videoEl.addEventListener('canplay', () => {
      console.log('‚úÖ –ù–µ–¥–æ—Å—Ç–∞—é—â–µ–µ –≤–∏–¥–µ–æ –≥–æ—Ç–æ–≤–æ –∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—é:', hotspot.title);

      // –ò–°–ü–†–ê–í–õ–Ø–ï–ú: –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª –≤ canplay –µ—Å–ª–∏ –Ω–µ –±—ã–ª–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –≤ loadeddata
      const currentMaterial = videoPlane ? videoPlane.getAttribute('material') : null;
      if (videoPlane && (!currentMaterial || !currentMaterial.src)) {
        videoPlane.setAttribute('material', {
          src: `#${videoId}`,
          transparent: false,
          side: 'double'
        });
        videoPlane.removeAttribute('text');
      }

      // –ù–ï –∑–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ - –≤–∏–¥–µ–æ –¥–æ–ª–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –ø–æ –∫–ª–∏–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      console.log('‚úÖ –í–∏–¥–µ–æ –≥–æ—Ç–æ–≤–æ, –Ω–æ –ù–ï –∑–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ - –∂–¥–µ–º –∫–ª–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
    });

    videoEl.addEventListener('error', (e) => {
      console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–µ–¥–æ—Å—Ç–∞—é—â–µ–≥–æ –≤–∏–¥–µ–æ:', {
        hotspot: hotspot.title || hotspot.id,
        videoUrl: hotspot.videoUrl,
        error: e.target.error
      });

      if (videoPlane) {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥–ª—É—à–∫—É –ø—Ä–∏ –æ—à–∏–±–∫–µ
        videoPlane.setAttribute('material', {
          color: '#cc3333',
          transparent: false
        });
        videoPlane.setAttribute('text', {
          value: `‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ\n${hotspot.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}`,
          align: 'center',
          color: '#ffffff'
        });
      }
    });

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫ –≤–∏–¥–µ–æ –µ—Å–ª–∏ –µ—Å—Ç—å
    if (hotspot.videoUrl && hotspot.videoUrl.trim() !== '') {
      try {
        videoEl.src = hotspot.videoUrl;
        console.log('‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω src –¥–ª—è –Ω–µ–¥–æ—Å—Ç–∞—é—â–µ–≥–æ –≤–∏–¥–µ–æ:', hotspot.videoUrl);

        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
        videoEl.load();
        console.log('üîÑ –ó–∞–ø—É—â–µ–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∞ –Ω–µ–¥–æ—Å—Ç–∞—é—â–µ–≥–æ –≤–∏–¥–µ–æ');
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ src –¥–ª—è –Ω–µ–¥–æ—Å—Ç–∞—é—â–µ–≥–æ –≤–∏–¥–µ–æ:', error);
      }
    } else {
      console.warn('‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—é—â–µ–µ –≤–∏–¥–µ–æ —Å–æ–∑–¥–∞–Ω–æ –±–µ–∑ src - videoUrl –ø—É—Å—Ç–æ–π');
    }

    console.log('üîß –ù–µ–¥–æ—Å—Ç–∞—é—â–∏–π –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω:', videoId);
  }

  initializeAFrame() {
    // –°–æ–∑–¥–∞–µ–º A-Frame —Å—Ü–µ–Ω—É
    this.aframeScene = document.createElement('a-scene');
    this.aframeScene.setAttribute('embedded', 'true');
    this.aframeScene.setAttribute('style', 'width: 100%; height: 100%; cursor: grab; background: transparent !important;');
    this.aframeScene.setAttribute('cursor', 'rayOrigin: mouse');
    this.aframeScene.setAttribute('raycaster', 'objects: .interactive');
    this.aframeScene.setAttribute('vr-mode-ui', 'enabled: false');
    this.aframeScene.setAttribute('background', 'color: #000000; transparent: true');

    // –°–æ–∑–¥–∞–µ–º assets –¥–ª—è —à—Ä–∏—Ñ—Ç–æ–≤
    const assets = document.createElement('a-assets');

    // –£–¥–∞–ª—è–µ–º –ø—Ä–æ–±–ª–µ–º–∞—Ç–∏—á–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É Roboto
    // const robotoFont = document.createElement('a-asset-item');
    // ...

    this.aframeScene.appendChild(assets);

    // –°–æ–∑–¥–∞–µ–º –∫–∞–º–µ—Ä—É
    this.aframeCamera = document.createElement('a-entity');
    this.aframeCamera.setAttribute('camera', 'fov: 80; zoom: 1');
    this.aframeCamera.setAttribute('look-controls', 'enabled: true');
    this.aframeCamera.setAttribute('wasd-controls', 'enabled: false');
    this.aframeCamera.id = 'camera';
    this.aframeScene.appendChild(this.aframeCamera);

    // –ù–ï —Å–æ–∑–¥–∞–µ–º –∫—É—Ä—Å–æ—Ä - —É–±–∏—Ä–∞–µ–º —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –∫—Ä—É–∂–æ–∫
    // const cursor = document.createElement('a-cursor');
    // ...

    // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –Ω–µ–±–∞ –¥–ª—è –ø–∞–Ω–æ—Ä–∞–º—ã
    this.aframeSky = document.createElement('a-sky');
    this.aframeSky.setAttribute('color', '#000000'); // –ß–µ—Ä–Ω—ã–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    this.aframeSky.setAttribute('opacity', '0'); // –°–∫—Ä—ã—Ç–æ –¥–æ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–∞–Ω–æ—Ä–∞–º—ã
    this.aframeScene.appendChild(this.aframeSky);

    // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ü–µ–Ω—É –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    this.container.appendChild(this.aframeScene);

    // –£–±–∏—Ä–∞–µ–º —Ñ–æ–Ω A-Frame –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
    this.aframeScene.addEventListener('renderstart', () => {
      this.removeLAFrame();
      // –î–æ–±–∞–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ —Å–æ–±—ã—Ç–∏–π –º—ã—à–∏
      this.setupGlobalMouseHandlers();
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ü–µ–Ω—ã
    this.initializeCoordinateManager();

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ü–µ–Ω—ã —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
    setTimeout(() => {
      this.setupEventHandlers();
      this.setupZoomControls(); // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É –∑—É–º–∞ –∫–æ–ª–µ—Å–∏–∫–æ–º –º—ã—à–∏
      this.updateZoomIndicator(80); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑—É–º–∞
      console.log('üéØ –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –º–∞—Ä–∫–µ—Ä–æ–≤ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã');
      console.log('üîç –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑—É–º–æ–º –∫–æ–ª–µ—Å–∏–∫–æ–º –º—ã—à–∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ');

      // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è –ø–∞—É–∑—ã –∞–≤—Ç–æ—Ä–æ—Ç–∞—Ü–∏–∏
      this._setupAutorotateUserInteractivity();
    }, 100);

    console.log('A-Frame —Å—Ü–µ–Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∫–∏—Ä–∏–ª–ª–∏—Ü—ã');
  }

  removeLAFrame() {
    // –£–¥–∞–ª—è–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∑–∞–≥—Ä—É–∑—á–∏–∫–∞ A-Frame
    const loader = document.querySelector('.a-loader');
    if (loader) {
      loader.style.display = 'none';
      loader.remove();
    }

    const loaderTitle = document.querySelector('.a-loader-title');
    if (loaderTitle) {
      loaderTitle.style.display = 'none';
      loaderTitle.remove();
    }

    // –£–¥–∞–ª—è–µ–º –∫–Ω–æ–ø–∫—É VR
    const vrButton = document.querySelector('.a-enter-vr-button');
    if (vrButton) {
      vrButton.style.display = 'none';
      vrButton.remove();
    }

    // –£–±–∏—Ä–∞–µ–º —Ñ–æ–Ω —Å canvas
    const canvases = document.querySelectorAll('canvas');
    canvases.forEach(canvas => {
      canvas.style.background = 'transparent';
      canvas.style.backgroundColor = 'transparent';
    });

    // –£–±–∏—Ä–∞–µ–º —Ñ–æ–Ω —Å—Ü–µ–Ω—ã Three.js
    if (this.aframeScene && this.aframeScene.object3D && this.aframeScene.object3D.background) {
      this.aframeScene.object3D.background = null;
    }

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω –¥–ª—è renderer Three.js
    setTimeout(() => {
      if (this.aframeScene && this.aframeScene.renderer) {
        this.aframeScene.renderer.setClearColor(0x000000, 0); // –ü—Ä–æ–∑—Ä–∞—á–Ω—ã–π —á–µ—Ä–Ω—ã–π
        this.aframeScene.renderer.alpha = true;
      }
    }, 100);

    console.log('üßπ –§–æ–Ω A-Frame —É–¥–∞–ª–µ–Ω');
  }

  // === –ì–ª–æ–±–æ–≤—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ ===
  showGlobalLoading(label = '–ó–∞–≥—Ä—É–∑–∫–∞...') {
    const box = document.getElementById('futuristic-progress');
    if (!box) return;
    const labelEl = box.querySelector('.label');
    if (labelEl) labelEl.textContent = label;
    const glow = box.querySelector('.glow');
    if (glow) glow.style.width = '5%';
    box.style.display = 'flex';
  }

  hideGlobalLoading() {
    const box = document.getElementById('futuristic-progress');
    if (!box) return;
    box.style.display = 'none';
  }

  setupGlobalMouseHandlers() {
    // –î–æ–±–∞–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –∏ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏–π
    const canvas = this.aframeScene.querySelector('canvas');
    if (canvas) {
      console.log('üì± –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –º—ã—à–∏ –Ω–∞ canvas');

      canvas.addEventListener('contextmenu', (e) => {
        console.log('üéØ Canvas contextmenu event detected - button:', e.button, 'which:', e.which, 'buttons:', e.buttons);
        console.log('üéØ Canvas contextmenu - rightClickDetected:', this._rightClickDetected);

        // –í—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é
        e.preventDefault();

        // –í–ê–ñ–ù–û: –ø—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–ª –ª–∏ —É–∂–µ —Å–æ–±—ã—Ç–∏–µ –º–∞—Ä–∫–µ—Ä
        if (this._contextMenuHandled) {
          console.log('üéØ Contextmenu —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ –º–∞—Ä–∫–µ—Ä–æ–º - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º canvas –æ–±—Ä–∞–±–æ—Ç–∫—É');
          return;
        }

        // –ò–°–ü–†–ê–í–õ–Ø–ï–ú: –ù–ï –ø—Ä–æ–≤–µ—Ä—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –¥–ª—è contextmenu
        // –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Å–∏—Å—Ç–µ–º—ã –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
        console.log('üéØ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º contextmenu –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –≥–ª–æ–±–∞–ª—å–Ω–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏');
        console.log('üéØ Event target:', e.target.tagName, e.target.className, e.target.id);
        console.log('üéØ Event coordinates:', e.clientX, e.clientY);

        // –ò–°–ü–†–ê–í–õ–Ø–ï–ú: –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏
        console.log('üéØ –ò—Å–ø–æ–ª—å–∑—É–µ–º CoordinateManager –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏');
        const intersection = this.getIntersectionPoint(e);

        if (intersection) {
          console.log('‚úÖ –ü–æ–∑–∏—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∞ —á–µ—Ä–µ–∑ CoordinateManager:', intersection);

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –º–∞—Ä–∫–µ—Ä —Ä—è–¥–æ–º —Å –ø–æ–∑–∏—Ü–∏–µ–π –∫–ª–∏–∫–∞
          const nearestMarker = this.findNearestMarker(intersection);

          if (nearestMarker) {
            console.log('üéØ –ù–ê–ô–î–ï–ù –ú–ê–†–ö–ï–† –†–Ø–î–û–ú! Canvas contextmenu –ù–ê –ú–ê–†–ö–ï–†–ï - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞');
            console.log('üéØ –ú–∞—Ä–∫–µ—Ä –¥–∞–Ω–Ω—ã–µ:', nearestMarker.hotspot.title, 'ID:', nearestMarker.hotspot.id, 'distance:', nearestMarker.distance);
            console.log('üéØ –í–´–ó–´–í–ê–ï–ú handleMarkerRightClick()');

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ü–ï–†–ï–î –≤—ã–∑–æ–≤–æ–º —Ñ—É–Ω–∫—Ü–∏–∏
            this._contextMenuHandled = true;

            this.handleMarkerRightClick(e, nearestMarker.element, nearestMarker.hotspot);

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
            setTimeout(() => {
              this._contextMenuHandled = false;
              console.log('üîÑ –§–ª–∞–≥ _contextMenuHandled —Å–±—Ä–æ—à–µ–Ω –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –º–∞—Ä–∫–µ—Ä–∞');
            }, 300);

            // –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ù–ï–ú–ï–î–õ–ï–ù–ù–û –ü–†–ï–†–´–í–ê–ï–ú –í–´–ü–û–õ–ù–ï–ù–ò–ï
            console.log('üü¢ Canvas contextmenu - –ú–ê–†–ö–ï–† –û–ë–†–ê–ë–û–¢–ê–ù, –ø—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ');
            return;
          }

          // –ú–∞—Ä–∫–µ—Ä –ù–ï –Ω–∞–π–¥–µ–Ω - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é —Å–æ–∑–¥–∞–Ω–∏—è
          console.log('‚ùå –ú–ê–†–ö–ï–† –ù–ï –ù–ê–ô–î–ï–ù! Canvas contextmenu –Ω–∞ –ø—É—Å—Ç–æ–º –º–µ—Å—Ç–µ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é —Å–æ–∑–¥–∞–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞');
          console.log('üéØ –í–´–ó–´–í–ê–ï–ú handleCanvasRightClick()');
          this.handleCanvasRightClick(e);
          return;
        }

        // Intersection –ù–ï –ø–æ–ª—É—á–µ–Ω - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é —Å–æ–∑–¥–∞–Ω–∏—è
        console.log('‚ùå INTERSECTION –ù–ï –ü–û–õ–£–ß–ï–ù! Canvas contextmenu –±–µ–∑ intersection - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é —Å–æ–∑–¥–∞–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞');
        console.log('üéØ –í–´–ó–´–í–ê–ï–ú handleCanvasRightClick()');
        this.handleCanvasRightClick(e);
        return;

      });

      // –î–í–û–ô–ù–û–ô –ö–õ–ò–ö –û–¢–ö–õ–Æ–ß–ï–ù –ü–û –ü–†–û–°–¨–ë–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
      /*
      canvas.addEventListener('dblclick', (e) => {
          console.log('üéØ Canvas dblclick event detected - button:', e.button, 'which:', e.which, 'buttons:', e.buttons);
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –±–ª–æ–∫–∏—Ä–æ–≤–∫—É dblclick
          if (this._dblClickHandled) {
              console.log('üö´ Canvas dblclick –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω - —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–º');
              e.preventDefault();
              return;
          }
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ–ø–∞–ª–∏ –ª–∏ –º—ã –Ω–∞ –º–∞—Ä–∫–µ—Ä
          this.handleCanvasDoubleClick(e);
      });
      */      // –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–´–ô –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ mousedown –≤ CAPTURE —Ñ–∞–∑–µ –¥–ª—è –ú–ì–ù–û–í–ï–ù–ù–û–ô –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
      canvas.addEventListener('mousedown', (e) => {
        // –ú–ì–ù–û–í–ï–ù–ù–ê–Ø –ì–õ–û–ë–ê–õ–¨–ù–ê–Ø –ë–õ–û–ö–ò–†–û–í–ö–ê –ø—Ä–∏ –ø—Ä–∞–≤–æ–º –∫–ª–∏–∫–µ
        const isRightClick = (e.button === 2) || (e.which === 3) || (e.buttons === 2);

        if (isRightClick) {
          // –ù–ï–ú–ï–î–õ–ï–ù–ù–ê–Ø –≥–ª–æ–±–∞–ª—å–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –¢–û–õ–¨–ö–û —Å–∏—Å—Ç–µ–º—ã –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
          // –ù–ï –±–ª–æ–∫–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é!
          window._dragSystemBlocked = true;
          console.log('üî• –ú–ì–ù–û–í–ï–ù–ù–ê–Ø –ì–õ–û–ë–ê–õ–¨–ù–ê–Ø –ë–õ–û–ö–ò–†–û–í–ö–ê —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –¥–ª—è –ø—Ä–∞–≤–æ–≥–æ –∫–ª–∏–∫–∞');

          setTimeout(() => {
            window._dragSystemBlocked = false;
            console.log('üî• –ì–õ–û–ë–ê–õ–¨–ù–ê–Ø –ë–õ–û–ö–ò–†–û–í–ö–ê —Å–Ω—è—Ç–∞ —á–µ—Ä–µ–∑ 200ms');
          }, 200);
        }

        console.log('üéØ Canvas mousedown event detected - button:', e.button, 'which:', e.which, 'buttons:', e.buttons);

        // –§–ª–∞–≥ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ —Å—Ü–µ–Ω–µ
        this._isNavigating = false;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫–ª–∏–∫–Ω—É–ª–∏ –ª–∏ –ø–æ —É–≥–ª—É –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞
        if (!isRightClick) {
          const resizeHandle = this.getResizeHandleAt(e);
          if (resizeHandle && !this._isResizing) {
            console.log('üéØ Canvas –æ–±–Ω–∞—Ä—É–∂–∏–ª –∫–ª–∏–∫ –ø–æ —É–≥–ª—É –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞:', resizeHandle.corner);

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞
            this._currentResizeHandle = resizeHandle;

            // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞
            this.startResize(
              resizeHandle.marker,
              resizeHandle.videoPlane,
              resizeHandle.hotspot,
              resizeHandle.corner,
              e
            );

            e.stopPropagation();
            e.preventDefault();
            return;
          }

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫–ª–∏–∫–Ω—É–ª–∏ –ª–∏ –ø–æ –∫–Ω–æ–ø–∫–µ –≤—Ä–∞—â–µ–Ω–∏—è
          const rotationHandle = this.getRotationHandleAt(e);
          if (rotationHandle) {
            console.log('üéØ Canvas –æ–±–Ω–∞—Ä—É–∂–∏–ª –∫–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ –≤—Ä–∞—â–µ–Ω–∏—è:', rotationHandle.action);

            this.rotateVideoArea(
              rotationHandle.marker,
              rotationHandle.videoPlane,
              rotationHandle.hotspot,
              rotationHandle.action
            );

            e.stopPropagation();
            e.preventDefault();
            return;
          }

          // –¢–û–õ–¨–ö–û –ü–û–°–õ–ï –í–°–ï–• –ü–†–û–í–ï–†–û–ö –ø—Ä–æ–≤–µ—Ä—è–µ–º –∑–æ–Ω—É –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
          const moveZone = this.getMoveZoneAt(e);
          if (moveZone && this.coordinateManager) {
            console.log('üéØ Canvas –æ–±–Ω–∞—Ä—É–∂–∏–ª –∫–ª–∏–∫ –ø–æ –∑–æ–Ω–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è');

            // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏
            this.coordinateManager.startVideoAreaDragging(
              moveZone.marker,
              moveZone.videoPlane,
              moveZone.hotspot,
              e
            );

            e.stopPropagation();
            e.preventDefault();
            return;
          }

          // –ï—Å–ª–∏ –Ω–µ –ø–æ–ø–∞–ª–∏ –Ω–∏ –≤ –∫–∞–∫—É—é —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é –∑–æ–Ω—É - —ç—Ç–æ –Ω–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Å—Ü–µ–Ω–µ
          if (!isRightClick) {
            console.log('üéØ –ù–∞—á–∏–Ω–∞–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é –ø–æ —Å—Ü–µ–Ω–µ (–ª–µ–≤–∞—è –∫–Ω–æ–ø–∫–∞ –º—ã—à–∏)');
            this._isNavigating = true;

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫—É—Ä—Å–æ—Ä –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
            canvas.style.cursor = 'move';
            document.body.style.cursor = 'move';
            console.log('üîÑ –ö—É—Ä—Å–æ—Ä –∏–∑–º–µ–Ω–µ–Ω –Ω–∞: move (–Ω–∞–≤–∏–≥–∞—Ü–∏—è)');
          }
        }

        if (isRightClick) {
          console.log('üéØ Canvas –û–ü–†–ï–î–ï–õ–ò–õ –ø—Ä–∞–≤—ã–π –∫–ª–∏–∫ —á–µ—Ä–µ–∑ mousedown');

          // –ê–ì–†–ï–°–°–ò–í–ù–ê–Ø –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –¥–ª—è –ø—Ä–∞–≤–æ–≥–æ –∫–ª–∏–∫–∞
          this._blockDraggingForRightClick = true;
          this._rightClickInProgress = true;
          this._lastRightClickTime = Date.now(); // –í–∞–∂–Ω–æ –¥–ª—è CoordinateManager

          // –£–≤–µ–¥–æ–º–ª—è–µ–º CoordinateManager –æ –ø—Ä–∞–≤–æ–º –∫–ª–∏–∫–µ
          if (this.coordinateManager) {
            this.coordinateManager._rightClickDetected = true;
            setTimeout(() => {
              this.coordinateManager._rightClickDetected = false;
            }, 500);
          }

          // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –Ω–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–µ –≤—Ä–µ–º—è
          setTimeout(() => {
            this._blockDraggingForRightClick = false;
            this._rightClickInProgress = false;
          }, 800);

          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–∞–≤–æ–º –∫–ª–∏–∫–µ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ contextmenu
          this._rightClickDetected = true;
          setTimeout(() => {
            this._rightClickDetected = false;
          }, 1500);
        }
      }, true); // CAPTURE —Ñ–∞–∑–∞ - –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û –¥–ª—è –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞ –ü–ï–†–ï–î A-Frame!

      // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ mousemove –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫—É—Ä—Å–æ—Ä–∞
      canvas.addEventListener('mousemove', (e) => {
        // –ò–°–ü–†–ê–í–õ–Ø–ï–ú: —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é –º—ã—à–∏ –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–∏ isMouseOverMarker
        window._lastMousePosition = { x: e.clientX, y: e.clientY };

        if (this._isResizing || (this.coordinateManager && this.coordinateManager.isDragging)) {
          return; // –ù–µ –º–µ–Ω—è–µ–º –∫—É—Ä—Å–æ—Ä –≤–æ –≤—Ä–µ–º—è –æ–ø–µ—Ä–∞—Ü–∏–π
        }

        // –ï—Å–ª–∏ –∏–¥–µ—Ç –Ω–∞–≤–∏–≥–∞—Ü–∏—è - –æ—Å—Ç–∞–≤–ª—è–µ–º –∫—É—Ä—Å–æ—Ä move
        if (this._isNavigating) {
          return; // –ù–µ –º–µ–Ω—è–µ–º –∫—É—Ä—Å–æ—Ä –≤–æ –≤—Ä–µ–º—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        }

        let newCursor = 'default';

        // –í–ê–ñ–ù–û: –ø—Ä–æ–≤–µ—Ä—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É - –æ—Ç —Å–∞–º—ã—Ö —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏—Ö –∫ –æ–±—â–∏–º

        // 1. –£–≥–ª—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ (—Å–∞–º—ã–π –≤—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
        const resizeHandle = this.getResizeHandleAt(e);
        if (resizeHandle) {
          const corner = resizeHandle.corner;
          console.log('üéØ –ö—É—Ä—Å–æ—Ä –Ω–∞ —É–≥–ª—É –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞:', corner, resizeHandle.handle.getAttribute('data-corner'));
          switch (corner) {
            case 'top-left':
              newCursor = 'nw-resize';
              console.log('üéØ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫—É—Ä—Å–æ—Ä nw-resize –¥–ª—è top-left');
              break;
            case 'top-right':
              newCursor = 'ne-resize';
              console.log('üéØ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫—É—Ä—Å–æ—Ä ne-resize –¥–ª—è top-right');
              break;
            case 'bottom-left':
              newCursor = 'ne-resize';
              console.log('üéØ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫—É—Ä—Å–æ—Ä ne-resize –¥–ª—è bottom-left');
              break;
            case 'bottom-right':
              newCursor = 'nw-resize';
              console.log('üéØ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫—É—Ä—Å–æ—Ä nw-resize –¥–ª—è bottom-right');
              break;
          }
        } else {
          // 2. –ö–Ω–æ–ø–∫–∏ –≤—Ä–∞—â–µ–Ω–∏—è
          const rotationHandle = this.getRotationHandleAt(e);
          if (rotationHandle) {
            console.log('üéØ –ö—É—Ä—Å–æ—Ä –Ω–∞ –∫–æ–Ω—Ç—Ä–æ–ª–µ –≤—Ä–∞—â–µ–Ω–∏—è:', rotationHandle.action);
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—É—Ä—Å–æ—Ä—ã —Å –∫—Ä—É–≥–ª—ã–º–∏ —Å—Ç—Ä–µ–ª–∫–∞–º–∏ –¥–ª—è –ø–æ–≤–æ—Ä–æ—Ç–æ–≤
            if (rotationHandle.action === 'rotate-left') {
              newCursor = 'url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'24\' height=\'24\' viewBox=\'0 0 24 24\'%3E%3Cpath d=\'M12,5V1L7,6L12,11V7A6,6 0 0,1 18,13A6,6 0 0,1 12,19A6,6 0 0,1 6,13H4A8,8 0 0,0 12,21A8,8 0 0,0 20,13A8,8 0 0,0 12,5Z\' fill=\'%23ffffff\'/%3E%3C/svg%3E") 12 12, auto';
              console.log('üéØ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫—É—Ä—Å–æ—Ä –ø–æ–≤–æ—Ä–æ—Ç–∞ –ø—Ä–æ—Ç–∏–≤ —á–∞—Å–æ–≤–æ–π —Å—Ç—Ä–µ–ª–∫–∏');
            } else if (rotationHandle.action === 'rotate-right') {
              newCursor = 'url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'24\' height=\'24\' viewBox=\'0 0 24 24\'%3E%3Cpath d=\'M12,5V1L17,6L12,11V7A6,6 0 0,0 6,13A6,6 0 0,0 12,19A6,6 0 0,0 18,13H20A8,8 0 0,1 12,21A8,8 0 0,1 4,13A8,8 0 0,1 12,5Z\' fill=\'%23ffffff\'/%3E%3C/svg%3E") 12 12, auto';
              console.log('üéØ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫—É—Ä—Å–æ—Ä –ø–æ–≤–æ—Ä–æ—Ç–∞ –ø–æ —á–∞—Å–æ–≤–æ–π —Å—Ç—Ä–µ–ª–∫–µ');
            } else {
              newCursor = 'ew-resize'; // fallback
            }
          } else {
            // 3. –ó–æ–Ω–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è (—Å–∞–º—ã–π –Ω–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
            const moveZone = this.getMoveZoneAt(e);
            if (moveZone) {
              console.log('üéØ –ö—É—Ä—Å–æ—Ä –Ω–∞ –∑–æ–Ω–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è');
              newCursor = 'move';
            }
          }
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –∫—É—Ä—Å–æ—Ä —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω –∏–∑–º–µ–Ω–∏–ª—Å—è
        if (canvas.style.cursor !== newCursor) {
          canvas.style.cursor = newCursor;
          document.body.style.cursor = newCursor; // –î—É–±–ª–∏—Ä—É–µ–º –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
          console.log('üîÑ –ö—É—Ä—Å–æ—Ä –∏–∑–º–µ–Ω–µ–Ω –Ω–∞:', newCursor);
        }
      });

      // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ mouseup –¥–ª—è —Å–±—Ä–æ—Å–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
      canvas.addEventListener('mouseup', (e) => {
        if (this._isNavigating) {
          console.log('üéØ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ —Å—Ü–µ–Ω–µ');
          this._isNavigating = false;

          // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫—É—Ä—Å–æ—Ä –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
          canvas.style.cursor = 'default';
          document.body.style.cursor = 'default';
          console.log('üîÑ –ö—É—Ä—Å–æ—Ä —Å–±—Ä–æ—à–µ–Ω –Ω–∞: default (–∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏)');
        }
      });

      // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ mouseleave –¥–ª—è —Å–±—Ä–æ—Å–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø—Ä–∏ —É—Ö–æ–¥–µ –º—ã—à–∏ —Å canvas
      canvas.addEventListener('mouseleave', (e) => {
        if (this._isNavigating) {
          console.log('üéØ –ú—ã—à—å –ø–æ–∫–∏–Ω—É–ª–∞ canvas - –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏');
          this._isNavigating = false;

          // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫—É—Ä—Å–æ—Ä –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
          canvas.style.cursor = 'default';
          document.body.style.cursor = 'default';
          console.log('üîÑ –ö—É—Ä—Å–æ—Ä —Å–±—Ä–æ—à–µ–Ω –Ω–∞: default (–º—ã—à—å –ø–æ–∫–∏–Ω—É–ª–∞ canvas)');
        }
      });
    }

    // –î–æ–±–∞–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –¥–ª—è –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –∑–∞–∫—Ä—ã—Ç–∏—è –º–µ–Ω—é
    document.addEventListener('keydown', (e) => {
      // Escape - –∑–∞–∫—Ä—ã—Ç–∏–µ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã—Ö –º–µ–Ω—é
      if (e.key === 'Escape') {
        console.log('üéØ –ù–∞–∂–∞—Ç–∞ –∫–ª–∞–≤–∏—à–∞ Escape - –∑–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –º–µ–Ω—é');
        this.hideAllContextMenus();
        this.cleanupAutoCloseHandlers();
        e.preventDefault();
        return;
      }

      // E + –º–∞—Ä–∫–µ—Ä –ø–æ–¥ –∫—É—Ä—Å–æ—Ä–æ–º = —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
      if (e.key === 'e' || e.key === 'E' || e.key === '—É' || e.key === '–£') {
        console.log('üéØ –ù–∞–∂–∞—Ç–∞ –∫–ª–∞–≤–∏—à–∞ E –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');

        // –ù–∞—Ö–æ–¥–∏–º –º–∞—Ä–∫–µ—Ä –ø–æ–¥ –∫—É—Ä—Å–æ—Ä–æ–º –º—ã—à–∏
        this.editMarkerUnderCursor();
      }
    });
  }

  handleMarkerRightClick(event, markerElement, hotspot) {
    console.log('üü¢ ===== –ù–ê–ß–ê–õ–û handleMarkerRightClick =====');
    console.log('üéØ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø—Ä–∞–≤—ã–π –∫–ª–∏–∫ –Ω–∞ –º–∞—Ä–∫–µ—Ä–µ:', hotspot.title, 'ID:', hotspot.id);

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –º–∞—Ä–∫–µ—Ä–∞ (—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
    console.log('üéØ –í—ã–∑—ã–≤–∞–µ–º showMarkerContextMenu –¥–ª—è –º–∞—Ä–∫–µ—Ä–∞:', hotspot.title);
    console.log('üéØ –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –º–µ–Ω—é:', event.clientX, event.clientY);
    this.showMarkerContextMenu(event.clientX, event.clientY, hotspot);
    console.log('‚úÖ showMarkerContextMenu –≤—ã–∑–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ');

    console.log('üü¢ ===== –ö–û–ù–ï–¶ handleMarkerRightClick =====');

    // –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –¥–∞–ª—å–Ω–µ–π—à–µ–µ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è
    event.stopPropagation();
    event.preventDefault();
  }

  handleCanvasRightClick(event) {
    // –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê: –±–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–∞–≤—ã—Ö –∫–ª–∏–∫–æ–≤
    console.log('üî¥ ===== –ù–ê–ß–ê–õ–û handleCanvasRightClick =====');
    console.log('üéØ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø—Ä–∞–≤—ã–π –∫–ª–∏–∫ –Ω–∞ canvas');

    // –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ø—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª–æ –ª–∏ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é
    if (this._contextMenuHandled) {
      console.log('üö´ Canvas –ø—Ä–∞–≤—ã–π –∫–ª–∏–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω - –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ');
      return;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ª–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ
    if (this.coordinateManager && this.coordinateManager.isDragging) {
      console.log('üö´ Canvas –ø—Ä–∞–≤—ã–π –∫–ª–∏–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω - –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ');
      return;
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ—Å–ª–µ–¥–Ω–µ–º –º–∞—Ä–∫–µ—Ä–µ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
    if (!this._lastHoveredMarker) {
      this._lastHoveredMarker = null;
    }

    // –ï—Å–ª–∏ –º—ã –¥–æ—à–ª–∏ –¥–æ —Å—é–¥–∞, —Ç–æ —ç—Ç–æ –∫–ª–∏–∫ –Ω–∞ –ø—É—Å—Ç–æ–º –º–µ—Å—Ç–µ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—ã—á–Ω–æ–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é
    console.log('üéØ –ü—Ä–∞–≤—ã–π –∫–ª–∏–∫ –Ω–∞ –ø—É—Å—Ç–æ–º –º–µ—Å—Ç–µ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—ã—á–Ω–æ–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –°–û–ó–î–ê–ù–ò–Ø');
    console.log('üéØ –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –º–µ–Ω—é:', event.clientX, event.clientY);
    this.showContextMenu(event.clientX, event.clientY);
    console.log('‚úÖ showContextMenu (—Å–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤) –≤—ã–∑–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ');
    console.log('üî¥ ===== –ö–û–ù–ï–¶ handleCanvasRightClick =====');
  }

  handleCanvasDoubleClick(event) {
    // –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê: –±–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–≤–æ–π–Ω—ã—Ö –∫–ª–∏–∫–æ–≤
    console.log('üéØ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –Ω–∞ canvas');

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ª–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ
    if (this.coordinateManager && this.coordinateManager.isDragging) {
      console.log('üö´ Canvas –¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω - –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ');
      return;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ –∫–ª–∏–∫ –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ –Ω–∞ –º–∞—Ä–∫–µ—Ä–µ (—á–µ—Ä–µ–∑ event.target)
    const target = event.target;
    if (target && target.closest && target.closest('.interactive')) {
      console.log('üö´ Canvas dblclick –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω - –∫–ª–∏–∫ –±—ã–ª –Ω–∞ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–º —ç–ª–µ–º–µ–Ω—Ç–µ');
      return;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –º–∞—Ä–∫–µ—Ä—ã —Å –≤–∏–¥–∏–º—ã–º–∏ tooltip'–∞–º–∏ (–æ–Ω–∏ –ø–æ–¥ –∫—É—Ä—Å–æ—Ä–æ–º)
    const markers = this.aframeScene.querySelectorAll('[data-hotspot-id]');
    let targetMarker = null;

    markers.forEach(markerEl => {
      if (markerEl._tooltipVisible) {
        const hotspotId = markerEl.getAttribute('data-hotspot-id');
        const hotspot = this.hotspotManager ? this.hotspotManager.findHotspotById(hotspotId) : null;
        if (hotspot) {
          targetMarker = { element: markerEl, hotspot: hotspot };
        }
      }
    });

    if (targetMarker) {
      console.log('üéØ Canvas –†–ï–ó–ï–†–í–ù–ê–Ø –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–≤–æ–π–Ω–æ–≥–æ –∫–ª–∏–∫–∞ –Ω–∞ –º–∞—Ä–∫–µ—Ä–µ (–ø–æ tooltip):', targetMarker.hotspot.title);

      event.preventDefault();

      if (this.hotspotManager) {
        console.log('‚úÖ –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä –º–∞—Ä–∫–µ—Ä–∞ —á–µ—Ä–µ–∑ —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ canvas (–ø–æ tooltip)');
        this.hotspotManager.editHotspot(targetMarker.hotspot.id);
      }
      return;
    }

    // Fallback: –ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ —á–µ—Ä–µ–∑ intersection point
    const intersection = this.getIntersectionPoint(event);
    if (intersection) {
      // –ù–∞—Ö–æ–¥–∏–º –±–ª–∏–∂–∞–π—à–∏–π –º–∞—Ä–∫–µ—Ä –∫ —Ç–æ—á–∫–µ –∫–ª–∏–∫–∞
      const marker = this.findNearestMarker(intersection);
      if (marker && marker.hotspot) {
        console.log('üéØ Canvas –†–ï–ó–ï–†–í–ù–ê–Ø –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–≤–æ–π–Ω–æ–≥–æ –∫–ª–∏–∫–∞ –Ω–∞ –º–∞—Ä–∫–µ—Ä–µ (–ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º):', marker.hotspot.title);

        event.preventDefault();

        if (this.hotspotManager) {
          console.log('‚úÖ –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä –º–∞—Ä–∫–µ—Ä–∞ —á–µ—Ä–µ–∑ —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ canvas (–ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º)');
          this.hotspotManager.editHotspot(marker.hotspot.id);
        }
        return;
      }
    }

    console.log('‚ö†Ô∏è –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –Ω–µ –Ω–∞ –º–∞—Ä–∫–µ—Ä–µ');
    // –ï—Å–ª–∏ –º—ã –∑–¥–µ—Å—å, —Ç–æ double click –±—ã–ª –Ω–µ –Ω–∞ –º–∞—Ä–∫–µ—Ä–µ
  }

  findNearestMarker(position) {
    // –ù–∞—Ö–æ–¥–∏–º –º–∞—Ä–∫–µ—Ä –±–ª–∏–∂–∞–π—à–∏–π –∫ —É–∫–∞–∑–∞–Ω–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏
    console.log('üéØ –ü–æ–∏—Å–∫ –±–ª–∏–∂–∞–π—à–µ–≥–æ –º–∞—Ä–∫–µ—Ä–∞ –∫ –ø–æ–∑–∏—Ü–∏–∏:', position);

    const markers = this.aframeScene.querySelectorAll('[data-hotspot-id]');
    let nearestMarker = null;
    let nearestDistance = Infinity;

    console.log('üéØ –ü—Ä–æ–≤–µ—Ä—è–µ–º', markers.length, '–º–∞—Ä–∫–µ—Ä–æ–≤ –≤ —Å—Ü–µ–Ω–µ');

    markers.forEach((markerEl, index) => {
      const markerPosition = markerEl.getAttribute('position');
      if (markerPosition) {
        const distance = this.calculateDistance(position, markerPosition);
        console.log(`üéØ –ú–∞—Ä–∫–µ—Ä ${index}:`, markerEl.getAttribute('data-hotspot-id'),
          '–ø–æ–∑–∏—Ü–∏—è:', markerPosition, '—Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ:', distance.toFixed(3));

        if (distance < nearestDistance && distance < 1.5) { // –£–í–ï–õ–ò–ß–ò–õ–ò —Å 0.8 –¥–æ 1.5 –¥–ª—è –ª—É—á—à–µ–≥–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–æ–≤
          nearestDistance = distance;
          const hotspotId = markerEl.getAttribute('data-hotspot-id');
          const hotspot = this.hotspotManager ? this.hotspotManager.findHotspotById(hotspotId) : null;
          if (hotspot) {
            nearestMarker = {
              element: markerEl,
              hotspot: hotspot,
              distance: distance
            };
            console.log('‚úÖ –ù–∞–π–¥–µ–Ω –±–æ–ª–µ–µ –±–ª–∏–∑–∫–∏–π –º–∞—Ä–∫–µ—Ä:', hotspot.title, '—Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ:', distance.toFixed(3));
          }
        }
      }
    });

    if (nearestMarker) {
      console.log('üéØ –ò—Ç–æ–≥–æ–≤—ã–π –±–ª–∏–∂–∞–π—à–∏–π –º–∞—Ä–∫–µ—Ä:', nearestMarker.hotspot.title, '—Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ:', nearestMarker.distance.toFixed(3));
      return nearestMarker;
    } else {
      console.log('‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω–æ –º–∞—Ä–∫–µ—Ä–æ–≤ –≤ —Ä–∞–¥–∏—É—Å–µ 1.5 –µ–¥–∏–Ω–∏—Ü');
      return null;
    }
  }

  editMarkerUnderCursor() {
    // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –º–∞—Ä–∫–µ—Ä—ã —Å –≤–∏–¥–∏–º—ã–º–∏ tooltip'–∞–º–∏ (–æ–Ω–∏ –ø–æ–¥ –∫—É—Ä—Å–æ—Ä–æ–º)
    const markers = this.aframeScene.querySelectorAll('[data-hotspot-id]');
    let targetMarker = null;

    markers.forEach(markerEl => {
      if (markerEl._tooltipVisible) {
        const hotspotId = markerEl.getAttribute('data-hotspot-id');
        const hotspot = this.hotspotManager ? this.hotspotManager.findHotspotById(hotspotId) : null;
        if (hotspot) {
          targetMarker = { element: markerEl, hotspot: hotspot };
        }
      }
    });

    if (targetMarker) {
      console.log('üéØ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞ –ø–æ–¥ –∫—É—Ä—Å–æ—Ä–æ–º (–∫–ª–∞–≤–∏—à–∞ E):', targetMarker.hotspot.title);
      if (this.hotspotManager) {
        this.hotspotManager.editHotspot(targetMarker.hotspot.id);
      }
    } else {
      console.log('‚ö†Ô∏è –ù–µ—Ç –º–∞—Ä–∫–µ—Ä–∞ –ø–æ–¥ –∫—É—Ä—Å–æ—Ä–æ–º –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
    }
  }

  calculateDistance(pos1, pos2) {
    const dx = pos1.x - pos2.x;
    const dy = pos1.y - pos2.y;
    const dz = pos1.z - pos2.z;
    return Math.sqrt(dx * dx + dy * dy + dz * dz);
  }

  async setPanorama(imageSrc) {
    if (!this.aframeSky) {
      console.error('A-Frame sky —ç–ª–µ–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
      return false;
    }

    try {
      console.log('üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–∞–Ω–æ—Ä–∞–º—É:', imageSrc);

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –ø–∞–Ω–æ—Ä–∞–º—ã
      this.showGlobalLoading('–ó–∞–≥—Ä—É–∑–∫–∞ –ø–∞–Ω–æ—Ä–∞–º—ã...');

      // –°–ø—Ä—è—Ç–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ–∫—Å—Ç—É—Ä—ã/–æ—à–∏–±–∫–∏/—Ç–∞–π–º-–∞—É—Ç–∞
      let hideTimer = setTimeout(() => {
        console.warn('‚è±Ô∏è –¢–∞–π–º-–∞—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø–∞–Ω–æ—Ä–∞–º—ã');
        this.hideGlobalLoading();
      }, 10000);

      const onTextureLoadedOnce = () => {
        clearTimeout(hideTimer);
        this.hideGlobalLoading();
        this.aframeSky.removeEventListener('materialtextureloaded', onTextureLoadedOnce);
      };
      this.aframeSky.addEventListener('materialtextureloaded', onTextureLoadedOnce, { once: true });

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ Data URL (–∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ñ–∞–π–ª)
      if (imageSrc.startsWith('data:')) {
        console.log('‚úÖ –û–±–Ω–∞—Ä—É–∂–µ–Ω Data URL, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞–ø—Ä—è–º—É—é');

        // –£–±–∏—Ä–∞–µ–º —Ü–≤–µ—Ç –ø–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        this.aframeSky.removeAttribute('color');

        // –ü–æ–ø—Ä–æ–±—É–µ–º —Å–Ω–∞—á–∞–ª–∞ –Ω–∞–ø—Ä—è–º—É—é —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Data URL
        try {
          this.aframeSky.setAttribute('src', imageSrc);
          this.aframeSky.setAttribute('opacity', '1');
          this.currentPanorama = imageSrc;
          console.log('‚úÖ –ü–∞–Ω–æ—Ä–∞–º–∞ –∏–∑ Data URL –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –Ω–∞–ø—Ä—è–º—É—é');
          return true;
        } catch (error) {
          console.warn('‚ö†Ô∏è –ü—Ä—è–º–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ Data URL –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∞, –ø—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ blob:', error);

          // Fallback: –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º Data URL –≤ blob URL
          try {
            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º data URL –≤ blob
            const response = await fetch(imageSrc);
            const blob = await response.blob();
            const blobUrl = URL.createObjectURL(blob);

            this.aframeSky.setAttribute('src', blobUrl);
            this.aframeSky.setAttribute('opacity', '1');
            this.currentPanorama = imageSrc;

            // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º blob URL —á–µ—Ä–µ–∑ –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è
            setTimeout(() => {
              URL.revokeObjectURL(blobUrl);
            }, 5000);

            console.log('‚úÖ –ü–∞–Ω–æ—Ä–∞–º–∞ –∏–∑ Data URL –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —á–µ—Ä–µ–∑ blob URL');
            return true;
          } catch (blobError) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –≤ blob URL:', blobError);
            clearTimeout(hideTimer);
            this.hideGlobalLoading();
            return false;
          }
        }
      }

      // –ï—Å–ª–∏ —ç—Ç–æ URL —Ñ–∞–π–ª–∞, –ø—Ä–æ–≤–µ—Ä—è–µ–º –µ–≥–æ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å
      console.log('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ñ–∞–π–ª–∞:', imageSrc);
      const response = await fetch(imageSrc, { method: 'HEAD' });

      if (!response.ok) {
        throw new Error(`–§–∞–π–ª –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: ${response.status} ${response.statusText}`);
      }

      // –£–±–∏—Ä–∞–µ–º —Ü–≤–µ—Ç –ø–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
      this.aframeSky.removeAttribute('color');
      this.aframeSky.setAttribute('src', imageSrc);
      this.aframeSky.setAttribute('opacity', '1'); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–µ–±–æ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
      this.currentPanorama = imageSrc;
      console.log('‚úÖ –ü–∞–Ω–æ—Ä–∞–º–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ:', imageSrc);
      return true;

    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–∞–Ω–æ—Ä–∞–º—ã:', error.message);
      console.error('üìÅ –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É:', imageSrc);
      this.hideGlobalLoading();
      return false;
    }
  }

  // === –ê–≤—Ç–æ—Ä–æ—Ç–∞—Ü–∏—è –∫–∞–º–µ—Ä—ã ===
  enableAutorotate(enabled, speed = null, idleDelay = null) {
    this.autorotateEnabled = !!enabled;
    if (speed !== null && !isNaN(speed)) this.autorotateSpeed = speed;
    if (idleDelay !== null && !isNaN(idleDelay)) this.autorotateIdleDelay = idleDelay;

    if (this.autorotateEnabled) {
      this._startAutorotateLoop();
    } else {
      this._stopAutorotateLoop();
    }
  }

  _setupAutorotateUserInteractivity() {
    const onInteract = () => {
      this._lastUserInteraction = Date.now();
      this._autorotatePaused = true;
    };
    const sceneEl = this.aframeScene;
    if (!sceneEl) return;
    const canvas = sceneEl.querySelector('canvas');
    const target = canvas || sceneEl;
    ['mousedown', 'wheel', 'touchstart', 'keydown'].forEach(evt => {
      target.addEventListener(evt, onInteract, { passive: true });
    });
  }

  _startAutorotateLoop() {
    if (this._autorotateRaf) return;
    this._autorotatePaused = false;
    this._autorotateLastTs = performance.now();
    const loop = (ts) => {
      if (!this.autorotateEnabled) { this._autorotateRaf = null; return; }
      const dt = Math.max(0, (ts - this._autorotateLastTs) / 1000);
      this._autorotateLastTs = ts;

      // –í–æ–∑–æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å–ª–µ –ø–∞—É–∑—ã –ø–æ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ idleDelay
      if (this._autorotatePaused) {
        if (Date.now() - this._lastUserInteraction >= this.autorotateIdleDelay) {
          this._autorotatePaused = false;
        }
      }

      if (!this._autorotatePaused && this.aframeCamera) {
        const rot = this.aframeCamera.getAttribute('rotation') || { x: 0, y: 0, z: 0 };
        const newY = rot.y + (this.autorotateSpeed * (180 / Math.PI)) * dt; // –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Ä–∞–¥/—Å–µ–∫ –≤ –≥—Ä–∞–¥/—Å–µ–∫
        this.aframeCamera.setAttribute('rotation', `${rot.x} ${newY} ${rot.z}`);
      }

      this._autorotateRaf = requestAnimationFrame(loop);
    };
    this._autorotateRaf = requestAnimationFrame(loop);
  }

  _stopAutorotateLoop() {
    if (this._autorotateRaf) {
      cancelAnimationFrame(this._autorotateRaf);
      this._autorotateRaf = null;
    }
  }

  /**
   * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–Ω–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞
   */
  initializeCoordinateManager() {
    this.coordinateManager.initialize(this.aframeScene);
    console.log('üìê –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
  }

  setupEventHandlers() {
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–∞–≤–æ–≥–æ –∫–ª–∏–∫–∞ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é
    this.container.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      this.showContextMenu(e.clientX, e.clientY, e);
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é –ø—Ä–∏ –æ–±—ã—á–Ω–æ–º –∫–ª–∏–∫–µ
    this.container.addEventListener('click', (e) => {
      // –ü–û–õ–ù–û–°–¢–¨–Æ –û–¢–ö–õ–Æ–ß–ê–ï–ú –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ
      // –¢–µ–ø–µ—Ä—å –º–µ–Ω—é –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ auto-close –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
      console.log('üõ°Ô∏è –ì–õ–û–ë–ê–õ–¨–ù–´–ô –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ click - –ù–ï –∑–∞–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é (–ø–æ–ª–Ω–∞—è –∑–∞—â–∏—Ç–∞)');

      // –ù–ï –≤—ã–∑—ã–≤–∞–µ–º this.hideContextMenu() - –ø—É—Å—Ç—å –º–µ–Ω—é –æ—Å—Ç–∞–µ—Ç—Å—è –≤–∏–¥–∏–º—ã–º
      // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ auto-close –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤ showMarkerContextMenu
    });
  }

  showContextMenu(x, y, event) {
    console.log('üî¥ ===== –ù–ê–ß–ê–õ–û showContextMenu (—Å–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤) =====');
    console.log('üéØ –ü–û–ö–ê–ó–´–í–ê–ï–ú –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –°–û–ó–î–ê–ù–ò–Ø –º–∞—Ä–∫–µ—Ä–æ–≤, –ø–æ–∑–∏—Ü–∏—è:', x, y);

    // –°–ï–õ–ï–ö–¢–ò–í–ù–û–ï —É–¥–∞–ª–µ–Ω–∏–µ: —É–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ –æ–±—ã—á–Ω—ã–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –º–µ–Ω—é, –ù–ï —Ç—Ä–æ–≥–∞–µ–º –º–µ–Ω—é –º–∞—Ä–∫–µ—Ä–æ–≤
    const existingGeneralMenus = document.querySelectorAll('.custom-context-menu');
    existingGeneralMenus.forEach(menu => {
      console.log('üóëÔ∏è –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ –æ–±—â–µ–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é');
      menu.remove();
    });

    const menu = document.createElement('div');
    menu.className = 'custom-context-menu';
    menu.style.left = x + 'px';
    menu.style.top = y + 'px';

    menu.innerHTML = `
            <button data-type="hotspot">üîó –•–æ—Ç—Å–ø–æ—Ç</button>
            <button data-type="info-point">‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ç–æ—á–∫–∞</button>
            <button data-type="video-area">üé¨ –í–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç—å</button>
      <button data-type="animated-object">üß© –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç</button>
        `;

    document.body.appendChild(menu);

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –º–µ–Ω—é
    menu.querySelectorAll('button').forEach(btn => {
      btn.addEventListener('click', () => {
        const type = btn.dataset.type;

        // –ü–æ–ª—É—á–∞–µ–º 3D –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–ª–∏–∫–∞
        const intersection = this.getIntersectionPoint(event);
        if (!intersection) {
          console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–æ—á–∫—É –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è.");
          return;
        }

        // –í—ã–∑—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏–µ –¥–ª—è main.js
        const customEvent = new CustomEvent('context-menu-add-hotspot', {
          detail: { type, position: `${intersection.x} ${intersection.y} ${intersection.z}` }
        });
        this.container.dispatchEvent(customEvent);

        menu.remove();
      });
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
    setTimeout(() => {
      const closeHandler = (e) => {
        if (!menu.contains(e.target)) {
          menu.remove();
          document.removeEventListener('click', closeHandler);
        }
      };
      document.addEventListener('click', closeHandler);
    }, 0);
  }

  hideContextMenu() {
    // –°–ï–õ–ï–ö–¢–ò–í–ù–û–ï –∑–∞–∫—Ä—ã—Ç–∏–µ: –∑–∞–∫—Ä—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –æ–±—ã—á–Ω—ã–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –º–µ–Ω—é
    const generalMenus = document.querySelectorAll('.custom-context-menu');
    generalMenus.forEach(menu => {
      console.log('üóëÔ∏è –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ–±—â–µ–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é');
      menu.remove();
    });
  }

  /**
   * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∫–ª–∏–∫–Ω—É–ª–∏ –ª–∏ –ø–æ —É–≥–ª—É –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏
   */
  getResizeHandleAt(event) {
    const camera = this.aframeCamera;
    const scene = this.aframeScene;

    if (!camera || !scene || typeof THREE === 'undefined') {
      return null;
    }

    const rect = scene.canvas.getBoundingClientRect();
    const x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
    const y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2(x, y);
    raycaster.setFromCamera(mouse, camera.getObject3D('camera'));

    // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ —É–≥–ª—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞
    const resizeHandles = this.aframeScene.querySelectorAll('.resize-handle');
    const intersectableObjects = [];

    resizeHandles.forEach(handle => {
      if (handle.object3D && handle.getAttribute('visible') !== 'false') {
        intersectableObjects.push(handle.object3D);
        // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º —Å–≤—è–∑—å –º–µ–∂–¥—É object3D –∏ —ç–ª–µ–º–µ–Ω—Ç–æ–º
        handle.object3D.userData.element = handle;
      }
    });

    if (intersectableObjects.length === 0) {
      return null;
    }

    const intersects = raycaster.intersectObjects(intersectableObjects, true);

    if (intersects.length > 0) {
      // –ò–°–ü–†–ê–í–õ–Ø–ï–ú: –±–µ—Ä–µ–º –°–ê–ú–û–ï –ë–õ–ò–ó–ö–û–ï –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ resize handle
      const closest = intersects[0];
      const handleElement = closest.object.userData?.element || closest.object.parent?.userData?.element;

      if (handleElement && handleElement.classList.contains('resize-handle')) {
        const corner = handleElement.getAttribute('data-corner');
        const markerEl = handleElement.parentElement;

        if (corner && markerEl) {
          console.log('üéØ –û–±–Ω–∞—Ä—É–∂–µ–Ω –∫–ª–∏–∫ –ø–æ —É–≥–ª—É –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞:', corner);

          // –ù–∞—Ö–æ–¥–∏–º –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç—å –≤ —ç—Ç–æ–º –º–∞—Ä–∫–µ—Ä–µ
          const videoPlane = markerEl.querySelector('[data-video-plane]');

          if (videoPlane) {
            // –ù–∞—Ö–æ–¥–∏–º hotspot –ø–æ ID –º–∞—Ä–∫–µ—Ä–∞
            const markerId = markerEl.getAttribute('data-marker-id');
            let hotspot = null;

            if (markerId && this.hotspotManager) {
              hotspot = this.hotspotManager.findHotspotById(markerId);
            }

            return {
              corner,
              handle: handleElement,
              marker: markerEl,
              videoPlane,
              hotspot,
              distance: closest.distance
            };
          }
        }
      }
    }

    return null;
  }

  /**
   * –í—ã–ø–æ–ª–Ω—è–µ—Ç raycast –∏–∑ –ø–æ–∑–∏—Ü–∏–∏ –º—ã—à–∏ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è
   */
  raycastFromMouse(event) {
    const camera = this.aframeCamera;
    const scene = this.aframeScene;

    if (!camera || !scene || typeof THREE === 'undefined') {
      return [];
    }

    const rect = scene.canvas.getBoundingClientRect();
    const x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
    const y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2(x, y);
    raycaster.setFromCamera(mouse, camera.getObject3D('camera'));

    // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –æ–±—ä–µ–∫—Ç—ã —Å—Ü–µ–Ω—ã –¥–ª—è –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è
    const intersectableObjects = [];

    scene.querySelectorAll('a-entity').forEach(entity => {
      if (entity.object3D && entity.getAttribute('visible') !== 'false') {
        intersectableObjects.push(entity.object3D);
        entity.object3D.userData.element = entity;
      }
    });

    const intersects = raycaster.intersectObjects(intersectableObjects, true);
    return intersects;
  }

  /**
   * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∫–ª–∏–∫–Ω—É–ª–∏ –ª–∏ –ø–æ –∫–Ω–æ–ø–∫–µ –≤—Ä–∞—â–µ–Ω–∏—è –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏
   */
  getRotationHandleAt(event) {
    const camera = this.aframeCamera;
    const scene = this.aframeScene;

    if (!camera || !scene || typeof THREE === 'undefined') {
      return null;
    }

    const rect = scene.canvas.getBoundingClientRect();
    const x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
    const y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2(x, y);
    raycaster.setFromCamera(mouse, camera.getObject3D('camera'));

    // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –∫–Ω–æ–ø–∫–∏ –≤—Ä–∞—â–µ–Ω–∏—è
    const rotationHandles = this.aframeScene.querySelectorAll('.rotation-handle');
    const intersectableObjects = [];

    rotationHandles.forEach(handle => {
      if (handle.object3D && handle.getAttribute('visible') !== 'false') {
        intersectableObjects.push(handle.object3D);
        // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º —Å–≤—è–∑—å –º–µ–∂–¥—É object3D –∏ —ç–ª–µ–º–µ–Ω—Ç–æ–º
        handle.object3D.userData.element = handle;
      }
    });

    if (intersectableObjects.length === 0) {
      return null;
    }

    const intersects = raycaster.intersectObjects(intersectableObjects, true);

    if (intersects.length > 0) {
      const closest = intersects[0];
      const handleElement = closest.object.userData?.element || closest.object.parent?.userData?.element;

      if (handleElement) {
        const action = handleElement.getAttribute('data-rotation-action');
        const markerEl = handleElement.parentElement;

        if (action && markerEl) {
          console.log('üéØ –û–±–Ω–∞—Ä—É–∂–µ–Ω –∫–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ –≤—Ä–∞—â–µ–Ω–∏—è:', action);

          // –ù–∞—Ö–æ–¥–∏–º –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç—å –≤ —ç—Ç–æ–º –º–∞—Ä–∫–µ—Ä–µ
          const videoPlane = markerEl.querySelector('[data-video-plane]');

          if (videoPlane) {
            // –ù–∞—Ö–æ–¥–∏–º hotspot –ø–æ ID –º–∞—Ä–∫–µ—Ä–∞
            const markerId = markerEl.getAttribute('data-marker-id');
            let hotspot = null;

            if (markerId && this.hotspotManager) {
              hotspot = this.hotspotManager.findHotspotById(markerId);
            }

            return {
              action,
              handle: handleElement,
              marker: markerEl,
              videoPlane,
              hotspot,
              distance: closest.distance
            };
          }
        }
      }
    }

    return null;
  }

  /**
   * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∫–ª–∏–∫–Ω—É–ª–∏ –ª–∏ –ø–æ –∑–æ–Ω–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏
   */
  getMoveZoneAt(event) {
    const camera = this.aframeCamera;
    const scene = this.aframeScene;

    if (!camera || !scene || typeof THREE === 'undefined') {
      return null;
    }

    const rect = scene.canvas.getBoundingClientRect();
    const x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
    const y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2(x, y);
    raycaster.setFromCamera(mouse, camera.getObject3D('camera'));

    // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –∑–æ–Ω—ã –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
    const moveZones = this.aframeScene.querySelectorAll('.move-zone');
    const intersectableObjects = [];

    moveZones.forEach(zone => {
      if (zone.object3D && zone.getAttribute('visible') !== 'false') {
        intersectableObjects.push(zone.object3D);
        // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º —Å–≤—è–∑—å –º–µ–∂–¥—É object3D –∏ —ç–ª–µ–º–µ–Ω—Ç–æ–º
        zone.object3D.userData.element = zone;
      }
    });

    if (intersectableObjects.length === 0) {
      return null;
    }

    const intersects = raycaster.intersectObjects(intersectableObjects, true);

    if (intersects.length > 0) {
      const closest = intersects[0];
      const zoneElement = closest.object.userData?.element || closest.object.parent?.userData?.element;

      if (zoneElement) {
        const markerEl = zoneElement.parentElement;

        if (markerEl) {
          console.log('üéØ –û–±–Ω–∞—Ä—É–∂–µ–Ω –∫–ª–∏–∫ –ø–æ –∑–æ–Ω–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è');

          // –ù–∞—Ö–æ–¥–∏–º –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç—å –≤ —ç—Ç–æ–º –º–∞—Ä–∫–µ—Ä–µ
          const videoPlane = markerEl.querySelector('[data-video-plane]');

          if (videoPlane) {
            // –ù–∞—Ö–æ–¥–∏–º hotspot –ø–æ ID –º–∞—Ä–∫–µ—Ä–∞
            const markerId = markerEl.getAttribute('data-marker-id');
            let hotspot = null;

            if (markerId && this.hotspotManager) {
              hotspot = this.hotspotManager.findHotspotById(markerId);
            }

            return {
              zone: zoneElement,
              marker: markerEl,
              videoPlane,
              hotspot,
              distance: closest.distance
            };
          }
        }
      }
    }

    return null;
  }

  getIntersectionPoint(event) {
    if (!this.aframeScene || !this.aframeCamera) {
      return null;
    }

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º CoordinateManager –µ—Å–ª–∏ –æ–Ω –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏
    if (this.coordinateManager && typeof this.coordinateManager.getMousePositionOnSphere === 'function') {
      console.log('üéØ –ò—Å–ø–æ–ª—å–∑—É–µ–º CoordinateManager –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏');
      const position = this.coordinateManager.getMousePositionOnSphere(event);
      if (position) {
        console.log('‚úÖ –ü–æ–∑–∏—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∞ —á–µ—Ä–µ–∑ CoordinateManager:', position);
        return position;
      }
    }

    // Fallback: –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π ray-casting
    const camera = this.aframeCamera;
    const scene = this.aframeScene;

    if (!camera || !scene || !scene.canvas) {
      console.warn('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–∞–º–µ—Ä—É –∏–ª–∏ canvas –¥–ª—è ray-casting');
      return null;
    }

    // –ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –º—ã—à–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ canvas
    const rect = scene.canvas.getBoundingClientRect();
    const x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
    const y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

    // –°–æ–∑–¥–∞–µ–º –ª—É—á –æ—Ç –∫–∞–º–µ—Ä—ã —á–µ—Ä–µ–∑ THREE.js
    if (typeof THREE !== 'undefined') {
      const raycaster = new THREE.Raycaster();
      const mouse = new THREE.Vector2(x, y);

      raycaster.setFromCamera(mouse, camera.getObject3D('camera'));

      // –ü–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ —Å –Ω–µ–≤–∏–¥–∏–º–æ–π —Å—Ñ–µ—Ä–æ–π —Ä–∞–¥–∏—É—Å–∞ 10
      const sphereRadius = 10;
      const sphere = new THREE.Sphere(new THREE.Vector3(0, 0, 0), sphereRadius);
      const intersectionPoint = new THREE.Vector3();

      if (raycaster.ray.intersectSphere(sphere, intersectionPoint)) {
        console.log('üéØ –¢–æ—á–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è —á–µ—Ä–µ–∑ ray-casting:', intersectionPoint);
        return {
          x: intersectionPoint.x,
          y: intersectionPoint.y,
          z: intersectionPoint.z
        };
      }
    }

    // –ü–æ—Å–ª–µ–¥–Ω–∏–π fallback –∫ —Å—Ç–∞—Ä–æ–º—É –º–µ—Ç–æ–¥—É
    console.warn('‚ö†Ô∏è THREE.js –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π –º–µ—Ç–æ–¥');
    const phi = (x * Math.PI);
    const theta = ((y + 1) * Math.PI / 2);

    const radius = 10;
    const position = {
      x: radius * Math.sin(theta) * Math.cos(phi),
      y: radius * Math.cos(theta),
      z: radius * Math.sin(theta) * Math.sin(phi)
    };

    return position;
  }

  createVisualMarker(hotspot) {
    if (!this.aframeScene) return;

    const markerEl = document.createElement('a-entity');
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è DOM-—ç–ª–µ–º–µ–Ω—Ç–∞, —Å–≤—è–∑–∞–Ω–Ω—ã–π —Å ID —Ö–æ—Ç—Å–ø–æ—Ç–∞
    markerEl.id = `marker-${hotspot.id}`;
    markerEl.setAttribute('data-hotspot-id', hotspot.id);
    markerEl.setAttribute('data-marker-id', hotspot.id); // –î–ª—è –ø–æ–∏—Å–∫–∞ –≤ getResizeHandleAt

    // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –º–∞—Ä–∫–µ—Ä
    if (hotspot.position && hotspot.position.x !== undefined && hotspot.position.y !== undefined && hotspot.position.z !== undefined) {
      const posStr = `${hotspot.position.x} ${hotspot.position.y} ${hotspot.position.z}`;
      console.log('üéØ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –º–∞—Ä–∫–µ—Ä–∞:', hotspot.id, '–ø–æ–∑–∏—Ü–∏—è:', posStr);
      markerEl.setAttribute('position', posStr);
    } else {
      console.warn('‚ö†Ô∏è –ú–∞—Ä–∫–µ—Ä –±–µ–∑ –ø–æ–∑–∏—Ü–∏–∏:', hotspot.id, '–ø–æ–∑–∏—Ü–∏—è:', hotspot.position);
      markerEl.setAttribute('position', '0 0 -5'); // –ü–æ–∑–∏—Ü–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    }

    // –î–µ–ª–∞–µ–º –º–∞—Ä–∫–µ—Ä –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–º –∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º—ã–º
    markerEl.className = 'interactive draggable';

    // –î–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç —Å–ª—É—á–∞–π–Ω—ã—Ö –∫–ª–∏–∫–æ–≤
    markerEl._creationTime = Date.now();

    // –í–ê–ñ–ù–û: –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¢–û–õ–¨–ö–û –Ω–∞ shape —ç–ª–µ–º–µ–Ω—Ç
    // —Ç–∞–∫ –∫–∞–∫ A-Frame –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è –∏–º–µ–Ω–Ω–æ –Ω–∞ –Ω–∏—Ö

    // –í–∞–∂–Ω–æ: –¥–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å interactive –∏ –∫ shape –¥–ª—è raycaster
    // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
    markerEl._isDragging = false;
    markerEl._tooltipVisible = false;

    // –ü–æ–ª—É—á–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –º–∞—Ä–∫–µ—Ä–∞
    const defaultSettings = this.getDefaultSettings();
    const radius = hotspot.size || (hotspot.type === 'hotspot' ? defaultSettings.hotspotSize : defaultSettings.infopointSize);

    // –í–ê–ñ–ù–û: –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Ü–≤–µ—Ç –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å, –∏–Ω–∞—á–µ - —Ü–≤–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —Ç–∏–ø–∞
    let color;
    if (hotspot.color && hotspot.color !== 'undefined' && hotspot.color !== '') {
      color = hotspot.color;
      console.log('üé® –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Ü–≤–µ—Ç —Ö–æ—Ç—Å–ø–æ—Ç–∞:', hotspot.id, color);
    } else {
      color = (hotspot.type === 'hotspot' ? defaultSettings.hotspotColor : defaultSettings.infopointColor);
      console.log('üé® –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ü–≤–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —Ç–∏–ø–∞', hotspot.type, ':', color);
    }

    const icon = hotspot.icon || (hotspot.type === 'hotspot' ? 'arrow' : 'sphere');

    // –î–ª—è –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏ —Å–æ–∑–¥–∞–µ–º –ø–ª–æ—Å–∫–æ—Å—Ç—å –≤–º–µ—Å—Ç–æ –º–∞—Ä–∫–µ—Ä–∞
    if (hotspot.type === 'video-area') {
      return this.createVideoArea(hotspot, markerEl);
    }

    // –î–ª—è –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤–∏–¥–µ–æ-–ø–ª–æ—Å–∫–æ—Å—Ç—å —Å –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º —Ö—Ä–æ–º–∞–∫–µ–µ–º
    if (hotspot.type === 'animated-object') {
      return this.createAnimatedObject(hotspot, markerEl);
    }

    // –°–æ–∑–¥–∞–µ–º –≥–µ–æ–º–µ—Ç—Ä–∏—é
    let shape;
    console.log('–°–æ–∑–¥–∞–µ–º —Ñ–∏–≥—É—Ä—É:', icon, '—Ä–∞–∑–º–µ—Ä:', radius, '—Ü–≤–µ—Ç:', color);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è –∏–∫–æ–Ω–∫–∞
    if (icon === 'custom' && hotspot.customIconData) {
      console.log('–°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫—É—é –∏–∫–æ–Ω–∫—É');

      // –°–æ–∑–¥–∞–µ–º –ø–ª–æ—Å–∫–æ—Å—Ç—å –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
      shape = document.createElement('a-plane');

      // –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è —Ç–µ–∫—Å—Ç—É—Ä—ã
      const textureId = `custom-texture-${hotspot.id}`;

      // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç img –¥–ª—è —Ç–µ–∫—Å—Ç—É—Ä—ã
      const img = document.createElement('img');
      img.id = textureId;
      img.src = hotspot.customIconData;
      img.crossOrigin = 'anonymous';
      img.style.display = 'none';

      // –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ assets
      let assets = this.aframeScene.querySelector('a-assets');
      if (!assets) {
        assets = document.createElement('a-assets');
        this.aframeScene.appendChild(assets);
      }
      assets.appendChild(img);

      // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª —Å —Ç–µ–∫—Å—Ç—É—Ä–æ–π
      shape.setAttribute('material', {
        src: `#${textureId}`,
        transparent: true,
        alphaTest: 0.5
      });

      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä (–¥–ª—è –ø–ª–æ—Å–∫–æ—Å—Ç–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º width –∏ height)
      shape.setAttribute('width', radius * 2);
      shape.setAttribute('height', radius * 2);

      console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è –∏–∫–æ–Ω–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ —Å ID —Ç–µ–∫—Å—Ç—É—Ä—ã:', textureId);

    } else {
      // –°–æ–∑–¥–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫—É—é —Ñ–∏–≥—É—Ä—É
      switch (icon) {
        case 'cube':
          shape = document.createElement('a-box');
          shape.setAttribute('width', radius);
          shape.setAttribute('height', radius);
          shape.setAttribute('depth', radius);
          break;
        case 'cylinder':
          shape = document.createElement('a-cylinder');
          shape.setAttribute('radius', radius);
          shape.setAttribute('height', radius * 2);
          break;
        case 'octahedron':
          shape = document.createElement('a-octahedron');
          shape.setAttribute('radius', radius);
          break;
        case 'arrow':
          // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç—É—é –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—É—é —Å—Ç—Ä–µ–ª–∫—É (—Ç–æ–ª—å–∫–æ –∫–æ–Ω—É—Å)
          shape = document.createElement('a-cone');
          shape.setAttribute('radius-bottom', radius * 0.8);
          shape.setAttribute('radius-top', '0');
          shape.setAttribute('height', radius * 1.5);
          shape.setAttribute('color', color);
          shape.setAttribute('position', '0 0 0');
          shape.setAttribute('rotation', '0 0 0');

          // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–≤–æ—Ä–æ—Ç–∞ –æ—Ç –∫–∞–º–µ—Ä—ã
          shape.setAttribute('navigation-arrow', '');
          break;
        default: // sphere
          shape = document.createElement('a-sphere');
          shape.setAttribute('radius', radius);
          break;
      }

      // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ü–≤–µ—Ç –∏ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –¥–ª—è –≤—Å–µ—Ö —Ñ–∏–≥—É—Ä
      shape.setAttribute('color', color);
      shape.setAttribute('opacity', '0.9');
      shape.setAttribute('material', 'transparent: true');
    }

    // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è raycaster
    shape.className = 'interactive';

    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞—à –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π
    shape.setAttribute('hotspot-handler', `hotspotId: ${hotspot.id}; hotspotTitle: ${hotspot.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}; hotspotType: ${hotspot.type}`);

    // –ê–Ω–∏–º–∞—Ü–∏—è –ø—É–ª—å—Å–∞—Ü–∏–∏
    shape.setAttribute('animation__pulse', 'property: scale; to: 1.2 1.2 1.2; dir: alternate; loop: true; dur: 1000; easing: easeInOutSine;');

    // –ê–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
    shape.setAttribute('animation__hover_on', 'property: scale; to: 1.4 1.4 1.4; startEvents: mouseenter; dur: 200;');
    shape.setAttribute('animation__hover_off', 'property: scale; to: 1 1 1; startEvents: mouseleave; dur: 200;');

    console.log('–§–∏–≥—É—Ä–∞ —Å–æ–∑–¥–∞–Ω–∞:', shape.tagName, shape.getAttribute('radius') || shape.getAttribute('width'));

    // –¢–µ–∫—Å—Ç (–Ω–∞–∑–≤–∞–Ω–∏–µ) - –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—à –∫–∞—Å—Ç–æ–º–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –∫–∏—Ä–∏–ª–ª–∏—Ü—ã
    const textContainer = document.createElement('a-entity');
    textContainer.setAttribute('position', '0 0.8 0'); // –ù–∞–¥ –∏–∫–æ–Ω–∫–æ–π
    textContainer.setAttribute('billboard', '');

    // –£–±–∏—Ä–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π a-text –∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—à –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
    const text = document.createElement('a-entity');
    const textValue = (hotspot.title ? this.removeFileExtension(hotspot.title) : '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è').toString();
    console.log('üî§ –°–æ–∑–¥–∞–µ–º —Ç–µ–∫—Å—Ç –º–∞—Ä–∫–µ—Ä–∞:', textValue);

    // –ú–∞—Å—à—Ç–∞–± –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –Ω–∞—Å—Ç—Ä–æ–π–∫–µ —Ä–∞–∑–º–µ—Ä–∞ —Ç–µ–∫—Å—Ç–∞ (–≤–∏–∑—É–∞–ª—å–Ω–æ)
    const textScale = parseFloat(hotspot.textSize || 1);
    text.setAttribute('cyrillic-text', {
      value: textValue,
      color: hotspot.textColor || '#ffffff',
      align: 'center',
      family: hotspot.textFamily || 'Arial, sans-serif',
      bold: !!hotspot.textBold,
      underline: !!hotspot.textUnderline
    });
    if (!isNaN(textScale) && textScale !== 1) {
      text.setAttribute('scale', `${textScale} ${textScale} ${textScale}`);
    }
    text.setAttribute('position', '0 0 0');
    text.setAttribute('visible', 'false');

    // –û–¢–ö–õ–Æ–ß–ï–ù–û: billboard –º–æ–∂–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞—Ç—å —Å –¥—Ä—É–≥–∏–º–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏
    // textContainer.setAttribute('billboard', '');

    textContainer.appendChild(text);

    // –°–æ–±—ã—Ç–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è —Ç–µ–∫—Å—Ç–∞ –∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
    console.log('–°–æ–∑–¥–∞–µ–º —Å–æ–±—ã—Ç–∏—è –¥–ª—è –º–∞—Ä–∫–µ—Ä–∞:', hotspot.id, hotspot.title);

    // –ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç –Ω–∞–≤–µ–¥–µ–Ω–∏—è
    markerEl.addEventListener('mouseenter', (e) => {
      console.log('MOUSEENTER –Ω–∞ –º–∞—Ä–∫–µ—Ä:', hotspot.title);
      e.stopPropagation();
      if (!markerEl._isDragging && !markerEl._tooltipVisible) {
        text.setAttribute('visible', 'true');
        markerEl._tooltipVisible = true;
        console.log('Tooltip –ø–æ–∫–∞–∑–∞–Ω –¥–ª—è:', hotspot.title);
      }

      // –ó–ê–ü–û–ú–ò–ù–ê–ï–ú –ø–æ—Å–ª–µ–¥–Ω–∏–π –º–∞—Ä–∫–µ—Ä –ø–æ–¥ –∫—É—Ä—Å–æ—Ä–æ–º –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é
      this._lastHoveredMarker = { element: markerEl, hotspot: hotspot, time: Date.now() };
    });

    markerEl.addEventListener('mouseleave', (e) => {
      console.log('MOUSELEAVE —Å –º–∞—Ä–∫–µ—Ä–∞:', hotspot.title);
      e.stopPropagation();
      if (!markerEl._isDragging && markerEl._tooltipVisible) {
        text.setAttribute('visible', 'false');
        markerEl._tooltipVisible = false;
        console.log('Tooltip —Å–∫—Ä—ã—Ç –¥–ª—è:', hotspot.title);
      }

      // –ù–ï —Å–±—Ä–∞—Å—ã–≤–∞–µ–º _lastHoveredMarker —Å—Ä–∞–∑—É - –æ—Å—Ç–∞–≤–ª—è–µ–º –£–í–ï–õ–ò–ß–ï–ù–ù–û–ï –æ–∫–Ω–æ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
      setTimeout(() => {
        if (this._lastHoveredMarker && this._lastHoveredMarker.element === markerEl) {
          this._lastHoveredMarker = null;
        }
      }, 500); // –£–í–ï–õ–ò–ß–ò–õ–ò —Å 200ms –¥–æ 500ms –¥–ª—è –ª—É—á—à–µ–π —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
    });

    // –£–î–ê–õ–Ø–ï–ú: –ª–æ–∫–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ contextmenu –Ω–∞ –º–∞—Ä–∫–µ—Ä–µ
    // –¢–µ–ø–µ—Ä—å –∑–∞ –≤—Å—é –æ–±—Ä–∞–±–æ—Ç–∫—É –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é –æ—Ç–≤–µ—á–∞–µ—Ç –¢–û–õ–¨–ö–û canvas –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
    // –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –º–∞—Ä–∫–µ—Ä—ã —á–µ—Ä–µ–∑ findNearestMarker()

    // markerEl.addEventListener('contextmenu', (e) => {
    //   console.log('üéØ contextmenu –Ω–∞ –º–∞—Ä–∫–µ—Ä–µ:', hotspot.title);
    //   e.preventDefault();
    //   e.stopPropagation();
    //   // –ù–ï —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Ñ–ª–∞–≥ _contextMenuHandled
    //   // –ü—É—Å—Ç—å canvas –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–∞–º –æ–ø—Ä–µ–¥–µ–ª–∏—Ç –º–∞—Ä–∫–µ—Ä –∏ –ø–æ–∫–∞–∂–µ—Ç –º–µ–Ω—é
    // });

    // –ö–ª–∏–∫ –±–µ–∑ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è - –æ—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
    markerEl.addEventListener('click', (e) => {
      console.log('CLICK –Ω–∞ –º–∞—Ä–∫–µ—Ä:', hotspot.title, 'wasDragged:', markerEl._wasDragged);

      // üî• –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–í–ï–†–ö–ê: –±–ª–æ–∫–∏—Ä—É–µ–º –∫–ª–∏–∫ –ø–æ—Å–ª–µ –ø—Ä–∞–≤–æ–≥–æ –∫–ª–∏–∫–∞ (–∫–∞–∫ –≤ A-Frame –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ)
      const currentTime = Date.now();
      const lastRightClickTime = window.viewerManager ? window.viewerManager._lastRightClickTime : 0;
      const timeSinceRightClick = currentTime - (lastRightClickTime || 0);

      if (timeSinceRightClick < 300) {
        console.log('üö´ –°–¢–ê–†–´–ô –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω - –Ω–µ–¥–∞–≤–Ω–∏–π –ø—Ä–∞–≤—ã–π –∫–ª–∏–∫ (', timeSinceRightClick, 'ms –Ω–∞–∑–∞–¥)');
        return;
      }

      // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
      if (window._dragSystemBlocked) {
        console.log('üö´ –°–¢–ê–†–´–ô –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω - –≥–ª–æ–±–∞–ª—å–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞');
        return;
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–ª–∞–≥–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –æ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
      if (markerEl._rightClickHandled) {
        console.log('üö´ –ö–ª–∏–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω - –æ–±—Ä–∞–±–æ—Ç–∞–Ω –∫–∞–∫ contextmenu');
        return;
      }

      if (markerEl._doubleClickHandled) {
        console.log('üö´ –ö–ª–∏–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω - –æ–±—Ä–∞–±–æ—Ç–∞–Ω –∫–∞–∫ dblclick');
        return;
      }

      e.stopPropagation();
      e.preventDefault();

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–ª–∞–≥ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
      if (!markerEl._wasDragged) {
        if (hotspot.type === 'hotspot' && hotspot.targetSceneId) {
          console.log('üéØ –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –Ω–∞ —Å—Ü–µ–Ω—É:', hotspot.targetSceneId, '–æ—Ç —Ö–æ—Ç—Å–ø–æ—Ç–∞:', hotspot.title);

          // –ó–ê–©–ò–¢–ê: –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ü–µ–ª–µ–≤–∞—è —Å—Ü–µ–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
          const targetScene = window.sceneManager?.getSceneById(hotspot.targetSceneId);
          if (!targetScene) {
            console.warn('‚ö†Ô∏è –¶–µ–ª–µ–≤–∞—è —Å—Ü–µ–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞:', hotspot.targetSceneId, '- –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ');
            return;
          }

          // –ó–ê–©–ò–¢–ê: –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –Ω–µ –Ω–∞ —Ü–µ–ª–µ–≤–æ–π —Å—Ü–µ–Ω–µ —É–∂–µ
          const currentScene = window.sceneManager?.getCurrentScene();
          if (currentScene && currentScene.id === hotspot.targetSceneId) {
            console.log('‚ÑπÔ∏è –£–∂–µ –Ω–∞ —Ü–µ–ª–µ–≤–æ–π —Å—Ü–µ–Ω–µ:', hotspot.targetSceneId, '- –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è');
            return;
          }

          // –ó–ê–©–ò–¢–ê: –¥–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Å–ª—É—á–∞–π–Ω—ã—Ö –∫–ª–∏–∫–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
          const markerAge = Date.now() - (markerEl._creationTime || 0);
          if (markerAge < 500) { // –£–º–µ–Ω—å—à–∞–µ–º –≤—Ä–µ–º—è –∑–∞—â–∏—Ç—ã
            console.log('üõ°Ô∏è –ú–∞—Ä–∫–µ—Ä —Å–ª–∏—à–∫–æ–º –º–æ–ª–æ–¥–æ–π –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è (', markerAge, 'ms) - –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–ª–∏–∫');
            return;
          }

          // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –Ω–µ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –µ—Å–ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø–µ—Ä–µ—Ö–æ–¥ –±—ã–ª –Ω–µ–¥–∞–≤–Ω–æ
          const timeSinceLastTransition = Date.now() - (window._lastTransitionTime || 0);
          if (timeSinceLastTransition < 1000) {
            console.log('üõ°Ô∏è –°–ª–∏—à–∫–æ–º —Ä–∞–Ω–æ –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞ (', timeSinceLastTransition, 'ms –Ω–∞–∑–∞–¥) - –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–ª–∏–∫');
            return;
          }

          console.log('‚úÖ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ —Å—Ü–µ–Ω—É —Ä–∞–∑—Ä–µ—à–µ–Ω–æ:', hotspot.targetSceneId);
          window._lastTransitionTime = Date.now();
          window.sceneManager.switchToScene(hotspot.targetSceneId);
        } else if (hotspot.type === 'info-point') {
          console.log('–ü–æ–∫–∞–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –∏–Ω—Ñ–æ—Ç–æ—á–∫–∏');
          this.showInfoPointModal(hotspot);
        } else if (hotspot.type === 'video-area') {
          console.log('üé¨ DOM –æ–±—Ä–∞–±–æ—Ç—á–∏–∫: –∫–ª–∏–∫ –ø–æ –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏');

          // –ò–°–ü–†–ê–í–õ–Ø–ï–ú: –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–ª–∏–∫ –ø–æ –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ
          const videoEl = document.getElementById(`video-${hotspot.id}`);
          if (videoEl && hotspot.videoUrl) {
            // –ï—Å–ª–∏ –µ—Å—Ç—å –≤–∏–¥–µ–æ - –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
            console.log('üé¨ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –≤–∏–¥–µ–æ:', hotspot.title);
            this.playVideoElement(videoEl, hotspot);
          } else {
            // –ï—Å–ª–∏ –Ω–µ—Ç –≤–∏–¥–µ–æ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            console.log('üé¨ –í–∏–¥–µ–æ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ, –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä');
            if (window.hotspotManager) {
              window.hotspotManager.editHotspot(hotspot.id);
            }
          }
        }
      } else {
        console.log('üö´ –ö–ª–∏–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω - –º–∞—Ä–∫–µ—Ä –±—ã–ª –ø–µ—Ä–µ—Ç–∞—â–µ–Ω');
      }

      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–µ –≤—ã—à–µ
      setTimeout(() => {
        markerEl._wasDragged = false;
      }, 10);
    });

    markerEl.appendChild(shape);
    markerEl.appendChild(textContainer);

    // –°–ù–ê–ß–ê–õ–ê –¥–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä –≤ —Å—Ü–µ–Ω—É
    this.aframeScene.appendChild(markerEl);
    console.log('‚úÖ –ú–∞—Ä–∫–µ—Ä –≤–∏–∑—É–∞–ª—å–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω –≤ DOM:', markerEl.id, '–¥–ª—è —Ö–æ—Ç—Å–ø–æ—Ç–∞:', hotspot.id);

    // –ü–û–¢–û–ú –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä (—á—Ç–æ–±—ã –µ–≥–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–æ–±–∞–≤–∏–ª–∏—Å—å –ü–û–°–õ–ï –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã—Ö)
    if (this.coordinateManager) {
      this.coordinateManager.setupMarkerDragging(markerEl, hotspot.id, (newPosition) => {
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –≤ –º–µ–Ω–µ–¥–∂–µ—Ä–µ —Ö–æ—Ç—Å–ø–æ—Ç–æ–≤
        this.hotspotManager.updateHotspotPosition(hotspot.id, newPosition);
        markerEl._wasDragged = true;
        console.log('üéØ –ü–æ–∑–∏—Ü–∏—è –º–∞—Ä–∫–µ—Ä–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ —á–µ—Ä–µ–∑ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä:', hotspot.id, newPosition);
      });
    }

    console.log('–ú–∞—Ä–∫–µ—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å—Ü–µ–Ω—É:', {
      id: markerEl.id,
      className: markerEl.className,
      position: markerEl.getAttribute('position'),
      hasShape: !!shape,
      hasTextContainer: !!textContainer,
      sceneChildren: this.aframeScene.children.length
    });

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É, —á—Ç–æ —ç–ª–µ–º–µ–Ω—Ç –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –≤ DOM
    setTimeout(() => {
      const checkEl = document.getElementById(`marker-${hotspot.id}`);
      console.log('–ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∞—Ä–∫–µ—Ä–∞ —á–µ—Ä–µ–∑ 100ms:', !!checkEl, checkEl ? checkEl.className : '–Ω–µ –Ω–∞–π–¥–µ–Ω');
    }, 100);
  }

  /**
   * –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç: –≤–∏–¥–µ–æ-–ø–ª–æ—Å–∫–æ—Å—Ç—å, –≤—Å–µ–≥–¥–∞ —Å–º–æ—Ç—Ä–∏—Ç –Ω–∞ –∫–∞–º–µ—Ä—É, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ö—Ä–æ–º–∞–∫–µ–π
   */
  createAnimatedObject(hotspot, markerEl) {
    if (!markerEl) {
      markerEl = document.createElement('a-entity');
      markerEl.id = `marker-${hotspot.id}`;
      markerEl.setAttribute('data-hotspot-id', hotspot.id);
      const posStr = `${hotspot.position?.x || 0} ${hotspot.position?.y || 1.5} ${hotspot.position?.z || -3}`;
      markerEl.setAttribute('position', posStr);
    }

    markerEl.classList.add('interactive');
    markerEl.setAttribute('face-camera', '');

    const plane = document.createElement('a-plane');
    const width = parseFloat(hotspot.videoWidth) || 2;
    const height = parseFloat(hotspot.videoHeight) || 2 * 9 / 16;
    plane.setAttribute('width', width);
    plane.setAttribute('height', height);
    plane.className = 'animated-object-plane';

    // –°–æ–∑–¥–∞—ë–º/–ø–æ–¥–≤—è–∑—ã–≤–∞–µ–º –≤–∏–¥–µ–æ
    const videoId = `video-${hotspot.id}`;
    let videoEl = document.getElementById(videoId);
    if (!videoEl) {
      videoEl = document.createElement('video');
      videoEl.id = videoId;
      videoEl.crossOrigin = 'anonymous';
      videoEl.loop = true;
      videoEl.playsInline = true;
      videoEl.muted = true;
      videoEl.style.display = 'none';
      let assets = this.aframeScene.querySelector('a-assets');
      if (!assets) { assets = document.createElement('a-assets'); this.aframeScene.appendChild(assets); }
      assets.appendChild(videoEl);
    }

    if (hotspot.videoUrl) {
      videoEl.src = hotspot.videoUrl;
      try { videoEl.load(); } catch { }
    }

    // –ú–∞—Ç–µ—Ä–∏–∞–ª: –æ–±—ã—á–Ω—ã–π –∏–ª–∏ chroma-key
    const chromaEnabled = !!hotspot.chromaEnabled;
    if (chromaEnabled) {
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º —à–µ–π–¥–µ—Ä chroma-key
      plane.setAttribute('material', `shader: chroma-key; src: #${videoId}; color: ${hotspot.chromaColor || '#00ff00'}; similarity: ${hotspot.chromaSimilarity ?? 0.4}; smoothness: ${hotspot.chromaSmoothness ?? 0.1}; threshold: ${hotspot.chromaThreshold ?? 0.0}; side: double`);
    } else {
      plane.setAttribute('material', `shader: flat; src: #${videoId}; side: double`);
    }

    // –ü–æ–¥–ø–∏—Å—å (3D-–ª–µ–π–±–ª)
    if (hotspot.title) {
      const label = document.createElement('a-entity');
      label.setAttribute('position', `0 ${height / 2 + 0.25} 0.01`);
      label.setAttribute('billboard', '');
      const text = document.createElement('a-entity');
      const textSize = parseFloat(hotspot.textSize) || 1;
      text.setAttribute('cyrillic-text', {
        value: (hotspot.title || ''),
        color: hotspot.textColor || '#ffffff',
        align: 'center',
        family: hotspot.textFamily || 'Arial, sans-serif',
        bold: !!hotspot.textBold,
        underline: !!hotspot.textUnderline
      });
      if (textSize !== 1) text.setAttribute('scale', `${textSize} ${textSize} ${textSize}`);
      text.setAttribute('visible', true);
      text.setAttribute('position', '0 0 0.01');
      label.appendChild(text);
      markerEl.appendChild(label);
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞: toggle play/pause
    plane.addEventListener('click', (e) => {
      e.stopPropagation();
      if (videoEl.paused) {
        videoEl.play().catch(() => { });
      } else {
        videoEl.pause();
      }
    });

    markerEl.appendChild(plane);
    this.aframeScene.appendChild(markerEl);
    return markerEl;
  }

  showInfoPointModal(hotspot) {
    // –°–æ–∑–¥–∞–µ–º –∫—Ä–∞—Å–∏–≤–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∏–Ω—Ñ–æ—Ç–æ—á–∫–∏
    const modal = document.createElement('div');
    modal.className = 'info-point-modal';
    modal.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(26, 26, 26, 0.95);
            border: 1px solid #646cff;
            border-radius: 12px;
            padding: 20px 30px;
            z-index: 10001;
            max-width: 400px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            color: rgba(255, 255, 255, 0.87);
        `;

    modal.innerHTML = `
            <h3 style="margin: 0 0 15px 0; color: #ffcc00;">${hotspot.title}</h3>
            <p style="margin: 0; line-height: 1.5; color: ${hotspot.textColor || '#ffffff'}; font-size: ${hotspot.textSize || '1'}em;">${hotspot.description || ''}</p>
            <div style="margin-top: 10px; font-size: 0.8em; color: #888; border-top: 1px solid #444; padding-top: 10px;">
                üí° <strong>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞–º–∏:</strong><br>
                ‚Ä¢ –ü—Ä–∞–≤—ã–π –∫–ª–∏–∫ - –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é<br>
                ‚Ä¢ –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ - —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ<br>
                ‚Ä¢ Ctrl+Click - —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ<br>
                ‚Ä¢ –ö–ª–∞–≤–∏—à–∞ E (–ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏) - —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
            </div>
            <button onclick="this.closest('.info-point-modal').remove()" 
                    style="margin-top: 15px; padding: 8px 16px; background: #646cff; border: none; border-radius: 4px; color: white; cursor: pointer;">
                –ó–∞–∫—Ä—ã—Ç—å
            </button>
        `;

    document.body.appendChild(modal);

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    setTimeout(() => {
      const closeHandler = (e) => {
        if (!modal.contains(e.target)) {
          modal.remove();
          document.removeEventListener('click', closeHandler);
        }
      };
      document.addEventListener('click', closeHandler);
    }, 0);
  }

  showMarkerContextMenu(x, y, hotspot) {
    console.log('üü¢ ===== –ù–ê–ß–ê–õ–û showMarkerContextMenu =====');
    console.log('üéØ –ü–û–ö–ê–ó–´–í–ê–ï–ú –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø –¥–ª—è –º–∞—Ä–∫–µ—Ä–∞:', hotspot.title, '–ø–æ–∑–∏—Ü–∏—è:', x, y);

    // –ó–ê–©–ò–¢–ê: –ë–ª–æ–∫–∏—Ä—É–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –°–†–ê–ó–£ - –î–û –æ—á–∏—Å—Ç–∫–∏
    this._contextMenuCreationTime = Date.now();

    // –û–°–¢–û–†–û–ñ–ù–û–ï —É–¥–∞–ª–µ–Ω–∏–µ: –ù–ï —É–¥–∞–ª—è–µ–º –º–µ–Ω—é –µ—Å–ª–∏ –æ–Ω–∏ –±—ã–ª–∏ —Å–æ–∑–¥–∞–Ω—ã –Ω–µ–¥–∞–≤–Ω–æ
    const existingMenus = document.querySelectorAll('.marker-context-menu, .custom-context-menu');
    const currentTime = Date.now();
    existingMenus.forEach(menu => {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è
      const creationTime = menu._creationTime || 0;
      if (currentTime - creationTime > 100) { // –£–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Å—Ç–∞—Ä—ã–µ –º–µ–Ω—é
        console.log('üóëÔ∏è –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é (–≤–æ–∑—Ä–∞—Å—Ç:', currentTime - creationTime, 'ms)');
        menu.remove();
      } else {
        console.log('üõ°Ô∏è –ó–∞—â–∏—â–∞–µ–º –Ω–µ–¥–∞–≤–Ω–æ —Å–æ–∑–¥–∞–Ω–Ω–æ–µ –º–µ–Ω—é –æ—Ç —É–¥–∞–ª–µ–Ω–∏—è (–≤–æ–∑—Ä–∞—Å—Ç:', currentTime - creationTime, 'ms)');
      }
    });

    // –£–õ–£–ß–®–ï–ù–ù–û–ï –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –≥—Ä–∞–Ω–∏—Ü —ç–∫—Ä–∞–Ω–∞
    const menuWidth = 220;
    const menuHeight = 300; // –ü—Ä–∏–º–µ—Ä–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –º–µ–Ω—é —Å –∫–Ω–æ–ø–∫–∞–º–∏

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ–º–µ—â–∞–µ—Ç—Å—è –ª–∏ –º–µ–Ω—é —Å–ø—Ä–∞–≤–∞
    let finalX = x;
    if (x + menuWidth > window.innerWidth) {
      finalX = x - menuWidth; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ª–µ–≤–∞ –æ—Ç –∫—É—Ä—Å–æ—Ä–∞
      if (finalX < 10) finalX = 10; // –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø –æ—Ç –∫—Ä–∞—è
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ–º–µ—â–∞–µ—Ç—Å—è –ª–∏ –º–µ–Ω—é —Å–Ω–∏–∑—É
    let finalY = y;
    if (y + menuHeight > window.innerHeight) {
      finalY = y - menuHeight; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–≤–µ—Ä—Ö—É –æ—Ç –∫—É—Ä—Å–æ—Ä–∞
      if (finalY < 10) finalY = 10; // –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø –æ—Ç –∫—Ä–∞—è
    }

    // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –º–µ–Ω—é –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤–∏–¥–Ω–æ
    finalX = Math.max(10, Math.min(finalX, window.innerWidth - menuWidth - 10));
    finalY = Math.max(10, Math.min(finalY, window.innerHeight - menuHeight - 10));

    console.log('üìê –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ–Ω—é:', {
      –∏—Å—Ö–æ–¥–Ω—ã–µ: { x, y },
      —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ: { finalX, finalY },
      —Ä–∞–∑–º–µ—Ä—ã–≠–∫—Ä–∞–Ω–∞: { width: window.innerWidth, height: window.innerHeight },
      —Ä–∞–∑–º–µ—Ä—ã–ú–µ–Ω—é: { menuWidth, menuHeight }
    });

    // –°–æ–∑–¥–∞–µ–º –º–µ–Ω—é —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º ID –∏ –±–µ–∑ –∫–ª–∞—Å—Å–æ–≤ (–∏–∑–±–µ–≥–∞–µ–º CSS –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤)
    const menuId = 'hotspot-editor-menu-' + Date.now();
    const menu = document.createElement('div');
    menu.id = menuId;
    menu.className = 'marker-context-menu'; // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
    menu._creationTime = Date.now(); // –í–ê–ñ–ù–û: –ø–æ–º–µ—á–∞–µ–º –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è –¥–ª—è –∑–∞—â–∏—Ç—ã

    // –†–ê–î–ò–ö–ê–õ–¨–ù–´–ô –ø–æ–¥—Ö–æ–¥: –≤—Å—Ç—Ä–∞–∏–≤–∞–µ–º –í–°–ï —Å—Ç–∏–ª–∏ inline –≤ cssText
    menu.style.cssText = `
      all: initial !important;
      position: fixed !important;
      left: ${finalX}px !important;
      top: ${finalY}px !important;
      z-index: 2147483647 !important;
      width: 200px !important;
      height: auto !important;
      min-height: 100px !important;
      background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%) !important;
      border: 2px solid #4CAF50 !important;
      border-radius: 8px !important;
      box-shadow: 0 8px 32px rgba(0,255,0,0.3), 0 0 0 1px rgba(76,175,80,0.5) !important;
      font-family: 'Segoe UI', Arial, sans-serif !important;
      font-size: 14px !important;
      color: white !important;
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
      pointer-events: auto !important;
      overflow: visible !important;
      margin: 0 !important;
      padding: 8px 0 !important;
      text-align: left !important;
      line-height: normal !important;
      white-space: nowrap !important;
      user-select: none !important;
      box-sizing: border-box !important;
    `;

    // –°–æ–∑–¥–∞–µ–º –¢–û–õ–¨–ö–û –¥–≤–µ –∫–Ω–æ–ø–∫–∏ (—É–¥–∞–ª—è–µ–º "–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å")
    const buttons = [
      { action: 'edit', text: '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å', color: '#4CAF50' },
      { action: 'delete', text: 'üóëÔ∏è –£–¥–∞–ª–∏—Ç—å', color: '#f44336' }
    ];

    buttons.forEach((btn, index) => {
      const button = document.createElement('div');
      button.setAttribute('data-action', btn.action);
      button.textContent = btn.text;

      button.style.cssText = `
        all: initial !important;
        display: block !important;
        width: 100% !important;
        padding: 12px 16px !important;
        margin: 0 !important;
        background: transparent !important;
        border: none !important;
        border-bottom: ${index < buttons.length - 1 ? '1px solid rgba(255,255,255,0.1)' : 'none'} !important;
        color: white !important;
        font-family: 'Segoe UI', Arial, sans-serif !important;
        font-size: 14px !important;
        font-weight: normal !important;
        text-align: left !important;
        cursor: pointer !important;
        transition: all 0.2s ease !important;
        user-select: none !important;
        box-sizing: border-box !important;
        line-height: 1.4 !important;
        white-space: nowrap !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
      `;

      // Hover —ç—Ñ—Ñ–µ–∫—Ç—ã —á–µ—Ä–µ–∑ —Å–æ–±—ã—Ç–∏—è (–∏–∑–±–µ–≥–∞–µ–º CSS)
      button.addEventListener('mouseenter', () => {
        button.style.backgroundColor = `${btn.color}33 !important`;
        button.style.borderLeft = `3px solid ${btn.color} !important`;
        button.style.paddingLeft = '13px !important';
      });

      button.addEventListener('mouseleave', () => {
        button.style.backgroundColor = 'transparent !important';
        button.style.borderLeft = 'none !important';
        button.style.paddingLeft = '16px !important';
      });

      menu.appendChild(button);
    });

    // –î–æ–±–∞–≤–ª—è–µ–º –≤ body
    document.body.appendChild(menu);

    // –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤ –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –º–µ–Ω—é
    this.setupMenuHandlers(menu, hotspot);
    console.log('‚úÖ –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –º–µ–Ω—é');

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å
    const rect = menu.getBoundingClientRect();
    console.log('üéØ –†–∞–∑–º–µ—Ä—ã –Ω–æ–≤–æ–≥–æ –º–µ–Ω—é:', {
      width: rect.width,
      height: rect.height,
      visible: rect.width > 0 && rect.height > 0,
      id: menuId
    });

    // –ï—Å–ª–∏ –º–µ–Ω—é –≤—Å–µ –µ—â–µ –Ω–µ–≤–∏–¥–∏–º–æ - —Å–æ–∑–¥–∞–µ–º —Å—É–ø–µ—Ä-–ø—Ä–æ—Å—Ç–æ–µ –∞–≤–∞—Ä–∏–π–Ω–æ–µ –º–µ–Ω—é
    if (rect.width === 0 || rect.height === 0) {
      console.log('üö® –°–û–ó–î–ê–ï–ú –ê–í–ê–†–ò–ô–ù–û–ï –ú–ï–ù–Æ - –æ—Å–Ω–æ–≤–Ω–æ–µ –Ω–µ–≤–∏–¥–∏–º–æ');
      menu.remove();

      // –°–æ–∑–¥–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø—Ä–æ—Å—Ç–æ–µ –º–µ–Ω—é
      const emergency = document.createElement('div');
      emergency.className = 'marker-context-menu';
      emergency.innerHTML = `
        <div style="position:fixed!important;left:${finalX}px!important;top:${finalY}px!important;z-index:9999999!important;background:#ff0000!important;color:#fff!important;padding:20px!important;border:5px solid #ffff00!important;font-size:18px!important;font-family:Arial!important;width:250px!important;height:150px!important">
          <div style="cursor:pointer;padding:15px;border:2px solid #fff;margin:5px 0;background:#000" data-action="edit">‚úèÔ∏è –†–ï–î–ê–ö–¢–ò–†–û–í–ê–¢–¨</div>
          <div style="cursor:pointer;padding:15px;border:2px solid #fff;margin:5px 0;background:#000" data-action="delete">üóëÔ∏è –£–î–ê–õ–ò–¢–¨</div>
        </div>
      `;

      document.body.appendChild(emergency);
      this.setupMenuHandlers(emergency.firstElementChild, hotspot);

      console.log('üö® –ê–í–ê–†–ò–ô–ù–û–ï –º–µ–Ω—é —Å–æ–∑–¥–∞–Ω–æ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–æ');
      return;
    }

    // –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–ê–Ø –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ auto-close —Ç–æ–ª—å–∫–æ –¥–ª—è –õ–ö–ú
    const immediateCloseHandler = (e) => {
      // –¢–æ–ª—å–∫–æ –¥–ª—è –ª–µ–≤–æ–≥–æ –∫–ª–∏–∫–∞ - –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ
      if (e.button === 0 && e.type === 'click') {
        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–ª–∏–∫–∏ –ø–æ —Å–∞–º–æ–º—É –º–µ–Ω—é
        if (e.target.closest('.marker-context-menu') || e.target.closest(`#${menuId}`)) {
          return;
        }

        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–ª–∏–∫–∏ –ø–æ –º–∞—Ä–∫–µ—Ä–∞–º
        if (e.target.closest('a-text') || e.target.closest('[hotspot-marker]') || e.target.closest('.hotspot')) {
          return;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –º–µ–Ω—é
        const stillExists = document.getElementById(menuId);
        if (stillExists) {
          console.log('üéØ –ú–ì–ù–û–í–ï–ù–ù–û–ï –∑–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –ø–æ –õ–ö–ú');
          stillExists.remove();
          this._contextMenuCreationTime = null;

          // –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
          document.removeEventListener('click', immediateCloseHandler, true);
          document.removeEventListener('mousedown', immediateCloseHandler, true);
        }
      }
    };

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ù–ï–ú–ï–î–õ–ï–ù–ù–û –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è –õ–ö–ú
    document.addEventListener('click', immediateCloseHandler, true);
    document.addEventListener('mousedown', immediateCloseHandler, true);

    // –£–õ–£–ß–®–ï–ù–ù–ê–Ø —Å–∏—Å—Ç–µ–º–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –º–µ–Ω—é - –º–≥–Ω–æ–≤–µ–Ω–Ω–∞—è —Ä–µ–∞–∫—Ü–∏—è –Ω–∞ –õ–ö–ú –ø–æ —Å–≤–æ–±–æ–¥–Ω–æ–º—É –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤—É
    setTimeout(() => {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º–µ–Ω—é –µ—â–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ø–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
      const currentMenu = document.getElementById(menuId);
      if (!currentMenu) {
        console.log('üõ°Ô∏è AUTO-CLOSE –æ—Ç–º–µ–Ω–µ–Ω - –º–µ–Ω—é —É–∂–µ —É–¥–∞–ª–µ–Ω–æ –¥–æ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤');
        return;
      }

      const closeHandler = (e) => {
        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –ø—Ä–∞–≤—ã–µ –∫–ª–∏–∫–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é
        if (e.button === 2 || e.type === 'contextmenu') {
          console.log('üõ°Ô∏è AUTO-CLOSE –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –ø—Ä–∞–≤—ã–π –∫–ª–∏–∫');
          return;
        }

        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–ª–∏–∫–∏ –ø–æ —Å–∞–º–æ–º—É –º–µ–Ω—é –∏ –µ–≥–æ –¥–æ—á–µ—Ä–Ω–∏–º —ç–ª–µ–º–µ–Ω—Ç–∞–º
        if (e.target.closest('.marker-context-menu') || e.target.closest(`#${menuId}`)) {
          console.log('üõ°Ô∏è AUTO-CLOSE –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –∫–ª–∏–∫ –ø–æ –º–µ–Ω—é');
          return;
        }

        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–ª–∏–∫–∏ –ø–æ –º–∞—Ä–∫–µ—Ä–∞–º/—Ö–æ—Ç—Å–ø–æ—Ç–∞–º
        if (e.target.closest('a-text') || e.target.closest('[hotspot-marker]') || e.target.closest('.hotspot')) {
          console.log('üõ°Ô∏è AUTO-CLOSE –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –∫–ª–∏–∫ –ø–æ –º–∞—Ä–∫–µ—Ä—É');
          return;
        }

        // –ú–ì–ù–û–í–ï–ù–ù–û–ï –ó–ê–ö–†–´–¢–ò–ï –¥–ª—è –ª–µ–≤–æ–≥–æ –∫–ª–∏–∫–∞ (button 0) –ø–æ —Å–≤–æ–±–æ–¥–Ω–æ–º—É –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤—É
        const menuAge = Date.now() - (menu._creationTime || 0);
        if (e.button === 0 && e.type === 'click') {
          // –õ–µ–≤—ã–π –∫–ª–∏–∫ - –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –±–µ–∑ –∑–∞–¥–µ—Ä–∂–∫–∏
          console.log('üéØ –ú–ì–ù–û–í–ï–ù–ù–û–ï –∑–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –ø–æ –õ–ö–ú –ø–æ —Å–≤–æ–±–æ–¥–Ω–æ–º—É –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤—É');
        } else {
          // –î–ª—è –¥—Ä—É–≥–∏—Ö —Å–æ–±—ã—Ç–∏–π - –∑–∞—â–∏—â–∞–µ–º –º–µ–Ω—é –ø–µ—Ä–≤—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã
          if (menuAge < 3000) {
            console.log('üõ°Ô∏è AUTO-CLOSE –∑–∞—â–∏—â–∞–µ—Ç –º–æ–ª–æ–¥–æ–µ –º–µ–Ω—é (–≤–æ–∑—Ä–∞—Å—Ç:', menuAge, 'ms)');
            return;
          }
        }

        // –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –º–µ–Ω—é
        const stillExists = document.getElementById(menuId);
        if (!stillExists) {
          console.log('üõ°Ô∏è AUTO-CLOSE - –º–µ–Ω—é —É–∂–µ —É–¥–∞–ª–µ–Ω–æ');
          // –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –µ—Å–ª–∏ –º–µ–Ω—é —É–∂–µ –Ω–µ—Ç
          document.removeEventListener('click', closeHandler, true);
          document.removeEventListener('mousedown', closeHandler, true);
          return;
        }

        console.log('üéØ AUTO-CLOSE –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é');
        stillExists.remove();
        this._contextMenuCreationTime = null;

        // –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: —É–¥–∞–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è
        document.removeEventListener('click', closeHandler, true);
        document.removeEventListener('mousedown', closeHandler, true);
      };

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑–≤–Ω–µ
      if (!this._activeAutoCloseHandlers) {
        this._activeAutoCloseHandlers = new Set();
      }
      this._activeAutoCloseHandlers.add(closeHandler);

      // –ò—Å–ø–æ–ª—å–∑—É–µ–º CAPTURE —Ñ–∞–∑—É –¥–ª—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞
      document.addEventListener('click', closeHandler, true);
      document.addEventListener('mousedown', closeHandler, true);

      console.log('‚úÖ AUTO-CLOSE –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑', 3000, 'ms —Å –∑–∞—â–∏—Ç–æ–π 3 —Å–µ–∫—É–Ω–¥—ã');
    }, 3000); // –£–í–ï–õ–ò–ß–ò–õ–ò –¥–æ 3000ms –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏

    console.log('‚úÖ –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é —Å–æ–∑–¥–∞–Ω–æ –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ');
  }

  hideAllContextMenus() {
    // –ü—Ä–æ—Å—Ç–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã—Ö –º–µ–Ω—é –±–µ–∑ —Å–ª–æ–∂–Ω–æ–π –ª–æ–≥–∏–∫–∏
    console.log('ÔøΩÔ∏è hideAllContextMenus - —É–¥–∞–ª—è–µ–º –í–°–ï –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –º–µ–Ω—é');

    const selectors = [
      '.marker-context-menu',
      '.custom-context-menu',
      '[id*="hotspot-editor-menu"]',
      '[id*="marker-menu"]',
      '[class*="context-menu"]'
    ];

    selectors.forEach(selector => {
      document.querySelectorAll(selector).forEach(menu => {
        console.log('üóëÔ∏è –£–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é:', selector);
        menu.remove();
      });
    });

    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è
    this._contextMenuCreationTime = null;
  }

  forceHideAllContextMenus() {
    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –ë–ï–ó –∑–∞—â–∏—Ç–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏
    const selectors = [
      '.marker-context-menu',
      '.custom-context-menu',
      '[id*="hotspot-editor-menu"]',
      '[id*="marker-menu"]',
      '[class*="context-menu"]'
    ];

    selectors.forEach(selector => {
      document.querySelectorAll(selector).forEach(menu => {
        console.log('üóëÔ∏è –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û —É–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é:', selector);
        menu.remove();
      });
    });

    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è
    this._contextMenuCreationTime = null;
  }

  setupMenuHandlers(menu, hotspot) {
    // –ü—Ä–æ—Å—Ç—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –±–µ–∑ —Å–ª–æ–∂–Ω–æ–π –ª–æ–≥–∏–∫–∏
    const editBtn = menu.querySelector('[data-action="edit"]');
    const deleteBtn = menu.querySelector('[data-action="delete"]');

    if (editBtn) {
      editBtn.addEventListener('click', (e) => {
        console.log('üéØ –ö–ª–∏–∫ –ø–æ "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" –¥–ª—è –º–∞—Ä–∫–µ—Ä–∞:', hotspot.title);
        e.stopPropagation();
        e.preventDefault();

        if (this.hotspotManager) {
          this.hotspotManager.editHotspot(hotspot.id);
          console.log('‚úÖ –†–µ–¥–∞–∫—Ç–æ—Ä –º–∞—Ä–∫–µ—Ä–∞ –≤—ã–∑–≤–∞–Ω –¥–ª—è:', hotspot.id);
        }

        // –ë–ï–ó–û–ü–ê–°–ù–û–ï –∑–∞–∫—Ä—ã—Ç–∏–µ: —É–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â–µ–µ –º–µ–Ω—é
        menu.remove();
        console.log('‚úÖ –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –∑–∞–∫—Ä—ã—Ç–æ –ø–æ—Å–ª–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
      });
    }

    if (deleteBtn) {
      deleteBtn.addEventListener('click', (e) => {
        console.log('üéØ –ö–ª–∏–∫ –ø–æ "–£–¥–∞–ª–∏—Ç—å" –¥–ª—è –º–∞—Ä–∫–µ—Ä–∞:', hotspot.title);
        e.stopPropagation();
        e.preventDefault();

        console.log(`üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞ "${hotspot.title}"`);
        // –ò–°–ü–†–ê–í–õ–Ø–ï–ú: –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ —É–¥–∞–ª–µ–Ω–∏—è
        try {
          // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Ç–æ–¥–∞
          if (this.hotspotManager && this.hotspotManager.removeHotspotById) {
            this.hotspotManager.removeHotspotById(hotspot.id);
            console.log('‚úÖ –ú–∞—Ä–∫–µ—Ä —É–¥–∞–ª–µ–Ω —á–µ—Ä–µ–∑ removeHotspotById:', hotspot.id);
          } else if (this.hotspotManager && this.hotspotManager.hotspots) {
            // Fallback: —É–¥–∞–ª—è–µ–º –Ω–∞–ø—Ä—è–º—É—é –∏–∑ –º–∞—Å—Å–∏–≤–∞
            const index = this.hotspotManager.hotspots.findIndex(h => h.id === hotspot.id);
            if (index !== -1) {
              this.hotspotManager.hotspots.splice(index, 1);

              // –£–¥–∞–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–π –º–∞—Ä–∫–µ—Ä
              this.removeVisualMarker(hotspot.id);

              // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
              if (this.hotspotManager.saveHotspots) {
                this.hotspotManager.saveHotspots();
              }

              console.log('‚úÖ –ú–∞—Ä–∫–µ—Ä —É–¥–∞–ª–µ–Ω —á–µ—Ä–µ–∑ –ø—Ä—è–º–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –∏–∑ –º–∞—Å—Å–∏–≤–∞:', hotspot.id);
            }
          }
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –º–∞—Ä–∫–µ—Ä–∞:', error);

          // –ü–æ–ø—ã—Ç–∞–µ–º—Å—è —É–¥–∞–ª–∏—Ç—å —Ö–æ—Ç—è –±—ã –≤–∏–∑—É–∞–ª—å–Ω–æ –∏ –∏–∑ –º–∞—Å—Å–∏–≤–∞
          try {
            this.removeVisualMarker(hotspot.id);

            if (this.hotspotManager && this.hotspotManager.hotspots) {
              const index = this.hotspotManager.hotspots.findIndex(h => h.id === hotspot.id);
              if (index !== -1) {
                this.hotspotManager.hotspots.splice(index, 1);
                if (this.hotspotManager.saveHotspots) {
                  this.hotspotManager.saveHotspots();
                }
              }
            }

            console.log('‚ö†Ô∏è –ú–∞—Ä–∫–µ—Ä —É–¥–∞–ª–µ–Ω –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏');
          } catch (fallbackError) {
            console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–º —É–¥–∞–ª–µ–Ω–∏–∏:', fallbackError);
          }
        }

        // –ë–ï–ó–û–ü–ê–°–ù–û–ï –∑–∞–∫—Ä—ã—Ç–∏–µ: —É–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â–µ–µ –º–µ–Ω—é
        menu.remove();
        console.log('‚úÖ –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –∑–∞–∫—Ä—ã—Ç–æ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è');
      });
    }

    console.log('‚úÖ –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –¥–ª—è –∫–Ω–æ–ø–æ–∫:', !!editBtn, !!deleteBtn);
  } startMoveMode(hotspot) {
    const markerEl = document.getElementById(`marker-${hotspot.id}`);
    if (!markerEl) return;

    // –í–∏–∑—É–∞–ª—å–Ω–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è —Ä–µ–∂–∏–º–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
    const shapeEl = markerEl.querySelector('a-sphere, a-box, a-cylinder, a-octahedron');
    if (shapeEl) {
      shapeEl.setAttribute('color', '#ff00ff');
      shapeEl.setAttribute('opacity', '0.7');
    }

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
    const instruction = document.createElement('div');
    instruction.style.cssText = `
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(26, 26, 26, 0.9);
            border: 1px solid #ff00ff;
            border-radius: 8px;
            padding: 12px 20px;
            color: rgba(255, 255, 255, 0.87);
            z-index: 10000;
        `;
    instruction.textContent = '–ö–ª–∏–∫–Ω–∏—Ç–µ –≤ –Ω–æ–≤–æ–µ –º–µ—Å—Ç–æ –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞';
    document.body.appendChild(instruction);

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    const moveHandler = (e) => {
      if (e.target.tagName === 'A-SKY') {
        const newPosition = this.getIntersectionPoint(e);
        if (newPosition) {
          // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é —Ö–æ—Ç—Å–ø–æ—Ç–∞
          hotspot.position = `${newPosition.x} ${newPosition.y} ${newPosition.z}`;
          window.hotspotManager.updateHotspot(hotspot.id, { position: hotspot.position });

          // –£–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏–¥
          this.container.removeEventListener('click', moveHandler);
          if (shapeEl) {
            const defaultSettings = this.getDefaultSettings();
            const color = hotspot.color || (hotspot.type === 'hotspot' ? defaultSettings.hotspotColor : defaultSettings.infopointColor);
            shapeEl.setAttribute('color', color);
            shapeEl.setAttribute('opacity', '0.9');
          }
          instruction.remove();
        }
      }
    };

    this.container.addEventListener('click', moveHandler);
  }

  updateVisualMarker(hotspot) {
    const markerEl = document.getElementById(`marker-${hotspot.id}`);
    if (!markerEl) return;

    // –î–ª—è –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–µ–π –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ-–¥—Ä—É–≥–æ–º—É
    if (hotspot.type === 'video-area') {
      const videoPlane = markerEl.querySelector('a-plane');
      if (videoPlane) {
        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —á–∞—Å—Ç–æ—Ç—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –≤–∏–¥–µ–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞
        const now = Date.now();
        const lastUpdate = videoPlane._lastMaterialUpdate || 0;
        const timeSinceUpdate = now - lastUpdate;

        console.log('üé¨ updateVisualMarker –¥–ª—è –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏:', hotspot.id, '–≤—Ä–µ–º—è —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', timeSinceUpdate);
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä—ã
        videoPlane.setAttribute('width', hotspot.videoWidth || 4);
        videoPlane.setAttribute('height', hotspot.videoHeight || 3);

        // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏
        this.updateVideoAreaTitleText(markerEl, hotspot.title);
        this.updateVideoAreaTitle(markerEl, hotspot.videoHeight || 3);

        // –ó–ê–©–ò–¢–ê: —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–º, —á—Ç–æ –≤–∏–¥–µ–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è
        const videoEl = this.aframeScene.querySelector(`#video-${hotspot.id}`);
        const isVideoCurrentlyPlaying = videoEl && !videoEl.paused && !videoEl.ended && videoEl.currentTime > 0;

        if (isVideoCurrentlyPlaying) {
          console.log('üõ°Ô∏è –ó–ê–©–ò–¢–ê: –≤–∏–¥–µ–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è - –ù–ï —Ç—Ä–æ–≥–∞–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–æ–≤');
          // –ù–û –æ–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä—ã –∏ –ø–æ–∑–∏—Ü–∏—é –Ω–∞–∑–≤–∞–Ω–∏—è
          videoPlane.setAttribute('width', hotspot.videoWidth || 4);
          videoPlane.setAttribute('height', hotspot.videoHeight || 3);
          this.updateVideoAreaTitleText(markerEl, hotspot.title);
          this.updateVideoAreaTitle(markerEl, hotspot.videoHeight || 3);
          return; // –ü—Ä–µ–∫—Ä–∞—â–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –µ—Å–ª–∏ –≤–∏–¥–µ–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–µ–æ –∏—Å—Ç–æ—á–Ω–∏–∫ –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π
        if (hotspot.videoUrl && hotspot.videoUrl.trim() !== '') {
          console.log('üé¨ –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç—å —Å videoUrl:', hotspot.videoUrl);

          let videoEl = this.aframeScene.querySelector(`#video-${hotspot.id}`);

          // –ò–°–ü–†–ê–í–õ–Ø–ï–ú: –ø—Ä–æ–≤–µ—Ä—è–µ–º, –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –ª–∏ –≤–∏–¥–µ–æ –∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–∏ —É–∂–µ –º–∞—Ç–µ—Ä–∏–∞–ª
          const isVideoPlaying = videoEl && !videoEl.paused && !videoEl.ended && videoEl.currentTime > 0;
          const currentMaterial = videoPlane.getAttribute('material');
          const hasVideoMaterial = currentMaterial && currentMaterial.src === `#video-${hotspot.id}`;

          console.log('üé¨ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤–∏–¥–µ–æ:', {
            videoExists: !!videoEl,
            isPlaying: isVideoPlaying,
            hasVideoMaterial: hasVideoMaterial,
            videoUrl: hotspot.videoUrl
          });
          if (!videoEl) {
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç
            console.log('üé¨ –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç');
            const videoId = `video-${hotspot.id}`;
            videoEl = document.createElement('video');
            videoEl.id = videoId;
            videoEl.crossOrigin = 'anonymous';
            videoEl.loop = true;
            videoEl.muted = true;
            videoEl.autoplay = false; // –û–¢–ö–õ–Æ–ß–ê–ï–ú autoplay - –≤–∏–¥–µ–æ –¥–æ–ª–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –ø–æ –∫–ª–∏–∫—É
            videoEl.controls = false;
            videoEl.style.display = 'none';
            videoEl.preload = 'metadata';

            // –ù–ï —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º poster - –æ–Ω –º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            // videoEl.poster = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';

            // –î–æ–±–∞–≤–ª—è–µ–º –≤ assets
            let assets = this.aframeScene.querySelector('a-assets');
            if (!assets) {
              assets = document.createElement('a-assets');
              this.aframeScene.appendChild(assets);
            }
            assets.appendChild(videoEl);

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
            videoEl.addEventListener('loadeddata', () => {
              console.log('‚úÖ –í–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏:', hotspot.title);

              // –ò–°–ü–†–ê–í–õ–Ø–ï–ú: –∂–¥–µ–º –ø–æ–ª–Ω–æ–π –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –≤–∏–¥–µ–æ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º —Ç–µ–∫—Å—Ç—É—Ä—ã
              if (videoEl.readyState >= 2 && videoEl.videoWidth > 0 && videoEl.videoHeight > 0) {
                videoPlane.setAttribute('material', {
                  src: `#${videoId}`,
                  transparent: false,
                  side: 'double'
                });
              } else {
                console.warn('‚ö†Ô∏è –í–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏, –Ω–æ –Ω–µ –≥–æ—Ç–æ–≤–æ –¥–ª—è —Ç–µ–∫—Å—Ç—É—Ä—ã');
              }
            });

            videoEl.addEventListener('canplay', () => {
              console.log('‚úÖ –í–∏–¥–µ–æ –≥–æ—Ç–æ–≤–æ –∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—é –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏:', hotspot.title);

              // –ò–°–ü–†–ê–í–õ–Ø–ï–ú: –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª –≤ canplay –µ—Å–ª–∏ –Ω–µ –±—ã–ª–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ
              const currentMaterial = videoPlane.getAttribute('material');
              if (!currentMaterial || !currentMaterial.src) {
                videoPlane.setAttribute('material', {
                  src: `#${videoId}`,
                  transparent: false,
                  side: 'double'
                });
              }

              // –ù–ï –∑–∞–ø—É—Å–∫–∞–µ–º –≤–∏–¥–µ–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ - —Ç–æ–ª—å–∫–æ –ø–æ –∫–ª–∏–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
              console.log('‚úÖ –í–∏–¥–µ–æ –≥–æ—Ç–æ–≤–æ –∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—é:', hotspot.title);
            });

            videoEl.addEventListener('error', (e) => {
              console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏:', e);
              videoPlane.setAttribute('material', {
                color: '#cc3333',
                transparent: false
              });
            });
          }

          // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫
          if (videoEl.src !== hotspot.videoUrl) {
            videoEl.src = hotspot.videoUrl;
          }

          // –ò–°–ü–†–ê–í–õ–Ø–ï–ú: —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏–¥–µ–æ –º–∞—Ç–µ—Ä–∏–∞–ª —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∏ –ø—Ä–æ—à–ª–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤—Ä–µ–º–µ–Ω–∏
          const shouldUpdateMaterial = (!isVideoPlaying && !hasVideoMaterial) || timeSinceUpdate > 1000; // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–µ —á–∞—â–µ —Ä–∞–∑–∞ –≤ —Å–µ–∫—É–Ω–¥—É

          if (shouldUpdateMaterial && !isVideoPlaying && !hasVideoMaterial) {
            console.log('üé¨ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏–¥–µ–æ –º–∞—Ç–µ—Ä–∏–∞–ª (–≤–∏–¥–µ–æ –Ω–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –∏ –º–∞—Ç–µ—Ä–∏–∞–ª –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)');
            videoPlane.removeAttribute('text');
            videoPlane.setAttribute('material', {
              src: `#video-${hotspot.id}`,
              transparent: false,
              side: 'double'
            });
            videoPlane._lastMaterialUpdate = now;
          } else if (isVideoPlaying && hasVideoMaterial) {
            console.log('üé¨ –ù–ï –æ–±–Ω–æ–≤–ª—è–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª - –≤–∏–¥–µ–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –∏ –º–∞—Ç–µ—Ä–∏–∞–ª —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
          } else if (hasVideoMaterial) {
            console.log('üé¨ –ù–ï –æ–±–Ω–æ–≤–ª—è–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª - –≤–∏–¥–µ–æ –º–∞—Ç–µ—Ä–∏–∞–ª —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
          } else if (timeSinceUpdate <= 1000) {
            console.log('üé¨ –ù–ï –æ–±–Ω–æ–≤–ª—è–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª - —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (', timeSinceUpdate, 'ms)');
          } else {
            console.log('üé¨ –ù–ï –æ–±–Ω–æ–≤–ª—è–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª - –≤–∏–¥–µ–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è, –∂–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è');
          }
        } else {
          // –ù–µ—Ç videoUrl - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥–ª—É—à–∫—É
          console.log('üé¨ –ù–µ—Ç videoUrl - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥–ª—É—à–∫—É');
          videoPlane.setAttribute('material', {
            color: '#333333',
            transparent: false
          });
          videoPlane.setAttribute('text', {
            value: `üìπ –í–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç—å\n${hotspot.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}\n\nüñ±Ô∏è –ö–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∏–¥–µ–æ\nüñ±Ô∏è –ü–ö–ú –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é`,
            align: 'center',
            color: '#ffffff',
            width: 6
          });
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —É–≥–ª—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞
        const safeWidth = parseFloat(hotspot.videoWidth) || 4;
        const safeHeight = parseFloat(hotspot.videoHeight) || 3;
        this.updateResizeHandles(markerEl, safeWidth, safeHeight);
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é
      markerEl.setAttribute('position', `${hotspot.position.x} ${hotspot.position.y} ${hotspot.position.z}`);
      return;
    }

    // –ï—Å–ª–∏ –∏–∫–æ–Ω–∫–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å, –ø–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä
    const currentShape = markerEl.querySelector('a-sphere, a-box, a-cylinder, a-octahedron, a-plane');
    const newIcon = hotspot.icon || (hotspot.type === 'hotspot' ? 'arrow' : 'sphere');
    const currentIcon = this.getShapeType(currentShape);

    if (currentIcon !== newIcon) {
      // –ü–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä —Å –Ω–æ–≤–æ–π –≥–µ–æ–º–µ—Ç—Ä–∏–µ–π
      this.removeVisualMarker(hotspot.id);
      this.createVisualMarker(hotspot);
      return;
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é
    markerEl.setAttribute('position', `${hotspot.position.x} ${hotspot.position.y} ${hotspot.position.z}`);

    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç
    const textContainer = markerEl.querySelector('a-entity');
    const textEl = textContainer ? textContainer.querySelector('[cyrillic-text]') : null;
    if (textEl) {
      const textScale = parseFloat(hotspot.textSize || 1);
      textEl.setAttribute('cyrillic-text', {
        value: (hotspot.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'),
        color: hotspot.textColor || '#ffffff',
        align: 'center',
        family: hotspot.textFamily || 'Arial, sans-serif',
        bold: !!hotspot.textBold,
        underline: !!hotspot.textUnderline
      });
      if (!isNaN(textScale) && textScale > 0) {
        textEl.setAttribute('scale', `${textScale} ${textScale} ${textScale}`);
      } else {
        textEl.removeAttribute('scale');
      }
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–≤–µ—Ç –∏ —Ä–∞–∑–º–µ—Ä –º–∞—Ä–∫–µ—Ä–∞
    if (currentShape) {
      const defaultSettings = this.getDefaultSettings();
      const size = hotspot.size || (hotspot.type === 'hotspot' ? defaultSettings.hotspotSize : defaultSettings.infopointSize);
      const color = hotspot.color || (hotspot.type === 'hotspot' ? defaultSettings.hotspotColor : defaultSettings.infopointColor);

      currentShape.setAttribute('color', color);

      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –≥–µ–æ–º–µ—Ç—Ä–∏–∏
      switch (newIcon) {
        case 'cube':
          currentShape.setAttribute('width', size);
          currentShape.setAttribute('height', size);
          currentShape.setAttribute('depth', size);
          break;
        case 'cylinder':
          currentShape.setAttribute('radius', size);
          currentShape.setAttribute('height', size * 2);
          break;
        default: // sphere, octahedron
          currentShape.setAttribute('radius', size);
          break;
      }
    }
  }

  getShapeType(element) {
    if (!element) return 'sphere';
    const tagName = element.tagName.toLowerCase();
    switch (tagName) {
      case 'a-box': return 'cube';
      case 'a-cylinder': return 'cylinder';
      case 'a-octahedron': return 'octahedron';
      default: return 'sphere';
    }
  }

  removeVisualMarker(hotspotId) {
    const markerEl = document.getElementById(`marker-${hotspotId}`);
    if (markerEl) {
      console.log('üóëÔ∏è –£–¥–∞–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–π –º–∞—Ä–∫–µ—Ä:', hotspotId);

      // –í–ê–ñ–ù–û: –û—á–∏—â–∞–µ–º –≤–∏–¥–µ–æ —Ä–µ—Å—É—Ä—Å—ã –¥–ª—è –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–µ–π
      const videoEl = document.getElementById(`video-${hotspotId}`);
      if (videoEl) {
        console.log('üé¨ –û—á–∏—â–∞–µ–º –≤–∏–¥–µ–æ —Ä–µ—Å—É—Ä—Å—ã –¥–ª—è:', hotspotId);

        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏–¥–µ–æ
        if (!videoEl.paused) {
          videoEl.pause();
        }

        // –û—á–∏—â–∞–µ–º src –¥–ª—è –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è –ø–∞–º—è—Ç–∏
        videoEl.src = '';
        videoEl.removeAttribute('src');

        // –£–¥–∞–ª—è–µ–º –∏–∑ DOM
        videoEl.remove();
      }

      // –û—á–∏—â–∞–µ–º coordinate manager —Å–≤—è–∑–∏
      if (this.coordinateManager) {
        this.coordinateManager.cleanupMarker(hotspotId);
      }

      // –£–¥–∞–ª—è–µ–º –º–∞—Ä–∫–µ—Ä –∏–∑ DOM (—ç—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª–∏—Ç –≤—Å–µ –¥–æ—á–µ—Ä–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∏ –∏—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏)
      markerEl.remove();

      console.log('‚úÖ –ú–∞—Ä–∫–µ—Ä –∏ —Ä–µ—Å—É—Ä—Å—ã –æ—á–∏—â–µ–Ω—ã:', hotspotId);
    } else {
      console.warn('‚ö†Ô∏è –ú–∞—Ä–∫–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:', hotspotId);
    }
  }

  getViewer() {
    return {
      container: this.container,
      scene: this.aframeScene,
      camera: this.aframeCamera,
      sky: this.aframeSky
    };
  }

  clearMarkers() {
    const markers = this.aframeScene.querySelectorAll('[data-hotspot-id]');
    console.log('üóëÔ∏è clearMarkers: —É–¥–∞–ª—è–µ–º', markers.length, '–º–∞—Ä–∫–µ—Ä–æ–≤');
    console.trace('üìç –°—Ç–µ–∫ –≤—ã–∑–æ–≤–æ–≤ clearMarkers'); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º, –∫—Ç–æ –≤—ã–∑–≤–∞–ª —É–¥–∞–ª–µ–Ω–∏–µ
    console.warn('üö® –í–ù–ò–ú–ê–ù–ò–ï: clearMarkers –≤—ã–∑–≤–∞–Ω! –≠—Ç–æ —É–¥–∞–ª–∏—Ç –í–°–ï –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏ –∏ –º–∞—Ä–∫–µ—Ä—ã!');
    console.warn('üö® –ï—Å–ª–∏ —ç—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –≤—Ä–∞—â–µ–Ω–∏–∏ –∫–∞–º–µ—Ä—ã - —ç—Ç–æ –ë–ê–ì!');

    markers.forEach(marker => {
      const hotspotId = marker.getAttribute('data-hotspot-id');
      const markerType = marker.getAttribute('data-marker-type') || 'unknown';
      console.log('üóëÔ∏è –£–¥–∞–ª—è–µ–º –º–∞—Ä–∫–µ—Ä:', hotspotId, marker.id, '—Ç–∏–ø:', markerType);
      marker.remove();
    });
  } updateCameraSettings(settings) {
    if (this.aframeCamera && settings.mouseSensitivity) {
      // –û–±–Ω–æ–≤–ª—è–µ–º —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –º—ã—à–∏ –¥–ª—è look-controls
      const lookControls = this.aframeCamera.getAttribute('look-controls');
      this.aframeCamera.setAttribute('look-controls', {
        ...lookControls,
        mouseSensitivity: settings.mouseSensitivity,
        touchSensitivity: settings.mouseSensitivity
      });
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∫–æ—Ä–æ—Å—Ç–∏ –∑—É–º–∞
    if (settings.zoomSpeed) {
      this.zoomSpeed = settings.zoomSpeed;
    }

    // –ü—Ä–∏–º–µ–Ω—è–µ–º –≥–∏—Ä–æ—Å–∫–æ–ø
    if (typeof settings.gyroEnabled === 'boolean') {
      this.enableGyro(settings.gyroEnabled);
    }
  }

  setupZoomControls() {
    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑—É–º–æ–º –∫–æ–ª–µ—Å–∏–∫–æ–º –º—ã—à–∏ - –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –∫ document –¥–ª—è —Ä–∞–±–æ—Ç—ã –≤ –ª—é–±–æ–º –º–µ—Å—Ç–µ
    document.addEventListener('wheel', (e) => {
      // –ü–†–ò–û–†–ò–¢–ï–¢: –ï—Å–ª–∏ –∑–∞–∂–∞—Ç Shift - —ç—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏, –∞ –ù–ï –∑—É–º
      if (e.shiftKey) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã—à—å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞–¥ A-Frame —Å—Ü–µ–Ω–æ–π
        if (!e.target.closest('a-scene') && !e.target.matches('canvas')) {
          return;
        }

        // –ù–∞—Ö–æ–¥–∏–º –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç—å –ø–æ–¥ –∫—É—Ä—Å–æ—Ä–æ–º –º—ã—à–∏
        const intersectedElements = this.raycastFromMouse(e);
        let targetVideoArea = null;
        let targetMarker = null;

        for (const intersection of intersectedElements) {
          const element = intersection.object.el;
          if (element && element.getAttribute('data-video-plane')) {
            targetVideoArea = element;
            targetMarker = element.parentNode;
            break;
          }
        }

        if (!targetVideoArea || !targetMarker) {
          return; // –ù–µ—Ç –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏ –ø–æ–¥ –∫—É—Ä—Å–æ—Ä–æ–º
        }

        e.preventDefault();
        e.stopPropagation();

        // –ù–∞—Ö–æ–¥–∏–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —Ö–æ—Ç—Å–ø–æ—Ç
        const markerId = targetMarker.getAttribute('data-marker-id');
        const hotspot = this.hotspotManager.hotspots.find(h => h.id === markerId);

        if (!hotspot) {
          console.warn('‚ö†Ô∏è –•–æ—Ç—Å–ø–æ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞');
          return;
        }

        // –¢–µ–∫—É—â–∏–µ —Ä–∞–∑–º–µ—Ä—ã —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å
        let currentWidth = parseFloat(hotspot.videoWidth);
        let currentHeight = parseFloat(hotspot.videoHeight);

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –∑–Ω–∞—á–µ–Ω–∏–π –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        if (isNaN(currentWidth) || currentWidth <= 0) {
          currentWidth = 4;
          hotspot.videoWidth = currentWidth;
        }
        if (isNaN(currentHeight) || currentHeight <= 0) {
          currentHeight = 3;
          hotspot.videoHeight = currentHeight;
        }

        // –í—ã—á–∏—Å–ª—è–µ–º –Ω–æ–≤—ã–µ —Ä–∞–∑–º–µ—Ä—ã
        const resizeStep = 0.2; // –®–∞–≥ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞
        const delta = e.deltaY > 0 ? -resizeStep : resizeStep; // –û–±—Ä–∞—Ç–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –∏–Ω—Ç—É–∏—Ç–∏–≤–Ω–æ—Å—Ç–∏

        let newWidth = currentWidth + delta;
        let newHeight = currentHeight + delta * (currentHeight / currentWidth); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏

        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã
        newWidth = Math.max(0.5, Math.min(20, newWidth));
        newHeight = Math.max(0.5, Math.min(20, newHeight));

        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –Ω–æ–≤—ã—Ö —Ä–∞–∑–º–µ—Ä–æ–≤
        if (isNaN(newWidth) || isNaN(newHeight)) {
          console.warn('‚ö†Ô∏è –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –Ω–æ–≤—ã–µ —Ä–∞–∑–º–µ—Ä—ã, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é');
          newWidth = 4;
          newHeight = 3;
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä—ã –≤ —Ö–æ—Ç—Å–ø–æ—Ç–µ
        hotspot.videoWidth = newWidth;
        hotspot.videoHeight = newHeight;

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä—ã –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏
        targetVideoArea.setAttribute('width', newWidth);
        targetVideoArea.setAttribute('height', newHeight);

        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏–∏ —É–≥–ª–æ–≤ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞
        this.updateResizeHandles(targetMarker, newWidth, newHeight);

        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é —Ç–µ–∫—Å—Ç–∞ –Ω–∞–∑–≤–∞–Ω–∏—è
        this.updateVideoAreaTitle(targetMarker, newHeight);

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
        this.hotspotManager.saveHotspots();

        console.log(`üìè –†–∞–∑–º–µ—Ä –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω: ${currentWidth.toFixed(1)}√ó${currentHeight.toFixed(1)} ‚Üí ${newWidth.toFixed(1)}√ó${newHeight.toFixed(1)}`);
        return; // –í—ã—Ö–æ–¥–∏–º, —á—Ç–æ–±—ã –ù–ï –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∑—É–º
      }

      // –û–ë–´–ß–ù–´–ô –ó–£–ú (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ù–ï –∑–∞–∂–∞—Ç Shift)
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã—à—å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞–¥ A-Frame —Å—Ü–µ–Ω–æ–π
      if (!e.target.closest('a-scene') && !e.target.matches('canvas')) {
        return; // –ï—Å–ª–∏ –º—ã—à—å –Ω–µ –Ω–∞–¥ —Å—Ü–µ–Ω–æ–π, –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å —Å—Ü–µ–Ω—ã –∏ –∫–∞–º–µ—Ä—ã
      if (!this.aframeCamera || !this.aframeScene) {
        console.warn('‚ö†Ô∏è –ó—É–º –∫–æ–ª–µ—Å–∏–∫–æ–º –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω - –∫–∞–º–µ—Ä–∞ –∏–ª–∏ —Å—Ü–µ–Ω–∞ –Ω–µ –≥–æ—Ç–æ–≤—ã');
        return;
      }

      e.preventDefault();
      e.stopPropagation();

      const currentFov = parseFloat(this.aframeCamera.getAttribute('fov')) || 80;

      // –ë–æ–ª–µ–µ –ø–ª–∞–≤–Ω—ã–π –∑—É–º: —É–º–µ–Ω—å—à–∞–µ–º –±–∞–∑–æ–≤—ã–π —à–∞–≥ –∏ –¥–µ–ª–∞–µ–º –µ–≥–æ –∑–∞–≤–∏—Å–∏–º—ã–º –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ FOV
      const baseZoomStep = 2.5; // –£–º–µ–Ω—å—à–µ–Ω –¥–ª—è –±–æ–ª–µ–µ –ø–ª–∞–≤–Ω–æ–≥–æ –∑—É–º–∞
      const fovFactor = currentFov / 80; // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ FOV
      const adaptiveZoomStep = baseZoomStep * fovFactor * (this.zoomSpeed || 1);

      const delta = e.deltaY > 0 ? adaptiveZoomStep : -adaptiveZoomStep;
      let newFov = currentFov + delta;

      // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∑—É–º (FOV –æ—Ç 10 –¥–æ 130 –≥—Ä–∞–¥—É—Å–æ–≤ –¥–ª—è –±–æ–ª—å—à–µ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞)
      newFov = Math.max(10, Math.min(130, newFov));

      // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–æ–≤—ã–π FOV –∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∫–∞–º–µ—Ä—É
      this.aframeCamera.setAttribute('fov', newFov);
      // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º Three.js –∫–∞–º–µ—Ä—É –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏
      setTimeout(() => {
        if (this.aframeCamera.getObject3D('camera')) {
          this.aframeCamera.getObject3D('camera').updateProjectionMatrix();
          this.aframeCamera.getObject3D('camera').fov = newFov;
          this.aframeCamera.getObject3D('camera').updateProjectionMatrix();
        }
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º A-Frame –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
        if (this.aframeCamera.components && this.aframeCamera.components.camera && this.aframeCamera.components.camera.tick) {
          this.aframeCamera.components.camera.tick();
        }
      }, 0);

      // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑—É–º–∞
      this.updateZoomIndicator(newFov);

      // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —Å –ø—Ä–æ—Ü–µ–Ω—Ç–∞–º–∏
      const oldZoom = Math.round((80 / currentFov) * 100);
      const newZoom = Math.round((80 / newFov) * 100);
      console.log(`üîç –ó—É–º –∫–æ–ª–µ—Å–∏–∫–æ–º: ${oldZoom}% ‚Üí ${newZoom}% (FOV ${currentFov.toFixed(1)}¬∞ ‚Üí ${newFov.toFixed(1)}¬∞, –¥–µ–ª—å—Ç–∞: ${delta.toFixed(1)}¬∞)`);
    }, { passive: false }); // –í–ê–ñ–ù–û: passive: false –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ preventDefault()

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑—É–º–æ–º –∫–Ω–æ–ø–∫–∞–º–∏ + –∏ -
    document.addEventListener('keydown', (e) => {
      if (e.key === '+' || e.key === '=') {
        this.zoomIn();
      } else if (e.key === '-') {
        this.zoomOut();
      }
    });

    // Pinch-to-zoom –Ω–∞ —Ç–∞—á-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
    const sceneEl = this.aframeScene;
    if (sceneEl) {
      sceneEl.addEventListener('touchstart', (e) => {
        if (e.touches && e.touches.length === 2) {
          this._pinch.active = true;
          const dx = e.touches[0].clientX - e.touches[1].clientX;
          const dy = e.touches[0].clientY - e.touches[1].clientY;
          this._pinch.startDist = Math.hypot(dx, dy);
          this._pinch.startFov = parseFloat(this.aframeCamera?.getAttribute('fov')) || 80;
        }
      }, { passive: false });

      sceneEl.addEventListener('touchmove', (e) => {
        if (this._pinch.active && e.touches && e.touches.length === 2) {
          e.preventDefault();
          const dx = e.touches[0].clientX - e.touches[1].clientX;
          const dy = e.touches[0].clientY - e.touches[1].clientY;
          const dist = Math.hypot(dx, dy);
          if (this._pinch.startDist > 0) {
            const scale = this._pinch.startDist / dist; // –±–æ–ª—å—à–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ -> zoom in
            let newFov = this._pinch.startFov * scale;
            newFov = Math.max(10, Math.min(130, newFov));
            this.aframeCamera.setAttribute('fov', newFov);
            if (this.aframeCamera.getObject3D('camera')) {
              this.aframeCamera.getObject3D('camera').fov = newFov;
              this.aframeCamera.getObject3D('camera').updateProjectionMatrix();
            }
            this.updateZoomIndicator(newFov);
          }
        }
      }, { passive: false });

      const endPinch = () => { this._pinch.active = false; };
      sceneEl.addEventListener('touchend', endPinch, { passive: true });
      sceneEl.addEventListener('touchcancel', endPinch, { passive: true });
    }
  }

  // === –ì–∏—Ä–æ—Å–∫–æ–ø ===
  async enableGyro(enabled) {
    this.gyroEnabled = !!enabled;
    if (!this.aframeCamera) return;
    const current = this.aframeCamera.getAttribute('look-controls') || {};
    if (this.gyroEnabled) {
      // –ó–∞–ø—Ä–æ—Å–∏–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ (iOS 13+)
      try { await this.requestGyroPermission(); } catch (e) { console.warn('–ì–∏—Ä–æ—Å–∫–æ–ø: —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–µ –≤—ã–¥–∞–Ω–æ', e); }
      this.aframeCamera.setAttribute('look-controls', {
        ...current,
        enabled: true,
        magicWindowTrackingEnabled: true,
        pointerLockEnabled: false,
      });
    } else {
      this.aframeCamera.setAttribute('look-controls', {
        ...current,
        magicWindowTrackingEnabled: false
      });
    }
  }

  async requestGyroPermission() {
    const w = window;
    const needPerm = typeof w.DeviceOrientationEvent !== 'undefined' && typeof w.DeviceOrientationEvent.requestPermission === 'function';
    if (needPerm) {
      try {
        const res = await w.DeviceOrientationEvent.requestPermission();
        return res === 'granted';
      } catch (e) {
        return false;
      }
    }
    return true; // –ù–∞ Android –æ–±—ã—á–Ω–æ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è
  }

  zoomIn() {
    if (!this.aframeCamera || !this.aframeScene) {
      console.warn('‚ö†Ô∏è –ó—É–º –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω - –∫–∞–º–µ—Ä–∞ –∏–ª–∏ —Å—Ü–µ–Ω–∞ –Ω–µ –≥–æ—Ç–æ–≤—ã');
      return;
    }

    const currentFov = parseFloat(this.aframeCamera.getAttribute('fov')) || 80;
    const zoomStep = 5 * (this.zoomSpeed || 1);
    const newFov = Math.max(10, currentFov - zoomStep);

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π FOV –∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∫–∞–º–µ—Ä—É
    this.aframeCamera.setAttribute('fov', newFov);
    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º Three.js –∫–∞–º–µ—Ä—É –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏
    setTimeout(() => {
      if (this.aframeCamera.getObject3D('camera')) {
        this.aframeCamera.getObject3D('camera').updateProjectionMatrix();
        this.aframeCamera.getObject3D('camera').fov = newFov;
        this.aframeCamera.getObject3D('camera').updateProjectionMatrix();
      }
      // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º A-Frame –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
      if (this.aframeCamera.components && this.aframeCamera.components.camera) {
        this.aframeCamera.components.camera.tick();
      }
    }, 0);
    this.updateZoomIndicator(newFov);

    const oldZoom = Math.round((80 / currentFov) * 100);
    const newZoom = Math.round((80 / newFov) * 100);
    console.log(`üîç –ó—É–º –∫–Ω–æ–ø–∫–æ–π +: ${oldZoom}% ‚Üí ${newZoom}% (FOV ${currentFov.toFixed(1)}¬∞ ‚Üí ${newFov.toFixed(1)}¬∞)`);
  }

  zoomOut() {
    if (!this.aframeCamera || !this.aframeScene) {
      console.warn('‚ö†Ô∏è –ó—É–º –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω - –∫–∞–º–µ—Ä–∞ –∏–ª–∏ —Å—Ü–µ–Ω–∞ –Ω–µ –≥–æ—Ç–æ–≤—ã');
      return;
    }

    const currentFov = parseFloat(this.aframeCamera.getAttribute('fov')) || 80;
    const zoomStep = 5 * (this.zoomSpeed || 1);
    const newFov = Math.min(130, currentFov + zoomStep);

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π FOV –∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∫–∞–º–µ—Ä—É
    this.aframeCamera.setAttribute('fov', newFov);
    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º Three.js –∫–∞–º–µ—Ä—É –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏
    setTimeout(() => {
      if (this.aframeCamera.getObject3D('camera')) {
        this.aframeCamera.getObject3D('camera').updateProjectionMatrix();
        this.aframeCamera.getObject3D('camera').fov = newFov;
        this.aframeCamera.getObject3D('camera').updateProjectionMatrix();
      }
      // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º A-Frame –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
      if (this.aframeCamera.components && this.aframeCamera.components.camera) {
        this.aframeCamera.components.camera.tick();
      }
    }, 0);
    this.updateZoomIndicator(newFov);

    const oldZoom = Math.round((80 / currentFov) * 100);
    const newZoom = Math.round((80 / newFov) * 100);
    console.log(`üîç –ó—É–º –∫–Ω–æ–ø–∫–æ–π -: ${oldZoom}% ‚Üí ${newZoom}% (FOV ${currentFov.toFixed(1)}¬∞ ‚Üí ${newFov.toFixed(1)}¬∞)`);
  }

  resetZoom() {
    if (!this.aframeCamera || !this.aframeScene) {
      console.warn('‚ö†Ô∏è –ó—É–º –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω - –∫–∞–º–µ—Ä–∞ –∏–ª–∏ —Å—Ü–µ–Ω–∞ –Ω–µ –≥–æ—Ç–æ–≤—ã');
      return;
    }

    const currentFov = parseFloat(this.aframeCamera.getAttribute('fov')) || 80;

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º FOV –Ω–∞ 80 –∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∫–∞–º–µ—Ä—É
    this.aframeCamera.setAttribute('fov', 80);
    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º Three.js –∫–∞–º–µ—Ä—É –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏
    setTimeout(() => {
      if (this.aframeCamera.getObject3D('camera')) {
        this.aframeCamera.getObject3D('camera').updateProjectionMatrix();
        this.aframeCamera.getObject3D('camera').fov = 80;
        this.aframeCamera.getObject3D('camera').updateProjectionMatrix();
      }
      // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º A-Frame –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
      if (this.aframeCamera.components && this.aframeCamera.components.camera) {
        this.aframeCamera.components.camera.tick();
      }
    }, 0);
    this.updateZoomIndicator(80);

    const oldZoom = Math.round((80 / currentFov) * 100);
    console.log(`üîç –°–±—Ä–æ—Å –∑—É–º–∞: ${oldZoom}% ‚Üí 100% (FOV ${currentFov.toFixed(1)}¬∞ ‚Üí 80.0¬∞)`);
  }

  /**
   * –û–±–Ω–æ–≤–ª—è–µ—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑—É–º–∞ –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
   */
  updateZoomIndicator(fov) {
    const zoomValueElement = document.getElementById('zoom-value');
    if (zoomValueElement) {
      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º FOV –≤ –ø–æ–Ω—è—Ç–Ω—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç –∑—É–º–∞
      // FOV 80¬∞ = 100% (–±–∞–∑–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å)
      // FOV 40¬∞ = 200% (–ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ –≤ 2 —Ä–∞–∑–∞)
      // FOV 160¬∞ = 50% (–æ—Ç–¥–∞–ª–µ–Ω–∏–µ –≤ 2 —Ä–∞–∑–∞)
      const zoomPercent = Math.round((80 / fov) * 100);
      zoomValueElement.textContent = `${zoomPercent}%`;

      // –î–æ–±–∞–≤–∏–º —Ü–≤–µ—Ç–æ–≤–æ–µ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ
      const indicator = document.getElementById('zoom-indicator');
      if (indicator) {
        if (zoomPercent > 150) {
          indicator.style.background = 'rgba(0, 128, 0, 0.8)'; // –ó–µ–ª–µ–Ω—ã–π –¥–ª—è —Å–∏–ª—å–Ω–æ–≥–æ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏—è
        } else if (zoomPercent < 75) {
          indicator.style.background = 'rgba(128, 0, 0, 0.8)'; // –ö—Ä–∞—Å–Ω—ã–π –¥–ª—è —Å–∏–ª—å–Ω–æ–≥–æ –æ—Ç–¥–∞–ª–µ–Ω–∏—è
        } else {
          indicator.style.background = 'rgba(0, 0, 0, 0.7)'; // –û–±—ã—á–Ω—ã–π —Ü–≤–µ—Ç
        }

        // –ê–Ω–∏–º–∞—Ü–∏—è –º–∏–≥–∞–Ω–∏—è –¥–ª—è –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è –≤–Ω–∏–º–∞–Ω–∏—è
        indicator.style.transform = 'scale(1.1)';
        indicator.style.transition = 'all 0.2s ease';
        setTimeout(() => {
          indicator.style.transform = 'scale(1)';
        }, 200);
      }

      // –û–¢–ö–õ–Æ–ß–ï–ù–û: —É–±–∏—Ä–∞–µ–º –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∑—É–º–µ
      // this.showZoomNotification(zoomPercent);

      // –£–±–∏—Ä–∞–µ–º –∫–æ–Ω—Å–æ–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ –∑—É–º–µ (—Å–ª–∏—à–∫–æ–º —Å–ø–∞–º—è—Ç)
      // console.log(`üîç –ó—É–º: ${zoomPercent}% (FOV: ${fov.toFixed(1)}¬∞)`);
    }
  }

  /**
   * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∑—É–º–∞
   */
  showZoomNotification(zoomPercent) {
    // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    const existingNotification = document.getElementById('zoom-notification');
    if (existingNotification) {
      existingNotification.remove();
    }

    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    const notification = document.createElement('div');
    notification.id = 'zoom-notification';
    notification.style.cssText = `
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 15px 25px;
      border-radius: 10px;
      font-size: 24px;
      font-weight: bold;
      z-index: 10000;
      pointer-events: none;
      animation: zoomNotificationFade 1s ease;
    `;
    notification.textContent = `üîç ${zoomPercent}%`;

    // –î–æ–±–∞–≤–ª—è–µ–º CSS –∞–Ω–∏–º–∞—Ü–∏—é –µ—Å–ª–∏ –µ—ë –µ—â—ë –Ω–µ—Ç
    if (!document.getElementById('zoom-notification-style')) {
      const style = document.createElement('style');
      style.id = 'zoom-notification-style';
      style.textContent = `
        @keyframes zoomNotificationFade {
          0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
          20% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
          80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
          100% { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
        }
      `;
      document.head.appendChild(style);
    }

    document.body.appendChild(notification);

    // –£–¥–∞–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
    setTimeout(() => {
      if (notification.parentNode) {
        notification.remove();
      }
    }, 1000);
  }

  /**
   * –£–õ–£–ß–®–ï–ù–ù–ê–Ø —Å–∏—Å—Ç–µ–º–∞ –æ—á–∏—Å—Ç–∫–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã—Ö –º–µ–Ω—é —Å —É–¥–∞–ª–µ–Ω–∏–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
   */
  cleanupAutoCloseHandlers() {
    // –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –û—á–∏—â–∞–µ–º –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ auto-close –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    if (this._activeAutoCloseHandlers) {
      console.log('üßπ –û—á–∏—â–∞–µ–º', this._activeAutoCloseHandlers.size, '–∞–∫—Ç–∏–≤–Ω—ã—Ö auto-close –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤');

      this._activeAutoCloseHandlers.forEach(handler => {
        document.removeEventListener('click', handler, true);
        document.removeEventListener('mousedown', handler, true);
      });

      this._activeAutoCloseHandlers.clear();
      console.log('‚úÖ –í—Å–µ auto-close –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —É–¥–∞–ª–µ–Ω—ã');
    }
  }

  /**
   * –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
   */
  getDefaultSettings() {
    return {
      hotspotSize: 0.3,
      hotspotColor: '#ff0000',
      infopointSize: 0.25,
      infopointColor: '#0066cc'
    };
  }

  /**
   * –£–±–∏—Ä–∞–µ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è
   */
  removeFileExtension(filename) {
    if (!filename || typeof filename !== 'string') {
      return filename;
    }

    // –°–ø–∏—Å–æ–∫ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π –≤–∏–¥–µ–æ –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    const videoExtensions = ['.mp4', '.avi', '.mov', '.webm', '.mkv', '.flv', '.wmv', '.m4v', '.3gp', '.ogv'];
    const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.svg', '.webp', '.tiff', '.ico'];
    const allExtensions = [...videoExtensions, ...imageExtensions];

    const lowerFilename = filename.toLowerCase();

    for (const ext of allExtensions) {
      if (lowerFilename.endsWith(ext)) {
        return filename.slice(0, -ext.length);
      }
    }

    return filename;
  }

  /**
   * –£–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∏–∑ –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–µ–π
   */
  removeOldDarkElements() {
    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∫–Ω–æ–ø–∫–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è (–∑–µ–ª–µ–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã)
    const oldPlayButtons = document.querySelectorAll('.video-play-button');
    oldPlayButtons.forEach(button => {
      console.log('üßπ –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –∫–Ω–æ–ø–∫—É –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è');
      button.remove();
    });

    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –±–µ–∑ –ø–æ–¥–ª–æ–∂–∫–∏
    const oldTitleTexts = document.querySelectorAll('.video-title-text');
    oldTitleTexts.forEach(text => {
      console.log('üßπ –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –±–µ–∑ –ø–æ–¥–ª–æ–∂–∫–∏');
      text.remove();
    });

    // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª—ã –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–µ–π —Å –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–º–∏ —Ü–≤–µ—Ç–∞–º–∏
    const videoPlanes = document.querySelectorAll('[data-video-plane]');
    videoPlanes.forEach(plane => {
      const material = plane.getAttribute('material');
      if (material && material.opacity && parseFloat(material.opacity) < 0.5) {
        console.log('üßπ –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏');
        plane.setAttribute('material', {
          color: '#666666',
          opacity: 1.0,
          transparent: false,
          side: 'double',
          shader: 'flat'
        });
      }
    });
  }

  /**
   * –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏ —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –Ω–∞–ª–∏–ø–∞–Ω–∏—è –Ω–∞ –æ–±—ä–µ–∫—Ç—ã —Å—Ü–µ–Ω—ã
   */
  createVideoArea(hotspot, markerEl) {
    console.log('üé¨ –°–æ–∑–¥–∞–µ–º –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç—å:', hotspot);
    console.log('üé¨ videoUrl –≤ hotspot:', hotspot.videoUrl);
    console.log('üé¨ –í—Å–µ —Å–≤–æ–π—Å—Ç–≤–∞ hotspot:', Object.keys(hotspot));

    // –û–ß–ò–°–¢–ö–ê: –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Ç–µ–º–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
    this.removeOldDarkElements();

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ hotspot –∏–º–µ–µ—Ç –±–∞–∑–æ–≤—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞
    if (!hotspot || !hotspot.id) {
      console.error('‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π hotspot - –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç id:', hotspot);
      return null;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    if (!hotspot.position) {
      console.warn('‚ö†Ô∏è Hotspot –±–µ–∑ –ø–æ–∑–∏—Ü–∏–∏, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é');
      hotspot.position = { x: 0, y: 0, z: -3 };
    }

    console.log('üé¨ –ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è hotspot:', hotspot.position);

    // –ï—Å–ª–∏ markerEl –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω, —Å–æ–∑–¥–∞–µ–º –µ–≥–æ
    if (!markerEl) {
      console.log('üé¨ –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –º–∞—Ä–∫–µ—Ä –¥–ª—è –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏');
      markerEl = document.createElement('a-entity');
      markerEl.id = `marker-${hotspot.id}`;
      markerEl.setAttribute('data-hotspot-id', hotspot.id);
      markerEl.setAttribute('data-marker-id', hotspot.id);

      // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –º–∞—Ä–∫–µ—Ä
      const posStr = `${hotspot.position.x} ${hotspot.position.y} ${hotspot.position.z}`;
      console.log('üéØ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –Ω–æ–≤–æ–≥–æ –º–∞—Ä–∫–µ—Ä–∞:', hotspot.id, '–ø–æ–∑–∏—Ü–∏—è:', posStr);
      markerEl.setAttribute('position', posStr);

      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–ª–∞—Å—Å –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
      markerEl.className = 'interactive video-area';

      // –ù–û–í–û–ï: –î–æ–±–∞–≤–ª—è–µ–º —É–ª—É—á—à–µ–Ω–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–π –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ –∫ –∫–∞–º–µ—Ä–µ
      if (!AFRAME.components['face-camera']) {
        AFRAME.registerComponent('face-camera', {
          init: function () {
            this.cameraEl = null;
            this.tick = this.tick.bind(this);
            this.findCamera();
            console.log('üé• –ö–æ–º–ø–æ–Ω–µ–Ω—Ç face-camera –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–∞:', this.el.id);
          },

          findCamera: function () {
            // –ò—â–µ–º –∫–∞–º–µ—Ä—É —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏
            this.cameraEl = document.querySelector('[camera]') ||
              document.querySelector('a-camera') ||
              document.querySelector('#defaultCamera');

            if (!this.cameraEl) {
              const scene = document.querySelector('a-scene');
              if (scene && scene.camera && scene.camera.el) {
                this.cameraEl = scene.camera.el;
              }
            }

            if (this.cameraEl) {
              console.log('üì∑ –ö–∞–º–µ—Ä–∞ –Ω–∞–π–¥–µ–Ω–∞ –¥–ª—è face-camera –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞:', this.cameraEl.id || '–±–µ–∑ ID');
            } else {
              console.warn('‚ö†Ô∏è –ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –¥–ª—è face-camera –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞');
            }
          },

          tick: function () {
            if (!this.cameraEl) {
              this.findCamera();
              return;
            }

            // –ü–æ–ª—É—á–∞–µ–º –º–∏—Ä–æ–≤—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –∫–∞–º–µ—Ä—ã –∏ —ç–ª–µ–º–µ–Ω—Ç–∞
            const cameraWorldPosition = new THREE.Vector3();
            const elementWorldPosition = new THREE.Vector3();

            this.cameraEl.object3D.getWorldPosition(cameraWorldPosition);
            this.el.object3D.getWorldPosition(elementWorldPosition);

            // –í—ã—á–∏—Å–ª—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫ –∫–∞–º–µ—Ä–µ –¢–û–õ–¨–ö–û –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏
            const direction = new THREE.Vector3();
            direction.subVectors(cameraWorldPosition, elementWorldPosition);
            direction.y = 0; // –í–ê–ñ–ù–û: –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
            direction.normalize();

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ
            if (direction.length() > 0) {
              // –í—ã—á–∏—Å–ª—è–µ–º —É–≥–æ–ª –ø–æ–≤–æ—Ä–æ—Ç–∞ –ø–æ Y-–æ—Å–∏ - –ò–°–ü–†–ê–í–õ–ï–ù–û: —É–±–∏—Ä–∞–µ–º Math.PI –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ñ—Ä–æ–Ω—Ç–∞–ª—å–Ω–æ–π –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏
              const angle = Math.atan2(direction.x, direction.z);

              // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–≤–æ—Ä–æ—Ç –¢–û–õ–¨–ö–û –ø–æ Y-–æ—Å–∏
              this.el.object3D.rotation.set(0, angle, 0);
            }
          }
        });
        console.log('‚úÖ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω —É–ª—É—á—à–µ–Ω–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç face-camera');
      }

      // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–æ–π —Å—Ç—Ä–µ–ª–∫–∏
      if (!AFRAME.components['navigation-arrow']) {
        AFRAME.registerComponent('navigation-arrow', {
          init: function () {
            this.cameraEl = null;
            this.tick = this.tick.bind(this);
            this.findCamera();
            console.log('üß≠ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç navigation-arrow –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–∞:', this.el.id);
          },

          findCamera: function () {
            // –ò—â–µ–º –∫–∞–º–µ—Ä—É —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏
            this.cameraEl = document.querySelector('[camera]') ||
              document.querySelector('a-camera') ||
              document.querySelector('#defaultCamera');

            if (!this.cameraEl) {
              const scene = document.querySelector('a-scene');
              if (scene && scene.camera && scene.camera.el) {
                this.cameraEl = scene.camera.el;
              }
            }

            if (this.cameraEl) {
              console.log('üß≠ –ö–∞–º–µ—Ä–∞ –Ω–∞–π–¥–µ–Ω–∞ –¥–ª—è navigation-arrow –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞:', this.cameraEl.id || '–±–µ–∑ ID');
            } else {
              console.warn('‚ö†Ô∏è –ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –¥–ª—è navigation-arrow –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞');
            }
          },

          tick: function () {
            if (!this.cameraEl) {
              this.findCamera();
              return;
            }

            // –ü–æ–ª—É—á–∞–µ–º –º–∏—Ä–æ–≤—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –∫–∞–º–µ—Ä—ã –∏ —ç–ª–µ–º–µ–Ω—Ç–∞
            const cameraWorldPosition = new THREE.Vector3();
            const elementWorldPosition = new THREE.Vector3();

            this.cameraEl.object3D.getWorldPosition(cameraWorldPosition);
            this.el.object3D.getWorldPosition(elementWorldPosition);

            // –í—ã—á–∏—Å–ª—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –û–¢ –∫–∞–º–µ—Ä—ã (–ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ)
            const direction = new THREE.Vector3();
            direction.subVectors(elementWorldPosition, cameraWorldPosition);
            direction.y = 0; // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –ø–ª–æ—Å–∫–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
            direction.normalize();

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ
            if (direction.length() > 0) {
              // –í—ã—á–∏—Å–ª—è–µ–º —É–≥–æ–ª –ø–æ–≤–æ—Ä–æ—Ç–∞ –ø–æ Y-–æ—Å–∏ –¥–ª—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –û–¢ –∫–∞–º–µ—Ä—ã
              const angle = Math.atan2(direction.x, direction.z);

              // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–≤–æ—Ä–æ—Ç –¢–û–õ–¨–ö–û –ø–æ Y-–æ—Å–∏, —Å—Ç—Ä–µ–ª–∫–∞ —É–∫–∞–∑—ã–≤–∞–µ—Ç –≤–ø–µ—Ä—ë–¥ (–≤ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –æ—Ç –∫–∞–º–µ—Ä—ã)
              this.el.object3D.rotation.set(0, angle, 0);
            }
          }
        });
        console.log('‚úÖ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –∫–æ–º–ø–æ–Ω–µ–Ω—Ç navigation-arrow –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å—Ç—Ä–µ–ª–æ–∫');
      }

      // –ù–ï –ø—Ä–∏–º–µ–Ω—è–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç face-camera –∫ —Å–∞–º–æ–º—É –º–∞—Ä–∫–µ—Ä—É –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
      // markerEl.setAttribute('face-camera', '');

      // –í–ê–ñ–ù–û: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –º–∞—Ä–∫–µ—Ä–∞
      markerEl.setAttribute('visible', 'true');
    }

    // –°–æ–∑–¥–∞–µ–º –ø–ª–æ—Å–∫–æ—Å—Ç—å –¥–ª—è –≤–∏–¥–µ–æ —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º –ø–æ–¥—Ö–æ–¥–æ–º
    const videoPlane = document.createElement('a-plane');// –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Ä–∞–∑–º–µ—Ä—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ
    let width = parseFloat(hotspot.videoWidth) || 4;
    let height = parseFloat(hotspot.videoHeight) || 3;

    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ NaN
    if (isNaN(width) || width <= 0) width = 4;
    if (isNaN(height) || height <= 0) height = 3;

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –æ–±—Ä–∞—Ç–Ω–æ –≤ —Ö–æ—Ç—Å–ø–æ—Ç
    hotspot.videoWidth = width;
    hotspot.videoHeight = height;

    console.log('üé¨ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏:', { width, height });

    videoPlane.setAttribute('width', width);
    videoPlane.setAttribute('height', height);
    videoPlane.className = 'interactive video-area video-plane';
    videoPlane.setAttribute('data-video-plane', 'true'); // –î–ª—è –ø–æ–∏—Å–∫–∞ –≤ getResizeHandleAt
    videoPlane.setAttribute('billboard', ''); // –í—Å–µ–≥–¥–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–æ –∫ –∫–∞–º–µ—Ä–µ

    // –í–ê–ñ–ù–û: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å
    videoPlane.setAttribute('visible', 'true');

    // –ò–°–ü–†–ê–í–õ–ï–ù–û: –µ—Å–ª–∏ –µ—Å—Ç—å –≤–∏–¥–µ–æ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å—Ç–µ—Ä/–º–∏–Ω–∏–∞—Ç—é—Ä—É (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞) –≤–º–µ—Å—Ç–æ —Å–µ—Ä–æ–≥–æ –∏ —Ç–µ–∫—Å—Ç–∞
    if (hotspot.videoUrl && hotspot.videoUrl.trim() !== '') {
      let posterUrl = hotspot.poster;
      if ((!posterUrl || !posterUrl.trim()) && window.hotspotManager && typeof window.hotspotManager.getPoster === 'function') {
        posterUrl = window.hotspotManager.getPoster(hotspot.id);
      }

      if (posterUrl) {
        videoPlane.setAttribute('material', { shader: 'flat', side: 'double', src: posterUrl, transparent: false });
      } else {
        // –ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π —Ç—ë–º–Ω—ã–π —Ñ–æ–Ω –±–µ–∑ —Ç–µ–∫—Å—Ç–∞
        videoPlane.setAttribute('material', { shader: 'flat', side: 'double', color: '#222222', transparent: false, alphaTest: 0.1 });
      }
    } else {
      // –ï—Å–ª–∏ –Ω–µ—Ç –≤–∏–¥–µ–æ - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª-–∑–∞–≥–ª—É—à–∫—É –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
      videoPlane.setAttribute('material', {
        shader: 'flat',
        side: 'double',
        color: '#333333', // –¢–µ–º–Ω–æ-—Å–µ—Ä—ã–π —Ñ–æ–Ω –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        transparent: false,
        alphaTest: 0.1
      });

      // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç-–ø–æ–¥—Å–∫–∞–∑–∫—É –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
      videoPlane.setAttribute('text', {
        value: 'üé¨ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –≤–∏–¥–µ–æ\n(–ü–ö–ú - –º–µ–Ω—é)',
        color: 'white',
        align: 'center',
        width: 6
      });
    }

    // –£–¥–∞–ª—è–µ–º —Ä–∞–º–∫—É –ø–æ –∑–∞–ø—Ä–æ—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è - –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤

    // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –≤–∏–¥–µ–æ URL
    // –ë–µ—Ä–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–π videoUrl (—á–µ—Ä–µ–∑ HotspotManager c –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ–º)
    let videoUrl = hotspot.videoUrl;
    if ((!videoUrl || !videoUrl.trim()) && window.hotspotManager && typeof window.hotspotManager.getHotspotWithFullData === 'function') {
      const restored = window.hotspotManager.getHotspotWithFullData(hotspot.id);
      if (restored && restored.videoUrl) {
        videoUrl = restored.videoUrl;
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –æ–±—Ä–∞—Ç–Ω–æ –≤ —Ö–æ—Ç—Å–ø–æ—Ç –∏ –≤ —Ä–µ–µ—Å—Ç—Ä
        hotspot.videoUrl = videoUrl;
        if (typeof window.hotspotManager.registerVideoUrl === 'function') {
          window.hotspotManager.registerVideoUrl(hotspot.id, videoUrl);
        }
      }
    }
    console.log('üé¨ –û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π videoUrl:', videoUrl, '—Ç–∏–ø:', typeof videoUrl);

    // –í–°–ï–ì–î–ê —Å–æ–∑–¥–∞–µ–º –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –±—É–¥—É—â–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
    const videoId = `video-${hotspot.id}`;
    let videoEl = document.getElementById(videoId);

    // –î–æ–±–∞–≤–ª—è–µ–º —É–ª—É—á—à–µ–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –≤–∏–¥–µ–æ
    if (!videoEl) {
      console.log('üé¨ –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç —Å ID:', videoId);
      videoEl = document.createElement('video');
      videoEl.id = videoId;
      videoEl.crossOrigin = 'anonymous';
      videoEl.loop = true;
      videoEl.muted = false; // –ò–ó–ú–ï–ù–ï–ù–û: –Ω–∞—á–∏–Ω–∞–µ–º —Å –≤–∫–ª—é—á–µ–Ω–Ω—ã–º –∑–≤—É–∫–æ–º
      videoEl.autoplay = false; // –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –æ—Ç–∫–ª—é—á–µ–Ω
      videoEl.controls = false;
      videoEl.style.display = 'none';
      videoEl.preload = 'metadata';

      // –ù–û–í–û–ï: –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É –∑–≤—É–∫–∞
      videoEl.volume = 0.7; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥—Ä–æ–º–∫–æ—Å—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      videoEl.setAttribute('data-has-audio', 'false'); // –§–ª–∞–≥ –Ω–∞–ª–∏—á–∏—è –∑–≤—É–∫–∞

      // –ù–û–í–û–ï: –£–ª—É—á—à–µ–Ω–Ω–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤–∏–¥–µ–æ –∏ –∑–≤—É–∫–∞
      videoEl.addEventListener('loadeddata', () => {
        console.log('‚úÖ –í–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ:', hotspot.title);

        // –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ü—Ä–∏–º–µ–Ω—è–µ–º –≤–∏–¥–µ–æ-–º–∞—Ç–µ—Ä–∏–∞–ª –ö–ê–ö –¢–û–õ–¨–ö–û –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
        if (videoEl.readyState >= 2 && videoEl.videoWidth > 0 && videoEl.videoHeight > 0) {
          console.log('üé¨ –ü—Ä–∏–º–µ–Ω—è–µ–º –≤–∏–¥–µ–æ-–º–∞—Ç–µ—Ä–∏–∞–ª —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
          videoPlane.setAttribute('material', {
            src: `#${videoId}`,
            transparent: false,
            side: 'double',
            shader: 'flat'
          });
          // –£–±–∏—Ä–∞–µ–º –ª—é–±–æ–π —Ç–µ–∫—Å—Ç-–∑–∞–≥–ª—É—à–∫—É
          videoPlane.removeAttribute('text');
          console.log('‚úÖ –í–∏–¥–µ–æ-–º–∞—Ç–µ—Ä–∏–∞–ª —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–∑ loadeddata:', `#${videoId}`);

          // –ü–æ–ø—ã—Ç–∫–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å—Ç–µ—Ä –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –∫–∞–¥—Ä–∞, –µ—Å–ª–∏ –æ–Ω –µ—â—ë –Ω–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω
          try {
            const hasPoster = !!hotspot.poster || (window.hotspotManager && typeof window.hotspotManager.getPoster === 'function' && window.hotspotManager.getPoster(hotspot.id));
            if (!hasPoster && window.hotspotManager && typeof window.hotspotManager.registerPoster === 'function') {
              const canvas = document.createElement('canvas');
              const maxW = 640;
              const scale = Math.min(1, maxW / videoEl.videoWidth);
              canvas.width = Math.round(videoEl.videoWidth * scale);
              canvas.height = Math.round(videoEl.videoHeight * scale);
              const ctx = canvas.getContext('2d');
              ctx.drawImage(videoEl, 0, 0, canvas.width, canvas.height);
              const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
              if (dataUrl && dataUrl.startsWith('data:image')) {
                window.hotspotManager.registerPoster(hotspot.id, dataUrl);
              }
            }
          } catch (e) {
            console.warn('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç–µ—Ä –∏–∑ –∫–∞–¥—Ä–∞:', e);
          }
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∞—É–¥–∏–æ–¥–æ—Ä–æ–∂–∫–∏
        const hasAudio = videoEl.mozHasAudio ||
          Boolean(videoEl.webkitAudioDecodedByteCount) ||
          Boolean(videoEl.audioTracks && videoEl.audioTracks.length) ||
          // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ MediaMetadata
          (videoEl.readyState >= 1 && videoEl.duration > 0);

        videoEl.setAttribute('data-has-audio', hasAudio.toString());
        console.log(`üîä –ê—É–¥–∏–æ –≤ –≤–∏–¥–µ–æ "${hotspot.title}": ${hasAudio ? '–æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ' : '–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}`);

        // –ê—É–¥–∏–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ –ø–æ –∑–∞–ø—Ä–æ—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        // if (hasAudio) {
        //   this.addAudioControls(markerEl, videoEl, hotspot);
        // }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å—Ç–æ—Ä–æ–Ω –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏, –µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
        if (videoEl.videoWidth && videoEl.videoHeight && videoEl.readyState >= 2) {
          const videoAspect = videoEl.videoWidth / videoEl.videoHeight;

          // –ï—Å–ª–∏ —Ä–∞–∑–Ω–∏—Ü–∞ –≤ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–∏ —Å—Ç–æ—Ä–æ–Ω –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–∞—è, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º
          const currentAspect = width / height;
          if (Math.abs(videoAspect - currentAspect) > 0.1) {
            console.log('üîÑ –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å—Ç–æ—Ä–æ–Ω –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏:',
              `${currentAspect.toFixed(2)} -> ${videoAspect.toFixed(2)}`);

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –ø–ª–æ—â–∞–¥—å
            const currentArea = width * height;

            // –í—ã—á–∏—Å–ª—è–µ–º –Ω–æ–≤—ã–µ —Ä–∞–∑–º–µ—Ä—ã, —Å–æ—Ö—Ä–∞–Ω—è—è –ø—Ä–∏–º–µ—Ä–Ω–æ —Ç—É –∂–µ –ø–ª–æ—â–∞–¥—å
            const newHeight = Math.sqrt(currentArea / videoAspect);
            const newWidth = newHeight * videoAspect;

            // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–æ–≤—ã–µ —Ä–∞–∑–º–µ—Ä—ã
            videoPlane.setAttribute('width', newWidth);
            videoPlane.setAttribute('height', newHeight);

            // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä—ã –≤ –¥–∞–Ω–Ω—ã—Ö —Ö–æ—Ç—Å–ø–æ—Ç–∞
            hotspot.videoWidth = newWidth;
            hotspot.videoHeight = newHeight;

            // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä—ã –∑–æ–Ω —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤)
            this.updateResizeHandles(markerEl, videoPlane, hotspot);
          }
        }

        // –ù–û–í–û–ï: –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const loadingIndicator = markerEl.querySelector('.video-loading-indicator');
        if (loadingIndicator) {
          loadingIndicator.setAttribute('visible', 'false');
        }
      });

      videoEl.addEventListener('canplay', () => {
        console.log('‚úÖ –í–∏–¥–µ–æ –≥–æ—Ç–æ–≤–æ –∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—é:', hotspot.title);

        // –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –≤–∏–¥–µ–æ-–º–∞—Ç–µ—Ä–∏–∞–ª –ø—Ä–∏–º–µ–Ω–µ–Ω
        const currentMaterial = videoPlane.getAttribute('material');
        if (!currentMaterial || !currentMaterial.src || currentMaterial.src !== `#${videoId}`) {
          console.log('üé¨ –ü—Ä–∏–º–µ–Ω—è–µ–º –≤–∏–¥–µ–æ-–º–∞—Ç–µ—Ä–∏–∞–ª –≤ canplay');
          videoPlane.setAttribute('material', {
            src: `#${videoId}`,
            transparent: false,
            side: 'double',
            shader: 'flat'
          });
          videoPlane.removeAttribute('text');
          console.log('‚úÖ –í–∏–¥–µ–æ-–º–∞—Ç–µ—Ä–∏–∞–ª —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–∑ canplay:', `#${videoId}`);
        }

        // –ù–û–í–û–ï: –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
        // this.showPlayButton(markerEl, videoPlane);
      });

      videoEl.addEventListener('error', (e) => {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ:', e, hotspot.title);

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥–ª—É—à–∫—É –ø—Ä–∏ –æ—à–∏–±–∫–µ
        videoPlane.setAttribute('material', {
          color: '#cc3333',
          transparent: false,
          side: 'double',
          shader: 'flat'
        });

        // –ù–û–í–û–ï: –î–æ–±–∞–≤–ª—è–µ–º –±–æ–ª–µ–µ –∑–∞–º–µ—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
        const errorTextEntity = document.createElement('a-text');
        errorTextEntity.setAttribute('value', `‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ\n${hotspot.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}`);
        errorTextEntity.setAttribute('align', 'center');
        errorTextEntity.setAttribute('color', '#ffffff');
        errorTextEntity.setAttribute('width', width * 0.75);
        errorTextEntity.setAttribute('position', `0 0 0.01`);
        videoPlane.appendChild(errorTextEntity);

        // –£–¥–∞–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const loadingIndicator = markerEl.querySelector('.video-loading-indicator');
        if (loadingIndicator) {
          loadingIndicator.setAttribute('visible', 'false');
        }
      });

      // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ play/pause (—Å —É–ª—É—á—à–µ–Ω–Ω—ã–º–∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞–º–∏)
      videoEl.addEventListener('play', () => {
        console.log('‚ñ∂Ô∏è –í–∏–¥–µ–æ –Ω–∞—á–∞–ª–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ');
        console.log('‚úÖ –í–∏–¥–µ–æ –∑–∞–ø—É—â–µ–Ω–æ:', hotspot.title);

        // –ù–û–í–û–ï: –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
        const playButton = markerEl.querySelector('.video-play-button');
        if (playButton) {
          playButton.setAttribute('visible', 'false');
        }

        // –ù–û–í–û–ï: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–∞—É–∑—ã –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
        videoPlane.setAttribute('data-video-playing', 'true');
      });

      videoEl.addEventListener('pause', () => {
        console.log('‚è∏Ô∏è –í–∏–¥–µ–æ –ø–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –Ω–∞ –ø–∞—É–∑—É');

        // –ù–û–í–û–ï: –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
        // this.showPlayButton(markerEl, videoPlane);

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        videoPlane.setAttribute('data-video-playing', 'false');
      });

      // –ù–û–í–û–ï: –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–∫–æ–Ω—á–∞–Ω–∏—è –≤–∏–¥–µ–æ
      videoEl.addEventListener('ended', () => {
        console.log('üîÑ –í–∏–¥–µ–æ –∑–∞–≤–µ—Ä—à–∏–ª–æ—Å—å, –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è');
        // this.showPlayButton(markerEl, videoPlane, true); // –û–¢–ö–õ–Æ–ß–ï–ù–û
      });

      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫ –≤–∏–¥–µ–æ
      if (videoUrl) {
        console.log('üé¨ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫ –≤–∏–¥–µ–æ:', videoUrl);
        videoEl.src = videoUrl;

        // –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–ê–Ø –ó–ê–ì–†–£–ó–ö–ê –¥–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è
        console.log('üîÑ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≥—Ä—É–∂–∞–µ–º –≤–∏–¥–µ–æ');
        videoEl.load();

        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
        console.log('üîç –°–æ—Å—Ç–æ—è–Ω–∏–µ –≤–∏–¥–µ–æ –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ src:', {
          src: videoEl.src,
          readyState: videoEl.readyState,
          networkState: videoEl.networkState
        });
      }

      // –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–¥–µ–æ –≤ assets
      let assets = this.aframeScene.querySelector('a-assets');
      if (!assets) {
        assets = document.createElement('a-assets');
        this.aframeScene.appendChild(assets);
      }
      assets.appendChild(videoEl);
    } // –ó–∞–∫—Ä—ã–≤–∞–µ–º –±–ª–æ–∫ —Å–æ–∑–¥–∞–Ω–∏—è –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç–∞

    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≥—Ä—É–∂–∞–µ–º –≤–∏–¥–µ–æ –µ—Å–ª–∏ src —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
    if (videoEl.src && videoEl.readyState === 0) {
      console.log('üé¨ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≥—Ä—É–∂–∞–µ–º –≤–∏–¥–µ–æ:', videoEl.src);
      videoEl.load();
    }

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫ –≤–∏–¥–µ–æ –∏–ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥–ª—É—à–∫—É
    if (videoUrl && videoUrl.trim() !== '') {
      console.log('‚úÖ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º videoUrl:', videoUrl);

      // –£–ª—É—á—à–µ–Ω–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–∏–¥–µ–æ URL —Å –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏
      if (videoEl && typeof videoEl.setAttribute === 'function') {
        try {
          // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —ç–ª–µ–º–µ–Ω—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤
          if (videoEl.readyState !== undefined) {
            videoEl.src = videoUrl;
            console.log('üé¨ –í–∏–¥–µ–æ src —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞–ø—Ä—è–º—É—é:', videoUrl);

            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
            videoEl.load();
            console.log('üîÑ –ó–∞–ø—É—â–µ–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ');
            // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º URL –≤ —Ä–µ–µ—Å—Ç—Ä–µ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
            if (window.hotspotManager && typeof window.hotspotManager.registerVideoUrl === 'function') {
              window.hotspotManager.registerVideoUrl(hotspot.id, videoUrl);
            }
          } else {
            // –ï—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –Ω–µ –≥–æ—Ç–æ–≤, –∂–¥–µ–º –∏ –ø–æ–≤—Ç–æ—Ä—è–µ–º
            setTimeout(() => {
              videoEl.src = videoUrl;
              videoEl.load();
              console.log('üîÑ –û—Ç–ª–æ–∂–µ–Ω–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–∏–¥–µ–æ src:', videoUrl);
              if (window.hotspotManager && typeof window.hotspotManager.registerVideoUrl === 'function') {
                window.hotspotManager.registerVideoUrl(hotspot.id, videoUrl);
              }
            }, 100);
          }
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤–∏–¥–µ–æ src:', error);
        }
      } else {
        console.error('‚ùå videoEl –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ src');
      }
    } else {
      console.log('üé¨ –ù–µ—Ç videoUrl - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∏–¥–∏–º—É—é –∑–∞–≥–ª—É—à–∫—É');

      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏–¥–∏–º—ã–π —Å–µ—Ä—ã–π —Ñ–æ–Ω –¥–ª—è –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏ –±–µ–∑ –≤–∏–¥–µ–æ
      videoPlane.setAttribute('material', {
        color: '#666666',
        opacity: 1.0,
        transparent: false,
        side: 'double'
      });

      // –ù–ï —Å–æ–∑–¥–∞–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç –∏ –∏–∫–æ–Ω–∫—É –≤ —Ü–µ–Ω—Ç—Ä–µ - –æ—Å—Ç–∞–≤–ª—è–µ–º –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç—å —á–∏—Å—Ç–æ–π
    }

    // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π
    const titleForHandler = hotspot.title && hotspot.title.trim() !== '' ? hotspot.title : '–í–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç—å';
    videoPlane.setAttribute('hotspot-handler', `hotspotId: ${hotspot.id}; hotspotTitle: ${titleForHandler}; hotspotType: video-area`);

    // –î–µ–ª–∞–µ–º –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç—å –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º–æ–π
    markerEl.className = 'interactive draggable';
    markerEl._isDragging = false;
    markerEl._tooltipVisible = false;
    markerEl._isVideoArea = true; // –ü–æ–º–µ—á–∞–µ–º –∫–∞–∫ –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç—å

    // –ò–ù–î–ò–ö–ê–¢–û–†–´ –í–û–°–ü–†–û–ò–ó–í–ï–î–ï–ù–ò–Ø –£–ë–†–ê–ù–´ –ü–û –ó–ê–ü–†–û–°–£ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–æ–∫–∞–∑–∞ –∫—É—Ä—Å–æ—Ä–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ (–ë–ï–ó –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤)
    videoPlane.addEventListener('mouseenter', (e) => {
      if (!markerEl._isDragging) {
        document.body.style.cursor = 'pointer';
        console.log('üé¨ Mouse ENTER –Ω–∞ –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç—å:', hotspot.title);
        // –ù–ï —Å–æ–∑–¥–∞–µ–º –Ω–∏–∫–∞–∫–∏—Ö –≤–∏–∑—É–∞–ª—å–Ω—ã—Ö –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
      }
    });

    videoPlane.addEventListener('mouseleave', (e) => {
      if (!markerEl._isDragging) {
        document.body.style.cursor = 'default';
        console.log('üé¨ Mouse LEAVE –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç—å:', hotspot.title);
        // –ù–ï —É–¥–∞–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã, —Ç–∞–∫ –∫–∞–∫ –Ω–µ —Å–æ–∑–¥–∞–≤–∞–ª–∏ –∏—Ö
      }
    });

    // –û–°–ù–û–í–ù–û–ô –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è/–ø–∞—É–∑—ã –≤–∏–¥–µ–æ
    videoPlane.addEventListener('click', (e) => {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –∏–º–µ–Ω–Ω–æ –ª–µ–≤–∞—è –∫–Ω–æ–ø–∫–∞ –º—ã—à–∏ (–≤ A-Frame event.button –º–æ–∂–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å)
      console.log('üñ±Ô∏è –ö–ª–∏–∫ –ø–æ –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏:', e.button);

      // –ï—Å–ª–∏ —è–≤–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ, —á—Ç–æ —ç—Ç–æ –Ω–µ –ª–µ–≤–∞—è –∫–Ω–æ–ø–∫–∞ –º—ã—à–∏ - –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
      if (e.button !== undefined && e.button !== 0) {
        console.log('üñ±Ô∏è –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–ª–∏–∫ –Ω–µ –ª–µ–≤–æ–π –∫–Ω–æ–ø–∫–æ–π:', e.button);
        return;
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –Ω–µ —Å–æ–±—ã—Ç–∏–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
      if (markerEl._isDragging) {
        console.log('üñ±Ô∏è –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–ª–∏–∫ –≤–æ –≤—Ä–µ–º—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è');
        return;
      }

      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –¥—Ä—É–≥–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏

      console.log('üñ±Ô∏è –û–°–ù–û–í–ù–û–ô –õ–ö–ú –∫–ª–∏–∫ –ø–æ –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏:', hotspot.title);

      // –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ö–æ—Ç—Å–ø–æ—Ç–∞ —Å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º–∏ –ø–æ–ª—è–º–∏
      const fullHotspot = window.hotspotManager ? window.hotspotManager.getHotspotWithFullData(hotspot.id) : hotspot;
      const currentVideoUrl = fullHotspot.videoUrl || videoUrl;

      if (currentVideoUrl && currentVideoUrl.trim() !== '') {
        const videoEl = document.getElementById(videoId);
        if (videoEl) {
          console.log('üé¨ –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤–∏–¥–µ–æ:', {
            paused: videoEl.paused,
            ended: videoEl.ended,
            currentTime: videoEl.currentTime,
            readyState: videoEl.readyState
          });

          if (videoEl.paused || videoEl.ended) {
            console.log('‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫–∞–µ–º –≤–∏–¥–µ–æ:', hotspot.title);

            // –ï—Å–ª–∏ –≤–∏–¥–µ–æ –∑–∞–∫–æ–Ω—á–∏–ª–æ—Å—å, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫ –Ω–∞—á–∞–ª—É
            if (videoEl.ended) {
              videoEl.currentTime = 0;
            }

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏–¥–µ–æ –º–∞—Ç–µ—Ä–∏–∞–ª –µ—Å–ª–∏ –≥–æ—Ç–æ–≤
            if (videoEl.readyState >= 2 && videoEl.videoWidth > 0 && videoEl.videoHeight > 0) {
              videoPlane.setAttribute('material', {
                src: `#${videoId}`,
                transparent: false,
                side: 'double',
                shader: 'flat'
              });
              videoPlane.removeAttribute('text');
              console.log('‚úÖ –í–∏–¥–µ–æ –º–∞—Ç–µ—Ä–∏–∞–ª —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:', `#${videoId}`);
            }

            // –ó–∞–ø—É—Å–∫–∞–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
            videoEl.play().then(() => {
              console.log('‚úÖ –í–∏–¥–µ–æ –∑–∞–ø—É—â–µ–Ω–æ:', hotspot.title);
            }).catch(err => {
              console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:', err);
              if (err.name === 'NotAllowedError') {
                videoEl.muted = true;
                videoEl.play().then(() => {
                  console.log('‚úÖ –í–∏–¥–µ–æ –∑–∞–ø—É—â–µ–Ω–æ –±–µ–∑ –∑–≤—É–∫–∞');
                }).catch(e => {
                  console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤–∏–¥–µ–æ:', e);
                });
              }
            });
          } else {
            console.log('‚è∏Ô∏è –°—Ç–∞–≤–∏–º –≤–∏–¥–µ–æ –Ω–∞ –ø–∞—É–∑—É:', hotspot.title);
            videoEl.pause();
            console.log('‚úÖ –í–∏–¥–µ–æ –ø–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –Ω–∞ –ø–∞—É–∑—É');
          }
        }
      } else {
        // –ù–µ—Ç –≤–∏–¥–µ–æ URL - –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä –∏–ª–∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
        console.log('üé¨ –ù–µ—Ç videoUrl - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–ª–∏–∫ –±–µ–∑ –≤–∏–¥–µ–æ');

        if (fullHotspot._needsVideoRestore) {
          // –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤–∏–¥–µ–æ
          if (window.hotspotManager && window.hotspotManager.promptForVideoRestore) {
            window.hotspotManager.promptForVideoRestore(fullHotspot, fullHotspot._needsVideoRestore);
          }
        } else {
          // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
          console.log('üé¨ –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∏–¥–µ–æ');
          if (window.hotspotManager && window.hotspotManager.editHotspot) {
            window.hotspotManager.editHotspot(hotspot.id);
          } else {
            console.warn('–§—É–Ω–∫—Ü–∏—è editHotspot –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
          }
        }
      }
    }, true); // –ò—Å–ø–æ–ª—å–∑—É–µ–º capture phase –¥–ª—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞

    // –ë–ª–æ–∫–∏—Ä—É–µ–º –ü–ö–ú (–±–µ–∑ –∑–∞–ø—É—Å–∫–∞ –≤–∏–¥–µ–æ)
    videoPlane.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      e.stopPropagation();
      console.log('üñ±Ô∏è –ü–ö–ú –∫–ª–∏–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –Ω–∞ –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏ (–±–µ–∑ –¥–µ–π—Å—Ç–≤–∏–π)');
    });

    // –î–æ–±–∞–≤–ª—è–µ–º —É–≥–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞
    this.addResizeHandles(markerEl, videoPlane, hotspot);

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏
    this.setupVideoAreaDragHandlers(markerEl, videoPlane, hotspot);

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª –¥–ª—è –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏ (–Ω–µ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ—Å—Ç–µ—Ä, –µ—Å–ª–∏ –æ–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
    if (videoUrl && videoUrl.trim() !== '') {
      const currentMaterial = videoPlane.getAttribute('material');
      if (!(currentMaterial && currentMaterial.src)) {
        videoPlane.setAttribute('material', {
          color: '#222222',
          opacity: 1.0,
          transparent: false,
          side: 'double',
          shader: 'flat'
        });
        console.log('‚úÖ –ù–∞—á–∞–ª—å–Ω—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª –¥–ª—è –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (–æ–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏)');
      }

      // –ï—Å–ª–∏ –≤–∏–¥–µ–æ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ, —Å—Ä–∞–∑—É –ø—Ä–∏–º–µ–Ω—è–µ–º –≤–∏–¥–µ–æ-–º–∞—Ç–µ—Ä–∏–∞–ª
      if (videoEl && videoEl.readyState >= 2 && videoEl.videoWidth > 0 && videoEl.videoHeight > 0) {
        console.log('üé¨ –í–∏–¥–µ–æ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ, –ø—Ä–∏–º–µ–Ω—è–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ');
        videoPlane.setAttribute('material', { src: `#${videoId}`, transparent: false, side: 'double', shader: 'flat' });
        console.log('‚úÖ –í–∏–¥–µ–æ-–º–∞—Ç–µ—Ä–∏–∞–ª –ø—Ä–∏–º–µ–Ω–µ–Ω –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ:', `#${videoId}`);
      }
    } else {
      // –ï—Å–ª–∏ –Ω–µ—Ç –≤–∏–¥–µ–æ URL - —Å—Ç–∞–≤–∏–º –≤–∏–¥–∏–º—ã–π —Å–µ—Ä—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª
      videoPlane.setAttribute('material', {
        color: '#999999',
        opacity: 1.0,
        transparent: false,
        side: 'double',
        shader: 'flat'
      });
      console.log('‚úÖ –ú–∞—Ç–µ—Ä–∏–∞–ª –¥–ª—è –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (–±–µ–∑ –≤–∏–¥–µ–æ URL)');
    }

    // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –î–æ–±–∞–≤–ª—è–µ–º face-camera –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –∫ –ú–ê–†–ö–ï–†–£, –∞ –Ω–µ –∫ –≤–∏–¥–µ–æ-–ø–ª–æ—Å–∫–æ—Å—Ç–∏
    // –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—é –≤—Å–µ–π –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏ –∫–∞–∫ –µ–¥–∏–Ω–æ–≥–æ —Ü–µ–ª–æ–≥–æ
    markerEl.setAttribute('face-camera', '');
    console.log('‚úÖ Face-camera –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–æ–±–∞–≤–ª–µ–Ω –∫ –º–∞—Ä–∫–µ—Ä—É –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏');

    // –î–æ–±–∞–≤–ª—è–µ–º –ø–ª–æ—Å–∫–æ—Å—Ç—å –∫ –º–∞—Ä–∫–µ—Ä—É
    markerEl.appendChild(videoPlane);

    // –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ —Å–æ–±—ã—Ç–∏–π –º—ã—à–∏ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–≤–æ—Ä–æ—Ç –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å –≤ hotspot
    if (hotspot.rotation) {
      const rotationStr = `${hotspot.rotation.x || 0} ${hotspot.rotation.y || 0} ${hotspot.rotation.z || 0}`;
      markerEl.setAttribute('rotation', rotationStr);
      console.log('üîÑ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–≤–æ—Ä–æ—Ç –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏:', rotationStr);
    }

    // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä –≤ —Å—Ü–µ–Ω—É
    this.aframeScene.appendChild(markerEl);
    console.log('üé¨ –ú–∞—Ä–∫–µ—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ A-Frame —Å—Ü–µ–Ω—É');

    // –§–ò–ù–ê–õ–¨–ù–ê–Ø –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–∏–¥–∏–º–æ—Å—Ç–∏ - —É–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ –º–∞—Ä–∫–µ—Ä –≤–∏–¥–∏–º—ã–π
    markerEl.setAttribute('visible', 'true');
    videoPlane.setAttribute('visible', 'true');
    console.log('üé¨ –ú–∞—Ä–∫–µ—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å—Ü–µ–Ω—É, –≤–∏–¥–∏–º–æ—Å—Ç—å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞:', markerEl.id);

    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
    setTimeout(() => {
      const addedMarker = document.getElementById(`marker-${hotspot.id}`);
      console.log('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –º–∞—Ä–∫–µ—Ä–∞ —á–µ—Ä–µ–∑ 100ms:', {
        found: !!addedMarker,
        visible: addedMarker ? addedMarker.getAttribute('visible') : '–Ω–µ –Ω–∞–π–¥–µ–Ω',
        inScene: addedMarker ? this.aframeScene.contains(addedMarker) : false,
        position: addedMarker ? addedMarker.getAttribute('position') : '–Ω–µ –Ω–∞–π–¥–µ–Ω'
      });
    }, 100);

    // –ù–ê–°–¢–†–ê–ò–í–ê–ï–ú –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ coordinate_manager (–ü–û–°–õ–ï –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ —Å—Ü–µ–Ω—É)
    if (this.coordinateManager) {
      this.coordinateManager.setupMarkerDragging(markerEl, hotspot.id, (newPosition) => {
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –≤ –º–µ–Ω–µ–¥–∂–µ—Ä–µ —Ö–æ—Ç—Å–ø–æ—Ç–æ–≤
        this.hotspotManager.updateHotspotPosition(hotspot.id, newPosition);
        markerEl._wasDragged = true;
        console.log('üéØ –ü–æ–∑–∏—Ü–∏—è –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ —á–µ—Ä–µ–∑ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä:', hotspot.id, newPosition);
      });
    }

    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏—é –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏ –≤ hotspotManager
    if (hotspot.position) {
      console.log('üíæ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏—é –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏:', hotspot.id, hotspot.position);
      this.hotspotManager.updateHotspotPosition(hotspot.id, hotspot.position);
    }

    console.log('‚úÖ –í–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç—å —Å–æ–∑–¥–∞–Ω–∞:', hotspot.id);
    return markerEl;
  }

  /**
   * –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è YouTube URL –≤ –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É
   */
  convertYouTubeUrl(url) {
    const videoIdMatch = url.match(/(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
    if (videoIdMatch) {
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º YouTube embed URL (–º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∞)
      return `https://www.youtube.com/embed/${videoIdMatch[1]}`;
    }
    return null;
  }

  /**
   * –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è RuTube URL –≤ –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É
   */
  convertRuTubeUrl(url) {
    const videoIdMatch = url.match(/(?:https?:\/\/)?(?:www\.)?rutube\.ru\/video\/([a-zA-Z0-9_-]+)/);
    if (videoIdMatch) {
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º RuTube embed URL
      return `https://rutube.ru/play/embed/${videoIdMatch[1]}`;
    }
    return null;
  }

  /**
   * –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –¥–ª—è –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏
   */
  setupVideoAreaDragHandlers(markerEl, videoPlane, hotspot) {
    // –î–µ–±–∞—É–Ω—Å–∏–Ω–≥ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –Ω–∞–≤–µ–¥–µ–Ω–∏—è
    let mouseEnterTimeout = null;
    let mouseLeaveTimeout = null;

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –≥—Ä–∞–Ω–∏—Ü —Å –¥–µ–±–∞—É–Ω—Å–∏–Ω–≥–æ–º
    videoPlane.addEventListener('mouseenter', (e) => {
      if (mouseEnterTimeout) clearTimeout(mouseEnterTimeout);
      mouseEnterTimeout = setTimeout(() => {
        console.log('MOUSEENTER –Ω–∞ –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç—å:', hotspot.title);
        e.stopPropagation();
        if (!markerEl._isDragging) {
          // –ù–ï –º–µ–Ω—è–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª –≤–∏–¥–µ–æ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ - —Ç–æ–ª—å–∫–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
          console.log('üé¨ –ù–ï –∏–∑–º–µ–Ω—è–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª –≤–∏–¥–µ–æ –ø—Ä–∏ mouseenter');
        }
        this._lastHoveredMarker = { element: markerEl, hotspot: hotspot, time: Date.now() };
        // –û–¢–ö–õ–Æ–ß–ï–ù–û: –ø–æ–∫–∞–∑ resize handles –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –º—ã—à–∏
        // this.showResizeHandles(markerEl);
      }, 100); // –î–µ–±–∞—É–Ω—Å–∏–Ω–≥ 100ms
    });

    videoPlane.addEventListener('mouseleave', (e) => {
      if (mouseLeaveTimeout) clearTimeout(mouseLeaveTimeout);
      mouseLeaveTimeout = setTimeout(() => {
        console.log('MOUSELEAVE –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç—å:', hotspot.title);
        e.stopPropagation();
        if (!markerEl._isDragging) {
          // –ù–ï –º–µ–Ω—è–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª –≤–∏–¥–µ–æ –ø—Ä–∏ mouseleave - —Ç–æ–ª—å–∫–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
          console.log('üé¨ –ù–ï –∏–∑–º–µ–Ω—è–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª –≤–∏–¥–µ–æ –ø—Ä–∏ mouseleave');
        }
        // –û–¢–ö–õ–Æ–ß–ï–ù–û: —Å–∫—Ä—ã—Ç–∏–µ resize handles –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –º—ã—à–∏
        // this.hideResizeHandles(markerEl);
      }, 100); // –î–µ–±–∞—É–Ω—Å–∏–Ω–≥ 100ms
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
    // –£–ë–ò–†–ê–ï–ú DOM-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫ mousedown - —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä
    // videoPlane.addEventListener('mousedown', ...) - –£–î–ê–õ–ï–ù –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤

    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä
    if (this.coordinateManager) {
      console.log('ÔøΩ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏ —á–µ—Ä–µ–∑ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä');
      // this.coordinateManager.setupDraggable(markerEl, hotspot); - –º–µ—Ç–æ–¥ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é - –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —ç—Ç–æ—Ç
    videoPlane.addEventListener('contextmenu', (e) => {
      console.log('üé¨ –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –Ω–∞ –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏:', hotspot.title);
      e.stopPropagation();
      e.preventDefault();
      return false;
    });
  }

  /**
   * –û–±–Ω–æ–≤–ª—è–µ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫ –≤–∏–¥–µ–æ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏
   * @param {Element} markerEl - –ú–∞—Ä–∫–µ—Ä –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏
   * @param {Element} videoPlane - –ü–ª–æ—Å–∫–æ—Å—Ç—å –≤–∏–¥–µ–æ
   * @param {string} hotspotId - ID —Ö–æ—Ç—Å–ø–æ—Ç–∞
   * @param {string} videoUrl - –ù–æ–≤—ã–π URL –≤–∏–¥–µ–æ
   */
  updateVideoSource(markerEl, videoPlane, hotspotId, videoUrl) {
    if (!videoUrl || !hotspotId) return;

    console.log('üîÑ –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫ –≤–∏–¥–µ–æ:', videoUrl);

    // –ü–æ–ª—É—á–∞–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç
    const videoId = `video-${hotspotId}`;
    let videoEl = document.getElementById(videoId);

    if (!videoEl) {
      // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç
      videoEl = document.createElement('video');
      videoEl.id = videoId;
      videoEl.crossOrigin = 'anonymous';
      videoEl.loop = true;
      videoEl.muted = true;
      videoEl.autoplay = false;
      videoEl.controls = false;
      videoEl.style.display = 'none';
      videoEl.preload = 'metadata';

      // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
      videoEl.addEventListener('loadeddata', () => {
        console.log('‚úÖ –í–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ:', videoUrl);

        // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const loadingIndicator = markerEl.querySelector('.video-loading-indicator');
        if (loadingIndicator) {
          loadingIndicator.setAttribute('visible', 'false');
        }

        // –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
        // this.showPlayButton(markerEl, videoPlane);
      });

      videoEl.addEventListener('error', (e) => {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ:', e);

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
        videoPlane.setAttribute('material', {
          color: '#cc3333',
          transparent: false,
          side: 'double',
          shader: 'flat'
        });

        // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const loadingIndicator = markerEl.querySelector('.video-loading-indicator');
        if (loadingIndicator) {
          loadingIndicator.setAttribute('visible', 'false');
        }
      });

      // –î–æ–±–∞–≤–ª—è–µ–º –≤ assets
      let assets = this.aframeScene.querySelector('a-assets');
      if (!assets) {
        assets = document.createElement('a-assets');
        this.aframeScene.appendChild(assets);
      }
      assets.appendChild(videoEl);
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫ –≤–∏–¥–µ–æ
    videoEl.src = videoUrl;
    videoEl.load();

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    const loadingIndicator = markerEl.querySelector('.video-loading-indicator');
    if (loadingIndicator) {
      loadingIndicator.setAttribute('visible', 'true');
    } else {
      // –°–æ–∑–¥–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
      const newLoadingIndicator = document.createElement('a-entity');
      newLoadingIndicator.className = 'video-loading-indicator';

      const spinnerRing = document.createElement('a-ring');
      spinnerRing.setAttribute('radius-inner', '0.4');
      spinnerRing.setAttribute('radius-outer', '0.6');
      spinnerRing.setAttribute('color', '#ffffff');
      spinnerRing.setAttribute('opacity', '0.7');
      spinnerRing.setAttribute('rotation', '0 0 0');
      spinnerRing.setAttribute('animation', {
        property: 'rotation',
        to: '0 0 360',
        dur: 2000,
        easing: 'linear',
        loop: true
      });

      const loadingText = document.createElement('a-text');
      loadingText.setAttribute('value', '–ó–∞–≥—Ä—É–∑–∫–∞...');
      loadingText.setAttribute('align', 'center');
      loadingText.setAttribute('color', '#ffffff');
      loadingText.setAttribute('width', '3');
      loadingText.setAttribute('position', '0 -1 0');

      newLoadingIndicator.appendChild(spinnerRing);
      newLoadingIndicator.appendChild(loadingText);
      newLoadingIndicator.setAttribute('position', '0 0 0.03');

      markerEl.appendChild(newLoadingIndicator);
    }

    // –£–±–∏—Ä–∞–µ–º —Ç–µ–∫—É—â—É—é –∫–Ω–æ–ø–∫—É –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è, –µ—Å–ª–∏ –µ—Å—Ç—å
    const playButton = markerEl.querySelector('.video-play-button');
    if (playButton) {
      playButton.setAttribute('visible', 'false');
    }

    return videoEl;
  }

  /**
   * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä –¥–ª—è –≤–∏–¥–µ–æ
   * @param {Element} markerEl - –ú–∞—Ä–∫–µ—Ä –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏
   * @param {Element} videoPlane - –ü–ª–æ—Å–∫–æ—Å—Ç—å –≤–∏–¥–µ–æ
   * @param {HTMLVideoElement} videoEl - –≠–ª–µ–º–µ–Ω—Ç –≤–∏–¥–µ–æ
   */
  showVideoProgress(markerEl, videoPlane, videoEl) {
    if (!videoEl || !videoPlane) return;

    // –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä
    const existingProgress = markerEl.querySelector('.video-progress-container');
    if (existingProgress) {
      existingProgress.parentNode.removeChild(existingProgress);
    }

    // –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –≤–∏–¥–µ–æ-–ø–ª–æ—Å–∫–æ—Å—Ç–∏
    const width = parseFloat(videoPlane.getAttribute('width')) || 4;
    const height = parseFloat(videoPlane.getAttribute('height')) || 3;

    // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä–∞
    const progressContainer = document.createElement('a-entity');
    progressContainer.className = 'video-progress-container interactive';
    progressContainer.setAttribute('position', `0 ${-height / 2 - 0.15} 0.02`);

    // –§–æ–Ω –ø—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä–∞
    const progressBg = document.createElement('a-plane');
    progressBg.setAttribute('width', width);
    progressBg.setAttribute('height', '0.1');
    progressBg.setAttribute('color', '#000000');
    progressBg.setAttribute('opacity', '0.7');
    progressBg.setAttribute('shader', 'flat');

    // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
    const progressBar = document.createElement('a-plane');
    progressBar.className = 'progress-indicator';
    progressBar.setAttribute('width', 0.01); // –ù–∞—á–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞
    progressBar.setAttribute('height', '0.06');
    progressBar.setAttribute('color', '#ffffff');
    progressBar.setAttribute('opacity', '0.9');
    progressBar.setAttribute('shader', 'flat');
    progressBar.setAttribute('position', `${-width / 2 + 0.005} 0 0.01`); // –ü–æ–∑–∏—Ü–∏—è —Å–ª–µ–≤–∞

    // –¢–µ–∫—Å—Ç –≤—Ä–µ–º–µ–Ω–∏
    const timeText = document.createElement('a-text');
    timeText.className = 'time-indicator';
    timeText.setAttribute('value', '0:00 / 0:00');
    timeText.setAttribute('align', 'right');
    timeText.setAttribute('color', '#ffffff');
    timeText.setAttribute('width', '2');
    timeText.setAttribute('position', `${width / 2 - 0.1} 0 0.02`);

    // –î–æ–±–∞–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    progressContainer.appendChild(progressBg);
    progressContainer.appendChild(progressBar);
    progressContainer.appendChild(timeText);

    // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤ –º–∞—Ä–∫–µ—Ä
    markerEl.appendChild(progressContainer);

    // –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏
    const formatTime = (seconds) => {
      const minutes = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
    };

    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
    const updateProgress = () => {
      if (videoEl.paused || videoEl.ended) {
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, –µ—Å–ª–∏ –≤–∏–¥–µ–æ –Ω–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è
        return;
      }

      const progress = videoEl.currentTime / videoEl.duration;
      const progressWidth = Math.max(0.01, width * progress);

      // –û–±–Ω–æ–≤–ª—è–µ–º —à–∏—Ä–∏–Ω—É –∏ –ø–æ–∑–∏—Ü–∏—é –ø—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä–∞
      progressBar.setAttribute('width', progressWidth);
      progressBar.setAttribute('position', `${-width / 2 + progressWidth / 2} 0 0.01`);

      // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –≤—Ä–µ–º–µ–Ω–∏
      timeText.setAttribute('value',
        `${formatTime(videoEl.currentTime)} / ${formatTime(videoEl.duration)}`);

      // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
      requestAnimationFrame(updateProgress);
    };

    // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    updateProgress();

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è –ø–µ—Ä–µ–º–æ—Ç–∫–∏
    progressBg.addEventListener('click', (e) => {
      e.stopPropagation();

      // –ü–æ–ª—É—á–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–ª–∏–∫–∞
      const canvas = document.querySelector('canvas.a-canvas');
      if (!canvas) return;

      // –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –∏ –µ–≥–æ —Ä–∞–∑–º–µ—Ä—ã
      const rect = canvas.getBoundingClientRect();

      // –ò—Å–ø–æ–ª—å–∑—É–µ–º raycaster –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏ –∫–ª–∏–∫–∞
      const raycaster = new THREE.Raycaster();
      const mouse = new THREE.Vector2(
        ((e.clientX - rect.left) / rect.width) * 2 - 1,
        -((e.clientY - rect.top) / rect.height) * 2 + 1
      );

      raycaster.setFromCamera(mouse, this.aframeCamera.getObject3D('camera'));

      // –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è —Å –ø—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä–æ–º
      const intersects = raycaster.intersectObject(
        progressBg.getObject3D('mesh'), true
      );

      if (intersects.length > 0) {
        // –ü–æ–ª—É—á–∞–µ–º —Ç–æ—á–∫—É –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –≤ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö
        const point = intersects[0].point;

        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –º–∏—Ä–æ–≤—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–ª—è –ø—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä–∞
        const progressObject = progressBg.object3D;
        const worldToLocal = new THREE.Vector3();
        worldToLocal.copy(point);
        progressObject.worldToLocal(worldToLocal);

        // –í—ã—á–∏—Å–ª—è–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç –æ—Ç -0.5 –¥–æ 0.5 (—à–∏—Ä–∏–Ω–∞ –ø–ª–æ—Å–∫–æ—Å—Ç–∏)
        const percent = (worldToLocal.x + 0.5);

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤–æ–µ –≤—Ä–µ–º—è –≤–∏–¥–µ–æ
        if (videoEl.duration) {
          videoEl.currentTime = videoEl.duration * percent;

          // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä
          const progressWidth = Math.max(0.01, width * percent);
          progressBar.setAttribute('width', progressWidth);
          progressBar.setAttribute('position', `${-width / 2 + progressWidth / 2} 0 0.01`);

          // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –≤—Ä–µ–º–µ–Ω–∏
          timeText.setAttribute('value',
            `${formatTime(videoEl.currentTime)} / ${formatTime(videoEl.duration)}`);
        }
      }
    });

    return progressContainer;
  }

  /**
   * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –º—ã—à—å —Ç–æ—á–Ω–æ –Ω–∞–¥ –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç—å—é (—Å—Ç—Ä–æ–≥–∞—è –≤–µ—Ä—Å–∏—è)
   * —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –≤—Å–µ—Ö –Ω–æ–≤—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
   */
  isMouseOverVideoArea(event, markerEl, width, height) {
    try {
      console.log('üéØ isMouseOverVideoArea –≤—ã–∑–≤–∞–Ω (—Å—Ç—Ä–æ–≥–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞):', { width, height, eventType: event.type });

      // –°—Ç—Ä–æ–≥–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–æ–±—ã—Ç–∏–µ –∏–º–µ–Ω–Ω–æ –æ—Ç —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏
      if (event.target) {
        const targetEl = event.target;
        const markerId = markerEl.id;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª–∞—Å—Å—ã —ç–ª–µ–º–µ–Ω—Ç–∞
        const targetClasses = targetEl.className?.split(' ') || [];
        const validClasses = [
          'video-area',
          'move-zone',
          'resize-handle',
          'rotation-zone',
          'interactive',
          'video-play-button',
          'video-progress-container',
          'progress-indicator',
          'time-indicator',
          'video-loading-indicator'
        ];

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª–∞—Å—Å—ã —Ü–µ–ª–µ–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
        const hasValidClass = validClasses.some(cls => targetClasses.includes(cls));

        if (hasValidClass) {
          console.log('‚úÖ –≠–ª–µ–º–µ–Ω—Ç –∏–º–µ–µ—Ç –≤–∞–ª–∏–¥–Ω—ã–π –∫–ª–∞—Å—Å:', targetClasses, '- —Ä–∞–∑—Ä–µ—à–∞–µ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ');
          return true;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞—Ç—Ä–∏–±—É—Ç—ã —ç–ª–µ–º–µ–Ω—Ç–∞
        const validAttributes = [
          'data-video-plane',
          'data-corner',
          'data-rotation-axis',
          'data-arrow-id',
          'data-video-playing'
        ];

        const hasValidAttribute = validAttributes.some(attr =>
          targetEl.hasAttribute && targetEl.hasAttribute(attr)
        );

        if (hasValidAttribute) {
          console.log('‚úÖ –≠–ª–µ–º–µ–Ω—Ç –∏–º–µ–µ—Ç –≤–∞–ª–∏–¥–Ω—ã–π –∞—Ç—Ä–∏–±—É—Ç - —Ä–∞–∑—Ä–µ—à–∞–µ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ');
          return true;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–æ–±—ã—Ç–∏–µ –æ—Ç —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏–º–µ–Ω–Ω–æ —ç—Ç–æ–π –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏
        if (targetEl.id === markerId ||
          targetEl.parentElement?.id === markerId ||
          targetEl.closest(`#${markerId}`) === markerEl) {
          console.log('üéØ –°–æ–±—ã—Ç–∏–µ –æ—Ç —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏ - —Ä–∞–∑—Ä–µ—à–∞–µ–º:', targetEl.tagName, targetEl.className);
          return true;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–≤—è–∑–∏ —Å–æ —Å—Ç—Ä–µ–ª–∫–∞–º–∏ –∏ –Ω–æ–≤—ã–º–∏ —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        const isVideoAreaElement =
          targetEl.closest('.rotation-arrow-indicator') ||
          targetEl.closest('.video-play-button') ||
          targetEl.closest('.video-progress-container') ||
          targetEl.classList?.contains('rotation-arrow-indicator');

        if (isVideoAreaElement && markerEl.contains(targetEl)) {
          console.log('üéØ –°–æ–±—ã—Ç–∏–µ –æ—Ç —ç–ª–µ–º–µ–Ω—Ç–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–∏–¥–µ–æ - —Ä–∞–∑—Ä–µ—à–∞–µ–º');
          return true;
        }

        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è A-Frame —Å–æ–±—ã—Ç–∏–π
        if (event.detail && event.detail.intersection &&
          event.detail.intersection.object?.el?.id === markerId) {
          console.log('üéØ A-Frame —Å–æ–±—ã—Ç–∏–µ –æ—Ç –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏ - —Ä–∞–∑—Ä–µ—à–∞–µ–º');
          return true;
        }

        // –ù–û–í–û–ï: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤–Ω—É—Ç—Ä–∏ –º–∞—Ä–∫–µ—Ä–∞ –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏
        if (markerEl.contains && markerEl.contains(targetEl)) {
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç–ª–µ–º–µ–Ω—Ç —á–∞—Å—Ç—å—é –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
          const isInteractiveChild =
            targetEl.tagName === 'A-ENTITY' ||
            targetEl.tagName === 'A-PLANE' ||
            targetEl.tagName === 'A-TEXT' ||
            targetEl.tagName === 'A-SPHERE' ||
            targetEl.tagName === 'A-CIRCLE' ||
            targetEl.tagName === 'A-RING';

          if (isInteractiveChild) {
            console.log('üéØ –°–æ–±—ã—Ç–∏–µ –æ—Ç –¥–æ—á–µ—Ä–Ω–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏ - —Ä–∞–∑—Ä–µ—à–∞–µ–º');
            return true;
          }
        }
      }

      console.log('üö´ –°–æ–±—ã—Ç–∏–µ –ù–ï –æ—Ç –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏ - –∑–∞–ø—Ä–µ—â–∞–µ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ');
      console.log('   –°–æ–±—ã—Ç–∏–µ –æ—Ç:', event.target.tagName, event.target.className);

      return false;
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –≤ isMouseOverVideoArea:', error);
      return false; // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –∑–∞–ø—Ä–µ—â–∞–µ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    }
  }

  /**
   * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–Ω–æ–ø–∫—É –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –¥–ª—è –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏
   * @param {Element} markerEl - –ú–∞—Ä–∫–µ—Ä –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏
   * @param {Element} videoPlane - –ü–ª–æ—Å–∫–æ—Å—Ç—å –≤–∏–¥–µ–æ
   * @param {boolean} isReplay - –ü—Ä–∏–∑–Ω–∞–∫ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
   */
  showPlayButton(markerEl, videoPlane, isReplay = false) {
    // –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∫–Ω–æ–ø–∫—É, –µ—Å–ª–∏ –µ—Å—Ç—å
    const existingButton = markerEl.querySelector('.video-play-button');
    if (existingButton) {
      existingButton.parentNode.removeChild(existingButton);
    }

    // –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –≤–∏–¥–µ–æ-–ø–ª–æ—Å–∫–æ—Å—Ç–∏
    const width = parseFloat(videoPlane.getAttribute('width')) || 4;
    const height = parseFloat(videoPlane.getAttribute('height')) || 3;

    // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–Ω–æ–ø–∫–∏
    const buttonEntity = document.createElement('a-entity');
    buttonEntity.className = 'video-play-button interactive';
    buttonEntity.setAttribute('position', `0 0 0.02`);

    // –°–æ–∑–¥–∞–µ–º —Ñ–æ–Ω –∫–Ω–æ–ø–∫–∏ (–∫—Ä—É–≥)
    const buttonBg = document.createElement('a-circle');
    buttonBg.setAttribute('radius', Math.min(width, height) * 0.2);
    buttonBg.setAttribute('color', '#000000');
    buttonBg.setAttribute('opacity', '0.7');
    buttonBg.setAttribute('shader', 'flat');
    buttonBg.className = 'interactive';

    // –°–æ–∑–¥–∞–µ–º –∑–Ω–∞—á–æ–∫ –∫–Ω–æ–ø–∫–∏
    const buttonIcon = document.createElement('a-text');
    buttonIcon.setAttribute('value', isReplay ? 'üîÑ' : '‚ñ∂Ô∏è');
    buttonIcon.setAttribute('align', 'center');
    buttonIcon.setAttribute('color', '#ffffff');
    buttonIcon.setAttribute('width', Math.min(width, height) * 0.5);
    buttonIcon.setAttribute('position', '0 0 0.01');
    buttonIcon.className = 'interactive';

    // –°–æ–±–∏—Ä–∞–µ–º –∫–Ω–æ–ø–∫—É
    buttonEntity.appendChild(buttonBg);
    buttonEntity.appendChild(buttonIcon);

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞
    buttonEntity.addEventListener('click', (e) => {
      e.stopPropagation();
      e.preventDefault();

      // –ü–æ–ª—É—á–∞–µ–º –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç
      const videoId = videoPlane.parentNode.getAttribute('data-hotspot-id');
      const videoEl = document.getElementById(`video-${videoId}`);

      if (videoEl) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≥–æ—Ç–æ–≤–æ –ª–∏ –≤–∏–¥–µ–æ –∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—é
        if (videoEl.readyState >= 2) {
          // –ï—Å–ª–∏ –≤–∏–¥–µ–æ –∑–∞–∫–æ–Ω—á–∏–ª–æ—Å—å, –ø–µ—Ä–µ–º–∞—Ç—ã–≤–∞–µ–º –∫ –Ω–∞—á–∞–ª—É
          if (videoEl.ended) {
            videoEl.currentTime = 0;
          }

          // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –≤–∏–¥–µ–æ
          videoEl.play().then(() => {
            console.log('‚úÖ –í–∏–¥–µ–æ –∑–∞–ø—É—â–µ–Ω–æ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è');

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏–¥–µ–æ –º–∞—Ç–µ—Ä–∏–∞–ª
            videoPlane.setAttribute('material', {
              src: `#video-${videoId}`,
              shader: 'flat',
              side: 'double',
              transparent: false
            });

            // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            buttonEntity.setAttribute('visible', 'false');
          }).catch(err => {
            console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:', err);            // –ï—Å–ª–∏ –≤–∏–¥–µ–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ –ø–æ–ª–∏—Ç–∏–∫–æ–π –∞–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è, –ø—Ä–æ–±—É–µ–º –±–µ–∑ –∑–≤—É–∫–∞
            if (err.name === 'NotAllowedError') {
              videoEl.muted = true;
              videoEl.play().then(() => {
                console.log('‚úÖ –í–∏–¥–µ–æ –∑–∞–ø—É—â–µ–Ω–æ –±–µ–∑ –∑–≤—É–∫–∞');

                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏–¥–µ–æ –º–∞—Ç–µ—Ä–∏–∞–ª
                videoPlane.setAttribute('material', {
                  src: `#video-${videoId}`,
                  shader: 'flat',
                  side: 'double',
                  transparent: false
                });

                // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                buttonEntity.setAttribute('visible', 'false');
              }).catch(e => {
                console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤–∏–¥–µ–æ:', e);
              });
            }
          });
        } else {
          console.warn('‚ö†Ô∏è –í–∏–¥–µ–æ –Ω–µ –≥–æ—Ç–æ–≤–æ –∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—é, readyState:', videoEl.readyState);
        }
      }
    });

    // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –≤ –º–∞—Ä–∫–µ—Ä
    markerEl.appendChild(buttonEntity);

    return buttonEntity;
  }

  /**
   * –û–±–Ω–æ–≤–ª—è–µ—Ç –∑–æ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–æ–≤ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–æ–≤ –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏
   */
  updateResizeHandles(markerEl, videoPlane, hotspot) {
    // –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–æ–Ω—ã
    const existingHandles = markerEl.querySelectorAll('.resize-handle');
    existingHandles.forEach(handle => {
      handle.parentNode.removeChild(handle);
    });

    // –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–æ–Ω—ã –≤—Ä–∞—â–µ–Ω–∏—è
    const existingRotationZones = markerEl.querySelectorAll('.rotation-zone');
    existingRotationZones.forEach(zone => {
      zone.parentNode.removeChild(zone);
    });

    // –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ç—Ä–µ–ª–∫–∏ –≤—Ä–∞—â–µ–Ω–∏—è
    const existingArrows = markerEl.querySelectorAll('[id^="arrow-rotate-"]');
    existingArrows.forEach(arrow => {
      arrow.parentNode.removeChild(arrow);
    });

    // –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–æ–Ω—É –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
    const existingMoveZone = markerEl.querySelector('.move-zone');
    if (existingMoveZone) {
      existingMoveZone.parentNode.removeChild(existingMoveZone);
    }

    // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç face-camera –∞–∫—Ç–∏–≤–µ–Ω
    if (!markerEl.getAttribute('face-camera')) {
      markerEl.setAttribute('face-camera', '');
      console.log('‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫–æ–º–ø–æ–Ω–µ–Ω—Ç face-camera –¥–ª—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ –∫ –∫–∞–º–µ—Ä–µ');
    }

    // –ü–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º –Ω–µ–≤–∏–¥–∏–º—ã–µ —É–≥–ª—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞
    const corners = [
      { position: [-1, 1], corner: 'top-left' },
      { position: [1, 1], corner: 'top-right' },
      { position: [-1, -1], corner: 'bottom-left' },
      { position: [1, -1], corner: 'bottom-right' }
    ];

    corners.forEach(cornerInfo => {
      const resizeHandle = document.createElement('a-box');

      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –∏ –ø–æ–∑–∏—Ü–∏—é
      resizeHandle.setAttribute('width', '0.3');
      resizeHandle.setAttribute('height', '0.3');
      resizeHandle.setAttribute('depth', '0.05');

      // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –≤ —É–≥–ª–∞—Ö –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏
      const width = parseFloat(hotspot.videoWidth) || 4;
      const height = parseFloat(hotspot.videoHeight) || 3;
      const posX = (width / 2) * cornerInfo.position[0];
      const posY = (height / 2) * cornerInfo.position[1];

      resizeHandle.setAttribute('position', `${posX} ${posY} 0.05`);

      // –î–µ–ª–∞–µ–º –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–µ–≤–∏–¥–∏–º—ã–º–∏ resize handles - —É–±–∏—Ä–∞–µ–º –ª—é–±—É—é –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
      resizeHandle.setAttribute('material', {
        color: 'red',
        opacity: 0.0,
        transparent: true,
        visible: false
      });

      // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ visibility
      resizeHandle.setAttribute('visible', 'false');

      // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å—ã –∏ –∞—Ç—Ä–∏–±—É—Ç—ã –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
      resizeHandle.classList.add('resize-handle');
      resizeHandle.setAttribute('data-corner', cornerInfo.corner);
      resizeHandle.setAttribute('data-marker-id', hotspot.id);

      // –î–æ–±–∞–≤–ª—è–µ–º raycaster-listen –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏–π
      resizeHandle.setAttribute('raycaster-listen', '');

      // –î–æ–±–∞–≤–ª—è–µ–º –≤ –º–∞—Ä–∫–µ—Ä
      markerEl.appendChild(resizeHandle);
    });

    console.log('‚úÖ –ù–µ–≤–∏–¥–∏–º—ã–µ —É–≥–ª—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω—ã');
  }  /**
   * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –º—ã—à—å –Ω–∞–¥ –æ–±—ã—á–Ω—ã–º –º–∞—Ä–∫–µ—Ä–æ–º —Ö–æ—Ç—Å–ø–æ—Ç–∞
   */
  isMouseOverMarker(event, markerEl) {
    try {
      console.log('üéØ isMouseOverMarker –≤—ã–∑–≤–∞–Ω –¥–ª—è –º–∞—Ä–∫–µ—Ä–∞:', markerEl.id);

      const canvas = this.aframeScene.canvas;
      if (!canvas) {
        console.warn('‚ö†Ô∏è Canvas –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return true;
      }

      // –ò–°–ü–†–ê–í–õ–Ø–ï–ú: –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –º—ã—à–∏ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –Ω–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å
      const rect = canvas.getBoundingClientRect();

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ event —Å–æ–¥–µ—Ä–∂–∏—Ç –≤–∞–ª–∏–¥–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
      if (!event || typeof event.clientX !== 'number' || typeof event.clientY !== 'number') {
        console.warn('‚ö†Ô∏è –ù–µ–≤–∞–ª–∏–¥–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –º—ã—à–∏ –≤ event:', event);
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º true –∫–∞–∫ fallback - —Å—á–∏—Ç–∞–µ–º —á—Ç–æ –º—ã—à—å –Ω–∞–¥ –º–∞—Ä–∫–µ—Ä–æ–º
        return true;
      }

      const mouseX = ((event.clientX - rect.left) / rect.width) * 2 - 1;
      const mouseY = -((event.clientY - rect.top) / rect.height) * 2 + 1;

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–µ NaN
      if (isNaN(mouseX) || isNaN(mouseY)) {
        console.warn('‚ö†Ô∏è –ü–æ–ª—É—á–µ–Ω—ã NaN –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:', { mouseX, mouseY, event });
        return true; // Fallback - —Å—á–∏—Ç–∞–µ–º —á—Ç–æ –Ω–∞–¥ –º–∞—Ä–∫–µ—Ä–æ–º
      }

      console.log('üéØ –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –º—ã—à–∏:', { mouseX, mouseY });

      // –°–æ–∑–¥–∞–µ–º raycaster –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è
      const camera = this.aframeCamera;
      if (!camera) {
        console.warn('‚ö†Ô∏è Camera –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
        return true;
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–∞–º–µ—Ä—ã THREE.js
      const threeCamera = camera.getObject3D('camera');
      if (!threeCamera) {
        console.warn('‚ö†Ô∏è THREE.js camera –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
        return true;
      }

      const raycaster = new THREE.Raycaster();
      raycaster.setFromCamera({ x: mouseX, y: mouseY }, threeCamera);

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ —Å –º–∞—Ä–∫–µ—Ä–æ–º
      const markerObject3D = markerEl.object3D;
      if (!markerObject3D) {
        console.warn('‚ö†Ô∏è Object3D –º–∞—Ä–∫–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return true;
      }

      const intersects = raycaster.intersectObject(markerObject3D, true);
      const isOverMarker = intersects.length > 0;

      console.log('üéØ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ø–∞–¥–∞–Ω–∏—è –≤ –º–∞—Ä–∫–µ—Ä:', {
        markerId: markerEl.id,
        intersects: intersects.length,
        isOverMarker: isOverMarker
      });

      return isOverMarker;

    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–∑–∏—Ü–∏–∏ –º—ã—à–∏ –Ω–∞–¥ –º–∞—Ä–∫–µ—Ä–æ–º:', error);
      return true; // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ —Ä–∞–∑—Ä–µ—à–∞–µ–º –¥–µ–π—Å—Ç–≤–∏–µ
    }
  }

  /**
   * –î–æ–±–∞–≤–ª—è–µ—Ç —É–≥–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏
   */
  addResizeHandles(markerEl, videoPlane, hotspot) {
    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —É–≥–ª—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞
    const oldHandles = markerEl.querySelectorAll('.resize-handle');
    oldHandles.forEach(handle => handle.remove());

    const width = parseFloat(hotspot.width) || 4;
    const height = parseFloat(hotspot.height) || 3;
    const handleSize = 0.3; // –†–∞–∑–º–µ—Ä –Ω–µ–≤–∏–¥–∏–º–æ–π –∑–æ–Ω—ã –¥–ª—è –∑–∞—Ö–≤–∞—Ç–∞
    const handleOffset = handleSize / 2;

    // –ü–æ–∑–∏—Ü–∏–∏ —É–≥–ª–æ–≤
    const corners = [
      { name: 'top-left', x: -width / 2 - handleOffset, y: height / 2 + handleOffset, cursor: 'nw-resize' },
      { name: 'top-right', x: width / 2 + handleOffset, y: height / 2 + handleOffset, cursor: 'ne-resize' },
      { name: 'bottom-left', x: -width / 2 - handleOffset, y: -height / 2 - handleOffset, cursor: 'sw-resize' },
      { name: 'bottom-right', x: width / 2 + handleOffset, y: -height / 2 - handleOffset, cursor: 'se-resize' }
    ];

    corners.forEach(corner => {
      // –°–æ–∑–¥–∞–µ–º –Ω–µ–≤–∏–¥–∏–º—É—é –∑–æ–Ω—É –¥–ª—è –∑–∞—Ö–≤–∞—Ç–∞
      const handle = document.createElement('a-plane');
      handle.className = 'resize-handle interactive';
      handle.setAttribute('width', handleSize);
      handle.setAttribute('height', handleSize);
      handle.setAttribute('position', `${corner.x} ${corner.y} 0.02`);
      handle.setAttribute('material', 'color: #ffffff; opacity: 0; transparent: true'); // –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π
      handle.setAttribute('data-corner', corner.name);
      handle.setAttribute('data-cursor', corner.cursor);

      // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫—É—Ä—Å–æ—Ä–∞
      handle.addEventListener('mouseenter', (e) => {
        document.body.style.cursor = corner.cursor;
        console.log(`üéØ –ù–∞–≤–µ–¥–µ–Ω–∏–µ –Ω–∞ —É–≥–æ–ª ${corner.name}, –∫—É—Ä—Å–æ—Ä: ${corner.cursor}`);
      });

      handle.addEventListener('mouseleave', (e) => {
        if (!this._isResizing) {
          document.body.style.cursor = 'default';
        }
      });

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞—á–∞–ª–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞
      handle.addEventListener('mousedown', (e) => {
        e.stopPropagation();
        this.startVideoResize(markerEl, videoPlane, hotspot, corner.name, e);
      });

      markerEl.appendChild(handle);
    });

    console.log('‚úÖ –ù–µ–≤–∏–¥–∏–º—ã–µ —É–≥–ª—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ —Å–æ–∑–¥–∞–Ω—ã');
  }

  /**
   * –ù–∞—á–∏–Ω–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏
   */
  startVideoResize(markerEl, videoPlane, hotspot, cornerName, event) {
    event.stopPropagation();

    this._isResizing = true;
    this._currentResizeHandle = cornerName;

    console.log(`üéØ –ù–∞—á–∞–ª–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏, —É–≥–æ–ª: ${cornerName}`);

    const initialWidth = parseFloat(hotspot.width) || 4;
    const initialHeight = parseFloat(hotspot.height) || 3;

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –º—ã—à–∏
    const startMouseX = event.clientX;
    const startMouseY = event.clientY;

    // –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–≤–∏–∂–µ–Ω–∏—è –º—ã—à–∏
    const mouseMoveHandler = (e) => {
      const deltaX = (e.clientX - startMouseX) * 0.01; // –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –¥–≤–∏–∂–µ–Ω–∏–µ
      const deltaY = (startMouseY - e.clientY) * 0.01; // –ò–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º Y –¥–ª—è A-Frame

      let newWidth = initialWidth;
      let newHeight = initialHeight;

      // –í—ã—á–∏—Å–ª—è–µ–º –Ω–æ–≤—ã–µ —Ä–∞–∑–º–µ—Ä—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —É–≥–ª–∞
      switch (cornerName) {
        case 'top-right':
          newWidth = Math.max(1, initialWidth + deltaX);
          newHeight = Math.max(0.5, initialHeight + deltaY);
          break;
        case 'top-left':
          newWidth = Math.max(1, initialWidth - deltaX);
          newHeight = Math.max(0.5, initialHeight + deltaY);
          break;
        case 'bottom-right':
          newWidth = Math.max(1, initialWidth + deltaX);
          newHeight = Math.max(0.5, initialHeight - deltaY);
          break;
        case 'bottom-left':
          newWidth = Math.max(1, initialWidth - deltaX);
          newHeight = Math.max(0.5, initialHeight - deltaY);
          break;
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä—ã –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏
      this.updateVideoAreaSize(markerEl, videoPlane, hotspot, newWidth, newHeight);
    };

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞
    const mouseUpHandler = (e) => {
      this._isResizing = false;
      this._currentResizeHandle = null;
      document.body.style.cursor = 'default';

      document.removeEventListener('mousemove', mouseMoveHandler);
      document.removeEventListener('mouseup', mouseUpHandler);

      console.log('‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–æ');

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
      if (this.hotspotManager && this.hotspotManager.saveProject) {
        this.hotspotManager.saveProject();
      }
    };

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    document.addEventListener('mousemove', mouseMoveHandler);
    document.addEventListener('mouseup', mouseUpHandler);
  }

  /**
   * –û–±–Ω–æ–≤–ª—è–µ—Ç —Ä–∞–∑–º–µ—Ä—ã –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏
   */
  updateVideoAreaSize(markerEl, videoPlane, hotspot, newWidth, newHeight) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –≤—Ö–æ–¥–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–æ–≤
    newWidth = parseFloat(newWidth);
    newHeight = parseFloat(newHeight);

    if (isNaN(newWidth) || newWidth <= 0) {
      console.warn('‚ö†Ô∏è –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é');
      newWidth = 4;
    }
    if (isNaN(newHeight) || newHeight <= 0) {
      console.warn('‚ö†Ô∏è –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é');
      newHeight = 3;
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä—ã –≤–∏–¥–µ–æ-–ø–ª–æ—Å–∫–æ—Å—Ç–∏
    videoPlane.setAttribute('width', newWidth);
    videoPlane.setAttribute('height', newHeight);

    // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä—ã –≤ –æ–±—ä–µ–∫—Ç–µ hotspot
    hotspot.width = newWidth;
    hotspot.height = newHeight;

    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏–∏ —É–≥–ª–æ–≤ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞
    this.updateResizeHandles(markerEl, newWidth, newHeight);

    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –∑–∞–≥–æ–ª–æ–≤–∫–∞ –µ—Å–ª–∏ –µ—Å—Ç—å
    this.updateVideoAreaTitle(markerEl, newHeight);

    console.log(`üìè –†–∞–∑–º–µ—Ä—ã –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã: ${newWidth.toFixed(2)} x ${newHeight.toFixed(2)}`);
  }

  /**
   * –û–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–∑–∏—Ü–∏—é —É–≥–ª–æ–≤ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞
   */
  updateResizeHandles(markerEl, width, height) {
    const handles = markerEl.querySelectorAll('.resize-handle');
    if (handles.length === 0) return;

    const handleSize = 0.3; // –†–∞–∑–º–µ—Ä –Ω–µ–≤–∏–¥–∏–º–æ–π –∑–æ–Ω—ã –¥–ª—è –∑–∞—Ö–≤–∞—Ç–∞
    const handleOffset = handleSize / 2;

    // –ü–æ–∑–∏—Ü–∏–∏ —É–≥–ª–æ–≤
    const corners = [
      { name: 'top-left', x: -width / 2 - handleOffset, y: height / 2 + handleOffset },
      { name: 'top-right', x: width / 2 + handleOffset, y: height / 2 + handleOffset },
      { name: 'bottom-left', x: -width / 2 - handleOffset, y: -height / 2 - handleOffset },
      { name: 'bottom-right', x: width / 2 + handleOffset, y: -height / 2 - handleOffset }
    ];

    handles.forEach((handle) => {
      const cornerName = handle.getAttribute('data-corner');
      const corner = corners.find(c => c.name === cornerName);
      if (corner) {
        handle.setAttribute('position', `${corner.x} ${corner.y} 0.02`);
      }
    });

    console.log('‚úÖ –ü–æ–∑–∏—Ü–∏–∏ –Ω–µ–≤–∏–¥–∏–º—ã—Ö —É–≥–ª–æ–≤ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
  }

  /**
   * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç resize handles –¥–ª—è –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏
   */
  showResizeHandles(markerEl) {
    // –û–¢–ö–õ–Æ–ß–ï–ù–û: resize handles –æ—Ç–∫–ª—é—á–µ–Ω—ã
    return;
  }

  /**
   * –°–∫—Ä—ã–≤–∞–µ—Ç resize handles –¥–ª—è –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏
   */
  hideResizeHandles(markerEl) {
    // –û–¢–ö–õ–Æ–ß–ï–ù–û: resize handles –æ—Ç–∫–ª—é—á–µ–Ω—ã
    return;
  }

  /**
   * –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –Ω–µ–≤–∏–¥–∏–º—ã—Ö –∑–æ–Ω (–ø–æ–≤–æ—Ä–æ—Ç, –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞)
   */
  setupInvisibleZoneHandlers(markerEl, videoPlane, hotspot) {
    // –ü–æ –∑–∞–ø—Ä–æ—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –≤—Å–µ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞—é—â–∏–µ –ª–∏–Ω–∏–∏ –∏ –∫—Ä—É–≥–∏ —É–±—Ä–∞–Ω—ã.
    console.log('‚úÖ –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∑–æ–Ω –≤—Ä–∞—â–µ–Ω–∏—è –∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–æ–≤ –æ—Ç–∫–ª—é—á–µ–Ω—ã –ø–æ –∑–∞–ø—Ä–æ—Å—É');
  }

  /**
   * –ù–∞—á–∏–Ω–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏
   */
  startResize(markerEl, videoPlane, hotspot, corner, startEvent) {
    // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã
    if (this._isResizing) {
      console.log('üîÑ –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ —É–∂–µ –∞–∫—Ç–∏–≤–Ω–æ, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º');
      return;
    }

    this._isResizing = true;
    console.log('üîÑ –ù–∞—á–∞–ª–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏:', corner);

    const startWidth = parseFloat(hotspot.videoWidth) || 4;
    const startHeight = parseFloat(hotspot.videoHeight) || 3;

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Å–æ–±—ã—Ç–∏—è –Ω–∞–ø—Ä—è–º—É—é (canvas –∏–ª–∏ DOM)
    const startMousePos = {
      x: startEvent.clientX || startEvent.detail?.clientX || 0,
      y: startEvent.clientY || startEvent.detail?.clientY || 0
    };

    console.log('üîÑ –ù–∞—á–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è:', {
      startWidth,
      startHeight,
      corner,
      startMousePos,
      'hotspot.videoWidth': hotspot.videoWidth,
      'hotspot.videoHeight': hotspot.videoHeight
    });

    // –î–µ–±–∞—É–Ω—Å–∏–Ω–≥ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–æ–≤
    let updateTimeout;

    const resizeHandler = (moveEvent) => {
      if (!this._isResizing) return; // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞

      // –ò–°–ü–†–ê–í–õ–Ø–ï–ú: –∏–∑–º–µ–Ω—è–µ–º –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
      const deltaX = (moveEvent.clientX - startMousePos.x) * 0.005; // –£–º–µ–Ω—å—à–∞–µ–º —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
      const deltaY = (startMousePos.y - moveEvent.clientY) * 0.005; // –ò–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º Y –∏ —É–º–µ–Ω—å—à–∞–µ–º —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

      let newWidth = startWidth;
      let newHeight = startHeight;

      // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –Ω–æ–≤—ã–µ —Ä–∞–∑–º–µ—Ä—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —É–≥–ª–∞
      switch (corner) {
        case 'top-right':
          newWidth = Math.max(1.0, startWidth + deltaX);
          newHeight = Math.max(1.0, startHeight + deltaY);
          break;
        case 'bottom-left':
          newWidth = Math.max(1.0, startWidth - deltaX);
          newHeight = Math.max(1.0, startHeight - deltaY);
          break;
        case 'bottom-right':
          newWidth = Math.max(1.0, startWidth + deltaX);
          newHeight = Math.max(1.0, startHeight - deltaY);
          break;
        case 'top-left':
          newWidth = Math.max(1.0, startWidth - deltaX);
          newHeight = Math.max(1.0, startHeight + deltaY);
          break;
      }

      // –ò–°–ü–†–ê–í–õ–Ø–ï–ú: –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ä–∞–∑–º–µ—Ä—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∏ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º—É–º
      if (isNaN(newWidth) || isNaN(newHeight) || newWidth <= 0 || newHeight <= 0) {
        newWidth = startWidth; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫ –∏—Å—Ö–æ–¥–Ω—ã–º —Ä–∞–∑–º–µ—Ä–∞–º
        newHeight = startHeight;
      }

      // –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–ª—è –≤–∏–¥–∏–º–æ—Å—Ç–∏
      newWidth = Math.max(newWidth, 2); // –ú–∏–Ω–∏–º—É–º 2 –µ–¥–∏–Ω–∏—Ü—ã –¥–ª—è –≤–∏–¥–∏–º–æ—Å—Ç–∏
      newHeight = Math.max(newHeight, 1.5); // –ú–∏–Ω–∏–º—É–º 1.5 –µ–¥–∏–Ω–∏—Ü—ã –¥–ª—è –≤–∏–¥–∏–º–æ—Å—Ç–∏

      // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
      newWidth = Math.min(newWidth, 10); // –ú–∞–∫—Å–∏–º—É–º 10 –µ–¥–∏–Ω–∏—Ü
      newHeight = Math.min(newHeight, 8); // –ú–∞–∫—Å–∏–º—É–º 8 –µ–¥–∏–Ω–∏—Ü

      // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã
      newWidth = Math.min(newWidth, 20);
      newHeight = Math.min(newHeight, 20);

      // –î–µ–±–∞—É–Ω—Å–∏–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è DOM –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
      clearTimeout(updateTimeout);
      updateTimeout = setTimeout(() => {
        // –ò–°–ü–†–ê–í–õ–Ø–ï–ú: —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π –º–∞—Ç–µ—Ä–∏–∞–ª –≤–∏–¥–µ–æ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞
        const currentMaterial = videoPlane.getAttribute('material');

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä—ã –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏
        videoPlane.setAttribute('width', newWidth);
        videoPlane.setAttribute('height', newHeight);

        // –ò–°–ü–†–ê–í–õ–Ø–ï–ú: –µ—Å–ª–∏ –µ—Å—Ç—å –≤–∏–¥–µ–æ –º–∞—Ç–µ—Ä–∏–∞–ª, –ø–µ—Ä–µ-–ø—Ä–∏–º–µ–Ω—è–µ–º –µ–≥–æ
        if (currentMaterial && currentMaterial.src) {
          console.log('üîÑ –ü–µ—Ä–µ–ø—Ä–∏–º–µ–Ω—è–µ–º –≤–∏–¥–µ–æ –º–∞—Ç–µ—Ä–∏–∞–ª –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞');
          videoPlane.setAttribute('material', currentMaterial);
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏–∏ —É–≥–ª–æ–≤
        this.updateResizeHandles(markerEl, newWidth, newHeight);

        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é —Ç–µ–∫—Å—Ç–∞ –Ω–∞–∑–≤–∞–Ω–∏—è
        this.updateVideoAreaTitle(markerEl, newHeight);
      }, 16); // ~60fps
    };

    const stopResizeHandler = () => {
      console.log('üîÑ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏');

      this._isResizing = false;
      this._currentResizeHandle = null;
      clearTimeout(updateTimeout);

      document.removeEventListener('mousemove', resizeHandler);
      document.removeEventListener('mouseup', stopResizeHandler);

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—ã–µ —Ä–∞–∑–º–µ—Ä—ã
      let newWidth = parseFloat(videoPlane.getAttribute('width'));
      let newHeight = parseFloat(videoPlane.getAttribute('height'));

      // –ò–°–ü–†–ê–í–õ–Ø–ï–ú: –µ—Å–ª–∏ —Ä–∞–∑–º–µ—Ä—ã –≤—Å–µ –µ—â–µ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫ –∏—Å—Ö–æ–¥–Ω—ã–º
      if (isNaN(newWidth) || isNaN(newHeight) || newWidth <= 0 || newHeight <= 0) {
        console.warn('‚ö†Ô∏è –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏! –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫ –∏—Å—Ö–æ–¥–Ω—ã–º.', { newWidth, newHeight, startWidth, startHeight });
        newWidth = startWidth || 4;
        newHeight = startHeight || 3;

        // –û–±–Ω–æ–≤–ª—è–µ–º –∏ –≤ DOM
        videoPlane.setAttribute('width', newWidth);
        videoPlane.setAttribute('height', newHeight);
        this.updateResizeHandles(markerEl, newWidth, newHeight);
        this.updateVideoAreaTitle(markerEl, newHeight);
      }

      hotspot.videoWidth = newWidth;
      hotspot.videoHeight = newHeight;

      // Debounce —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è - —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞
      clearTimeout(this._resizeSaveTimeout);
      this._resizeSaveTimeout = setTimeout(() => {
        if (this.hotspotManager) {
          this.hotspotManager.updateHotspot(hotspot.id, {
            videoWidth: newWidth,
            videoHeight: newHeight
          });
        }
        console.log('‚úÖ –†–∞–∑–º–µ—Ä—ã –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã:', newWidth, 'x', newHeight);
      }, 300); // –ñ–¥–µ–º 300ms –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞
    };

    document.addEventListener('mousemove', resizeHandler);
    document.addEventListener('mouseup', stopResizeHandler);
  }

  /**
   * –û–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–∑–∏—Ü–∏—é —Ç–µ–∫—Å—Ç–∞ –Ω–∞–∑–≤–∞–Ω–∏—è –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏
   */
  updateVideoAreaTitle(markerEl, videoHeight) {
    const textElement = markerEl.querySelector('.video-area-title');
    if (textElement) {
      // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –≤—ã—à–µ –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏ —Å –±–æ–ª—å—à–∏–º –æ—Ç—Å—Ç—É–ø–æ–º
      const titleY = (parseFloat(videoHeight) || 3) / 2 + 0.8; // –£–≤–µ–ª–∏—á–µ–Ω –æ—Ç—Å—Ç—É–ø
      textElement.setAttribute('position', `0 ${titleY} 0.3`); // –£–≤–µ–ª–∏—á–µ–Ω Z-–æ—Ç—Å—Ç—É–ø
      console.log(`üìù –ü–æ–∑–∏—Ü–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞: Y = ${titleY}`);
    }
  }

  /**
   * –û–±–Ω–æ–≤–ª—è–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –Ω–∞–∑–≤–∞–Ω–∏—è –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏
   */
  updateVideoAreaTitleText(markerEl, newTitle) {
    const textElement = markerEl.querySelector('.video-area-title');
    if (textElement) {
      const titleText = newTitle && newTitle.trim() !== '' ? this.removeFileExtension(newTitle.trim()) : '';
      textElement.setAttribute('value', titleText);
      textElement.setAttribute('visible', titleText !== '' ? 'true' : 'false');
      console.log(`üìù –ù–∞–∑–≤–∞–Ω–∏–µ –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–æ: "${titleText}"`);
    } else if (newTitle && newTitle.trim() !== '') {
      // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –Ω–∞–∑–≤–∞–Ω–∏—è, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ –±—ã–ª–æ
      const cleanTitle = this.removeFileExtension(newTitle.trim());
      const newTextElement = document.createElement('a-text');
      newTextElement.setAttribute('value', cleanTitle);
      newTextElement.setAttribute('align', 'center');
      newTextElement.setAttribute('color', '#ffffff');
      newTextElement.setAttribute('width', 6);
      newTextElement.setAttribute('billboard', '');
      newTextElement.setAttribute('visible', 'true');
      newTextElement.className = 'video-area-title';

      // –ü–æ–ª—É—á–∞–µ–º –≤—ã—Å–æ—Ç—É –≤–∏–¥–µ–æ –¥–ª—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
      const videoPlane = markerEl.querySelector('[data-video-plane]');
      const videoHeight = videoPlane ? parseFloat(videoPlane.getAttribute('height')) || 3 : 3;
      const titleY = videoHeight / 2 + 0.8; // –£–≤–µ–ª–∏—á–µ–Ω –æ—Ç—Å—Ç—É–ø
      newTextElement.setAttribute('position', `0 ${titleY} 0.3`); // –£–≤–µ–ª–∏—á–µ–Ω Z-–æ—Ç—Å—Ç—É–ø

      markerEl.appendChild(newTextElement);
      console.log(`üìù –°–æ–∑–¥–∞–Ω–æ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏: "${cleanTitle}"`);
    }
  }

  /**
   * –û–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–∑–∏—Ü–∏–∏ —É–≥–ª–æ–≤ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞
   */
  updateResizeHandles(markerEl, width, height) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    width = parseFloat(width);
    height = parseFloat(height);

    if (isNaN(width) || isNaN(height) || width <= 0 || height <= 0) {
      console.warn('‚ö†Ô∏è –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –¥–ª—è updateResizeHandles:', { width, height });
      width = 4;
      height = 3;
    }

    const handles = markerEl.querySelectorAll('.resize-handle');

    handles.forEach(handle => {
      const corner = handle.getAttribute('data-corner');
      let x, y;

      switch (corner) {
        case 'top-left':
          x = -width / 2; y = height / 2;
          break;
        case 'top-right':
          x = width / 2; y = height / 2;
          break;
        case 'bottom-left':
          x = -width / 2; y = -height / 2;
          break;
        case 'bottom-right':
          x = width / 2; y = -height / 2;
          break;
        default:
          console.warn('‚ö†Ô∏è –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —É–≥–æ–ª:', corner);
          x = 0; y = 0;
      }

      // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ NaN
      if (isNaN(x) || isNaN(y)) {
        console.warn('‚ö†Ô∏è NaN –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è —É–≥–ª–∞:', corner, { x, y, width, height });
        x = 0; y = 0;
      }

      handle.setAttribute('position', `${x} ${y} 0.01`);
    });

    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏–∏ –∫–Ω–æ–ø–æ–∫ –≤—Ä–∞—â–µ–Ω–∏—è
    const rotationHandles = markerEl.querySelectorAll('.rotation-handle');
    rotationHandles.forEach(handle => {
      const action = handle.getAttribute('data-rotation-action');
      let x, y;

      switch (action) {
        case 'rotate-left':
          x = -width / 2 - 0.5; y = 0;
          break;
        case 'rotate-right':
          x = width / 2 + 0.5; y = 0;
          break;
        case 'rotate-up':
          x = 0; y = height / 2 + 0.3;
          break;
        case 'rotate-down':
          x = 0; y = -height / 2 - 0.3;
          break;
        default:
          x = 0; y = 0;
      }

      handle.setAttribute('position', `${x} ${y} 0.01`);
      console.log('üîß –û–±–Ω–æ–≤–ª–µ–Ω–∞ –ø–æ–∑–∏—Ü–∏—è –∫–Ω–æ–ø–∫–∏ –ø–æ–≤–æ—Ä–æ—Ç–∞:', action, '–Ω–æ–≤–∞—è –ø–æ–∑–∏—Ü–∏—è:', `${x} ${y} 0.01`);
    });
  }

  /**
   * –í—Ä–∞—â–∞–µ—Ç –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç—å –≤–æ–∫—Ä—É–≥ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–π –æ—Å–∏
   */
  rotateVideoArea(markerEl, videoPlane, hotspot, action) {
    console.log('üîÑ –í—Ä–∞—â–µ–Ω–∏–µ –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏:', action);
    console.log('üîÑ –≠–ª–µ–º–µ–Ω—Ç—ã:', { markerEl: !!markerEl, videoPlane: !!videoPlane, hotspot: !!hotspot });

    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –ø–æ–≤–æ—Ä–æ—Ç –º–∞—Ä–∫–µ—Ä–∞ (–∏–ª–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
    let currentRotation = markerEl.getAttribute('rotation');
    console.log('üîÑ –¢–µ–∫—É—â–∏–π rotation –∞—Ç—Ä–∏–±—É—Ç:', currentRotation);

    // –ò–°–ü–†–ê–í–õ–Ø–ï–ú: –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º rotation –∞—Ç—Ä–∏–±—É—Ç
    let rotX = 0, rotY = 0, rotZ = 0;
    if (currentRotation) {
      if (typeof currentRotation === 'string') {
        const parts = currentRotation.split(' ');
        rotX = parseFloat(parts[0]) || 0;
        rotY = parseFloat(parts[1]) || 0;
        rotZ = parseFloat(parts[2]) || 0;
      } else {
        rotX = currentRotation.x || 0;
        rotY = currentRotation.y || 0;
        rotZ = currentRotation.z || 0;
      }
    }

    console.log('üîÑ –ò—Å—Ö–æ–¥–Ω—ã–µ —É–≥–ª—ã:', { rotX, rotY, rotZ });

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —à–∞–≥ –ø–æ–≤–æ—Ä–æ—Ç–∞ (–≤ –≥—Ä–∞–¥—É—Å–∞—Ö)
    const rotationStep = 15; // 15 –≥—Ä–∞–¥—É—Å–æ–≤ –∑–∞ –æ–¥–∏–Ω –∫–ª–∏–∫

    // –ò–∑–º–µ–Ω—è–µ–º –ø–æ–≤–æ—Ä–æ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –¥–µ–π—Å—Ç–≤–∏—è
    if (action === 'rotate-left') {
      // –ü–æ–≤–æ—Ä–æ—Ç –ø—Ä–æ—Ç–∏–≤ —á–∞—Å–æ–≤–æ–π —Å—Ç—Ä–µ–ª–∫–∏ –≤–æ–∫—Ä—É–≥ Y-–æ—Å–∏
      rotY = (rotY - rotationStep) % 360;
      console.log('üîÑ –ü–æ–≤–æ—Ä–æ—Ç –ø—Ä–æ—Ç–∏–≤ —á–∞—Å–æ–≤–æ–π —Å—Ç—Ä–µ–ª–∫–∏ (Y-–æ—Å—å)');
    } else if (action === 'rotate-right') {
      // –ü–æ–≤–æ—Ä–æ—Ç –ø–æ —á–∞—Å–æ–≤–æ–π —Å—Ç—Ä–µ–ª–∫–µ –≤–æ–∫—Ä—É–≥ Y-–æ—Å–∏
      rotY = (rotY + rotationStep) % 360;
      console.log('üîÑ –ü–æ–≤–æ—Ä–æ—Ç –ø–æ —á–∞—Å–æ–≤–æ–π —Å—Ç—Ä–µ–ª–∫–µ (Y-–æ—Å—å)');
    } else if (action === 'rotate-up') {
      // –ü–æ–≤–æ—Ä–æ—Ç –≤–≤–µ—Ä—Ö –≤–æ–∫—Ä—É–≥ X-–æ—Å–∏
      rotX = (rotX - rotationStep) % 360;
      console.log('üîÑ –ü–æ–≤–æ—Ä–æ—Ç –≤–≤–µ—Ä—Ö (X-–æ—Å—å)');
    } else if (action === 'rotate-down') {
      // –ü–æ–≤–æ—Ä–æ—Ç –≤–Ω–∏–∑ –≤–æ–∫—Ä—É–≥ X-–æ—Å–∏
      rotX = (rotX + rotationStep) % 360;
      console.log('üîÑ –ü–æ–≤–æ—Ä–æ—Ç –≤–Ω–∏–∑ (X-–æ—Å—å)');
    }

    console.log('üîÑ –ù–æ–≤—ã–µ —É–≥–ª—ã:', { rotX, rotY, rotZ });

    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–≤–æ—Ä–æ—Ç –º–∞—Ä–∫–µ—Ä–∞
    const newRotationStr = `${rotX} ${rotY} ${rotZ}`;
    console.log('üîÑ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º rotation:', newRotationStr);
    markerEl.setAttribute('rotation', newRotationStr);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∏–º–µ–Ω–∏–ª–æ—Å—å
    const appliedRotation = markerEl.getAttribute('rotation');
    console.log('üîÑ –ü—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã–π rotation:', appliedRotation);

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–≤–æ—Ä–æ—Ç–∞ –≤ hotspot
    if (!hotspot.rotation) {
      hotspot.rotation = { x: 0, y: 0, z: 0 };
    }
    hotspot.rotation.x = rotX;
    hotspot.rotation.y = rotY;
    hotspot.rotation.z = rotZ;

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
    if (this.hotspotManager) {
      this.hotspotManager.updateHotspot(hotspot.id, {
        rotation: { x: rotX, y: rotY, z: rotZ }
      });
    }

    console.log('‚úÖ –í–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç—å –ø–æ–≤–µ—Ä–Ω—É—Ç–∞:', {
      action,
      newRotation: { x: rotX, y: rotY, z: rotZ }
    });
  }

  /**
   * –î–æ–±–∞–≤–ª—è–µ—Ç –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–≤—É–∫–æ–º –¥–ª—è –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏
   */
  addAudioControls(markerEl, videoEl, hotspot) {
    console.log('üîä –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–≤—É–∫–æ–º –¥–ª—è –≤–∏–¥–µ–æ:', hotspot.title);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã –ª–∏ —É–∂–µ –∫–Ω–æ–ø–∫–∏
    const existingControls = markerEl.querySelector('.audio-controls');
    if (existingControls) {
      console.log('üîä –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–≤—É–∫–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç');
      return;
    }

    const videoPlane = markerEl.querySelector('[data-video-plane]');
    if (!videoPlane) {
      console.warn('‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –≤–∏–¥–µ–æ-–ø–ª–æ—Å–∫–æ—Å—Ç—å –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∞—É–¥–∏–æ –∫–æ–Ω—Ç—Ä–æ–ª–æ–≤');
      return;
    }

    // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–Ω–æ–ø–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–≤—É–∫–æ–º
    const audioControls = document.createElement('a-entity');
    audioControls.className = 'audio-controls';
    audioControls.setAttribute('position', `${hotspot.videoWidth / 2 - 0.3} ${hotspot.videoHeight / 2 - 0.3} 0.01`);

    // –ö–Ω–æ–ø–∫–∞ –≤–∫–ª—é—á–µ–Ω–∏—è/–≤—ã–∫–ª—é—á–µ–Ω–∏—è –∑–≤—É–∫–∞
    const muteButton = document.createElement('a-plane');
    muteButton.className = 'audio-mute-btn interactive';
    muteButton.setAttribute('width', '0.4');
    muteButton.setAttribute('height', '0.4');
    muteButton.setAttribute('color', '#222222'); // –¢–µ–º–Ω—ã–π —Ü–≤–µ—Ç –≤–º–µ—Å—Ç–æ –∑–µ–ª–µ–Ω–æ–≥–æ
    muteButton.setAttribute('opacity', '0.8');
    muteButton.setAttribute('position', '0 0 0');

    // –¢–µ–∫—Å—Ç –Ω–∞ –∫–Ω–æ–ø–∫–µ (–∏–∫–æ–Ω–∫–∞ –∑–≤—É–∫–∞)
    const muteText = document.createElement('a-text');
    muteText.setAttribute('value', videoEl.muted ? 'üîá' : 'üîä');
    muteText.setAttribute('align', 'center');
    muteText.setAttribute('position', '0 0 0.01');
    muteText.setAttribute('scale', '0.8 0.8 0.8');
    muteText.setAttribute('color', '#ffffff');

    muteButton.appendChild(muteText);
    audioControls.appendChild(muteButton);

    // –ö–Ω–æ–ø–∫–∞ —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∫–∏ –≥—Ä–æ–º–∫–æ—Å—Ç–∏ (–µ—Å–ª–∏ –Ω–µ –≤—ã–∫–ª—é—á–µ–Ω –∑–≤—É–∫)
    if (!videoEl.muted) {
      const volumeSlider = this.createVolumeSlider(videoEl, hotspot);
      volumeSlider.setAttribute('position', '0.6 0 0');
      audioControls.appendChild(volumeSlider);
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–Ω–æ–ø–∫–µ –∑–≤—É–∫–∞
    muteButton.addEventListener('click', (e) => {
      e.stopPropagation();

      videoEl.muted = !videoEl.muted;
      muteText.setAttribute('value', videoEl.muted ? 'üîá' : 'üîä');
      muteButton.setAttribute('color', videoEl.muted ? '#ff4444' : '#222222'); // –¢–µ–º–Ω—ã–π —Ü–≤–µ—Ç –≤–º–µ—Å—Ç–æ –∑–µ–ª–µ–Ω–æ–≥–æ

      console.log(`üîä –ó–≤—É–∫ ${videoEl.muted ? '–≤—ã–∫–ª—é—á–µ–Ω' : '–≤–∫–ª—é—á–µ–Ω'} –¥–ª—è –≤–∏–¥–µ–æ:`, hotspot.title);

      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ª–∞–π–¥–µ—Ä –≥—Ä–æ–º–∫–æ—Å—Ç–∏
      const existingSlider = audioControls.querySelector('.volume-slider');
      if (existingSlider) {
        existingSlider.remove();
      }

      if (!videoEl.muted) {
        const volumeSlider = this.createVolumeSlider(videoEl, hotspot);
        volumeSlider.setAttribute('position', '0.6 0 0');
        audioControls.appendChild(volumeSlider);
      }
    });

    videoPlane.appendChild(audioControls);
    console.log('‚úÖ –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–≤—É–∫–æ–º –¥–æ–±–∞–≤–ª–µ–Ω—ã');
  }

  /**
   * –°–æ–∑–¥–∞–µ—Ç —Å–ª–∞–π–¥–µ—Ä –≥—Ä–æ–º–∫–æ—Å—Ç–∏ –¥–ª—è –≤–∏–¥–µ–æ
   */
  createVolumeSlider(videoEl, hotspot) {
    const sliderContainer = document.createElement('a-entity');
    sliderContainer.className = 'volume-slider';

    // –§–æ–Ω —Å–ª–∞–π–¥–µ—Ä–∞
    const sliderBg = document.createElement('a-plane');
    sliderBg.setAttribute('width', '0.8');
    sliderBg.setAttribute('height', '0.1');
    sliderBg.setAttribute('color', '#333333');
    sliderBg.setAttribute('opacity', '0.7');

    // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —É—Ä–æ–≤–Ω—è –≥—Ä–æ–º–∫–æ—Å—Ç–∏
    const volumeIndicator = document.createElement('a-plane');
    volumeIndicator.className = 'volume-indicator';
    volumeIndicator.setAttribute('width', 0.8 * videoEl.volume);
    volumeIndicator.setAttribute('height', '0.08');
    volumeIndicator.setAttribute('color', '#2196F3'); // –°–∏–Ω–∏–π —Ü–≤–µ—Ç –≤–º–µ—Å—Ç–æ –∑–µ–ª–µ–Ω–æ–≥–æ
    volumeIndicator.setAttribute('position', `${-0.4 + (0.8 * videoEl.volume / 2)} 0 0.01`);

    sliderContainer.appendChild(sliderBg);
    sliderContainer.appendChild(volumeIndicator);

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –≥—Ä–æ–º–∫–æ—Å—Ç–∏
    sliderBg.addEventListener('click', (e) => {
      e.stopPropagation();

      // –í—ã—á–∏—Å–ª—è–µ–º –Ω–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å –≥—Ä–æ–º–∫–æ—Å—Ç–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–∑–∏—Ü–∏–∏ –∫–ª–∏–∫–∞
      // –≠—Ç–æ —É–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è - –≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å —Ç–æ—á–Ω—É—é –ø–æ–∑–∏—Ü–∏—é –∫–ª–∏–∫–∞
      const newVolume = Math.random(); // –ó–∞–≥–ª—É—à–∫–∞ - –≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–∑–∏—Ü–∏–∏ –º—ã—à–∏

      videoEl.volume = Math.max(0, Math.min(1, newVolume));

      // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
      volumeIndicator.setAttribute('width', 0.8 * videoEl.volume);
      volumeIndicator.setAttribute('position', `${-0.4 + (0.8 * videoEl.volume / 2)} 0 0.01`);

      console.log(`üîä –ì—Ä–æ–º–∫–æ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞ ${Math.round(videoEl.volume * 100)}% –¥–ª—è –≤–∏–¥–µ–æ:`, hotspot.title);
    });

    return sliderContainer;
  }

  // –ú–µ—Ç–æ–¥ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –º–∞—Ä–∫–µ—Ä–∞ –ø–æ ID
  getHotspotData(hotspotId) {
    if (!this.hotspotManager) {
      return null;
    }

    const hotspots = this.hotspotManager.getHotspots();
    return hotspots.find(h => h.id === hotspotId);
  }

  /**
   * –ü—É–±–ª–∏—á–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ö–æ—Ç—Å–ø–æ—Ç–∞ –ø–æ—Å–ª–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
   */
  updateHotspotDisplay(hotspotId) {
    const markerEl = document.getElementById(`marker-${hotspotId}`);
    if (!markerEl) {
      console.warn(`‚ö†Ô∏è –ú–∞—Ä–∫–µ—Ä —Å ID ${hotspotId} –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è`);
      return;
    }

    const hotspot = this.getHotspotData(hotspotId);
    if (!hotspot) {
      console.warn(`‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ —Ö–æ—Ç—Å–ø–æ—Ç–∞ —Å ID ${hotspotId} –Ω–µ –Ω–∞–π–¥–µ–Ω—ã`);
      return;
    }

    // –ï—Å–ª–∏ —ç—Ç–æ –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç—å, –æ–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ
    if (hotspot.type === 'video-area' || markerEl._isVideoArea) {
      this.updateVideoAreaTitleText(markerEl, hotspot.title);
      console.log(`‚úÖ –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤–∏–¥–µ–æ-–æ–±–ª–∞—Å—Ç–∏ "${hotspot.title || ''}" –æ–±–Ω–æ–≤–ª–µ–Ω–æ`);
    }
  }

  /**
   * –ü–æ–ª—É—á–∞–µ—Ç —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é –∫–∞–º–µ—Ä—ã
   */
  getCameraPosition() {
    // –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –∫–∞–º–µ—Ä—É —Ä–∞–∑–Ω—ã–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏
    let camera = this.aframeScene?.querySelector('a-camera') ||
      this.aframeScene?.querySelector('[camera]') ||
      document.querySelector('a-camera') ||
      document.querySelector('[camera]');

    if (!camera) {
      console.warn('‚ö†Ô∏è –ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –ø—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ THREE.js');
      // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∫–∞–º–µ—Ä—É —á–µ—Ä–µ–∑ THREE.js
      try {
        const scene3D = this.aframeScene?.object3D;
        if (scene3D) {
          scene3D.traverse((child) => {
            if (child.isCamera && !camera) {
              camera = child.el; // –ü–æ–ª—É—á–∞–µ–º A-Frame —ç–ª–µ–º–µ–Ω—Ç
            }
          });
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –∫–∞–º–µ—Ä—ã —á–µ—Ä–µ–∑ THREE.js:', error);
      }
    }

    if (!camera) {
      console.warn('‚ö†Ô∏è –ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
      return null;
    }

    try {
      const position = camera.getAttribute('position');
      const rotation = camera.getAttribute('rotation');

      console.log('üìπ –¢–µ–∫—É—â–∞—è –ø–æ–∑–∏—Ü–∏—è –∫–∞–º–µ—Ä—ã:', { position, rotation });
      // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –¥–æ —á–∏—Å–ª–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
      const toNum = (v) => ({ x: parseFloat(v.x) || 0, y: parseFloat(v.y) || 0, z: parseFloat(v.z) || 0 });
      return { position: toNum(position || { x: 0, y: 0, z: 0 }), rotation: toNum(rotation || { x: 0, y: 0, z: 0 }) };
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏ –∫–∞–º–µ—Ä—ã:', error);
      return null;
    }
  }  /**
   * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø–æ–∑–∏—Ü–∏—é –∫–∞–º–µ—Ä—ã
   */
  setCameraPosition(cameraData) {
    // –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –∫–∞–º–µ—Ä—É —Ä–∞–∑–Ω—ã–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏
    let camera = this.aframeScene?.querySelector('a-camera') ||
      this.aframeScene?.querySelector('[camera]') ||
      document.querySelector('a-camera') ||
      document.querySelector('[camera]');

    if (!camera || !cameraData) {
      console.warn('‚ö†Ô∏è –ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ –¥–∞–Ω–Ω—ã–µ –∫–∞–º–µ—Ä—ã –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω—ã');
      return false;
    }

    try {
      if (cameraData.position) {
        const p = cameraData.position;
        camera.setAttribute('position', `${p.x || 0} ${p.y || 0} ${p.z || 0}`);
        console.log('üìπ –ü–æ–∑–∏—Ü–∏—è –∫–∞–º–µ—Ä—ã —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞:', cameraData.position);
      }

      if (cameraData.rotation) {
        const r = cameraData.rotation;
        camera.setAttribute('rotation', `${r.x || 0} ${r.y || 0} ${r.z || 0}`);
        console.log('üìπ –ü–æ–≤–æ—Ä–æ—Ç –∫–∞–º–µ—Ä—ã —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:', cameraData.rotation);
      }

      return true;
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –ø–æ–∑–∏—Ü–∏–∏ –∫–∞–º–µ—Ä—ã:', error);
      return false;
    }
  }

  /**
   * –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é –∫–∞–º–µ—Ä—ã –¥–ª—è —Å—Ü–µ–Ω—ã
   */
  saveCameraPositionForScene(sceneId) {
    if (!window.sceneManager) {
      console.warn('‚ö†Ô∏è SceneManager –Ω–µ –Ω–∞–π–¥–µ–Ω');
      return false;
    }

    const cameraPosition = this.getCameraPosition();
    if (!cameraPosition) {
      console.warn('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é –∫–∞–º–µ—Ä—ã');
      return false;
    }

    const scene = window.sceneManager.getSceneById(sceneId);
    if (!scene) {
      console.warn('‚ö†Ô∏è –°—Ü–µ–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞:', sceneId);
      return false;
    }

    scene.cameraPosition = cameraPosition;
    console.log('üìπ –ü–æ–∑–∏—Ü–∏—è –∫–∞–º–µ—Ä—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –¥–ª—è —Å—Ü–µ–Ω—ã:', sceneId, cameraPosition);
    return true;
  }
}
