# Инструкция по установке Color360

Это руководство объясняет, как установить сайт Color360 и приложение для редактирования панорам на VPS для онлайн-доступа.

## Обзор архитектуры

Развертывание состоит из трех основных компонентов:
1. **Основной сайт** - Приложение Express.js, обслуживающее целевую страницу и API
2. **Редактор панорам** - Статическое HTML/JS приложение для создания туров
3. **Прокси Nginx** - Обратный прокси для маршрутизации запросов к соответствующему сервису

## Предварительные требования

- VPS с Ubuntu 20.04+ или CentOS 8+
- Установленные Docker и Docker Compose
- Доменное имя (необязательно, но рекомендуется)
- Настроенный брандмауэр для разрешения портов 80 и 443

## Установка

### 1. Установите Docker и Docker Compose

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install docker.io docker-compose -y

# Запустите и включите Docker
sudo systemctl start docker
sudo systemctl enable docker

# Добавьте текущего пользователя в группу docker
sudo usermod -aG docker $USER
```

### 2. Клонируйте репозиторий

```bash
git clone <ваш-url-репозитория> /opt/color360
cd /opt/color360
```

### 3. Разверните с помощью Docker Compose

```bash
# Сделайте скрипт развертывания исполняемым
chmod +x deploy.sh

# Запустите развертывание
./deploy.sh
```

Или вручную:

```bash
# Создайте необходимые каталоги
mkdir -p data ssl logs

# Соберите и запустите сервисы
docker-compose up -d --build
```

## Конфигурация

### Переменные окружения

Основной сайт можно настроить с помощью этих переменных окружения:
- `PORT` - Порт для запуска основного сайта (по умолчанию: 3000)
- `NODE_ENV` - Окружение (production/development)
- `JWT_SECRET` - Секретный ключ для JWT (обязательно измените в production)

### Настройка SSL с Let's Encrypt

1. Установите Certbot:
```bash
sudo apt install certbot python3-certbot-nginx -y
```

2. Получите сертификат:
```bash
sudo certbot --nginx -d yourdomain.com
```

3. Обновите nginx.conf для HTTPS (замените блок сервера):
```nginx
server {
    listen 80;
    server_name yourdomain.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name yourdomain.com;

    ssl_certificate /etc/letsencrypt/live/yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/yourdomain.com/privkey.pem;

    # Включите остальную конфигурацию nginx здесь
}
```

## Доступ к приложению

После развертывания приложение будет доступно по адресам:
- Основной сайт: http://ip-вашего-сервера
- Редактор панорам: http://ip-вашего-сервера/pano

С доменом и SSL:
- Основной сайт: https://yourdomain.com
- Редактор панорам: https://yourdomain.com/pano

## Сохранение данных

Данные пользователей и проекты панорам хранятся в:
- Данные основного сайта: каталог `./data`
- Экспорт панорам: каталог `./pano/export`

Эти каталоги монтируются как тома в контейнерах Docker.

## Мониторинг и обслуживание

### Проверка статуса сервисов
```bash
docker-compose ps
```

### Просмотр логов
```bash
# Логи основного сайта
docker-compose logs color360-main

# Логи редактора панорам
docker-compose logs color360-pano

# Логи Nginx
docker-compose logs nginx
```

### Обновление приложения
```bash
# Получите последние изменения
git pull

# Пересоберите и перезапустите сервисы
docker-compose up -d --build
```

## Стратегия резервного копирования

### Скрипт автоматического резервного копирования
```bash
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backup/color360_$DATE"

mkdir -p $BACKUP_DIR

# Резервное копирование данных основного сайта
cp -r /opt/color360/data $BACKUP_DIR/

# Резервное копирование экспорта панорам
cp -r /opt/color360/pano/export $BACKUP_DIR/

# Сжатие резервной копии
tar -czf "/backup/color360_backup_$DATE.tar.gz" $BACKUP_DIR

# Удаление старых резервных копий (сохранять за последние 30 дней)
find /backup -name "color360_backup_*.tar.gz" -mtime +30 -delete
```

## Устранение неполадок

### Распространенные проблемы

1. **Порты уже заняты**:
   - Проверьте, не используются ли порты 80, 443 или 3000 другими сервисами
   - Измените docker-compose.yml для использования других портов

2. **Ошибки доступа**:
   - Убедитесь, что текущий пользователь входит в группу docker
   - При необходимости запускайте команды с sudo

3. **Сервисы не запускаются**:
   - Проверьте логи с помощью `docker-compose logs`
   - Убедитесь, что все файлы имеют правильные разрешения

4. **Приложение недоступно**:
   - Проверьте настройки брандмауэра
   - Проверьте конфигурацию nginx
   - Убедитесь, что DNS домена указывает на VPS

### Проверка состояния

Доступ к http://ip-вашего-сервера/health для проверки работоспособности приложения.

## Рекомендации по масштабированию

Для развертываний с высокой нагрузкой:
1. Используйте балансировщик нагрузки для нескольких экземпляров
2. Реализуйте Redis для хранения сессий
3. Используйте базу данных вместо хранения в памяти
4. Добавьте CDN для статических ресурсов
5. Реализуйте мониторинг с Prometheus/Grafana